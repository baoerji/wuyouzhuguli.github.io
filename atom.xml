<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>MrBird</title>
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://mrbird.cc/"/>
  <updated>2019-05-15T03:42:50.358Z</updated>
  <id>http://mrbird.cc/</id>
  
  <author>
    <name>MrBird</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>ThreadLocalä½¿ç”¨å­¦ä¹ </title>
    <link href="http://mrbird.cc/ThreadLocal.html"/>
    <id>http://mrbird.cc/ThreadLocal.html</id>
    <published>2019-03-15T08:21:35.000Z</published>
    <updated>2019-05-15T03:42:50.358Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Wed May 15 2019 17:13:43 GMT+0800 (GMT+08:00) --><p>ThreadLocalå­—é¢ä¸Šçš„æ„æ€æ˜¯å±€éƒ¨çº¿ç¨‹å˜é‡ï¼Œæ¯ä¸ªçº¿ç¨‹é€šè¿‡ThreadLocalçš„<code>get</code>å’Œ<code>set</code>æ–¹æ³•æ¥è®¿é—®å’Œä¿®æ”¹çº¿ç¨‹è‡ªå·±ç‹¬æœ‰çš„å˜é‡ã€‚ç®€å•åœ°è¯´ï¼ŒThreadLocalçš„ä½œç”¨å°±æ˜¯ä¸ºæ¯ä¸€ä¸ªçº¿ç¨‹æä¾›äº†ä¸€ä¸ªç‹¬ç«‹çš„å˜é‡å‰¯æœ¬ï¼Œæ¯ä¸€ä¸ªçº¿ç¨‹éƒ½å¯ä»¥ç‹¬ç«‹åœ°æ”¹å˜è‡ªå·±çš„å‰¯æœ¬ï¼Œè€Œä¸ä¼šå½±å“å…¶å®ƒçº¿ç¨‹æ‰€å¯¹åº”çš„å‰¯æœ¬ã€‚<a id="more"></a></p><h2 id="ThreadLocalçš„åŸºæœ¬ä½¿ç”¨"><a href="#ThreadLocalçš„åŸºæœ¬ä½¿ç”¨" class="headerlink" title="ThreadLocalçš„åŸºæœ¬ä½¿ç”¨"></a>ThreadLocalçš„åŸºæœ¬ä½¿ç”¨</h2><p>ThreadLocalæ˜¯ä¸€ä¸ªæ³›å‹ç±»ï¼Œåœ¨åˆ›å»ºçš„æ—¶å€™éœ€è¦æŒ‡å®šå˜é‡çš„ç±»å‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> ThreadLocal&lt;String&gt; threadLocal = <span class="keyword">new</span> ThreadLocal&lt;&gt;();</span><br></pre></td></tr></table></figure><p></p><p>ThreadLocalæä¾›äº†<code>set</code>æ–¹æ³•æ¥è®¾ç½®å˜é‡çš„å€¼ï¼Œ<code>get</code>æ–¹æ³•è·å–å˜é‡çš„å€¼ï¼Œ<code>remove</code>æ–¹æ³•ç§»é™¤å˜é‡ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadLocalTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ThreadLocal&lt;String&gt; threadLocal = <span class="keyword">new</span> ThreadLocal&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        threadLocal.set(<span class="string">"mrbird"</span>);</span><br><span class="line">        System.out.println(threadLocal.get());</span><br><span class="line">        threadLocal.remove();</span><br><span class="line">        System.out.println(threadLocal.get());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ç¨‹åºè¾“å‡ºå¦‚ä¸‹ï¼š <img src="img/QQæˆªå›¾20190515100033.png" alt="QQæˆªå›¾20190515100033.png"></p><p>æˆ‘ä»¬ä¹Ÿå¯ä»¥ç»™ThreadLocalè®¾ç½®åˆå§‹å€¼ï¼Œè®¾ç½®åˆå§‹å€¼æœ‰ä¸¤ç§æ–¹å¼ï¼š</p><ol><li>é‡å†™<code>initialValue</code>æ–¹æ³•ï¼š</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadLocalTest</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ThreadLocal&lt;String&gt; threadLocal = <span class="keyword">new</span> ThreadLocal&lt;String&gt;()&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> String <span class="title">initialValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"åˆå§‹å€¼"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        System.out.println(threadLocal.get()); <span class="comment">// åˆå§‹å€¼</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="2"><li>ä½¿ç”¨ThreadLocalçš„<code>withInitial</code>æ–¹æ³•ï¼š</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadLocalTest</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ThreadLocal&lt;String&gt; threadLocal = ThreadLocal.withInitial(() -&gt; <span class="string">"åˆå§‹å€¼"</span>);</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        System.out.println(threadLocal.get()); <span class="comment">// åˆå§‹å€¼</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å€¼å¾—æ³¨æ„çš„æ˜¯<code>remove</code>æ— æ³•ç§»é™¤åˆå§‹å€¼ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadLocalTest</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ThreadLocal&lt;String&gt; threadLocal = ThreadLocal.withInitial(() -&gt; <span class="string">"åˆå§‹å€¼"</span>);</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        threadLocal.remove();</span><br><span class="line">        System.out.println(threadLocal.get()); <span class="comment">// åˆå§‹å€¼</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><h2 id="æ¼”ç¤ºå¤šçº¿ç¨‹é—´ç‹¬ç«‹"><a href="#æ¼”ç¤ºå¤šçº¿ç¨‹é—´ç‹¬ç«‹" class="headerlink" title="æ¼”ç¤ºå¤šçº¿ç¨‹é—´ç‹¬ç«‹"></a>æ¼”ç¤ºå¤šçº¿ç¨‹é—´ç‹¬ç«‹</h2><p>åœ¨å¤šä¸ªçº¿ç¨‹ä¸­ä½¿ç”¨ThreadLocalï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadLocalTest2</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ThreadLocal&lt;String&gt; threadLocal = <span class="keyword">new</span> ThreadLocal&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Random random = <span class="keyword">new</span> Random(System.currentTimeMillis());</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        Thread thread1 = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            threadLocal.set(<span class="string">"thread t1"</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                TimeUnit.MICROSECONDS.sleep(random.nextInt(<span class="number">1000</span>));</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">" "</span> + threadLocal.get());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">"thread1"</span>);</span><br><span class="line"></span><br><span class="line">        Thread thread2 = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            threadLocal.set(<span class="string">"thread t2"</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                TimeUnit.MICROSECONDS.sleep(random.nextInt(<span class="number">1000</span>));</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">" "</span> + threadLocal.get());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">"thread2"</span>);</span><br><span class="line"></span><br><span class="line">        thread1.start();</span><br><span class="line">        thread2.start();</span><br><span class="line">        thread1.join();</span><br><span class="line">        thread2.join();</span><br><span class="line"></span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">" "</span> + threadLocal.get());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ç¨‹åºè¾“å‡ºå¦‚ä¸‹ï¼š</p><p><img src="img/QQæˆªå›¾20190515100702.png" alt="QQæˆªå›¾20190515100702.png"></p><p>ç»“æœè¯æ˜äº†ThreadLocalåœ¨æ¯ä¸ªçº¿ç¨‹é—´æ˜¯ç›¸äº’ç‹¬ç«‹çš„ï¼ŒthreadLocalåœ¨thread1ã€thread2å’Œmainçº¿ç¨‹é—´éƒ½æœ‰ä¸€ä»½ç‹¬ç«‹æ‹·è´ã€‚</p><h2 id="ThreadLocalåŸºæœ¬åŸç†"><a href="#ThreadLocalåŸºæœ¬åŸç†" class="headerlink" title="ThreadLocalåŸºæœ¬åŸç†"></a>ThreadLocalåŸºæœ¬åŸç†</h2><p>åœ¨ThreadLocalç±»ä¸­æœ‰ä¸€ä¸ªé™æ€å†…éƒ¨ç±»ThreadLocalMap(æ¦‚å¿µä¸Šç±»ä¼¼äºMap)ï¼Œç”¨é”®å€¼å¯¹çš„å½¢å¼å­˜å‚¨æ¯ä¸€ä¸ªçº¿ç¨‹çš„å˜é‡å‰¯æœ¬ï¼ŒThreadLocalMapä¸­å…ƒç´ çš„keyä¸ºå½“å‰ThreadLocalå¯¹è±¡ï¼Œè€Œvalueå¯¹åº”çº¿ç¨‹çš„å˜é‡å‰¯æœ¬ã€‚</p><p>æˆ‘ä»¬ä½¿ç”¨Mapæ¥ä»£æ›¿ThreadLocalMapï¼Œåˆ›å»ºä¸€ä¸ªç®€æ˜“çš„ç±»ThreadLocalå®ç°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyThreadLocal</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Thread, T&gt; threadLocalMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(T t)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            Thread key = Thread.currentThread();</span><br><span class="line">            threadLocalMap.put(key, t);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">get</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            Thread key = Thread.currentThread();</span><br><span class="line">            T t = threadLocalMap.get(key);</span><br><span class="line">            <span class="keyword">if</span> (t == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> initalValue();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> t;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">initalValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ä½¿ç”¨æ–¹å¼å’Œä¹‹å‰çš„ä¾‹å­ä¸€è‡´ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadLocalTest3</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> MyThreadLocal&lt;String&gt; threadLocal = <span class="keyword">new</span> MyThreadLocal&lt;String&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">initalValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"initalValue"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Random random = <span class="keyword">new</span> Random(System.currentTimeMillis());</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        Thread thread1 = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            threadLocal.set(<span class="string">"thread t1"</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                TimeUnit.MICROSECONDS.sleep(random.nextInt(<span class="number">1000</span>));</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">" "</span> + threadLocal.get());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">"thread1"</span>);</span><br><span class="line"></span><br><span class="line">        Thread thread2 = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            threadLocal.set(<span class="string">"thread t2"</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                TimeUnit.MICROSECONDS.sleep(random.nextInt(<span class="number">1000</span>));</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">" "</span> + threadLocal.get());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">"thread2"</span>);</span><br><span class="line"></span><br><span class="line">        thread1.start();</span><br><span class="line">        thread2.start();</span><br><span class="line">        thread1.join();</span><br><span class="line">        thread2.join();</span><br><span class="line"></span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">" "</span> + threadLocal.get());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ç¨‹åºè¾“å‡ºå¦‚ä¸‹ï¼š</p><p><img src="img/QQæˆªå›¾20190515101510.png" alt="QQæˆªå›¾20190515101510.png"></p><h2 id="ä½¿ç”¨å»ºè®®"><a href="#ä½¿ç”¨å»ºè®®" class="headerlink" title="ä½¿ç”¨å»ºè®®"></a>ä½¿ç”¨å»ºè®®</h2><ol><li><p>å°†ThreadLocalå˜é‡æŒ‡å®šä¸º<code>private static</code>ï¼›</p></li><li><p>ä½¿ç”¨å®Œæ¯•åæ˜¾å¼åœ°è°ƒç”¨<code>remove</code>æ–¹æ³•ç§»é™¤ã€‚</p></li></ol><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Wed May 15 2019 17:13:43 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;ThreadLocalå­—é¢ä¸Šçš„æ„æ€æ˜¯å±€éƒ¨çº¿ç¨‹å˜é‡ï¼Œæ¯ä¸ªçº¿ç¨‹é€šè¿‡ThreadLocalçš„&lt;code&gt;get&lt;/code&gt;å’Œ&lt;code&gt;set&lt;/code&gt;æ–¹æ³•æ¥è®¿é—®å’Œä¿®æ”¹çº¿ç¨‹è‡ªå·±ç‹¬æœ‰çš„å˜é‡ã€‚ç®€å•åœ°è¯´ï¼ŒThreadLocalçš„ä½œç”¨å°±æ˜¯ä¸ºæ¯ä¸€ä¸ªçº¿ç¨‹æä¾›äº†ä¸€ä¸ªç‹¬ç«‹çš„å˜é‡å‰¯æœ¬ï¼Œæ¯ä¸€ä¸ªçº¿ç¨‹éƒ½å¯ä»¥ç‹¬ç«‹åœ°æ”¹å˜è‡ªå·±çš„å‰¯æœ¬ï¼Œè€Œä¸ä¼šå½±å“å…¶å®ƒçº¿ç¨‹æ‰€å¯¹åº”çš„å‰¯æœ¬ã€‚
    
    </summary>
    
    
      <category term="Java" scheme="http://mrbird.cc/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>JUCä¹‹Semaphore</title>
    <link href="http://mrbird.cc/JUC-Semaphore.html"/>
    <id>http://mrbird.cc/JUC-Semaphore.html</id>
    <published>2019-03-11T08:24:16.000Z</published>
    <updated>2019-05-15T09:12:00.911Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Wed May 15 2019 17:13:43 GMT+0800 (GMT+08:00) --><p>JUCçš„Semaphoreä¿—ç§°ä¿¡å·é‡ï¼Œå¯ç”¨æ¥æ§åˆ¶åŒæ—¶è®¿é—®ç‰¹å®šèµ„æºçš„çº¿ç¨‹æ•°é‡ã€‚é€šè¿‡å®ƒçš„æ„é€ å‡½æ•°æˆ‘ä»¬å¯ä»¥æŒ‡å®šä¿¡å·é‡ï¼ˆç§°ä¸ºè®¸å¯è¯permitså¯èƒ½æ›´ä¸ºæ˜ç¡®ï¼‰çš„æ•°é‡ï¼Œçº¿ç¨‹å¯ä»¥è°ƒç”¨Semaphoreå¯¹è±¡çš„<code>acquire</code>æ–¹æ³•è·å–ä¸€ä¸ªè®¸å¯è¯ï¼Œè°ƒç”¨<code>release</code>æ¥å½’è¿˜ä¸€ä¸ªè®¸å¯è¯ã€‚</p><p>ä¸‹é¢ä¸¾ä¸ªSemaphoreçš„åŸºæœ¬ä½¿ç”¨ç¤ºä¾‹ã€‚<a id="more"></a></p><h2 id="Semaphoreç¤ºä¾‹"><a href="#Semaphoreç¤ºä¾‹" class="headerlink" title="Semaphoreç¤ºä¾‹"></a>Semaphoreç¤ºä¾‹</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SemaphoreTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="comment">// å®šä¹‰è®¸å¯è¯æ•°é‡</span></span><br><span class="line">        <span class="keyword">final</span> Semaphore semaphore = <span class="keyword">new</span> Semaphore(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        IntStream.range(<span class="number">0</span>, <span class="number">4</span>).forEach(i -&gt; &#123;</span><br><span class="line">            <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">"å¼€å§‹"</span>);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    semaphore.acquire(); <span class="comment">// ä¸€æ¬¡æ‹¿ä¸€ä¸ªè®¸å¯è¯</span></span><br><span class="line">                    System.out.println(Thread.currentThread().getName() + <span class="string">"è·å–è®¸å¯è¯"</span>);</span><br><span class="line">                    TimeUnit.SECONDS.sleep(<span class="number">3</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    System.out.println(Thread.currentThread().getName() + <span class="string">"é‡Šæ”¾è®¸å¯è¯"</span>);</span><br><span class="line">                    semaphore.release();</span><br><span class="line">                &#125;</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">"ç»“æŸ"</span>);</span><br><span class="line">            &#125;, <span class="string">"thread"</span> + (i + <span class="number">1</span>)).start();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰è®¸å¯è¯çš„æ•°é‡ä¸º2ä¸ªï¼Œç„¶å4ä¸ªçº¿ç¨‹é€šè¿‡<code>acquire</code>æ–¹æ³•å»è·å–è®¸å¯è¯ï¼Œç»“æŸè¡Œé€šè¿‡<code>release</code>æ–¹æ³•é‡Šæ”¾è®¸å¯è¯ã€‚<code>acquire</code>æ–¹æ³•é»˜è®¤ä¸€æ¬¡åªæ‹¿ä¸€ä¸ªè®¸å¯è¯ï¼Œæ‰€ä»¥ä¸Šé¢çš„ä¾‹å­ä¸­ï¼ŒåŒä¸€æ—¶åˆ»æœ€å¤šåªæœ‰ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡Œã€‚</p><p>ç¨‹åºè¾“å‡ºå¦‚ä¸‹æ‰€ç¤ºï¼š <img src="img/asfasdfa.gif" alt="asfasdfa.gif"></p><p><code>acquire</code>çš„é‡è½½æ–¹æ³•<code>acquire(int permits)</code>å…è®¸çº¿ç¨‹ä¸€æ¬¡æ€§è·å–Nä¸ªè®¸å¯è¯ï¼›åŒæ ·çš„<code>release</code>çš„é‡è½½æ–¹æ³•<code>release(int permits)</code>å…è®¸çº¿ç¨‹ä¸€æ¬¡æ€§é‡Šæ”¾Nä¸ªè®¸å¯è¯ã€‚</p><p>Semaphoreè¿˜æœ‰ä¸€ä¸ª<code>tryAcquire</code>ï¼Œå®ƒå…è®¸çº¿ç¨‹å°è¯•å»è·å–1ä¸ªè®¸å¯è¯ï¼Œå¦‚æœè®¸å¯è¯ä¸è¶³æ²¡æœ‰è·å–åˆ°çš„è¯ï¼Œçº¿ç¨‹ä¹Ÿä¼šç»§ç»­æ‰§è¡Œï¼Œè€Œéé˜»å¡ç­‰å¾…ã€‚<code>tryAcquire</code>æ–¹æ³•çš„é‡è½½æ–¹æ³•<code>tryAcquire(long timeout, TimeUnit unit)</code>å¯ä»¥æŒ‡å®šå°è¯•è·å–è®¸å¯è¯çš„è¶…æ—¶æ—¶é—´ã€‚</p><h2 id="acquireUninterruptibly"><a href="#acquireUninterruptibly" class="headerlink" title="acquireUninterruptibly"></a>acquireUninterruptibly</h2><p>ä»ä¸Šé¢çš„ä¾‹å­æˆ‘ä»¬ä¼šå‘ç°<code>acquire</code>æ–¹æ³•ä¼šæŠ›å‡º<code>InterruptedException</code>å¼‚å¸¸ï¼Œè¯´æ˜è¿™ä¸ªæ–¹æ³•æ˜¯å¯ä»¥è¢«æ‰“æ–­çš„ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SemaphoreTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Semaphore semaphore = <span class="keyword">new</span> Semaphore(<span class="number">1</span>);</span><br><span class="line">        Thread thread1 = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                semaphore.acquire(<span class="number">2</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                System.err.println(<span class="string">"semaphore InterruptedException"</span>);</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        thread1.start();</span><br><span class="line">        TimeUnit.MICROSECONDS.sleep(<span class="number">500</span>);</span><br><span class="line">        thread1.interrupt();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ä¸Šé¢ä¾‹å­thread1çº¿ç¨‹è·å–2ä¸ªè®¸å¯è¯ï¼Œä½†è®¸å¯è¯æ€»æ•°åªæœ‰1ä¸ªï¼Œæ‰€ä»¥ä¼šé˜»å¡ç­‰å¾…ã€‚mainçº¿ç¨‹é€šè¿‡è°ƒç”¨thread1çš„<code>interrupt</code>æ–¹æ³•å»æ‰“æ–­thread1çº¿ç¨‹ï¼Œç»“æœå¦‚ä¸‹ï¼š</p><p><img src="img/QQæˆªå›¾20190515164441.png" alt="QQæˆªå›¾20190515164441.png"></p><p>è€Œé€šè¿‡<code>acquireUninterruptibly</code>æ–¹æ³•å»è·å–è®¸å¯è¯æ˜¯ä¸å¯è¢«æ‰“æ–­çš„ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SemaphoreTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Semaphore semaphore = <span class="keyword">new</span> Semaphore(<span class="number">1</span>);</span><br><span class="line">        Thread thread1 = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            semaphore.acquireUninterruptibly(<span class="number">2</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">        thread1.start();</span><br><span class="line">        TimeUnit.MICROSECONDS.sleep(<span class="number">500</span>);</span><br><span class="line">        thread1.interrupt();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ä¸Šé¢ç¨‹åºå¹¶ä¸ä¼šæŠ›å‡º<code>InterruptedException</code>ï¼Œthread1ä¼šä¸€ç›´å¤„äºé˜»å¡çŠ¶æ€ã€‚</p><h2 id="drainPermits"><a href="#drainPermits" class="headerlink" title="drainPermits"></a>drainPermits</h2><p><code>drainPermits</code>æ–¹æ³•ä¸€æ¬¡æ€§è·å–æ‰€æœ‰è®¸å¯è¯ï¼ˆdrainæŠ½å¹²æ¦¨å¹²ğŸ˜®ï¼‰ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SemaphoreTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Semaphore semaphore = <span class="keyword">new</span> Semaphore(<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">"availablePermits: "</span> + semaphore.availablePermits());</span><br><span class="line">            semaphore.drainPermits(); <span class="comment">// è·å–æ‰€æœ‰è®¸å¯è¯ï¼ŒæŠ½å¹²</span></span><br><span class="line">            System.out.println(<span class="string">"availablePermits: "</span> + semaphore.availablePermits());</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                TimeUnit.SECONDS.sleep(<span class="number">4</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            semaphore.release(<span class="number">5</span>);</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">"ç»“æŸ"</span>);</span><br><span class="line">        &#125;, <span class="string">"thread1"</span>).start();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p><code>availablePermits</code>æ–¹æ³•ç”¨äºè·å–å½“å‰å¯ç”¨è®¸å¯è¯æ•°é‡çš„é¢„ä¼°å€¼ã€‚ç¨‹åºè¾“å‡ºå¦‚ä¸‹ï¼š</p><p><img src="img/QQæˆªå›¾20190515164951.png" alt="QQæˆªå›¾20190515164951.png"></p><h2 id="åˆ«çš„API"><a href="#åˆ«çš„API" class="headerlink" title="åˆ«çš„API"></a>åˆ«çš„API</h2><p><code>hasQueuedThreads</code>æ–¹æ³•ç”¨äºåˆ¤æ–­æ˜¯å¦æœ‰å¤„äºç­‰å¾…è·å–è®¸å¯è¯çŠ¶æ€çš„çº¿ç¨‹ï¼›<code>getQueueLength</code>ç”¨äºè·å–å¤„äºç­‰å¾…è·å–è®¸å¯è¯çŠ¶æ€çš„çº¿ç¨‹çš„æ•°é‡ï¼›<code>getQueuedThreads</code>ç”¨äºè·å–å¤„äºç­‰å¾…è·å–è®¸å¯è¯çŠ¶æ€çš„çº¿ç¨‹é›†åˆã€‚</p><p><code>getQueuedThreads</code>æ˜¯<code>protected</code>çš„ï¼Œæ‰€ä»¥è¦ä½¿ç”¨å®ƒï¼Œæˆ‘ä»¬å¾—è‡ªå®šä¹‰ä¸€ä¸ªSemaphoreçš„å­ç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SemaphoreTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// å®šä¹‰è®¸å¯è¯æ•°é‡</span></span><br><span class="line">        <span class="keyword">final</span> MySemaphore semaphore = <span class="keyword">new</span> MySemaphore(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        IntStream.range(<span class="number">0</span>, <span class="number">4</span>).forEach(i -&gt; &#123;</span><br><span class="line">            <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">"å¼€å§‹"</span>);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    semaphore.acquire();</span><br><span class="line">                    System.out.println(Thread.currentThread().getName() + <span class="string">"è·å–è®¸å¯è¯"</span>);</span><br><span class="line">                    TimeUnit.SECONDS.sleep(<span class="number">3</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    System.out.println(Thread.currentThread().getName() + <span class="string">"é‡Šæ”¾è®¸å¯è¯"</span>);</span><br><span class="line">                    semaphore.release();</span><br><span class="line">                &#125;</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">"ç»“æŸ"</span>);</span><br><span class="line">            &#125;, <span class="string">"thread"</span> + (i + <span class="number">1</span>)).start();</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (semaphore.hasQueuedThreads()) &#123;</span><br><span class="line">                System.out.println(<span class="string">"ç­‰å¾…çº¿ç¨‹æ•°é‡ï¼š"</span> + semaphore.getQueueLength());</span><br><span class="line">                Collection&lt;Thread&gt; queuedThreads = semaphore.getQueuedThreads();</span><br><span class="line">                System.out.println(<span class="string">"ç­‰å¾…çº¿ç¨‹ï¼š"</span> + queuedThreads.stream().map(Thread::getName).collect(Collectors.joining(<span class="string">","</span>)));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MySemaphore</span> <span class="keyword">extends</span> <span class="title">Semaphore</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">2595494765642942297L</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">MySemaphore</span><span class="params">(<span class="keyword">int</span> permits)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(permits);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">MySemaphore</span><span class="params">(<span class="keyword">int</span> permits, <span class="keyword">boolean</span> fair)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(permits, fair);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Collection&lt;Thread&gt; <span class="title">getQueuedThreads</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">super</span>.getQueuedThreads();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ç¨‹åºè¾“å‡ºå¦‚ä¸‹æ‰€ç¤ºï¼ˆæˆªå–ä¸€éƒ¨åˆ†ï¼‰ï¼š <img src="img/QQæˆªå›¾20190515165623.png" alt="QQæˆªå›¾20190515165623.png"></p><h2 id="Apiæ€»ç»“"><a href="#Apiæ€»ç»“" class="headerlink" title="Apiæ€»ç»“"></a>Apiæ€»ç»“</h2><p>æ€»ç»“ä¸‹Semaphoreå¸¸ç”¨çš„æ–¹æ³•ï¼š</p><table><tr><th>æ–¹æ³•</th><th>æè¿°</th></tr><tr><td><code>acquire()</code></td><td>è·å–ä¸€ä¸ªè®¸å¯è¯ï¼Œå¯ä»¥è¢«æ‰“æ–­ï¼Œæ²¡æœ‰è¶³å¤Ÿçš„è®¸å¯è¯æ—¶é˜»å¡ç­‰å¾…</td></tr><tr><td><code>acquire(int permits)</code></td><td>è·å–æŒ‡å®šæ•°é‡çš„è®¸å¯è¯ï¼Œå¯ä»¥è¢«æ‰“æ–­ï¼Œæ²¡æœ‰è¶³å¤Ÿçš„è®¸å¯è¯æ—¶é˜»å¡ç­‰å¾…</td></tr><tr><td><code>acquireUninterruptibly()</code></td><td>è·å–ä¸€ä¸ªè®¸å¯è¯ï¼Œä¸å¯è¢«æ‰“æ–­ï¼Œæ²¡æœ‰è¶³å¤Ÿçš„è®¸å¯è¯æ—¶é˜»å¡ç­‰å¾…</td></tr><tr><td><code>acquireUninterruptibly(int permits)</code></td><td>è·å–æŒ‡å®šæ•°é‡çš„è®¸å¯è¯ï¼Œä¸å¯è¢«æ‰“æ–­ï¼Œæ²¡æœ‰è¶³å¤Ÿçš„è®¸å¯è¯æ—¶é˜»å¡ç­‰å¾…</td></tr><tr><td><code>tryAcquire()</code></td><td>å°è¯•è·å–ä¸€ä¸ªè®¸å¯è¯ï¼Œæ²¡æœ‰è¶³å¤Ÿçš„è®¸å¯è¯æ—¶ç¨‹åºç»§ç»­æ‰§è¡Œï¼Œä¸ä¼šè¢«é˜»å¡</td></tr><tr><td><code>tryAcquire(int permits)</code></td><td>å°è¯•è·å–æŒ‡å®šæ•°é‡çš„è®¸å¯è¯ï¼Œæ²¡æœ‰è¶³å¤Ÿçš„è®¸å¯è¯æ—¶ç¨‹åºç»§ç»­æ‰§è¡Œï¼Œä¸ä¼šè¢«é˜»å¡</td></tr><tr><td><code>tryAcquire(long timeout, TimeUnit unit)</code></td><td>åœ¨æŒ‡å®šçš„æ—¶é—´èŒƒå›´å†…å°è¯•è·å–1ä¸ªè®¸å¯è¯ï¼Œæ²¡æœ‰è¶³å¤Ÿçš„è®¸å¯è¯æ—¶ç¨‹åºç»§ç»­æ‰§è¡Œï¼Œ<br>ä¸ä¼šè¢«é˜»å¡ï¼Œåœ¨è¯¥æ—¶é—´æ–¹ä½å†…å¯ä»¥è¢«æ‰“æ–­</td></tr><tr><td><code>tryAcquire(int permits, long timeout, TimeUnit unit)</code></td><td>åœ¨æŒ‡å®šçš„æ—¶é—´èŒƒå›´å†…å°è¯•è·å–æŒ‡å®šæ•°é‡çš„è®¸å¯è¯ï¼Œæ²¡æœ‰è¶³å¤Ÿçš„è®¸å¯è¯æ—¶ç¨‹åº<br>ç»§ç»­æ‰§è¡Œï¼Œä¸ä¼šè¢«é˜»å¡ï¼Œåœ¨è¯¥æ—¶é—´æ–¹ä½å†…å¯ä»¥è¢«æ‰“æ–­</td></tr><tr><td><code>release()</code></td><td>é‡Šæ”¾ä¸€ä¸ªè®¸å¯è¯</td></tr><tr><td><code>drainPermits()</code></td><td>ä¸€æ¬¡æ€§è·å–æ‰€æœ‰å¯ç”¨çš„è®¸å¯è¯</td></tr><tr><td><code>availablePermits()</code></td><td>è·å–å½“å‰å¯ç”¨è®¸å¯è¯æ•°é‡çš„é¢„ä¼°å€¼</td></tr><tr><td><code>hasQueuedThreads()</code></td><td>åˆ¤æ–­æ˜¯å¦æœ‰å¤„äºç­‰å¾…è·å–è®¸å¯è¯çŠ¶æ€çš„çº¿ç¨‹</td></tr><tr><td><code>getQueueLength()</code></td><td>è·å–å¤„äºç­‰å¾…è·å–è®¸å¯è¯çŠ¶æ€çš„çº¿ç¨‹çš„æ•°é‡çš„é¢„ä¼°å€¼</td></tr><tr><td><code>getQueuedThreads()</code></td><td>è·å–å¤„äºç­‰å¾…è·å–è®¸å¯è¯çŠ¶æ€çš„çº¿ç¨‹é›†åˆ</td></tr></table><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Wed May 15 2019 17:13:43 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;JUCçš„Semaphoreä¿—ç§°ä¿¡å·é‡ï¼Œå¯ç”¨æ¥æ§åˆ¶åŒæ—¶è®¿é—®ç‰¹å®šèµ„æºçš„çº¿ç¨‹æ•°é‡ã€‚é€šè¿‡å®ƒçš„æ„é€ å‡½æ•°æˆ‘ä»¬å¯ä»¥æŒ‡å®šä¿¡å·é‡ï¼ˆç§°ä¸ºè®¸å¯è¯permitså¯èƒ½æ›´ä¸ºæ˜ç¡®ï¼‰çš„æ•°é‡ï¼Œçº¿ç¨‹å¯ä»¥è°ƒç”¨Semaphoreå¯¹è±¡çš„&lt;code&gt;acquire&lt;/code&gt;æ–¹æ³•è·å–ä¸€ä¸ªè®¸å¯è¯ï¼Œè°ƒç”¨&lt;code&gt;release&lt;/code&gt;æ¥å½’è¿˜ä¸€ä¸ªè®¸å¯è¯ã€‚&lt;/p&gt;&lt;p&gt;ä¸‹é¢ä¸¾ä¸ªSemaphoreçš„åŸºæœ¬ä½¿ç”¨ç¤ºä¾‹ã€‚
    
    </summary>
    
    
      <category term="Java" scheme="http://mrbird.cc/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>æ·±å…¥ç†è§£volatileå…³é”®å­—</title>
    <link href="http://mrbird.cc/volatile.html"/>
    <id>http://mrbird.cc/volatile.html</id>
    <published>2019-03-10T08:20:41.000Z</published>
    <updated>2019-05-15T02:24:50.202Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Wed May 15 2019 17:13:44 GMT+0800 (GMT+08:00) --><p>volatileå…³é”®å­—ä¿®é¥°çš„æˆå‘˜å˜é‡å…·æœ‰ä¸¤å¤§ç‰¹æ€§ï¼šä¿è¯äº†è¯¥æˆå‘˜å˜é‡åœ¨ä¸åŒçº¿ç¨‹ä¹‹é—´çš„å¯è§æ€§ï¼›ç¦æ­¢å¯¹è¯¥æˆå‘˜å˜é‡è¿›è¡Œé‡æ’åºï¼Œä¹Ÿå°±ä¿è¯äº†å…¶æœ‰åºæ€§ã€‚ä½†æ˜¯volatileä¿®é¥°çš„æˆå‘˜å˜é‡å¹¶ä¸å…·æœ‰åŸå­æ€§ï¼Œåœ¨å¹¶å‘ä¸‹å¯¹å®ƒçš„ä¿®æ”¹æ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ã€‚ä¸‹é¢åˆ†åˆ«ä¸¾ä¾‹æ¥æ¼”ç¤ºè¿™ä¸¤ä¸ªç‰¹æ€§ï¼Œå¹¶ä¸”åˆ†æä¸ºä»€ä¹ˆvolatileä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</p><a id="more"></a><h2 id="å¯è§æ€§"><a href="#å¯è§æ€§" class="headerlink" title="å¯è§æ€§"></a>å¯è§æ€§</h2><p>é€šè¿‡å¯¹<a href="/Java-Memory-model.html">JMM</a>çš„å­¦ä¹ ï¼Œæˆ‘ä»¬éƒ½çŸ¥é“çº¿ç¨‹å¯¹ä¸»å†…å­˜ä¸­å…±äº«å˜é‡çš„ä¿®æ”¹é¦–å…ˆä¼šä»ä¸»å†…å­˜è·å–å€¼çš„æ‹·è´ï¼Œç„¶åä¿å­˜åˆ°çº¿ç¨‹çš„å·¥ä½œå†…å­˜ä¸­ã€‚æ¥ç€åœ¨å·¥ä½œå†…å­˜ä¸­å¯¹å€¼è¿›è¡Œä¿®æ”¹ï¼Œæœ€ç»ˆåˆ·å›ä¸»å†…å­˜ã€‚ç”±äºä¸åŒçº¿ç¨‹æ‹¥æœ‰å„è‡ªçš„å·¥ä½œå†…å­˜ï¼Œæ‰€ä»¥å®ƒä»¬å¯¹æŸä¸ªå…±äº«å˜é‡å€¼çš„ä¿®æ”¹åœ¨æ²¡æœ‰åˆ·å›ä¸»å†…å­˜çš„æ—¶å€™åªå¯¹è‡ªå·±å¯è§ã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼Œå‡å¦‚æœ‰ä¸¤ä¸ªçº¿ç¨‹ï¼Œå…¶ä¸­ä¸€ä¸ªçº¿ç¨‹ç”¨äºä¿®æ”¹å…±äº«å˜é‡valueï¼Œå¦ä¸€ä¸ªçº¿ç¨‹ç”¨äºè·å–ä¿®æ”¹åçš„valueï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VolatileTest</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> INIT_VALUE = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">int</span> LIMIT = <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">int</span> value = INIT_VALUE;</span><br><span class="line">            <span class="keyword">while</span> (value &lt; LIMIT) &#123;</span><br><span class="line">                <span class="keyword">if</span> (value != INIT_VALUE) &#123;</span><br><span class="line">                    System.out.println(<span class="string">"è·å–æ›´æ–°åçš„å€¼ï¼š"</span> + INIT_VALUE);</span><br><span class="line">                    value = INIT_VALUE;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">"reader"</span>).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">int</span> value = INIT_VALUE;</span><br><span class="line">            <span class="keyword">while</span> (INIT_VALUE &lt; LIMIT) &#123;</span><br><span class="line">                System.out.println(<span class="string">"å°†å€¼æ›´æ–°ä¸ºï¼š"</span> + ++value);</span><br><span class="line">                INIT_VALUE = value;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    TimeUnit.MICROSECONDS.sleep(<span class="number">500</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">"writer"</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>writerçº¿ç¨‹æ¯éš”0.5ç§’å°†INIT_VALUEå€¼é€’å¢ï¼Œç›´åˆ°INIT_VALUEå¤§äºç­‰äº5ã€‚è€Œreaderçº¿ç¨‹åˆ™æ˜¯ä¸åœçš„å»è·å–INIT_VALUEçš„å€¼ï¼Œç›´åˆ°INIT_VALUEçš„å€¼å¤§äºç­‰äº5ã€‚ç¨‹åºæ‰§è¡Œç»“æœå¦‚ä¸‹ï¼š</p><p><img src="img/QQæˆªå›¾20190514143804.png" alt="QQæˆªå›¾20190514143804.png"></p><p><img src="img/QQæˆªå›¾20190514150227.png" alt="QQæˆªå›¾20190514150227.png"></p><p>å¤šæ‰§è¡Œå‡ æ¬¡å¯èƒ½æ¯æ¬¡ç»“æœéƒ½ä¸ä¸€æ ·ï¼Œä½†æ˜¯å¯ä»¥ç¡®å®šçš„æ˜¯ï¼Œwriterå¯¹å€¼çš„ä¿®æ”¹readerå¹¶ä¸èƒ½é©¬ä¸Šæ„ŸçŸ¥åˆ°ï¼ˆå¦‚æœèƒ½æ„ŸçŸ¥åˆ°çš„è¯ï¼Œreaderçº¿ç¨‹å°±ä¸ä¼šåœä¸ä¸‹æ¥äº†ï¼‰ã€‚</p><p>ä¸ºä»€ä¹ˆä¼šå‡ºç°ä¸Šé¢çš„ç»“æœå‘¢ï¼Ÿå› ä¸ºwriterçº¿ç¨‹åœ¨å·¥ä½œå†…å­˜ä¸­ä¿®æ”¹äº†INIT_VALUEçš„å€¼ï¼Œå³ä½¿å®ƒåˆ·å›ä¸»å†…å­˜äº†ï¼Œä½†æ˜¯readerçº¿ç¨‹åœ¨æ­¤ä¹‹å‰å·²ç»ä»ä¸»å†…å­˜è·å–äº†INIT_VALUEçš„å€¼ï¼ˆå› ä¸ºçº¿ç¨‹è·å–CPUæ—¶é—´ç‰‡ä¸ç¡®å®šæ€§ï¼Œè¿™ä¸ªå€¼å¯èƒ½æ˜¯0ï¼Œä¹Ÿå¯èƒ½æ˜¯è¢«writerä¿®æ”¹åçš„å€¼ï¼Œä½†writerçº¿ç¨‹æ˜¯æ¯éš”0.5ç§’æ‰ä¼šå»ä¿®æ”¹å€¼ï¼Œæ‰€ä»¥readerè·å–åˆ°çš„INIT_VALUEçš„å€¼ä¸€èˆ¬ä¸ä¼šæ˜¯writerä¿®æ”¹çš„æœ€ç»ˆå€¼5ï¼‰ï¼Œå¹¶ä¿å­˜åˆ°äº†readerçº¿ç¨‹çš„å·¥ä½œå†…å­˜ä¸­ã€‚readerçº¿ç¨‹é€šè¿‡whileä¸æ–­çš„è½®è¯¢åˆ¤æ–­valueå’ŒINIT_VALUEçš„å€¼æ˜¯å¦ç›¸ç­‰ï¼Œä½†æ˜¯ç”±äºreaderçº¿ç¨‹å·¥ä½œå†…å­˜ä¸­å·²ç»æœ‰INIT_VALUEçš„å€¼çš„æ‹·è´äº†ï¼Œæ‰€ä»¥readerå¹¶ä¸ä¼šé‡æ–°ä»ä¸»å†…å­˜ä¸­è·å–è¢«writerä¿®æ”¹åçš„INIT_VALUEçš„å€¼ï¼Œreaderçº¿ç¨‹é‡Œwhileæ¡ä»¶ä¸€ç›´æˆç«‹ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆreaderçº¿ç¨‹ä¸ä¼šæ­£å¸¸åœæ­¢å¹¶ä¸”æ²¡æœ‰è¾“å‡ºä¿®æ”¹åçš„å€¼çš„åŸå› ã€‚</p><p>ä¿®æ”¹ä¸Šé¢çš„ä¾‹å­ï¼Œå°†INIT_VALUEæˆå‘˜å˜é‡ä½¿ç”¨volatileå…³é”®å­—ä¿®é¥°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VolatileTest</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">static</span> <span class="keyword">int</span> INIT_VALUE = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">int</span> LIMIT = <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">int</span> value = INIT_VALUE;</span><br><span class="line">            <span class="keyword">while</span> (value &lt; LIMIT) &#123;</span><br><span class="line">                <span class="keyword">if</span> (value != INIT_VALUE) &#123;</span><br><span class="line">                    System.out.println(<span class="string">"è·å–æ›´æ–°åçš„å€¼ï¼š"</span> + INIT_VALUE);</span><br><span class="line">                    value = INIT_VALUE;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">"reader"</span>).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">int</span> value = INIT_VALUE;</span><br><span class="line">            <span class="keyword">while</span> (INIT_VALUE &lt; LIMIT) &#123;</span><br><span class="line">                System.out.println(<span class="string">"å°†å€¼æ›´æ–°ä¸ºï¼š"</span> + ++value);</span><br><span class="line">                INIT_VALUE = value;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    TimeUnit.MICROSECONDS.sleep(<span class="number">500</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">"writer"</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p><img src="img/QQæˆªå›¾20190514145045.png" alt="QQæˆªå›¾20190514145045.png"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œreaderçº¿ç¨‹å·²ç»å¯ä»¥æ­£å¸¸åœæ­¢äº†ï¼Œå› ä¸ºæœ€ç»ˆINIT_VALUEçš„å€¼è‚¯å®šæ˜¯5ï¼Œå¹¶ä¸”readerå¯ä»¥æ„ŸçŸ¥åˆ°è¿™ä¸ªå€¼è¢«ä¿®æ”¹ä¸º5äº†ã€‚</p><p>ä¸ºä»€ä¹ˆvolatileä¿®é¥°çš„æˆå‘˜å˜é‡åœ¨çº¿ç¨‹é—´å…·æœ‰å¯è§æ€§å‘¢ï¼Ÿå› ä¸ºé€šè¿‡volatileä¿®é¥°ï¼Œå¯¹æ­¤å˜é‡è¿›è¡Œå†™æ“ä½œæ—¶ï¼Œæ±‡ç¼–æŒ‡ä»¤ä¸­ä¼šæœ‰ä¸€ä¸ªLOCKå‰ç¼€æŒ‡ä»¤ï¼ŒåŠ äº†è¿™ä¸ªæŒ‡ä»¤åï¼Œä¼šå¼•å‘ä¸¤ä»¶äº‹æƒ…ï¼š</p><ol><li><p>å°†å½“å‰å¤„ç†å™¨ç¼“å­˜è¡Œçš„å†…å®¹å†™å›åˆ°ç³»ç»Ÿå†…å­˜ï¼Œä¹Ÿå°±æ˜¯å¼ºåˆ¶å°†å·¥ä½œå†…å­˜ä¸­çš„å€¼åˆ·å›ä¸»å†…å­˜ï¼›</p></li><li><p>è¿™ä¸ªå†™å›åˆ°å†…å­˜çš„æ“ä½œä¼šä½¿å¾—åœ¨å…¶ä»–CPUé‡Œç¼“å­˜äº†è¯¥å†…å­˜åœ°å€çš„æ•°æ®å¤±æ•ˆã€‚å…¶ä»–CPUç¼“å­˜æ•°æ®å¤±æ•ˆï¼Œåˆ™ä¼šé‡æ–°å»å†…å­˜ä¸­è¯»å–å€¼ï¼Œä¹Ÿå°±æ˜¯è¢«ä¿®æ”¹çš„æ•°æ®ã€‚</p></li></ol><p>é€šè¿‡ä¸Šé¢è¿™ä¸¤ä¸ªç‰¹æ€§ï¼Œæˆ‘ä»¬å¯ä»¥ç¡®å®šçš„æ˜¯ï¼Œwriterå¯¹å€¼è¿›è¡Œä¿®æ”¹å¹¶åˆ·å›ä¸»å†…å­˜åï¼Œreaderé‡ŒINIT_VALUEå€¼çš„æ‹·è´å°±å¤±æ•ˆäº†ï¼Œæ‰€ä»¥readerçº¿ç¨‹ä¼šå†æ¬¡ä»ä¸»å†…å­˜ä¸­è·å–INIT_VALUEçš„å€¼ï¼Œè¿™æ—¶å€™è¿™ä¸ªå€¼å·²ç»æ˜¯è¢«writerçº¿ç¨‹ä¿®æ”¹åˆ·æ–°åçš„å€¼äº†ã€‚</p><h2 id="æœ‰åºæ€§"><a href="#æœ‰åºæ€§" class="headerlink" title="æœ‰åºæ€§"></a>æœ‰åºæ€§</h2><p>æ¥çœ‹ä¸€ä¸ªçº¿ç¨‹ä¸å®‰å…¨çš„å•ä¾‹å®ç°ï¼ˆåŒé‡åŒæ­¥é”å•ä¾‹æ¨¡å¼ï¼Œæ›´å¤šå…³äºå•ä¾‹çš„ä»‹ç»å¯ä»¥å‚è€ƒ<a href="/singleton.html">å•ä¾‹çš„å‡ ç§å†™æ³•å’Œå¯¹æ¯”</a>ï¼‰:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SingletonTest</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ç§æœ‰åŒ–æ„é€ å‡½æ•°ï¼Œè®©å¤–éƒ¨æ²¡åŠæ³•ç›´æ¥é€šè¿‡newæ¥åˆ›å»º</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">SingletonTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å•ä¾‹å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> SingletonTest instance = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">// é™æ€å·¥å‚æ–¹æ³•</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SingletonTest <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123; <span class="comment">// åŒé‡æ£€æµ‹</span></span><br><span class="line">            <span class="keyword">synchronized</span> (SingletonTest.class) &#123; <span class="comment">// åŒæ­¥é”</span></span><br><span class="line">                <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    instance = <span class="keyword">new</span> SingletonTest();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ä¸Šé¢çš„ä¾‹å­è™½ç„¶åŠ äº†åŒæ­¥é”ï¼Œä½†æ˜¯åœ¨å¤šçº¿ç¨‹ä¸‹å¹¶ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚ç¬¬12è¡Œ<code>instance = new SingletonTest()</code>åœ¨å®é™…æ‰§è¡Œçš„æ—¶å€™ä¼šè¢«æ‹†åˆ†ä¸ºä»¥ä¸‹ä¸‰ä¸ªæ­¥éª¤:</p><ol><li><p>åˆ†é…å­˜å‚¨SingletonTestå¯¹è±¡çš„å†…å­˜ç©ºé—´ï¼›</p></li><li><p>åˆå§‹åŒ–SingletonTestå¯¹è±¡ï¼›</p></li><li><p>å°†instanceæŒ‡å‘åˆšåˆšåˆ†é…çš„å†…å­˜ç©ºé—´ã€‚</p></li></ol><p>é€šè¿‡JMMçš„å­¦ä¹ æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œåœ¨æ‰§è¡Œç¨‹åºæ—¶ï¼Œä¸ºäº†æé«˜æ€§èƒ½ï¼Œç¼–è¯‘å™¨å’Œå¤„ç†å™¨å¸¸å¸¸ä¼šå¯¹æŒ‡ä»¤åšé‡æ’åºï¼Œå› ä¸ºç¬¬2æ­¥å’Œç¬¬3æ­¥å¹¶æ²¡æœ‰ä¾èµ–å…³ç³»ï¼Œæ‰€ä»¥å¯èƒ½å‘ç”Ÿé‡æ’åºï¼Œæ’åºåçš„æ­¥éª¤ä¸ºï¼š</p><ol><li><p>åˆ†é…å­˜å‚¨SingletonTestå¯¹è±¡çš„å†…å­˜ç©ºé—´ï¼›</p></li><li><p>å°†instanceæŒ‡å‘åˆšåˆšåˆ†é…çš„å†…å­˜ç©ºé—´ï¼›</p></li><li><p>åˆå§‹åŒ–SingletonTestå¯¹è±¡ã€‚</p></li></ol><p>ç»è¿‡é‡æ’åºåï¼Œä¸Šé¢çš„ä¾‹å­åœ¨å¤šçº¿ç¨‹ä¸‹å°±ä¼šå‡ºç°é—®é¢˜ã€‚å‡å¦‚ç°åœ¨æœ‰ä¸¤ä¸ªçº¿ç¨‹Aå’ŒBåŒæ—¶è°ƒç”¨SingletonTest#getInstanceï¼Œçº¿ç¨‹Aæ‰§è¡Œåˆ°äº†ä»£ç çš„ç¬¬12è¡Œ<code>instance = new SingletonTest()</code>ï¼Œå·²ç»å®Œæˆäº†å¯¹è±¡å†…å­˜ç©ºé—´çš„åˆ†é…å¹¶å°†instanceæŒ‡å‘äº†è¯¥å†…å­˜ç©ºé—´ï¼Œçº¿ç¨‹Bæ‰§è¡Œåˆ°äº†ç¬¬9è¡Œï¼Œå‘ç°instanceå¹¶ä¸æ˜¯nullï¼ˆå› ä¸ºå·²ç»æŒ‡å‘äº†å†…å­˜ç©ºé—´ï¼‰ï¼Œæ‰€ä»¥å°±ç›´æ¥è¿”å›instanceäº†ã€‚ä½†æ˜¯çº¿ç¨‹Aå¹¶è¿˜æ²¡æœ‰æ‰§è¡Œåˆå§‹åŒ–SingletonTestæ“ä½œï¼Œæ‰€ä»¥å®é™…çº¿ç¨‹Bæ‹¿åˆ°çš„SingletonTestå®ä¾‹æ˜¯ç©ºçš„ï¼Œé‚£ä¹ˆçº¿ç¨‹Båç»­å¯¹SingletonTestæ“æ§å°†æŠ›å‡ºç©ºæŒ‡é’ˆå¼‚å¸¸ã€‚</p><p>è¦è®©ä¸Šé¢çš„ä¾‹å­æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œåªéœ€è¦ç”¨volatileä¿®é¥°å•ä¾‹å¯¹è±¡å³å¯ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SingletonTest</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ç§æœ‰åŒ–æ„é€ å‡½æ•°ï¼Œè®©å¤–éƒ¨æ²¡åŠæ³•ç›´æ¥é€šè¿‡newæ¥åˆ›å»º</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">SingletonTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å•ä¾‹å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">static</span> SingletonTest instance = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">// é™æ€å·¥å‚æ–¹æ³•</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SingletonTest <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123; <span class="comment">// åŒé‡æ£€æµ‹</span></span><br><span class="line">            <span class="keyword">synchronized</span> (SingletonTest.class) &#123; <span class="comment">// åŒæ­¥é”</span></span><br><span class="line">                <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    instance = <span class="keyword">new</span> SingletonTest();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>å› ä¸ºé€šè¿‡volatileä¿®é¥°çš„æˆå‘˜å˜é‡ä¼šæ·»åŠ å†…å­˜å±éšœæ¥é˜»æ­¢JVMè¿›è¡ŒæŒ‡ä»¤é‡æ’ä¼˜åŒ–ã€‚</p><h2 id="çº¿ç¨‹ä¸å®‰å…¨"><a href="#çº¿ç¨‹ä¸å®‰å…¨" class="headerlink" title="çº¿ç¨‹ä¸å®‰å…¨"></a>çº¿ç¨‹ä¸å®‰å…¨</h2><p>ä¸¾ä¸ªé€’å¢çš„ä¾‹å­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VolatileTest2</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">static</span> <span class="keyword">int</span> value;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        Thread thread1 = <span class="keyword">new</span> Thread(() -&gt; IntStream.range(<span class="number">0</span>, <span class="number">500</span>).forEach(i -&gt; value += <span class="number">1</span>));</span><br><span class="line">        Thread thread2 = <span class="keyword">new</span> Thread(() -&gt; IntStream.range(<span class="number">0</span>, <span class="number">500</span>).forEach(i -&gt; value += <span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">        thread1.start();</span><br><span class="line">        thread2.start();</span><br><span class="line">        thread1.join();</span><br><span class="line">        thread2.join();</span><br><span class="line">        System.out.println(value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>å¤šæ¬¡è¿è¡Œä¸Šé¢çš„ä¾‹å­ï¼š</p><p><img src="img/asdfjwqefj.gif" alt="asdfjwqefj.gif"></p><p>å¯ä»¥çœ‹åˆ°æœ€ç»ˆçš„å€¼æœ‰å¯èƒ½å°äº1000ã€‚</p><p>volatileå¯ä»¥ä¿è¯ä¿®æ”¹çš„å€¼èƒ½å¤Ÿé©¬ä¸Šæ›´æ–°åˆ°ä¸»å†…å­˜ï¼Œå…¶ä»–çº¿ç¨‹ä¹Ÿä¼šæ•æ‰åˆ°è¢«ä¿®æ”¹åçš„å€¼ï¼Œé‚£ä¹ˆä¸ºä»€ä¹ˆä¸èƒ½ä¿è¯åŸå­æ€§å‘¢ï¼Ÿ</p><p>å› ä¸ºåœ¨Javaä¸­ï¼Œåªæœ‰å¯¹åŸºæœ¬ç±»å‹çš„èµ‹å€¼å’Œä¿®æ”¹æ‰æ˜¯åŸå­æ€§çš„ï¼Œè€Œå¯¹å…±äº«å˜é‡çš„ä¿®æ”¹å¹¶ä¸æ˜¯åŸå­æ€§çš„ã€‚é€šè¿‡<a href="/Java-Memory-model.html">JMM</a>å†…å­˜äº¤äº’åè®®æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹å…±äº«å˜é‡çš„å€¼éœ€è¦ç»è¿‡ä¸‹é¢è¿™äº›æ­¥éª¤ï¼š</p><ol><li><p>çº¿ç¨‹ä»ä¸»å†…å­˜ä¸­è¯»å–ï¼ˆreadï¼‰å…±äº«å˜é‡çš„å€¼ï¼Œç„¶åè½½å…¥ï¼ˆloadï¼‰åˆ°çº¿ç¨‹çš„å·¥ä½œå†…å­˜ä¸­çš„å˜é‡ï¼›</p></li><li><p>ä½¿ç”¨ï¼ˆuseï¼‰å·¥ä½œå†…å­˜å˜é‡çš„å€¼ï¼Œæ‰§è¡ŒåŠ å‡æ“ä½œï¼Œç„¶åå°†ä¿®æ”¹åçš„å€¼èµ‹å€¼ï¼ˆassignï¼‰ç»™å·¥ä½œå†…å­˜ä¸­çš„å˜é‡ï¼›</p></li><li><p>å°†å·¥ä½œå†…å­˜ä¸­ä¿®æ”¹åçš„å˜é‡çš„å€¼å­˜å‚¨ï¼ˆstoreï¼‰åˆ°ä¸»å†…å­˜ä¸­ï¼Œå¹¶æ‰§è¡Œå†™å…¥ï¼ˆwriteï¼‰æ“ä½œã€‚</p></li></ol><p>æ‰€ä»¥ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œå¯èƒ½å‡ºç°ä¸‹é¢è¿™ç§æƒ…å†µï¼š</p><p>thread1å’Œthread2åŒæ—¶è·å–äº†valueçš„å€¼ï¼Œæ¯”å¦‚ä¸º100ã€‚thread1æ‰§è¡Œäº†+1æ“ä½œï¼Œç„¶åå†™å›ä¸»å†…å­˜ï¼Œè¿™ä¸ªæ—¶å€™thread2åˆšå¥½æ‰§è¡Œå®Œuseæ“ä½œï¼ˆ+1ï¼‰ï¼Œå‡†å¤‡æ‰§è¡Œassignï¼ˆå°†+1åçš„å€¼å†™å›å·¥ä½œå†…å­˜å¯¹åº”çš„å˜é‡ä¸­ï¼‰æ“ä½œã€‚è™½ç„¶è¿™æ—¶å€™thread2å·¥ä½œå†…å­˜ä¸­valueå€¼çš„æ‹·è´æ— æ•ˆäº†ï¼ˆå› ä¸ºvolatileçš„ç‰¹æ€§ï¼‰ï¼Œä½†æ˜¯thread2å·²ç»æ‰§è¡Œå®Œ+1æ“ä½œäº†ï¼Œå®ƒå¹¶ä¸éœ€è¦å†ä»ä¸»å†…å­˜ä¸­è·å–valueçš„å€¼ï¼Œæ‰€ä»¥thread2å¯ä»¥é¡ºåˆ©åœ°å°†+1åçš„å€¼èµ‹å€¼ç»™å·¥ä½œå†…å­˜ä¸­çš„å˜é‡ï¼Œç„¶ååˆ·å›ä¸»å­˜ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆä¸Šé¢çš„ç´¯åŠ ç»“æœå¯èƒ½ä¼šå°äº1000çš„åŸå› ã€‚</p><p>è¦è®©ä¸Šé¢çš„ä¾‹å­æ˜¯çº¿ç¨‹å®‰å…¨çš„è¯å¯ä»¥åŠ åŒæ­¥é”ï¼Œæˆ–è€…ä½¿ç”¨atomicç±»ï¼Œåç»­ä¼šä»‹ç»åˆ°ã€‚</p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Wed May 15 2019 17:13:44 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;volatileå…³é”®å­—ä¿®é¥°çš„æˆå‘˜å˜é‡å…·æœ‰ä¸¤å¤§ç‰¹æ€§ï¼šä¿è¯äº†è¯¥æˆå‘˜å˜é‡åœ¨ä¸åŒçº¿ç¨‹ä¹‹é—´çš„å¯è§æ€§ï¼›ç¦æ­¢å¯¹è¯¥æˆå‘˜å˜é‡è¿›è¡Œé‡æ’åºï¼Œä¹Ÿå°±ä¿è¯äº†å…¶æœ‰åºæ€§ã€‚ä½†æ˜¯volatileä¿®é¥°çš„æˆå‘˜å˜é‡å¹¶ä¸å…·æœ‰åŸå­æ€§ï¼Œåœ¨å¹¶å‘ä¸‹å¯¹å®ƒçš„ä¿®æ”¹æ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ã€‚ä¸‹é¢åˆ†åˆ«ä¸¾ä¾‹æ¥æ¼”ç¤ºè¿™ä¸¤ä¸ªç‰¹æ€§ï¼Œå¹¶ä¸”åˆ†æä¸ºä»€ä¹ˆvolatileä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Java" scheme="http://mrbird.cc/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>JUCä¹‹Exchanger</title>
    <link href="http://mrbird.cc/JUC-Exchanger.html"/>
    <id>http://mrbird.cc/JUC-Exchanger.html</id>
    <published>2019-03-06T08:24:53.000Z</published>
    <updated>2019-05-14T01:46:05.879Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Wed May 15 2019 17:13:43 GMT+0800 (GMT+08:00) --><p>JUCä¸­çš„Exchangerå…è®¸<strong>æˆå¯¹çš„</strong>çº¿ç¨‹åœ¨æŒ‡å®šçš„åŒæ­¥ç‚¹ä¸Šé€šè¿‡<code>exchange</code>æ–¹æ³•æ¥äº¤æ¢æ•°æ®ã€‚å¦‚æœç¬¬ä¸€ä¸ªçº¿ç¨‹å…ˆæ‰§è¡Œ<code>exchange</code>æ–¹æ³•ï¼Œå®ƒä¼šä¸€ç›´ç­‰å¾…ç¬¬äºŒä¸ªçº¿ç¨‹ä¹Ÿ æ‰§è¡Œ<code>exchange</code>æ–¹æ³•ï¼Œå½“ä¸¤ä¸ªçº¿ç¨‹éƒ½åˆ°è¾¾åŒæ­¥ç‚¹æ—¶ï¼Œè¿™ä¸¤ä¸ªçº¿ç¨‹å°±å¯ä»¥äº¤æ¢æ•°æ®ï¼Œå°†å½“å‰çº¿ç¨‹ç”Ÿäº§ å‡ºæ¥çš„æ•°æ®ä¼ é€’ç»™å¯¹æ–¹ã€‚<a id="more"></a></p><h2 id="Exchangerç¤ºä¾‹"><a href="#Exchangerç¤ºä¾‹" class="headerlink" title="Exchangerç¤ºä¾‹"></a>Exchangerç¤ºä¾‹</h2><p>ä¸¤ä¸ªçº¿ç¨‹é€šè¿‡Exchangeräº¤æ¢æ•°æ®çš„ç®€å•ç¤ºä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExchangerTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Exchanger&lt;String&gt; exchanger = <span class="keyword">new</span> Exchanger&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">"thread1å¼€å§‹"</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                String exchange = exchanger.exchange(<span class="string">"æ¥è‡ªthread1çš„æ•°æ®"</span>);</span><br><span class="line">                System.out.println(<span class="string">"æ¥æ”¶thread2å‘é€çš„æ•°æ®ï¼š"</span> + exchange);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">"thread1ç»“æŸ"</span>);</span><br><span class="line">        &#125;, <span class="string">"thread1"</span>).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">"thread2å¼€å§‹"</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                String exchange = exchanger.exchange(<span class="string">"æ¥è‡ªthread2çš„æ•°æ®"</span>);</span><br><span class="line">                System.out.println(<span class="string">"æ¥æ”¶thread1å‘é€çš„æ•°æ®ï¼š"</span> + exchange);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">"thread2ç»“æŸ"</span>);</span><br><span class="line">        &#125;, <span class="string">"thread2"</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>åœ¨å®šä¹‰Exchangerçš„æ—¶å€™éœ€è¦æŒ‡å®šäº¤æ¢çš„æ•°æ®ç±»å‹ï¼Œè¿™é‡Œä¸ºStringç±»å‹ã€‚<code>exchange</code>æ–¹æ³•ç”¨äºå‘å¦ä¸€ä¸ªçº¿ç¨‹å‘é€æ•°æ®ï¼Œæ–¹æ³•çš„è¿”å›å€¼ä¸ºå¦ä¸€ä¸ªçº¿ç¨‹å‘é€è¿‡æ¥çš„æ•°æ®ã€‚ä¸Šé¢ä¾‹å­è¾“å‡ºå¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">thread1å¼€å§‹</span><br><span class="line">thread2å¼€å§‹</span><br><span class="line">æ¥æ”¶thread2å‘é€çš„æ•°æ®ï¼šæ¥è‡ªthread2çš„æ•°æ®</span><br><span class="line">thread1ç»“æŸ</span><br><span class="line">æ¥æ”¶thread1å‘é€çš„æ•°æ®ï¼šæ¥è‡ªthread1çš„æ•°æ®</span><br><span class="line">thread2ç»“æŸ</span><br></pre></td></tr></table></figure><p></p><p>ä¸Šé¢è¯´è¿‡ï¼Œåªæœ‰å½“æˆå¯¹çš„çº¿ç¨‹éƒ½åˆ°è¾¾åŒæ­¥ç‚¹çš„æ—¶å€™ï¼Œæ‰ä¼šæ‰§è¡Œæ•°æ®äº¤æ¢æ“ä½œã€‚ç°åœ¨æˆ‘ä»¬è®©thread2ä¼‘çœ ä¸€ä¼šå„¿ï¼Œçœ‹çœ‹thread1æ˜¯å¦ä¼šè¿›å…¥ç­‰å¾…ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExchangerTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Exchanger&lt;String&gt; exchanger = <span class="keyword">new</span> Exchanger&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">"thread1å¼€å§‹"</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                String exchange = exchanger.exchange(<span class="string">"æ¥è‡ªthread1çš„æ•°æ®"</span>);</span><br><span class="line">                System.out.println(<span class="string">"æ¥æ”¶thread2å‘é€çš„æ•°æ®ï¼š"</span> + exchange);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">"thread1ç»“æŸ"</span>);</span><br><span class="line">        &#125;, <span class="string">"thread1"</span>).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">"thread2å¼€å§‹"</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                TimeUnit.SECONDS.sleep(<span class="number">3</span>); <span class="comment">// thread1ä¹Ÿä¼šè¿›å…¥ç­‰å¾…ï¼Œç›´åˆ°åŒæ–¹éƒ½å‡†å¤‡å¥½äº¤æ¢æ•°æ®ã€‚</span></span><br><span class="line">                String exchange = exchanger.exchange(<span class="string">"æ¥è‡ªthread2çš„æ•°æ®"</span>);</span><br><span class="line">                System.out.println(<span class="string">"æ¥æ”¶thread1å‘é€çš„æ•°æ®ï¼š"</span> + exchange);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">"thread2ç»“æŸ"</span>);</span><br><span class="line">        &#125;, <span class="string">"thread2"</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ç¨‹åºè¾“å‡ºå¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><img src="img/exchanger1.gif" alt="exchanger1.gif"></p><p>é‚£ä¹ˆå¦‚æœçº¿ç¨‹ä¸æˆå¯¹ä¼šå‡ºç°ä»€ä¹ˆæƒ…å†µå‘¢ï¼Ÿæˆ‘ä»¬æ·»åŠ thread3çº¿ç¨‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExchangerTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Exchanger&lt;String&gt; exchanger = <span class="keyword">new</span> Exchanger&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">"thread1å¼€å§‹"</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                String exchange = exchanger.exchange(<span class="string">"å‘é€æ•°æ®-thread1"</span>);</span><br><span class="line">                System.out.println(<span class="string">"æ¥æ”¶æ•°æ®ï¼š"</span> + exchange);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">"thread1ç»“æŸ"</span>);</span><br><span class="line">        &#125;, <span class="string">"thread1"</span>).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">"thread2å¼€å§‹"</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                String exchange = exchanger.exchange(<span class="string">"å‘é€æ•°æ®-thread2"</span>);</span><br><span class="line">                System.out.println(<span class="string">"æ¥æ”¶æ•°æ®ï¼š"</span> + exchange);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">"thread2ç»“æŸ"</span>);</span><br><span class="line">        &#125;, <span class="string">"thread2"</span>).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">"thread3å¼€å§‹"</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                String exchange = exchanger.exchange(<span class="string">"å‘é€æ•°æ®-thread3"</span>);</span><br><span class="line">                System.out.println(<span class="string">"æ¥æ”¶æ•°æ®ï¼š"</span> + exchange);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">"thread3ç»“æŸ"</span>);</span><br><span class="line">        &#125;, <span class="string">"thread3"</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ç¨‹åºè¾“å‡ºå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">thread1å¼€å§‹</span><br><span class="line">thread3å¼€å§‹</span><br><span class="line">æ¥æ”¶æ•°æ®ï¼šå‘é€æ•°æ®-thread1</span><br><span class="line">thread3ç»“æŸ</span><br><span class="line">thread2å¼€å§‹</span><br><span class="line">æ¥æ”¶æ•°æ®ï¼šå‘é€æ•°æ®-thread3</span><br><span class="line">thread1ç»“æŸ</span><br></pre></td></tr></table></figure><p></p><p>å¯çœ‹åˆ°thread1å’Œthread3äº¤æ¢äº†æ•°æ®ç„¶åæ­£å¸¸åœæ­¢äº†ï¼Œè€Œthread2ç”±äºæ²¡æœ‰çº¿ç¨‹å’Œå®ƒäº¤æ¢æ•°æ®è€Œè‹¦è‹¦ç­‰å¾…ï¼Œçº¿ç¨‹æ°¸è¿œä¸ä¼šåœæ­¢ã€‚æŸ¥çœ‹çº¿ç¨‹å¿«ç…§å¯ä»¥è¯æ˜è¿™ç‚¹ï¼š</p><p><img src="img/QQæˆªå›¾20190514092846.png" alt="QQæˆªå›¾20190514092846.png"></p><p>çº¿ç¨‹åŒ¹é…æ˜¯éšæœºçš„ï¼Œæ‰€ä»¥ä¹Ÿæœ‰å¯èƒ½thread1å’Œthread2åŒ¹é…ï¼Œthread3è¿›å…¥æ— ä¼‘æ­¢çš„ç­‰å¾…ï¼Œè¿™å°±ç±»ä¼¼äºâ€¦</p><p><img src="img/QQæˆªå›¾20190514093233.png" alt="QQæˆªå›¾20190514093233.png"></p><p>å¦ä¸€ä¸ªå€¼å¾—ä¸€æçš„ç‚¹å°±æ˜¯é€šè¿‡Exchangeräº¤æ¢çš„æ˜¯åŒä¸€ä¸ªå¯¹è±¡ï¼Œè€Œä¸æ˜¯å¯¹è±¡çš„æ‹·è´ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExchangerTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Exchanger&lt;Object&gt; exchanger = <span class="keyword">new</span> Exchanger&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">"thread1å¼€å§‹"</span>);</span><br><span class="line">            Object object = <span class="keyword">new</span> Object();</span><br><span class="line">            System.out.println(<span class="string">"thread1å‘é€æ•°æ®ï¼š"</span> + object);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Object exchange = exchanger.exchange(object);</span><br><span class="line">                System.out.println(<span class="string">"æ¥æ”¶thread2å‘é€çš„æ•°æ®ï¼š"</span> + exchange);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">"thread1ç»“æŸ"</span>);</span><br><span class="line">        &#125;, <span class="string">"thread1"</span>).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">"thread2å¼€å§‹"</span>);</span><br><span class="line">            Object object = <span class="keyword">new</span> Object();</span><br><span class="line">            System.out.println(<span class="string">"thread2å‘é€æ•°æ®ï¼š"</span> + object);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Object exchange = exchanger.exchange(object);</span><br><span class="line">                System.out.println(<span class="string">"æ¥æ”¶thread1å‘é€çš„æ•°æ®ï¼š"</span> + exchange);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">"thread2ç»“æŸ"</span>);</span><br><span class="line">        &#125;, <span class="string">"thread2"</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ç¨‹åºè¾“å‡ºå¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">thread1å¼€å§‹</span><br><span class="line">thread2å¼€å§‹</span><br><span class="line">thread2å‘é€æ•°æ®ï¼šjava.lang.Object@6d559005</span><br><span class="line">thread1å‘é€æ•°æ®ï¼šjava.lang.Object@7702c19</span><br><span class="line">æ¥æ”¶thread2å‘é€çš„æ•°æ®ï¼šjava.lang.Object@6d559005</span><br><span class="line">æ¥æ”¶thread1å‘é€çš„æ•°æ®ï¼šjava.lang.Object@7702c19</span><br><span class="line">thread2ç»“æŸ</span><br><span class="line">thread1ç»“æŸ</span><br></pre></td></tr></table></figure><p></p><p>å¯ä»¥çœ‹åˆ°thread1å‘é€çš„å¯¹è±¡å’Œthread2æ¥æ”¶çš„å¯¹è±¡å¥æŸ„æ˜¯ä¸€è‡´çš„ã€‚</p><h2 id="è®¾ç½®è¶…æ—¶æ—¶é—´"><a href="#è®¾ç½®è¶…æ—¶æ—¶é—´" class="headerlink" title="è®¾ç½®è¶…æ—¶æ—¶é—´"></a>è®¾ç½®è¶…æ—¶æ—¶é—´</h2><p>å¦‚æœä¸æƒ³çº¿ç¨‹åœ¨äº¤æ¢æ•°æ®çš„æ—¶å€™ç­‰å¾…è¿‡é•¿çš„æ—¶é—´ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>exchanger</code>çš„é‡è½½æ–¹æ³•<code>exchange(V x, long timeout, TimeUnit unit)</code>æ¥æŒ‡å®šè¶…æ—¶æ—¶é—´ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExchangerTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Exchanger&lt;String&gt; exchanger = <span class="keyword">new</span> Exchanger&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">"thread1å¼€å§‹"</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                String exchange = exchanger.exchange(<span class="string">"æ¥è‡ªthread1çš„æ•°æ®"</span>, <span class="number">5</span>, TimeUnit.SECONDS);</span><br><span class="line">                System.out.println(<span class="string">"æ¥æ”¶thread2å‘é€çš„æ•°æ®ï¼š"</span> + exchange);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException | TimeoutException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">"thread1ç»“æŸ"</span>);</span><br><span class="line">        &#125;, <span class="string">"thread1"</span>).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">"thread2å¼€å§‹"</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                TimeUnit.SECONDS.sleep(<span class="number">10</span>);</span><br><span class="line">                String exchange = exchanger.exchange(<span class="string">"æ¥è‡ªthread2çš„æ•°æ®"</span>);</span><br><span class="line">                System.out.println(<span class="string">"æ¥æ”¶thread1å‘é€çš„æ•°æ®ï¼š"</span> + exchange);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">"thread2ç»“æŸ"</span>);</span><br><span class="line">        &#125;, <span class="string">"thread2"</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ä¸Šé¢ä¾‹å­ä¸­ï¼Œthread2ä¼‘çœ 10ç§’åæ‰å¼€å§‹äº¤æ¢æ•°æ®ï¼Œè€Œthread1åœ¨ç­‰å¾…5ç§’åæ²¡èƒ½æˆåŠŸäº¤æ¢æ•°æ®å°±æŠ›å‡º<code>TimeoutException</code>å¼‚å¸¸äº†ã€‚10ç§’åç”±äºæ²¡æœ‰çº¿ç¨‹å†å’Œthread2äº¤æ¢æ•°æ®ï¼Œæ‰€ä»¥thread2ä¼šä¸€ç›´ç­‰å¾…ï¼š</p><p><img src="img/QQæˆªå›¾20190514093752.png" alt="QQæˆªå›¾20190514093752.png"></p><p><img src="img/QQæˆªå›¾20190514093839.png" alt="QQæˆªå›¾20190514093839.png"></p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Wed May 15 2019 17:13:43 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;JUCä¸­çš„Exchangerå…è®¸&lt;strong&gt;æˆå¯¹çš„&lt;/strong&gt;çº¿ç¨‹åœ¨æŒ‡å®šçš„åŒæ­¥ç‚¹ä¸Šé€šè¿‡&lt;code&gt;exchange&lt;/code&gt;æ–¹æ³•æ¥äº¤æ¢æ•°æ®ã€‚å¦‚æœç¬¬ä¸€ä¸ªçº¿ç¨‹å…ˆæ‰§è¡Œ&lt;code&gt;exchange&lt;/code&gt;æ–¹æ³•ï¼Œå®ƒä¼šä¸€ç›´ç­‰å¾…ç¬¬äºŒä¸ªçº¿ç¨‹ä¹Ÿ æ‰§è¡Œ&lt;code&gt;exchange&lt;/code&gt;æ–¹æ³•ï¼Œå½“ä¸¤ä¸ªçº¿ç¨‹éƒ½åˆ°è¾¾åŒæ­¥ç‚¹æ—¶ï¼Œè¿™ä¸¤ä¸ªçº¿ç¨‹å°±å¯ä»¥äº¤æ¢æ•°æ®ï¼Œå°†å½“å‰çº¿ç¨‹ç”Ÿäº§ å‡ºæ¥çš„æ•°æ®ä¼ é€’ç»™å¯¹æ–¹ã€‚
    
    </summary>
    
    
      <category term="Java" scheme="http://mrbird.cc/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>JUCä¹‹CyclicBarrier</title>
    <link href="http://mrbird.cc/JUC-CyclicBarrier.html"/>
    <id>http://mrbird.cc/JUC-CyclicBarrier.html</id>
    <published>2019-03-03T08:23:58.000Z</published>
    <updated>2019-05-13T03:49:51.942Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Wed May 15 2019 17:13:43 GMT+0800 (GMT+08:00) --><p>CyclicBarrierçš„å­—é¢æ„æ€æ˜¯å¯å¾ªç¯ä½¿ç”¨ï¼ˆCyclicï¼‰çš„å±éšœï¼ˆBarrierï¼‰ã€‚å®ƒè¦åšçš„äº‹æƒ…æ˜¯ï¼Œè®©ä¸€ç»„çº¿ç¨‹åˆ°è¾¾ä¸€ä¸ªå±éšœï¼ˆä¹Ÿå¯ä»¥å«åŒæ­¥ç‚¹ï¼‰æ—¶è¢«é˜»å¡ï¼Œç›´åˆ°æœ€åä¸€ä¸ªçº¿ç¨‹åˆ°è¾¾å±éšœæ—¶ï¼Œå±éšœæ‰ä¼šå¼€é—¨ï¼Œæ‰€æœ‰è¢«å±éšœæ‹¦æˆªçš„çº¿ç¨‹æ‰ä¼šç»§ç»­è¿è¡Œã€‚CyclicBarrieré»˜è®¤çš„æ„é€ æ–¹æ³•æ˜¯<code>CyclicBarrier(int parties)</code>ï¼Œå…¶å‚æ•°è¡¨ç¤ºå±éšœæ‹¦æˆªçš„çº¿ç¨‹æ•°é‡ï¼Œæ¯ä¸ªçº¿ç¨‹è°ƒç”¨<code>await</code>æ–¹æ³•å‘Šè¯‰CyclicBarrieræˆ‘å·²ç»åˆ°è¾¾äº†å±éšœï¼Œç„¶åå½“å‰çº¿ç¨‹è¢«é˜»å¡ã€‚</p><a id="more"></a><h2 id="CyclicBarrierç¤ºä¾‹"><a href="#CyclicBarrierç¤ºä¾‹" class="headerlink" title="CyclicBarrierç¤ºä¾‹"></a>CyclicBarrierç¤ºä¾‹</h2><p>ä½¿ç”¨â€œäººæ»¡å‘è½¦â€çš„ä¾‹å­æ¥æ¼”ç¤ºCyclicBarrierï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CyclicBarrierTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        CyclicBarrier barrier = <span class="keyword">new</span> CyclicBarrier(<span class="number">2</span>);</span><br><span class="line">        System.out.println(<span class="string">"å¿«ä¸Šè½¦æ¥ä¸åŠè§£é‡Šäº†"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                TimeUnit.SECONDS.sleep(<span class="number">5</span>);</span><br><span class="line">                System.out.println(Thread.currentThread() + <span class="string">"å·²ä¸Šè½¦"</span>);</span><br><span class="line">                barrier.await();</span><br><span class="line">                System.out.println(<span class="string">"æ‰€æœ‰äººå·²ä¸Šè½¦ï¼Œå‘è½¦"</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException | BrokenBarrierException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">"Jane"</span>).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                TimeUnit.SECONDS.sleep(<span class="number">3</span>);</span><br><span class="line">                System.out.println(Thread.currentThread() + <span class="string">"å·²ä¸Šè½¦"</span>);</span><br><span class="line">                barrier.await();</span><br><span class="line">                System.out.println(<span class="string">"æ‰€æœ‰äººå·²ä¸Šè½¦ï¼Œå‘è½¦"</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException | BrokenBarrierException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">"Mike"</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ä¸Šé¢ä¾‹å­ä¸­æˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªç­‰å¾…2ä¸ªçº¿ç¨‹å®Œæˆçš„CyclicBarrierï¼Œåœ¨ä¸¤ä¸ªçº¿ç¨‹å†…éƒ¨è°ƒç”¨äº†<code>await</code>æ–¹æ³•ï¼Œè®©å…¶é˜»å¡ç­‰å¾…ï¼Œå¹¶å‘ŠçŸ¥CyclicBarrieræˆ‘å·²ç»åˆ°è¾¾å±éšœäº†ã€‚åªæœ‰å½“ä¸¤ä¸ªçº¿ç¨‹éƒ½æ‰§è¡Œåˆ°<code>barrier.await()</code>è¿™ä¸€è¡Œæ—¶ï¼Œå±éšœå¼€å¯ï¼Œçº¿ç¨‹æ‰ä¼šç»§ç»­å¾€ä¸‹æ‰§è¡Œã€‚ç¨‹åºè¾“å‡ºå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">å¿«ä¸Šè½¦æ¥ä¸åŠè§£é‡Šäº†</span><br><span class="line">Thread[Mike,5,main]å·²ä¸Šè½¦</span><br><span class="line">Thread[Jane,5,main]å·²ä¸Šè½¦</span><br><span class="line">æ‰€æœ‰äººå·²ä¸Šè½¦ï¼Œå‘è½¦</span><br><span class="line">æ‰€æœ‰äººå·²ä¸Šè½¦ï¼Œå‘è½¦</span><br></pre></td></tr></table></figure><p></p><p>CyclicBarrierçš„æ„é€ å‡½æ•°æ”¯æŒä¼ å…¥ä¸€ä¸ªå›è°ƒæ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CyclicBarrier barrier = <span class="keyword">new</span> CyclicBarrier(n, () -&gt; &#123;</span><br><span class="line">    System.out.println(<span class="string">"å½“æ‰€æœ‰çº¿ç¨‹åˆ°è¾¾å±éšœæ—¶ï¼Œæ‰§è¡Œè¯¥å›è°ƒ"</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p></p><p>æ”¹é€ ä¸Šé¢çš„ä¾‹å­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CyclicBarrierTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        CyclicBarrier barrier = <span class="keyword">new</span> CyclicBarrier(<span class="number">2</span>, <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">"å‘è½¦ï¼Œå˜Ÿå˜Ÿå˜Ÿ"</span>);</span><br><span class="line">        &#125;));</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"å¿«ä¸Šè½¦æ¥ä¸åŠè§£é‡Šäº†"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                TimeUnit.SECONDS.sleep(<span class="number">5</span>);</span><br><span class="line">                System.out.println(Thread.currentThread() + <span class="string">"å·²ä¸Šè½¦"</span>);</span><br><span class="line">                barrier.await();</span><br><span class="line">                System.out.println(<span class="string">"æ‰€æœ‰äººå·²ä¸Šè½¦"</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException | BrokenBarrierException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">"Jane"</span>).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                TimeUnit.SECONDS.sleep(<span class="number">3</span>);</span><br><span class="line">                System.out.println(Thread.currentThread() + <span class="string">"å·²ä¸Šè½¦"</span>);</span><br><span class="line">                barrier.await();</span><br><span class="line">                System.out.println(<span class="string">"æ‰€æœ‰äººå·²ä¸Šè½¦"</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException | BrokenBarrierException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">"Mike"</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>è¾“å‡ºå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">å¿«ä¸Šè½¦æ¥ä¸åŠè§£é‡Šäº†</span><br><span class="line">Thread[Mike,5,main]å·²ä¸Šè½¦</span><br><span class="line">Thread[Jane,5,main]å·²ä¸Šè½¦</span><br><span class="line">å‘è½¦ï¼Œå˜Ÿå˜Ÿå˜Ÿ</span><br><span class="line">æ‰€æœ‰äººå·²ä¸Šè½¦ï¼Œå‘è½¦</span><br><span class="line">æ‰€æœ‰äººå·²ä¸Šè½¦ï¼Œå‘è½¦</span><br></pre></td></tr></table></figure><p></p><h2 id="è®¾ç½®è¶…æ—¶æ—¶é—´"><a href="#è®¾ç½®è¶…æ—¶æ—¶é—´" class="headerlink" title="è®¾ç½®è¶…æ—¶æ—¶é—´"></a>è®¾ç½®è¶…æ—¶æ—¶é—´</h2><p><code>await</code>çš„é‡è½½æ–¹æ³•ï¼š<code>await(long timeout, TimeUnit unit)</code>å¯ä»¥è®¾ç½®æœ€å¤§ç­‰å¾…æ—¶é•¿ï¼Œè¶…å‡ºè¿™ä¸ªæ—¶é—´å±éšœè¿˜æ²¡æœ‰å¼€å¯çš„è¯åˆ™æŠ›å‡º<code>TimeoutException</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CyclicBarrierTest2</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        CyclicBarrier barrier = <span class="keyword">new</span> CyclicBarrier(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                TimeUnit.SECONDS.sleep(<span class="number">3</span>);</span><br><span class="line">                barrier.await();</span><br><span class="line">                System.out.println(Thread.currentThread() + <span class="string">"ç»§ç»­æ‰§è¡Œ"</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException | BrokenBarrierException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">"thread1"</span>).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                barrier.await(<span class="number">1</span>, TimeUnit.SECONDS);</span><br><span class="line">                System.out.println(Thread.currentThread() + <span class="string">"ç»§ç»­æ‰§è¡Œ"</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException | BrokenBarrierException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (TimeoutException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">"thread2"</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p><img src="img/QQæˆªå›¾20190513104938.png" alt="QQæˆªå›¾20190513104938.png"></p><p><img src="img/QQæˆªå›¾20190513105045.png" alt="QQæˆªå›¾20190513105045.png"></p><h2 id="BrokenBarrierException"><a href="#BrokenBarrierException" class="headerlink" title="BrokenBarrierException"></a>BrokenBarrierException</h2><p>æŠ›å‡º<code>BrokenBarrierException</code>å¼‚å¸¸æ—¶è¡¨ç¤ºå±éšœç ´æŸï¼Œæ­¤æ—¶æ ‡å¿—ä½broken=trueã€‚æŠ›å‡º<code>BrokenBarrierException</code>å¼‚å¸¸çš„æƒ…å†µä¸»è¦æœ‰ï¼š</p><ol><li><p>å…¶ä»–ç­‰å¾…çš„çº¿ç¨‹è¢«ä¸­æ–­ï¼Œåˆ™å½“å‰çº¿ç¨‹æŠ›å‡º<code>BrokenBarrierException</code>å¼‚å¸¸ï¼›</p></li><li><p>å…¶ä»–ç­‰å¾…çš„çº¿ç¨‹è¶…æ—¶ï¼Œåˆ™å½“å‰çº¿ç¨‹æŠ›å‡º<code>BrokenBarrierException</code>å¼‚å¸¸ï¼›</p></li><li><p>å½“å‰çº¿ç¨‹åœ¨ç­‰å¾…æ—¶ï¼Œå…¶ä»–çº¿ç¨‹è°ƒç”¨CyclicBarrier.reset()æ–¹æ³•ï¼Œåˆ™å½“å‰çº¿ç¨‹æŠ›å‡ºBrokenBarrierExceptionå¼‚å¸¸ã€‚</p></li></ol><p>æ¨¡æ‹Ÿç¬¬1ç§æƒ…å†µï¼Œå…¶ä»–ç­‰å¾…çš„çº¿ç¨‹è¢«ä¸­æ–­ï¼Œåˆ™å½“å‰çº¿ç¨‹æŠ›å‡º<code>BrokenBarrierException</code>å¼‚å¸¸ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CyclicBarrierTest2</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        CyclicBarrier barrier = <span class="keyword">new</span> CyclicBarrier(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                System.out.println(Thread.currentThread() + <span class="string">"å¼€å§‹æ‰§è¡Œ"</span>);</span><br><span class="line">                TimeUnit.SECONDS.sleep(<span class="number">3</span>);</span><br><span class="line">                barrier.await();</span><br><span class="line">                System.out.println(Thread.currentThread() + <span class="string">"ç»§ç»­æ‰§è¡Œ"</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException | BrokenBarrierException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">"thread1"</span>).start();</span><br><span class="line"></span><br><span class="line">        Thread thread2 = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                System.out.println(Thread.currentThread() + <span class="string">"å¼€å§‹æ‰§è¡Œ"</span>);</span><br><span class="line">                TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">                barrier.await();</span><br><span class="line">                System.out.println(Thread.currentThread() + <span class="string">"ç»§ç»­æ‰§è¡Œ"</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException | BrokenBarrierException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">"thread2"</span>);</span><br><span class="line"></span><br><span class="line">        thread2.start();</span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">2</span>);</span><br><span class="line">        thread2.interrupt();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>è¾“å‡ºï¼š</p><p><img src="img/QQæˆªå›¾20190513112642.png" alt="QQæˆªå›¾20190513112642.png"></p><p>ä¸Šé¢ä¾‹å­ä¸­thread2çº¿ç¨‹ç¡çœ 1ç§’åå…ˆåˆ°è¾¾å±éšœç‚¹ï¼Œç„¶åè¿›å…¥ç­‰å¾…çŠ¶æ€ã€‚2ç§’åmainçº¿ç¨‹æ‰§è¡Œ<code>thread2.interrupt()</code>ä¸­æ–­ç­‰å¾…ä¸­çš„thread2çº¿ç¨‹ï¼Œæ‰€ä»¥ç¨‹åºæŠ›å‡º<code>BrokenBarrierException</code>å¼‚å¸¸ã€‚3ç§’åthread1çº¿ç¨‹åˆ°è¾¾å±éšœç‚¹ï¼Œæ­¤æ—¶å±éšœå·²ç»è¢«ç ´åäº†ï¼Œæ‰€ä»¥ä¹ŸæŠ›å‡º<code>BrokenBarrierException</code>å¼‚å¸¸ã€‚</p><p>æ¨¡æ‹Ÿç¬¬2é’Ÿæƒ…å†µï¼šå…¶ä»–ç­‰å¾…çš„çº¿ç¨‹è¶…æ—¶ï¼Œåˆ™å½“å‰çº¿ç¨‹æŠ›å‡º<code>BrokenBarrierException</code>å¼‚å¸¸ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CyclicBarrierTest2</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        CyclicBarrier barrier = <span class="keyword">new</span> CyclicBarrier(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                System.out.println(Thread.currentThread() + <span class="string">"å¼€å§‹æ‰§è¡Œ"</span>);</span><br><span class="line">                TimeUnit.SECONDS.sleep(<span class="number">3</span>);</span><br><span class="line">                barrier.await();</span><br><span class="line">                System.out.println(Thread.currentThread() + <span class="string">"ç»§ç»­æ‰§è¡Œ"</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException | BrokenBarrierException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">"thread1"</span>).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                System.out.println(Thread.currentThread() + <span class="string">"å¼€å§‹æ‰§è¡Œ"</span>);</span><br><span class="line">                TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">                barrier.await(<span class="number">1</span>, TimeUnit.SECONDS);</span><br><span class="line">                System.out.println(Thread.currentThread() + <span class="string">"ç»§ç»­æ‰§è¡Œ"</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException | BrokenBarrierException | TimeoutException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">"thread2"</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>è¾“å‡ºï¼š</p><p><img src="img/QQæˆªå›¾20190513113514.png" alt="QQæˆªå›¾20190513113514.png"></p><p>ä¸Šé¢ä¾‹å­ä¸­thread2ç¡çœ 1ç§’ååˆ°è¾¾å±éšœç‚¹ï¼Œç„¶åè¿›å…¥ç­‰å¾…çŠ¶æ€ï¼ˆæœ€å¤šç­‰å¾…1ç§’ï¼‰ï¼Œç„¶è€Œå› ä¸ºthread1è¦3ç§’åæ‰èƒ½åˆ°è¾¾å±éšœç‚¹ï¼Œæ‰€ä»¥thread2å°†æŠ›å‡º<code>TimeoutException</code>ã€‚3ç§’åï¼Œthread1åˆ°è¾¾å±éšœç‚¹ï¼Œä½†è¿™æ—¶å€™ç”±äºthread2çš„<code>await</code>æ–¹æ³•æŠ›å‡ºçš„å¼‚å¸¸ç ´åäº†å±éšœï¼Œæ‰€ä»¥thread1å°†æŠ›å‡º<code>BrokenBarrierException</code>å¼‚å¸¸ã€‚</p><p>æ¨¡æ‹Ÿç¬¬3ä¸­æƒ…å†µï¼šå½“å‰çº¿ç¨‹åœ¨ç­‰å¾…æ—¶ï¼Œå…¶ä»–çº¿ç¨‹è°ƒç”¨CyclicBarrier.reset()æ–¹æ³•ï¼Œåˆ™å½“å‰çº¿ç¨‹æŠ›å‡ºBrokenBarrierExceptionå¼‚å¸¸ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CyclicBarrierTest2</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        CyclicBarrier barrier = <span class="keyword">new</span> CyclicBarrier(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                System.out.println(Thread.currentThread() + <span class="string">"å¼€å§‹æ‰§è¡Œ"</span>);</span><br><span class="line">                TimeUnit.SECONDS.sleep(<span class="number">3</span>);</span><br><span class="line">                barrier.await();</span><br><span class="line">                System.out.println(Thread.currentThread() + <span class="string">"ç»§ç»­æ‰§è¡Œ"</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException | BrokenBarrierException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">"thread1"</span>).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">                System.out.println(Thread.currentThread() + <span class="string">"å¼€å§‹æ‰§è¡Œ"</span>);</span><br><span class="line">                TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">                barrier.await();</span><br><span class="line">                System.out.println(Thread.currentThread() + <span class="string">"ç»§ç»­æ‰§è¡Œ"</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException | BrokenBarrierException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">"thread2"</span>).start();</span><br><span class="line"></span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">2</span>);</span><br><span class="line">        System.out.println(barrier.getNumberWaiting());</span><br><span class="line">        barrier.reset();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>è¾“å‡ºï¼š</p><p><img src="img/QQæˆªå›¾20190513114412.png" alt="QQæˆªå›¾20190513114412.png"></p><p>ä¸Šé¢ä¾‹å­ä¸­ï¼Œthread2ç¡çœ 1ç§’ååˆ°è¾¾å±éšœç‚¹ï¼Œç„¶åè¿›å…¥ç­‰å¾…çŠ¶æ€ã€‚2ç§’åmainçº¿ç¨‹è°ƒç”¨<code>reset</code>æ–¹æ³•é‡ç½®äº†å±éšœï¼Œæ‰€ä»¥åœ¨ç­‰å¾…çŠ¶æ€ä¸­çš„thread2æŠ›å‡º<code>BrokenBarrierException</code>å¼‚å¸¸ã€‚3ç§’åï¼Œthread1åˆ°è¾¾å±éšœç‚¹ï¼Œç”±äº<code>reset</code>æ–¹æ³•é‡ç½®äº†å±éšœï¼Œæ‰€ä»¥thread1å¹¶ä¸ä¼šæŠ›å‡º<code>BrokenBarrierException</code>å¼‚å¸¸ï¼Œè€Œæ˜¯ä¸€ç›´åœ¨å±éšœç‚¹è¿›è¡Œç­‰å¾…åˆ«çš„çº¿ç¨‹åˆ°è¾¾å±éšœç‚¹ã€‚</p><p><strong>ä»ä¸Šé¢çš„ä¸‰ä¸ªä¾‹å­ä¸­å¯ä»¥çœ‹åˆ°ï¼Œæ— è®ºæ˜¯å“ªç§æƒ…å†µå¯¼è‡´å±éšœç ´åï¼Œå±éšœç‚¹åé¢çš„ä»£ç éƒ½æ²¡æœ‰è¢«æ‰§è¡Œï¼Œmainæ–¹æ³•ä¹Ÿæ²¡æœ‰é€€å‡ºã€‚</strong></p><h2 id="å’ŒCountDownLatchåŒºåˆ«"><a href="#å’ŒCountDownLatchåŒºåˆ«" class="headerlink" title="å’ŒCountDownLatchåŒºåˆ«"></a>å’ŒCountDownLatchåŒºåˆ«</h2><ol><li><p>CountDownLatchï¼šä¸€ä¸ªçº¿ç¨‹(æˆ–è€…å¤šä¸ª)ï¼Œç­‰å¾…å¦å¤–Nä¸ªçº¿ç¨‹å®ŒæˆæŸä¸ªäº‹æƒ…ä¹‹åæ‰èƒ½æ‰§è¡Œï¼›CyclicBarrierï¼šNä¸ªçº¿ç¨‹ç›¸äº’ç­‰å¾…ï¼Œä»»ä½•ä¸€ä¸ªçº¿ç¨‹å®Œæˆä¹‹å‰ï¼Œæ‰€æœ‰çš„çº¿ç¨‹éƒ½å¿…é¡»ç­‰å¾…ã€‚</p></li><li><p>CountDownLatchï¼šä¸€æ¬¡æ€§çš„ï¼›CyclicBarrierï¼šå¯ä»¥é‡å¤ä½¿ç”¨ã€‚</p></li></ol><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Wed May 15 2019 17:13:43 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;CyclicBarrierçš„å­—é¢æ„æ€æ˜¯å¯å¾ªç¯ä½¿ç”¨ï¼ˆCyclicï¼‰çš„å±éšœï¼ˆBarrierï¼‰ã€‚å®ƒè¦åšçš„äº‹æƒ…æ˜¯ï¼Œè®©ä¸€ç»„çº¿ç¨‹åˆ°è¾¾ä¸€ä¸ªå±éšœï¼ˆä¹Ÿå¯ä»¥å«åŒæ­¥ç‚¹ï¼‰æ—¶è¢«é˜»å¡ï¼Œç›´åˆ°æœ€åä¸€ä¸ªçº¿ç¨‹åˆ°è¾¾å±éšœæ—¶ï¼Œå±éšœæ‰ä¼šå¼€é—¨ï¼Œæ‰€æœ‰è¢«å±éšœæ‹¦æˆªçš„çº¿ç¨‹æ‰ä¼šç»§ç»­è¿è¡Œã€‚CyclicBarrieré»˜è®¤çš„æ„é€ æ–¹æ³•æ˜¯&lt;code&gt;CyclicBarrier(int parties)&lt;/code&gt;ï¼Œå…¶å‚æ•°è¡¨ç¤ºå±éšœæ‹¦æˆªçš„çº¿ç¨‹æ•°é‡ï¼Œæ¯ä¸ªçº¿ç¨‹è°ƒç”¨&lt;code&gt;await&lt;/code&gt;æ–¹æ³•å‘Šè¯‰CyclicBarrieræˆ‘å·²ç»åˆ°è¾¾äº†å±éšœï¼Œç„¶åå½“å‰çº¿ç¨‹è¢«é˜»å¡ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Java" scheme="http://mrbird.cc/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>JUCä¹‹CountDownLatch</title>
    <link href="http://mrbird.cc/JUC-CountDownLatch.html"/>
    <id>http://mrbird.cc/JUC-CountDownLatch.html</id>
    <published>2019-02-28T08:23:26.000Z</published>
    <updated>2019-05-13T01:31:40.143Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Wed May 15 2019 17:13:42 GMT+0800 (GMT+08:00) --><p>CountDownLatchå…è®¸ä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹ç­‰å¾…å…¶ä»–çº¿ç¨‹å®Œæˆæ“ä½œã€‚å®šä¹‰CountDownLatchçš„æ—¶å€™ï¼Œéœ€è¦ä¼ å…¥ä¸€ä¸ªæ­£æ•°æ¥åˆå§‹åŒ–è®¡æ•°å™¨ï¼ˆè™½ç„¶ä¼ å…¥0ä¹Ÿå¯ä»¥ï¼Œä½†è¿™æ ·çš„è¯CountDownLatchæ²¡ä»€ä¹ˆå®é™…æ„ä¹‰ï¼‰ã€‚å…¶<code>countDown</code>æ–¹æ³•ç”¨äºé€’å‡è®¡æ•°å™¨ï¼Œ<code>await</code>æ–¹æ³•ä¼šä½¿å½“å‰çº¿ç¨‹é˜»å¡ï¼Œç›´åˆ°è®¡æ•°å™¨é€’å‡ä¸º0ã€‚æ‰€ä»¥CountDownLatchå¸¸ç”¨äºå¤šä¸ªçº¿ç¨‹ä¹‹é—´çš„åè°ƒå·¥ä½œã€‚<a id="more"></a></p><h2 id="CountDownLatchç¤ºä¾‹"><a href="#CountDownLatchç¤ºä¾‹" class="headerlink" title="CountDownLatchç¤ºä¾‹"></a>CountDownLatchç¤ºä¾‹</h2><p>å‡è®¾æˆ‘ä»¬ç°åœ¨æœ‰è¿™æ ·ä¸€ä¸ªéœ€æ±‚ï¼š</p><ol><li><p>ä»æ•°æ®åº“è·å–æ•°æ®</p></li><li><p>å¯¹è¿™æ‰¹æ•°æ®è¿›è¡Œå¤„ç†</p></li><li><p>ä¿å­˜è¿™æ‰¹æ•°æ®</p></li></ol><p>ä¸ºäº†è®©ç¨‹åºæ‰§è¡Œæ•ˆç‡æ›´é«˜ï¼Œç¬¬2æ­¥ä¸­æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¤šçº¿ç¨‹æ¥å¹¶è¡Œå¤„ç†è¿™æ‰¹æ•°æ®ï¼Œå¤§è‡´è¿‡ç¨‹å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CountDownLatchTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="comment">// 1. æ¨¡æ‹Ÿä»æ•°æ®åº“è·å–æ•°æ®</span></span><br><span class="line">        <span class="keyword">int</span>[] data = query();</span><br><span class="line">        System.out.println(<span class="string">"è·å–æ•°æ®å®Œæ¯•"</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. æ•°æ®å¤„ç†</span></span><br><span class="line">        IntStream.range(<span class="number">0</span>, data.length).forEach(i -&gt; &#123;</span><br><span class="line">            ExecutorService.execute(() -&gt; &#123;</span><br><span class="line">                System.out.println(Thread.currentThread() + <span class="string">"å¤„ç†ç¬¬"</span> + (i + <span class="number">1</span>) + <span class="string">"æ¡æ•°æ®"</span>);</span><br><span class="line">                <span class="keyword">int</span> value = data[i];</span><br><span class="line">                <span class="keyword">if</span> (value % <span class="number">2</span> == <span class="number">0</span>) &#123;</span><br><span class="line">                    data[i] = value * <span class="number">2</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    data[i] = value * <span class="number">10</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"æ‰€æœ‰æ•°æ®éƒ½å¤„ç†å®Œäº†"</span>);</span><br><span class="line">        <span class="comment">// å…³é—­çº¿ç¨‹æ± </span></span><br><span class="line">        ExecutorService.shutdown();</span><br><span class="line">        <span class="comment">// 3. ä¿å­˜æ•°æ®</span></span><br><span class="line">        save(data);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span>[] query() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="keyword">int</span>[]&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">10</span>&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">save</span><span class="params">(<span class="keyword">int</span>[] data)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"ä¿å­˜æ•°æ® - "</span> + Arrays.toString(data));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ç”±äºçº¿ç¨‹è·å–CPUæ—¶é—´ç‰‡çš„ä¸ç¡®å®šæ€§ï¼Œæ‰€ä»¥æœ‰å¯èƒ½æ•°æ®è¿˜æ²¡æœ‰å¤„ç†å®Œæ¯•ï¼Œç¬¬3æ­¥å°±æ‰§è¡Œå®Œäº†ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">è·å–æ•°æ®å®Œæ¯•</span><br><span class="line">æ‰€æœ‰æ•°æ®éƒ½å¤„ç†å®Œäº†</span><br><span class="line">ä¿å­˜æ•°æ® - [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]</span><br><span class="line">Thread[pool-1-thread-2,5,main]å¤„ç†ç¬¬2æ¡æ•°æ®</span><br><span class="line">Thread[pool-1-thread-1,5,main]å¤„ç†ç¬¬1æ¡æ•°æ®</span><br><span class="line">Thread[pool-1-thread-2,5,main]å¤„ç†ç¬¬3æ¡æ•°æ®</span><br><span class="line">Thread[pool-1-thread-1,5,main]å¤„ç†ç¬¬4æ¡æ•°æ®</span><br><span class="line">Thread[pool-1-thread-1,5,main]å¤„ç†ç¬¬6æ¡æ•°æ®</span><br><span class="line">Thread[pool-1-thread-2,5,main]å¤„ç†ç¬¬5æ¡æ•°æ®</span><br><span class="line">Thread[pool-1-thread-1,5,main]å¤„ç†ç¬¬7æ¡æ•°æ®</span><br><span class="line">Thread[pool-1-thread-1,5,main]å¤„ç†ç¬¬9æ¡æ•°æ®</span><br><span class="line">Thread[pool-1-thread-2,5,main]å¤„ç†ç¬¬8æ¡æ•°æ®</span><br><span class="line">Thread[pool-1-thread-1,5,main]å¤„ç†ç¬¬10æ¡æ•°æ®</span><br></pre></td></tr></table></figure><p></p><p>æˆ‘ä»¬å¯ä»¥å€ŸåŠ©CountDownLatchè§£å†³è¿™ä¸ªé—®é¢˜ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CountDownLatchTest</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ExecutorService ExecutorService = Executors.newFixedThreadPool(<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> CountDownLatch latch = <span class="keyword">new</span> CountDownLatch(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="comment">// 1. æ¨¡æ‹Ÿä»æ•°æ®åº“è·å–æ•°æ®</span></span><br><span class="line">        <span class="keyword">int</span>[] data = query();</span><br><span class="line">        System.out.println(<span class="string">"è·å–æ•°æ®å®Œæ¯•"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. æ•°æ®å¤„ç†</span></span><br><span class="line">        IntStream.range(<span class="number">0</span>, data.length).forEach(i -&gt; &#123;</span><br><span class="line">            ExecutorService.execute(() -&gt; &#123;</span><br><span class="line">                System.out.println(Thread.currentThread() + <span class="string">"å¤„ç†ç¬¬"</span> + (i + <span class="number">1</span>) + <span class="string">"æ¡æ•°æ®"</span>);</span><br><span class="line">                <span class="keyword">int</span> value = data[i];</span><br><span class="line">                <span class="keyword">if</span> (value % <span class="number">2</span> == <span class="number">0</span>) &#123;</span><br><span class="line">                    data[i] = value * <span class="number">2</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    data[i] = value * <span class="number">10</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                latch.countDown();</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        latch.await();</span><br><span class="line">        System.out.println(<span class="string">"æ‰€æœ‰æ•°æ®éƒ½å¤„ç†å®Œäº†"</span>);</span><br><span class="line">        <span class="comment">// å…³é—­çº¿ç¨‹æ± </span></span><br><span class="line">        ExecutorService.shutdown();</span><br><span class="line">        <span class="comment">// 3. ä¿å­˜æ•°æ®</span></span><br><span class="line">        save(data);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span>[] query() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="keyword">int</span>[]&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">10</span>&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">save</span><span class="params">(<span class="keyword">int</span>[] data)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"ä¿å­˜æ•°æ® - "</span> + Arrays.toString(data));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>æˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªCountDownLatchï¼Œè®¡æ•°å™¨å€¼ä¸º10ï¼Œå’Œæ•°æ®é‡ä¸€è‡´ã€‚ç„¶ååœ¨ç¬¬2æ­¥ä¸­ï¼Œå½“æ¯ä¸ªçº¿ç¨‹æ‰§è¡Œå®Œæ¯•çš„æ—¶å€™è°ƒç”¨<code>countDown</code>æ–¹æ³•ï¼Œè®©è®¡æ•°å™¨å‡1ã€‚åœ¨ç¬¬3æ­¥å‰è°ƒç”¨<code>await</code>æ–¹æ³•è®©mainçº¿ç¨‹é˜»å¡ç­‰å¾…ï¼Œç›´åˆ°è®¡æ•°å™¨è¢«å‡ä¸º0ã€‚æ‰€ä»¥è¿™å°±ä¿è¯äº†åªæœ‰å½“æ‰€æœ‰æ•°æ®åŠ å·¥å®Œæ¯•æ‰æ‰§è¡Œä¿å­˜æ•°æ®æ“ä½œã€‚</p><p>æ‰§è¡Œæ–¹æ³•ï¼Œç¨‹åºè¾“å‡ºå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">è·å–æ•°æ®å®Œæ¯•</span><br><span class="line">Thread[pool-1-thread-1,5,main]å¤„ç†ç¬¬1æ¡æ•°æ®</span><br><span class="line">Thread[pool-1-thread-1,5,main]å¤„ç†ç¬¬3æ¡æ•°æ®</span><br><span class="line">Thread[pool-1-thread-1,5,main]å¤„ç†ç¬¬4æ¡æ•°æ®</span><br><span class="line">Thread[pool-1-thread-1,5,main]å¤„ç†ç¬¬5æ¡æ•°æ®</span><br><span class="line">Thread[pool-1-thread-1,5,main]å¤„ç†ç¬¬6æ¡æ•°æ®</span><br><span class="line">Thread[pool-1-thread-1,5,main]å¤„ç†ç¬¬7æ¡æ•°æ®</span><br><span class="line">Thread[pool-1-thread-1,5,main]å¤„ç†ç¬¬8æ¡æ•°æ®</span><br><span class="line">Thread[pool-1-thread-1,5,main]å¤„ç†ç¬¬9æ¡æ•°æ®</span><br><span class="line">Thread[pool-1-thread-1,5,main]å¤„ç†ç¬¬10æ¡æ•°æ®</span><br><span class="line">Thread[pool-1-thread-2,5,main]å¤„ç†ç¬¬2æ¡æ•°æ®</span><br><span class="line">æ‰€æœ‰æ•°æ®éƒ½å¤„ç†å®Œäº†</span><br><span class="line">ä¿å­˜æ•°æ® - [10, 4, 30, 8, 50, 12, 70, 16, 90, 20]</span><br></pre></td></tr></table></figure><p></p><p><code>await</code>æœ‰é‡è½½æ–¹æ³•ï¼š<code>await(long timeout, TimeUnit unit)</code>ï¼Œè®¾ç½®æœ€å¤§ç­‰å¾…æ—¶é—´ï¼Œè¶…è¿‡è¿™ä¸ªæ—¶é—´ç¨‹åºå°†ç»§ç»­æ‰§è¡Œä¸å†è¢«é˜»å¡ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CountDownLatchTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> CountDownLatch latch = <span class="keyword">new</span> CountDownLatch(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                TimeUnit.SECONDS.sleep(<span class="number">4</span>);</span><br><span class="line">                System.out.println(Thread.currentThread() + <span class="string">"çº¿ç¨‹æ‰§è¡Œå®Œæ¯•"</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                latch.countDown();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">"thread1"</span>).start();</span><br><span class="line"> </span><br><span class="line">        latch.await(<span class="number">3</span>, TimeUnit.SECONDS); <span class="comment">// æœ€å¤šç­‰å¾… 3ç§’</span></span><br><span class="line">        System.out.println(<span class="string">"mainçº¿ç¨‹æ‰§è¡Œå®Œæ¯•"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºå¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mainçº¿ç¨‹æ‰§è¡Œå®Œæ¯•</span><br><span class="line">Thread[thread1,5,main]çº¿ç¨‹æ‰§è¡Œå®Œæ¯•</span><br></pre></td></tr></table></figure><p></p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Wed May 15 2019 17:13:42 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;CountDownLatchå…è®¸ä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹ç­‰å¾…å…¶ä»–çº¿ç¨‹å®Œæˆæ“ä½œã€‚å®šä¹‰CountDownLatchçš„æ—¶å€™ï¼Œéœ€è¦ä¼ å…¥ä¸€ä¸ªæ­£æ•°æ¥åˆå§‹åŒ–è®¡æ•°å™¨ï¼ˆè™½ç„¶ä¼ å…¥0ä¹Ÿå¯ä»¥ï¼Œä½†è¿™æ ·çš„è¯CountDownLatchæ²¡ä»€ä¹ˆå®é™…æ„ä¹‰ï¼‰ã€‚å…¶&lt;code&gt;countDown&lt;/code&gt;æ–¹æ³•ç”¨äºé€’å‡è®¡æ•°å™¨ï¼Œ&lt;code&gt;await&lt;/code&gt;æ–¹æ³•ä¼šä½¿å½“å‰çº¿ç¨‹é˜»å¡ï¼Œç›´åˆ°è®¡æ•°å™¨é€’å‡ä¸º0ã€‚æ‰€ä»¥CountDownLatchå¸¸ç”¨äºå¤šä¸ªçº¿ç¨‹ä¹‹é—´çš„åè°ƒå·¥ä½œã€‚
    
    </summary>
    
    
      <category term="Java" scheme="http://mrbird.cc/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>Java å†…å­˜æ¨¡å‹</title>
    <link href="http://mrbird.cc/Java-Memory-model.html"/>
    <id>http://mrbird.cc/Java-Memory-model.html</id>
    <published>2019-02-25T07:15:03.000Z</published>
    <updated>2019-05-13T08:37:18.367Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Wed May 15 2019 17:13:42 GMT+0800 (GMT+08:00) --><p>ç†è§£Javaå†…å­˜æ¨¡å‹æ˜¯æ·±å…¥å­¦ä¹ Javaå¹¶å‘ä¸å¯æˆ–ç¼ºçš„éƒ¨åˆ†ã€‚Javaå†…å­˜æ¨¡å‹å³Java Memory Modelï¼Œç®€ç§°ä¸ºJMMï¼Œå®šä¹‰äº†å¤šçº¿ç¨‹ä¹‹é—´å…±äº«å˜é‡çš„å¯è§æ€§ä»¥åŠå¦‚ä½•åœ¨éœ€è¦çš„æ—¶å€™å¯¹å…±äº«å˜é‡è¿›è¡ŒåŒæ­¥ã€‚</p><p>JMMè§„å®šJavaçº¿ç¨‹é—´çš„é€šä¿¡é‡‡ç”¨å…±äº«å†…å­˜çš„æ–¹å¼ã€‚åœ¨Javaä¸­ï¼Œæ‰€æœ‰æˆå‘˜å˜é‡ã€é™æ€å˜é‡å’Œæ•°ç»„å…ƒç´ éƒ½å­˜å‚¨åœ¨å †å†…å­˜ä¸­ï¼Œå †å†…å­˜åœ¨çº¿ç¨‹ä¹‹é—´å…±äº«ï¼Œæ‰€ä»¥å®ƒä»¬é€šå¸¸ä¹Ÿç§°ä¸ºå…±äº«å˜é‡ã€‚JMMå®šä¹‰äº†çº¿ç¨‹å’Œä¸»å†…å­˜ä¹‹é—´çš„æŠ½ è±¡å…³ç³»ï¼šçº¿ç¨‹ä¹‹é—´çš„å…±äº«å˜é‡å­˜å‚¨åœ¨ä¸»å†…å­˜ï¼ˆMain Memoryï¼‰ä¸­ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ªç§æœ‰çš„æœ¬åœ°å†…å­˜ï¼ˆLocal Memoryï¼Œæˆ–è€…ä¹Ÿå¯ä»¥ç§°ä¸ºå·¥ä½œå†…å­˜ Work Memoryï¼‰ï¼Œæœ¬åœ°å†…å­˜ä¸­å­˜å‚¨äº†è¯¥çº¿ç¨‹ä»¥è¯»/å†™å…±äº«å˜é‡çš„å‰¯æœ¬ã€‚æœ¬åœ°å†…å­˜æ˜¯JMMçš„ä¸€ä¸ªæŠ½è±¡æ¦‚å¿µï¼Œå¹¶ä¸çœŸå®å­˜åœ¨ã€‚å®ƒæ¶µç›–äº†ç¼“å­˜ã€å†™ç¼“å†²åŒºã€å¯„å­˜å™¨ä»¥åŠå…¶ä»–çš„ç¡¬ä»¶å’Œç¼–è¯‘å™¨ä¼˜åŒ–ã€‚</p><a id="more"></a><h2 id="JMMæŠ½è±¡"><a href="#JMMæŠ½è±¡" class="headerlink" title="JMMæŠ½è±¡"></a>JMMæŠ½è±¡</h2><p>JMMçš„æŠ½è±¡ç¤ºæ„å›¾å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><img src="img/QQæˆªå›¾20190513142140.png" alt="QQæˆªå›¾20190513142140.png"></p><p>å¤šä¸ªçº¿ç¨‹åŒæ—¶å¯¹åŒä¸€ä¸ªå…±äº«å˜é‡è¿›è¡Œè¯»å†™çš„æ—¶å€™ä¼šäº§ç”Ÿçº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚é‚£ä¸ºä»€ä¹ˆCPUä¸ç›´æ¥æ“ä½œå†…å­˜ï¼Œè€Œè¦åœ¨CPUå’Œå†…å­˜é—´åŠ ä¸Šå„ç§ç¼“å­˜å’Œå¯„å­˜å™¨ç­‰ç¼“å†²åŒºå‘¢ï¼Ÿå› ä¸ºCPUçš„è¿ç®—é€Ÿåº¦è¦æ¯”å†…å­˜çš„è¯»å†™é€Ÿåº¦å¿«å¾—å¤šï¼Œå¦‚æœCPUç›´æ¥æ“ä½œå†…å­˜çš„è¯åŠ¿å¿…ä¼šèŠ±è´¹å¾ˆé•¿æ—¶é—´ç­‰å¾…æ•°æ®åˆ°æ¥ï¼Œæ‰€ä»¥ç¼“å­˜çš„å‡ºç°ä¸»è¦æ˜¯ä¸ºäº†è§£å†³CPUè¿ç®—é€Ÿåº¦ä¸å†…å­˜è¯»å†™é€Ÿåº¦ä¸åŒ¹é…çš„çŸ›ç›¾ã€‚</p><h2 id="å†…å­˜é—´äº¤äº’åè®®"><a href="#å†…å­˜é—´äº¤äº’åè®®" class="headerlink" title="å†…å­˜é—´äº¤äº’åè®®"></a>å†…å­˜é—´äº¤äº’åè®®</h2><p>JMMè§„å®šäº†ä¸»å†…å­˜å’Œå·¥ä½œå†…å­˜é—´å…·ä½“çš„äº¤äº’åè®®ï¼Œå³ä¸€ä¸ªå˜é‡å¦‚ä½•ä»ä¸»å†…å­˜æ‹·è´åˆ°å·¥ä½œå†…å­˜ã€å¦‚ä½•ä»å·¥ä½œå†…å­˜åŒæ­¥åˆ°ä¸»å†…å­˜ä¹‹é—´çš„å®ç°ç»†èŠ‚ï¼Œè¿™ä¸»è¦åŒ…å«äº†ä¸‹é¢8ä¸ªæ­¥éª¤ï¼š</p><p><img src="img/QQæˆªå›¾20190513144649.png" alt="QQæˆªå›¾20190513144649.png"></p><ul><li><p>lockï¼ˆé”å®šï¼‰ï¼šä½œç”¨äºä¸»å†…å­˜çš„å˜é‡ï¼ŒæŠŠä¸€ä¸ªå˜é‡æ ‡è¯†ä¸ºä¸€æ¡çº¿ç¨‹ç‹¬å çŠ¶æ€ã€‚</p></li><li><p>unlockï¼ˆè§£é”ï¼‰ï¼šä½œç”¨äºä¸»å†…å­˜å˜é‡ï¼ŒæŠŠä¸€ä¸ªå¤„äºé”å®šçŠ¶æ€çš„å˜é‡é‡Šæ”¾å‡ºæ¥ï¼Œé‡Šæ”¾åçš„å˜é‡æ‰å¯ä»¥è¢«å…¶ä»–çº¿ç¨‹é”å®šã€‚</p></li><li><p>readï¼ˆè¯»å–ï¼‰ï¼šä½œç”¨äºä¸»å†…å­˜å˜é‡ï¼ŒæŠŠä¸€ä¸ªå˜é‡å€¼ä»ä¸»å†…å­˜ä¼ è¾“åˆ°çº¿ç¨‹çš„å·¥ä½œå†…å­˜ä¸­ï¼Œä»¥ä¾¿éšåçš„loadåŠ¨ä½œä½¿ç”¨</p></li><li><p>loadï¼ˆè½½å…¥ï¼‰ï¼šä½œç”¨äºå·¥ä½œå†…å­˜çš„å˜é‡ï¼Œå®ƒæŠŠreadæ“ä½œä»ä¸»å†…å­˜ä¸­å¾—åˆ°çš„å˜é‡å€¼æ”¾å…¥å·¥ä½œå†…å­˜çš„å˜é‡å‰¯æœ¬ä¸­ã€‚</p></li><li><p>useï¼ˆä½¿ç”¨ï¼‰ï¼šä½œç”¨äºå·¥ä½œå†…å­˜çš„å˜é‡ï¼ŒæŠŠå·¥ä½œå†…å­˜ä¸­çš„ä¸€ä¸ªå˜é‡å€¼ä¼ é€’ç»™æ‰§è¡Œå¼•æ“ï¼Œæ¯å½“è™šæ‹Ÿæœºé‡åˆ°ä¸€ä¸ªéœ€è¦ä½¿ç”¨å˜é‡çš„å€¼çš„å­—èŠ‚ç æŒ‡ä»¤æ—¶å°†ä¼šæ‰§è¡Œè¿™ä¸ªæ“ä½œã€‚</p></li><li><p>assignï¼ˆèµ‹å€¼ï¼‰ï¼šä½œç”¨äºå·¥ä½œå†…å­˜çš„å˜é‡ï¼Œå®ƒæŠŠä¸€ä¸ªä»æ‰§è¡Œå¼•æ“æ¥æ”¶åˆ°çš„å€¼èµ‹å€¼ç»™å·¥ä½œå†…å­˜çš„å˜é‡ï¼Œæ¯å½“è™šæ‹Ÿæœºé‡åˆ°ä¸€ä¸ªç»™å˜é‡èµ‹å€¼çš„å­—èŠ‚ç æŒ‡ä»¤æ—¶æ‰§è¡Œè¿™ä¸ªæ“ä½œã€‚</p></li><li><p>storeï¼ˆå­˜å‚¨ï¼‰ï¼šä½œç”¨äºå·¥ä½œå†…å­˜çš„å˜é‡ï¼ŒæŠŠå·¥ä½œå†…å­˜ä¸­çš„ä¸€ä¸ªå˜é‡çš„å€¼ä¼ é€åˆ°ä¸»å†…å­˜ä¸­ï¼Œä»¥ä¾¿éšåçš„writeçš„æ“ä½œã€‚</p></li><li><p>writeï¼ˆå†™å…¥ï¼‰ï¼šä½œç”¨äºä¸»å†…å­˜çš„å˜é‡ï¼Œå®ƒæŠŠstoreæ“ä½œä»å·¥ä½œå†…å­˜ä¸­ä¸€ä¸ªå˜é‡çš„å€¼ä¼ é€åˆ°ä¸»å†…å­˜çš„å˜é‡ä¸­ã€‚</p></li></ul><p>è¿™8ä¸ªæ­¥éª¤å¿…é¡»ç¬¦åˆä¸‹è¿°è§„åˆ™ï¼š</p><ol><li><p>ä¸å…è®¸readå’Œloadï¼Œstoreå’Œwriteæ“ä½œä¹‹ä¸€å•ç‹¬å‡ºç°ã€‚</p></li><li><p>ä¸å…è®¸ä¸€ä¸ªçº¿ç¨‹ä¸¢å¼ƒå®ƒæœ€è¿‘çš„assignæ“ä½œã€‚å³å˜é‡åœ¨å·¥ä½œå†…å­˜ä¸­æ”¹å˜äº†è´¦å·å¿…é¡»æŠŠå˜åŒ–åŒæ­¥å›ä¸»å†…å­˜</p></li><li><p>ä¸€ä¸ªæ–°çš„å˜é‡åªå…è®¸åœ¨ä¸»å†…å­˜ä¸­è¯ç”Ÿï¼Œä¸å…è®¸å·¥ä½œå†…å­˜ç›´æ¥ä½¿ç”¨æœªåˆå§‹åŒ–çš„å˜é‡ã€‚</p></li><li><p>ä¸€ä¸ªå˜é‡åŒä¸€æ—¶åˆ»åªå…è®¸ä¸€æ¡çº¿ç¨‹è¿›è¡Œlockæ“ä½œï¼Œä½†åŒä¸€çº¿ç¨‹å¯ä»¥lockå¤šæ¬¡ï¼Œlockå¤šæ¬¡ä¹‹åå¿…é¡»æ‰§è¡ŒåŒæ ·æ¬¡æ•°çš„unlockæ“ä½œ</p></li><li><p>å¦‚æœå¯¹ä¸€ä¸ªå˜é‡è¿›è¡Œlockæ“ä½œï¼Œé‚£ä¹ˆå°†ä¼šæ¸…ç©ºå·¥ä½œå†…å­˜ä¸­æ­¤å˜é‡çš„å€¼ã€‚</p></li><li><p>ä¸å…è®¸å¯¹æœªlockçš„å˜é‡è¿›è¡Œunlockæ“ä½œï¼Œä¹Ÿä¸å…è®¸unlockä¸€ä¸ªè¢«å…¶å®ƒçº¿ç¨‹lockçš„å˜é‡</p></li><li><p>å¦‚æœä¸€ä¸ªå˜é‡æ‰§è¡Œunlockæ“ä½œï¼Œå¿…é¡»å…ˆæŠŠæ­¤å˜é‡åŒæ­¥å›ä¸»å†…å­˜ä¸­ã€‚</p></li></ol><h2 id="æŒ‡ä»¤é‡æ’"><a href="#æŒ‡ä»¤é‡æ’" class="headerlink" title="æŒ‡ä»¤é‡æ’"></a>æŒ‡ä»¤é‡æ’</h2><p>åœ¨æ‰§è¡Œç¨‹åºæ—¶ï¼Œä¸ºäº†æé«˜æ€§èƒ½ï¼Œç¼–è¯‘å™¨å’Œå¤„ç†å™¨å¸¸å¸¸ä¼šå¯¹æŒ‡ä»¤åšé‡æ’åºã€‚ä»Javaæºä»£ç åˆ°æœ€ç»ˆå®é™…æ‰§è¡Œçš„æŒ‡ä»¤åºåˆ—ï¼Œä¼šåˆ†åˆ«ç»å†ä¸‹é¢3ç§é‡æ’åºï¼š</p><ol><li><p>ç¼–è¯‘å™¨ä¼˜åŒ–çš„é‡æ’åºã€‚ç¼–è¯‘å™¨åœ¨ä¸æ”¹å˜å•çº¿ç¨‹ç¨‹åºè¯­ä¹‰çš„å‰æä¸‹ï¼Œå¯ä»¥é‡æ–°å®‰æ’è¯­å¥çš„æ‰§è¡Œé¡ºåºã€‚</p></li><li><p>æŒ‡ä»¤çº§å¹¶è¡Œçš„é‡æ’åºã€‚ç°ä»£å¤„ç†å™¨é‡‡ç”¨äº†æŒ‡ä»¤çº§å¹¶è¡ŒæŠ€æœ¯ï¼ˆInstruction-LevelParallelismï¼ŒILPï¼‰æ¥å°†å¤šæ¡æŒ‡ä»¤é‡å æ‰§è¡Œã€‚å¦‚æœä¸å­˜åœ¨æ•°æ®ä¾èµ–æ€§ï¼Œå¤„ç†å™¨å¯ä»¥æ”¹å˜è¯­å¥å¯¹åº”æœºå™¨æŒ‡ä»¤çš„æ‰§è¡Œé¡ºåºã€‚</p></li><li><p>å†…å­˜ç³»ç»Ÿçš„é‡æ’åºã€‚ç”±äºå¤„ç†å™¨ä½¿ç”¨ç¼“å­˜å’Œè¯»/å†™ç¼“å†²åŒºï¼Œè¿™ä½¿å¾—åŠ è½½å’Œå­˜å‚¨æ“ä½œçœ‹ä¸Šå»å¯èƒ½æ˜¯åœ¨ä¹±åºæ‰§è¡Œã€‚</p></li></ol><p>å¦‚æœä¸¤ä¸ªæ“ä½œè®¿é—®åŒä¸€ä¸ªå˜é‡ï¼Œå…¶ä¸­ä¸€ä¸ªä¸ºå†™æ“ä½œï¼Œæ­¤æ—¶è¿™ä¸¤ä¸ªæ“ä½œä¹‹é—´å­˜åœ¨æ•°æ®ä¾èµ–æ€§ã€‚ ç¼–è¯‘å™¨å’Œå¤„ç†å™¨ä¸ä¼šæ”¹å˜å­˜åœ¨æ•°æ®ä¾èµ–æ€§å…³ç³»çš„ä¸¤ä¸ªæ“ä½œçš„æ‰§è¡Œé¡ºåºï¼Œå³ä¸ä¼šé‡æ’åºã€‚ä¸ç®¡æ€ä¹ˆé‡æ’åºï¼Œå•çº¿ç¨‹ä¸‹çš„æ‰§è¡Œç»“æœä¸èƒ½è¢«æ”¹å˜ï¼Œç¼–è¯‘å™¨ã€runtimeå’Œå¤„ç†å™¨éƒ½å¿…é¡»éµå®ˆas-if-serialè¯­ä¹‰ã€‚</p><h2 id="å†…å­˜å±éšœ"><a href="#å†…å­˜å±éšœ" class="headerlink" title="å†…å­˜å±éšœ"></a>å†…å­˜å±éšœ</h2><p>é€šè¿‡æ’å…¥å†…å­˜å±éšœï¼ˆMemory Barrierï¼‰å¯ä»¥é˜»æ­¢ç‰¹å®šç±»å‹çš„æŒ‡ä»¤é‡æ’ã€‚JMMå°†å†…å­˜å±éšœåˆ’åˆ†ä¸ºå››ç§ï¼š</p><table><tr><th>å±éšœç±»å‹</th><th>ç¤ºä¾‹</th><th>æè¿°</th></tr><tr><td>LoadLoad Barriers</td><td>Load1-LoadLoad-Load2</td><td>Load1æ•°æ®è£…è½½è¿‡ç¨‹è¦å…ˆäºLoad2åŠæ‰€æœ‰åç»­çš„æ•°æ®è£…è½½è¿‡ç¨‹</td></tr><tr><td>StoreStore Barriers</td><td>Store1-StoreStore-Store2</td><td>Store1åˆ·æ–°æ•°æ®åˆ°å†…å­˜çš„è¿‡ç¨‹è¦å…ˆäºStrore2åŠåç»­æ‰€æœ‰åˆ·æ–°æ•°æ®åˆ°å†…å­˜çš„è¿‡ç¨‹</td></tr><tr><td>LoadStore Barriers</td><td>Load1-LoadStore-Store2</td><td>Load1æ•°æ®è£…è½½è¦å…ˆäºStrore2åŠåç»­æ‰€æœ‰åˆ·æ–°æ•°æ®åˆ°å†…å­˜çš„è¿‡ç¨‹</td></tr><tr><td>StoreLoad Barriers</td><td>Store1-StoreLoad-Load2</td><td>Store1åˆ·æ–°æ•°æ®åˆ°å†…å­˜çš„è¿‡ç¨‹è¦å…ˆäºLoad2åŠæ‰€æœ‰åç»­çš„æ•°æ®è£…è½½è¿‡ç¨‹</td></tr></table><p>Javaä¸­volatileå…³é”®å­—çš„å®ç°å°±æ˜¯é€šè¿‡å†…å­˜å±éšœæ¥å®Œæˆçš„ã€‚</p><h2 id="happens-before"><a href="#happens-before" class="headerlink" title="happens-before"></a>happens-before</h2><p>ä»jdk5å¼€å§‹ï¼Œjavaä½¿ç”¨æ–°çš„JSR-133å†…å­˜æ¨¡å‹ï¼ŒåŸºäºhappens-beforeçš„æ¦‚å¿µæ¥é˜è¿°æ“ä½œä¹‹é—´çš„å†…å­˜å¯è§æ€§ã€‚</p><p>åœ¨JMMä¸­ï¼Œå¦‚æœä¸€ä¸ªæ“ä½œçš„æ‰§è¡Œç»“æœéœ€è¦å¯¹å¦ä¸€ä¸ªæ“ä½œå¯è§ï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªæ“ä½œä¹‹é—´å¿…é¡»è¦å­˜åœ¨happens-beforeå…³ç³»ï¼Œè¿™ä¸ªçš„ä¸¤ä¸ªæ“ä½œæ—¢å¯ä»¥åœ¨åŒä¸€ä¸ªçº¿ç¨‹ï¼Œä¹Ÿå¯ä»¥åœ¨ä¸åŒçš„ä¸¤ä¸ªçº¿ç¨‹ä¸­ã€‚</p><p>ä¸ç¨‹åºå‘˜å¯†åˆ‡ç›¸å…³çš„happens-beforeè§„åˆ™å¦‚ä¸‹ï¼š</p><ul><li><p>ç¨‹åºé¡ºåºè§„åˆ™ï¼šä¸€ä¸ªçº¿ç¨‹ä¸­çš„æ¯ä¸ªæ“ä½œï¼Œhappens-beforeäºè¯¥çº¿ç¨‹ä¸­ä»»æ„çš„åç»­æ“ä½œã€‚</p></li><li><p>ç›‘è§†å™¨é”è§„åˆ™ï¼šå¯¹ä¸€ä¸ªé”çš„è§£é”æ“ä½œï¼Œhappens-beforeäºéšåå¯¹è¿™ä¸ªé”çš„åŠ é”æ“ä½œã€‚</p></li><li><p>volatileåŸŸè§„åˆ™ï¼šå¯¹ä¸€ä¸ªvolatileåŸŸçš„å†™æ“ä½œï¼Œhappens-beforeäºä»»æ„çº¿ç¨‹åç»­å¯¹è¿™ä¸ªvolatileåŸŸçš„è¯»ã€‚</p></li><li><p>ä¼ é€’æ€§è§„åˆ™ï¼šå¦‚æœ A happens-before Bï¼Œä¸” B happens-before Cï¼Œé‚£ä¹ˆA happens-before Cã€‚</p></li></ul><div class="note danger"><p>æ³¨æ„ï¼šä¸¤ä¸ªæ“ä½œä¹‹é—´å…·æœ‰happens-beforeå…³ç³»ï¼Œå¹¶ä¸æ„å‘³å‰ä¸€ä¸ªæ“ä½œå¿…é¡»è¦åœ¨åä¸€ä¸ªæ“ä½œä¹‹å‰æ‰§è¡Œï¼ä»…ä»…è¦æ±‚å‰ä¸€ä¸ªæ“ä½œçš„æ‰§è¡Œç»“æœï¼Œå¯¹äºåä¸€ä¸ªæ“ä½œæ˜¯å¯è§çš„ï¼Œä¸”å‰ä¸€ä¸ªæ“ä½œæŒ‰é¡ºåºæ’åœ¨åä¸€ä¸ªæ“ä½œä¹‹å‰ã€‚</p></div><blockquote><p>å‚è€ƒè‡ªï¼š<a href="https://book.douban.com/subject/26591326/" target="_blank" rel="noopener">Javaå¹¶å‘ç¼–ç¨‹çš„è‰ºæœ¯</a></p></blockquote><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Wed May 15 2019 17:13:42 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;ç†è§£Javaå†…å­˜æ¨¡å‹æ˜¯æ·±å…¥å­¦ä¹ Javaå¹¶å‘ä¸å¯æˆ–ç¼ºçš„éƒ¨åˆ†ã€‚Javaå†…å­˜æ¨¡å‹å³Java Memory Modelï¼Œç®€ç§°ä¸ºJMMï¼Œå®šä¹‰äº†å¤šçº¿ç¨‹ä¹‹é—´å…±äº«å˜é‡çš„å¯è§æ€§ä»¥åŠå¦‚ä½•åœ¨éœ€è¦çš„æ—¶å€™å¯¹å…±äº«å˜é‡è¿›è¡ŒåŒæ­¥ã€‚&lt;/p&gt;&lt;p&gt;JMMè§„å®šJavaçº¿ç¨‹é—´çš„é€šä¿¡é‡‡ç”¨å…±äº«å†…å­˜çš„æ–¹å¼ã€‚åœ¨Javaä¸­ï¼Œæ‰€æœ‰æˆå‘˜å˜é‡ã€é™æ€å˜é‡å’Œæ•°ç»„å…ƒç´ éƒ½å­˜å‚¨åœ¨å †å†…å­˜ä¸­ï¼Œå †å†…å­˜åœ¨çº¿ç¨‹ä¹‹é—´å…±äº«ï¼Œæ‰€ä»¥å®ƒä»¬é€šå¸¸ä¹Ÿç§°ä¸ºå…±äº«å˜é‡ã€‚JMMå®šä¹‰äº†çº¿ç¨‹å’Œä¸»å†…å­˜ä¹‹é—´çš„æŠ½ è±¡å…³ç³»ï¼šçº¿ç¨‹ä¹‹é—´çš„å…±äº«å˜é‡å­˜å‚¨åœ¨ä¸»å†…å­˜ï¼ˆMain Memoryï¼‰ä¸­ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ªç§æœ‰çš„æœ¬åœ°å†…å­˜ï¼ˆLocal Memoryï¼Œæˆ–è€…ä¹Ÿå¯ä»¥ç§°ä¸ºå·¥ä½œå†…å­˜ Work Memoryï¼‰ï¼Œæœ¬åœ°å†…å­˜ä¸­å­˜å‚¨äº†è¯¥çº¿ç¨‹ä»¥è¯»/å†™å…±äº«å˜é‡çš„å‰¯æœ¬ã€‚æœ¬åœ°å†…å­˜æ˜¯JMMçš„ä¸€ä¸ªæŠ½è±¡æ¦‚å¿µï¼Œå¹¶ä¸çœŸå®å­˜åœ¨ã€‚å®ƒæ¶µç›–äº†ç¼“å­˜ã€å†™ç¼“å†²åŒºã€å¯„å­˜å™¨ä»¥åŠå…¶ä»–çš„ç¡¬ä»¶å’Œç¼–è¯‘å™¨ä¼˜åŒ–ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Java" scheme="http://mrbird.cc/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>Guava æ‚é¡¹ç¬”è®°</title>
    <link href="http://mrbird.cc/Guava-Miscellaneous-notes.html"/>
    <id>http://mrbird.cc/Guava-Miscellaneous-notes.html</id>
    <published>2019-01-18T01:41:24.000Z</published>
    <updated>2019-05-05T06:35:16.740Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Wed May 15 2019 17:13:42 GMT+0800 (GMT+08:00) --><p>è¿™é‡Œä¸»è¦è®°å½•Guavaæä¾›çš„ä¸€äº›å·¥å…·ç±»çš„ç”¨æ³•ã€‚</p><h2 id="Strings"><a href="#Strings" class="headerlink" title="Strings"></a>Strings</h2><p>ç©ºå’Œnullç›¸äº’è½¬æ¢ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">String s1 = Strings.emptyToNull(<span class="string">""</span>);</span><br><span class="line">System.out.println(s1); <span class="comment">// null</span></span><br><span class="line">String s2 = Strings.nullToEmpty(<span class="keyword">null</span>);</span><br><span class="line">System.out.println(s2); <span class="comment">//</span></span><br></pre></td></tr></table></figure><p></p><a id="more"></a><p>è·å–ç›¸åŒçš„å‰ç¼€å’Œåç¼€ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">String s3 = Strings.commonPrefix(<span class="string">"mrbird"</span>, <span class="string">"mr.right"</span>);</span><br><span class="line">System.out.println(s3); <span class="comment">// mr</span></span><br><span class="line">String s4 = Strings.commonSuffix(<span class="string">"mrbird"</span>, <span class="string">"third"</span>);</span><br><span class="line">System.out.println(s4); <span class="comment">// ird</span></span><br></pre></td></tr></table></figure><p></p><p>repeaté‡å¤æ“ä½œï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">String s5 = Strings.repeat(<span class="string">"mrbird"</span>, <span class="number">3</span>);</span><br><span class="line">System.out.println(s5); <span class="comment">// mrbirdmrbirdmrbird</span></span><br></pre></td></tr></table></figure><p></p><p>åˆ¤æ–­å­—ç¬¦ä¸²æ˜¯å¦ä¸ºç©ºæˆ–nullï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">boolean</span> nullOrEmpty = Strings.isNullOrEmpty(<span class="keyword">null</span>);</span><br><span class="line">System.out.println(nullOrEmpty); <span class="comment">// true</span></span><br></pre></td></tr></table></figure><p></p><p>å·¦ä¾§å¡«å……å’Œå³ä¾§å¡«å……ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">String s6 = Strings.padStart(<span class="string">"01"</span>, <span class="number">5</span>, <span class="string">'0'</span>);</span><br><span class="line">System.out.println(s6); <span class="comment">// 00001</span></span><br><span class="line">String s7 = Strings.padEnd(<span class="string">"1.0"</span>, <span class="number">5</span>, <span class="string">'0'</span>);</span><br><span class="line">System.out.println(s7); <span class="comment">// 1.000</span></span><br></pre></td></tr></table></figure><p></p><h2 id="StopWatcher"><a href="#StopWatcher" class="headerlink" title="StopWatcher"></a>StopWatcher</h2><p>StopWatcherç”¨äºç›‘æµ‹ä¸€æ®µç¨‹åºçš„æ‰§è¡Œè€—æ—¶ã€‚æˆ‘ä»¬ä¹‹å‰é€šå¸¸çš„åšæ³•æ˜¯ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">System.out.println(<span class="string">"ç¨‹åºå¼€å§‹å¤„ç†"</span>);</span><br><span class="line"><span class="keyword">long</span> start = System.currentTimeMillis();</span><br><span class="line">TimeUnit.SECONDS.sleep(<span class="number">2</span>);</span><br><span class="line">System.out.println(<span class="string">"ç¨‹åºå¤„ç†ç»“æŸï¼Œè€—æ—¶"</span> + (System.currentTimeMillis() - start) + <span class="string">"æ¯«ç§’"</span>); <span class="comment">// ç¨‹åºå¤„ç†ç»“æŸï¼Œè€—æ—¶2.002 s</span></span><br></pre></td></tr></table></figure><p></p><p>ä½¿ç”¨StopWatcheræ–¹ä¾¿ä¹‹å¤„åœ¨äºå®ƒä¼šå¸®æˆ‘ä»¬é€‰å–åˆé€‚çš„æ—¶é—´å•ä½ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">System.out.println(<span class="string">"ç¨‹åºå¼€å§‹å¤„ç†"</span>);</span><br><span class="line">Stopwatch stopwatch = Stopwatch.createStarted();</span><br><span class="line">TimeUnit.SECONDS.sleep(<span class="number">2</span>);</span><br><span class="line">System.out.println(<span class="string">"ç¨‹åºå¤„ç†ç»“æŸï¼Œè€—æ—¶"</span> + stopwatch.stop()); <span class="comment">// ç¨‹åºå¤„ç†ç»“æŸï¼Œè€—æ—¶2.002 s</span></span><br></pre></td></tr></table></figure><p></p><h2 id="Preconditionsæ–­è¨€"><a href="#Preconditionsæ–­è¨€" class="headerlink" title="Preconditionsæ–­è¨€"></a>Preconditionsæ–­è¨€</h2><p>æ–­è¨€å¸¸ç”¨äºç±»åº“è®¾è®¡ä¸­æ–¹æ³•å‚æ•°çš„åˆ¤æ–­ï¼Œå½“å‚æ•°ä¸ç¬¦åˆè¦æ±‚æ—¶ï¼Œè®©ç¨‹åºæå‰æŠ›å¼‚å¸¸ç»“æŸã€‚Preconditionsæ˜¯Guavaæä¾›çš„æ–­è¨€ç±»ã€‚</p><h3 id="éç©ºæ ¡éªŒ"><a href="#éç©ºæ ¡éªŒ" class="headerlink" title="éç©ºæ ¡éªŒ"></a>éç©ºæ ¡éªŒ</h3><p>åˆ¤æ–­æ˜¯å¦ä¸ºç©ºï¼Œä¸ºç©ºçš„è¯æŠ›å‡º<code>NullPointerException</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">List&lt;String&gt; list = <span class="keyword">null</span>;</span><br><span class="line">Preconditions.checkNotNull(list);</span><br></pre></td></tr></table></figure><p></p><p><img src="img/QQæˆªå›¾20190505140513.png" alt="QQæˆªå›¾20190505140513.png"></p><p>è‡ªå®šä¹‰æè¿°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">List&lt;String&gt; list = <span class="keyword">null</span>;</span><br><span class="line">Preconditions.checkNotNull(list, <span class="string">"listä¸èƒ½ä¸ºç©º"</span>);</span><br></pre></td></tr></table></figure><p></p><p><img src="img/QQæˆªå›¾20190505140642.png" alt="QQæˆªå›¾20190505140642.png"></p><p>è‡ªå®šä¹‰æè¿° + é•¿åº¦æ ¡éªŒï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">List&lt;String&gt; list = <span class="keyword">null</span>;</span><br><span class="line">Preconditions.checkNotNull(list, <span class="string">"listé•¿åº¦å¿…é¡»ä¸º%s"</span>, <span class="number">2</span>);</span><br></pre></td></tr></table></figure><p></p><p><img src="img/QQæˆªå›¾20190505140741.png" alt="QQæˆªå›¾20190505140741.png"></p><h3 id="å‚æ•°æ ¡éªŒ"><a href="#å‚æ•°æ ¡éªŒ" class="headerlink" title="å‚æ•°æ ¡éªŒ"></a>å‚æ•°æ ¡éªŒ</h3><p>æ ¡éªŒä¸é€šè¿‡æ—¶ï¼ŒæŠ›å‡º<code>IllegalArgumentException</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">String value = <span class="string">"hello"</span>;</span><br><span class="line">Preconditions.checkArgument(<span class="string">"world"</span>.equals(value), <span class="string">"å‚æ•°å†…å®¹å¿…é¡»ä¸ºworld"</span>);</span><br></pre></td></tr></table></figure><p></p><p><img src="img/QQæˆªå›¾20190505140953.png" alt="QQæˆªå›¾20190505140953.png"></p><h3 id="çŠ¶æ€æ ¡éªŒ"><a href="#çŠ¶æ€æ ¡éªŒ" class="headerlink" title="çŠ¶æ€æ ¡éªŒ"></a>çŠ¶æ€æ ¡éªŒ</h3><p>æ ¡éªŒä¸é€šè¿‡æ—¶ï¼ŒæŠ›å‡º<code>IllegalStateException</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">String state = <span class="string">"on"</span>;</span><br><span class="line">Preconditions.checkState(<span class="string">"off"</span>.equals(state), <span class="string">"çŠ¶æ€å¿…é¡»ä¸ºoff"</span>);</span><br></pre></td></tr></table></figure><p></p><p><img src="img/QQæˆªå›¾20190505141058.png" alt="QQæˆªå›¾20190505141058.png"></p><h3 id="æ ¡éªŒå…ƒç´ ä¸ªæ•°"><a href="#æ ¡éªŒå…ƒç´ ä¸ªæ•°" class="headerlink" title="æ ¡éªŒå…ƒç´ ä¸ªæ•°"></a>æ ¡éªŒå…ƒç´ ä¸ªæ•°</h3><p>æ ¡éªŒä¸é€šè¿‡ï¼ŒæŠ›å‡º<code>IndexOutOfBoundsException</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">List&lt;String&gt; list = ImmutableList.of();</span><br><span class="line">Preconditions.checkElementIndex(<span class="number">10</span>, list.size(), <span class="string">"ä¸‹æ ‡è¶Šç•Œï¼Œä¸å­˜åœ¨ç¬¬10ä¸ªå…ƒç´ "</span>);</span><br></pre></td></tr></table></figure><p></p><p><img src="img/QQæˆªå›¾20190505141210.png" alt="QQæˆªå›¾20190505141210.png"></p><h2 id="IOæ“ä½œ"><a href="#IOæ“ä½œ" class="headerlink" title="IOæ“ä½œ"></a>IOæ“ä½œ</h2><p>æ¼”ç¤ºä¹‹å‰å…ˆåˆ›å»ºä¸€ä¸ªsource.txtæ–‡ä»¶ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Guava I/O operation</span><br><span class="line">Guava I/O æ“ä½œ</span><br></pre></td></tr></table></figure><p></p><p>ç›¸å…³å¸¸é‡ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SOURCE_FILE = <span class="string">"C:\\Users\\Administrator\\Desktop\\guavatest\\src\\test\\java\\cc\\mrbird\\resources\\source.txt"</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TARGET_FILE = <span class="string">"C:\\Users\\Administrator\\Desktop\\guavatest\\src\\test\\java\\cc\\mrbird\\resources\\target.txt"</span>;</span><br></pre></td></tr></table></figure><p></p><h3 id="æ–‡ä»¶æ‹·è´"><a href="#æ–‡ä»¶æ‹·è´" class="headerlink" title="æ–‡ä»¶æ‹·è´"></a>æ–‡ä»¶æ‹·è´</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">File targetFile = <span class="keyword">new</span> File(TARGET_FILE);</span><br><span class="line">Files.copy(<span class="keyword">new</span> File(SOURCE_FILE), targetFile);</span><br><span class="line">System.out.println(targetFile.exists()); <span class="comment">// true</span></span><br></pre></td></tr></table></figure><p><img src="img/QQæˆªå›¾20190505141800.png" alt="QQæˆªå›¾20190505141800.png"></p><h3 id="æ–‡ä»¶ç§»åŠ¨"><a href="#æ–‡ä»¶ç§»åŠ¨" class="headerlink" title="æ–‡ä»¶ç§»åŠ¨"></a>æ–‡ä»¶ç§»åŠ¨</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Files.move(<span class="keyword">new</span> File(SOURCE_FILE), <span class="keyword">new</span> File(TARGET_FILE));</span><br></pre></td></tr></table></figure><p>æ–‡ä»¶ç§»åŠ¨å’Œæ–‡ä»¶æ‹·è´çš„åŒºåˆ«æ˜¯ï¼Œæ–‡ä»¶ç§»åŠ¨ä¼šåˆ é™¤æºæ–‡ä»¶ï¼š</p><p><img src="img/QQæˆªå›¾20190505142008.png" alt="QQæˆªå›¾20190505142008.png"></p><h3 id="è¯»å–æ–‡ä»¶å†…å®¹"><a href="#è¯»å–æ–‡ä»¶å†…å®¹" class="headerlink" title="è¯»å–æ–‡ä»¶å†…å®¹"></a>è¯»å–æ–‡ä»¶å†…å®¹</h3><p>å°†æ–‡ä»¶å†…å®¹è¯»å–åˆ°Stringé›†åˆä¸­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">List&lt;String&gt; list = Files.readLines(<span class="keyword">new</span> File(SOURCE_FILE), Charsets.UTF_8);</span><br><span class="line">list.forEach(System.out::println);</span><br></pre></td></tr></table></figure><p></p><p><img src="img/QQæˆªå›¾20190505142229.png" alt="QQæˆªå›¾20190505142229.png"></p><p>è¯»çš„è¿‡ç¨‹ä¸­è¿›è¡Œä¸€äº›åŠ å·¥ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">LineProcessor&lt;List&lt;String&gt;&gt; lineProcessor = <span class="keyword">new</span> LineProcessor&lt;List&lt;String&gt;&gt;() &#123;</span><br><span class="line">    List&lt;String&gt; result = Lists.newArrayList();</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">processLine</span><span class="params">(String line)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (line.length() != <span class="number">0</span>) &#123;</span><br><span class="line">            result.add(line + <span class="string">"ã€‚"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">getResult</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line">List&lt;String&gt; result = Files.asCharSource(<span class="keyword">new</span> File(SOURCE_FILE), Charsets.UTF_8).readLines(lineProcessor);</span><br><span class="line">System.out.println(result); <span class="comment">// [Guava I/O operationã€‚, Guava I/O æ“ä½œã€‚]</span></span><br></pre></td></tr></table></figure><p></p><h3 id="å†™æ“ä½œ"><a href="#å†™æ“ä½œ" class="headerlink" title="å†™æ“ä½œ"></a>å†™æ“ä½œ</h3><p>è¿½åŠ æ“ä½œï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">File file = <span class="keyword">new</span> File(SOURCE_FILE);</span><br><span class="line">String value = <span class="string">"æ·»åŠ ä¸€äº›å†…å®¹"</span>;</span><br><span class="line">CharSink charSink = Files.asCharSink(file, Charsets.UTF_8, FileWriteMode.APPEND); <span class="comment">// è¿½åŠ </span></span><br><span class="line">charSink.write(value);</span><br><span class="line"></span><br><span class="line">String read = Files.asCharSource(file, Charsets.UTF_8).read();</span><br><span class="line">System.out.println(read);</span><br></pre></td></tr></table></figure><p></p><p><img src="img/QQæˆªå›¾20190505142616.png" alt="QQæˆªå›¾20190505142616.png"></p><p>è¦†ç›–æ“ä½œï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">File file = <span class="keyword">new</span> File(SOURCE_FILE);</span><br><span class="line">String value = <span class="string">"æ·»åŠ ä¸€äº›å†…å®¹"</span>;</span><br><span class="line">CharSink charSink = Files.asCharSink(file, Charsets.UTF_8); <span class="comment">// è¦†ç›–</span></span><br><span class="line">charSink.write(value);</span><br><span class="line"></span><br><span class="line">String read = Files.asCharSource(file, Charsets.UTF_8).read();</span><br><span class="line">System.out.println(read);</span><br></pre></td></tr></table></figure><p></p><p><img src="img/QQæˆªå›¾20190505142740.png" alt="QQæˆªå›¾20190505142740.png"></p><h3 id="æ–‡ä»¶è½¬ä¸ºå“ˆå¸Œç "><a href="#æ–‡ä»¶è½¬ä¸ºå“ˆå¸Œç " class="headerlink" title="æ–‡ä»¶è½¬ä¸ºå“ˆå¸Œç "></a>æ–‡ä»¶è½¬ä¸ºå“ˆå¸Œç </h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">File file = <span class="keyword">new</span> File(SOURCE_FILE);</span><br><span class="line">HashCode hash = Files.asByteSource(file).hash(Hashing.sha256());</span><br><span class="line">System.out.println(hash); <span class="comment">// c46982603d4b2ba5032d73dc1fffbe1aea1f11d75921b2839632c56636673d31</span></span><br></pre></td></tr></table></figure><h3 id="æ–‡ä»¶åˆ›å»º"><a href="#æ–‡ä»¶åˆ›å»º" class="headerlink" title="æ–‡ä»¶åˆ›å»º"></a>æ–‡ä»¶åˆ›å»º</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">String TOUCH_FILE = <span class="string">"C:\\Users\\Administrator\\Desktop\\guavatest\\src\\test\\java\\cc\\mrbird\\resources\\new.txt"</span>;</span><br><span class="line">File file = <span class="keyword">new</span> File(TOUCH_FILE);</span><br><span class="line">Files.touch(file);</span><br><span class="line"><span class="keyword">boolean</span> exists = file.exists();</span><br><span class="line">System.out.println(exists); <span class="comment">// true</span></span><br></pre></td></tr></table></figure><h3 id="é€’å½’æ“ä½œ"><a href="#é€’å½’æ“ä½œ" class="headerlink" title="é€’å½’æ“ä½œ"></a>é€’å½’æ“ä½œ</h3><p>ç”±æµ…å…¥æ·±ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">File file = <span class="keyword">new</span> File(<span class="string">"C:\\Users\\Administrator\\Desktop\\guavatest\\src\\test\\java\\cc\\mrbird"</span>);</span><br><span class="line"><span class="comment">// depthFirstPreOrder ç”±æµ…å…¥æ·±</span></span><br><span class="line">Iterable&lt;File&gt; files = Files.fileTraverser().depthFirstPreOrder(file);</span><br><span class="line">files.forEach(f -&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (f.isDirectory()) &#123;</span><br><span class="line">        System.out.println(<span class="string">"directory: "</span> + f);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">"file: "</span> + f);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p></p><p><img src="img/QQæˆªå›¾20190505143344.png" alt="QQæˆªå›¾20190505143344.png"></p><p>ç”±æ·±å…¥æµ…ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">File file = <span class="keyword">new</span> File(<span class="string">"C:\\Users\\Administrator\\Desktop\\guavatest\\src\\test\\java\\cc\\mrbird"</span>);</span><br><span class="line"><span class="comment">// depthFirstPostOrder ç”±æ·±å…¥æµ…</span></span><br><span class="line">Iterable&lt;File&gt; files = Files.fileTraverser().depthFirstPostOrder(file);</span><br><span class="line">files.forEach(f -&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (f.isDirectory()) &#123;</span><br><span class="line">        System.out.println(<span class="string">"directory: "</span> + f);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">"file: "</span> + f);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p></p><p><img src="img/QQæˆªå›¾20190505143508.png" alt="QQæˆªå›¾20190505143508.png"></p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Wed May 15 2019 17:13:42 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;è¿™é‡Œä¸»è¦è®°å½•Guavaæä¾›çš„ä¸€äº›å·¥å…·ç±»çš„ç”¨æ³•ã€‚&lt;/p&gt;&lt;h2 id=&quot;Strings&quot;&gt;&lt;a href=&quot;#Strings&quot; class=&quot;headerlink&quot; title=&quot;Strings&quot;&gt;&lt;/a&gt;Strings&lt;/h2&gt;&lt;p&gt;ç©ºå’Œnullç›¸äº’è½¬æ¢ï¼š&lt;/p&gt;&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;String s1 = Strings.emptyToNull(&lt;span class=&quot;string&quot;&gt;&quot;&quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;System.out.println(s1); &lt;span class=&quot;comment&quot;&gt;// null&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;String s2 = Strings.nullToEmpty(&lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;System.out.println(s2); &lt;span class=&quot;comment&quot;&gt;//&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;&lt;/p&gt;
    
    </summary>
    
    
      <category term="guava" scheme="http://mrbird.cc/tags/guava/"/>
    
  </entry>
  
  <entry>
    <title>Guava RateLimiter</title>
    <link href="http://mrbird.cc/Guava-RateLimiter.html"/>
    <id>http://mrbird.cc/Guava-RateLimiter.html</id>
    <published>2019-01-15T01:38:42.000Z</published>
    <updated>2019-05-05T08:21:44.996Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Wed May 15 2019 17:13:42 GMT+0800 (GMT+08:00) --><p>Google Guavaæä¾›çš„<code>RateLimiter</code>ä½¿ç”¨çš„æ˜¯ä»¤ç‰Œæ¡¶ç®—æ³•ã€‚ä»¤ç‰Œæ¡¶ç®—æ³•çš„åŸºæœ¬æ€æƒ³æ˜¯ä»¥å›ºå®šçš„é€Ÿç‡ç”Ÿæˆä»¤ç‰Œï¼Œåœ¨æ‰§è¡Œè¯·æ±‚ä¹‹å‰éƒ½éœ€è¦ä»ä»¤ç‰Œæ¡¶é‡Œè·å–è¶³å¤Ÿçš„ä»¤ç‰Œã€‚å½“ä»¤ç‰Œæ•°é‡ä¸è¶³çš„æ—¶å€™ï¼Œè¯·æ±‚å°†è¢«é˜»å¡è¿›å…¥ç­‰å¾…çŠ¶æ€æˆ–è€…ç›´æ¥è¿”å›å¤±è´¥ã€‚<code>RateLimiter</code>å¸¸ç”¨äºé™åˆ¶è®¿é—®èµ„æºçš„é€Ÿç‡ã€‚<a id="more"></a></p><h2 id="RateLimiterä½¿ç”¨ç¤ºä¾‹"><a href="#RateLimiterä½¿ç”¨ç¤ºä¾‹" class="headerlink" title="RateLimiterä½¿ç”¨ç¤ºä¾‹"></a>RateLimiterä½¿ç”¨ç¤ºä¾‹</h2><p>ä¸‹é¢æ˜¯ä¸€ä¸ªRateLimiterçš„ç®€å•ä½¿ç”¨ç¤ºä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RateLimiterTest</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 1ç§’é’Ÿäº§ç”Ÿ0.5å¼ ä»¤ç‰Œ</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> RateLimiter limiter = RateLimiter.create(<span class="number">0.5</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ExecutorService service = Executors.newFixedThreadPool(<span class="number">5</span>);</span><br><span class="line">        IntStream.range(<span class="number">0</span>, <span class="number">5</span>).forEach(i -&gt; service.submit(RateLimiterTest::testLimiter));</span><br><span class="line">        service.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">testLimiter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(Thread.currentThread() + <span class="string">" waiting "</span> + limiter.acquire());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>æˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ª<code>RateLimiter</code>å®ä¾‹ï¼Œæ¯ç§’é’Ÿäº§ç”Ÿ0.5å¼ ä»¤ç‰Œï¼Œå³æ¯2ç§’é’Ÿäº§ç”Ÿ1å¼ ä»¤ç‰Œã€‚<code>testLimiter</code>æ–¹æ³•ä¸­é€šè¿‡<code>limiter.acquire()</code>æ–¹æ³•è·å–ä»¤ç‰Œï¼ˆä¸å¸¦å‚æ•°æ—¶é»˜è®¤è·å–1å¼ ä»¤ç‰Œï¼‰ã€‚<code>Executors.newFixedThreadPool(5)</code>ç”Ÿæˆäº”ä¸ªçº¿ç¨‹ï¼Œå¹¶å‘è°ƒç”¨<code>testLimiter</code>æ–¹æ³•ï¼Œæ‰§è¡Œä»£ç ï¼Œæ§åˆ¶å°è¾“å‡ºå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Thread[pool-1-thread-1,5,main] waiting 0.0</span><br><span class="line">Thread[pool-1-thread-5,5,main] waiting 1.908947</span><br><span class="line">Thread[pool-1-thread-4,5,main] waiting 3.908935</span><br><span class="line">Thread[pool-1-thread-3,5,main] waiting 5.908919</span><br><span class="line">Thread[pool-1-thread-2,5,main] waiting 7.908808</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æ¯ä¸ªçº¿ç¨‹è°ƒç”¨æ—¶é—´ç›¸éš”å¤§çº¦ä¸º2ç§’é’Ÿã€‚å¯èƒ½ä½ ä¼šé—®ï¼Œä¸ºä»€ä¹ˆç¬¬ä¸€ä¸ªçº¿ç¨‹æ²¡æœ‰ç­‰å¾…2ç§’ï¼Œç›´æ¥å°±è·å–åˆ°äº†ä»¤ç‰Œç„¶åæ‰§è¡Œäº†å‘¢ï¼Ÿ</p><p>Guava RateLimiterå…è®¸æŸæ¬¡è¯·æ±‚è·å–è¶…å‡ºå‰©ä½™ä»¤ç‰Œæ•°çš„ä»¤ç‰Œï¼Œä½†æ˜¯ä¸‹ä¸€æ¬¡è¯·æ±‚å°†ä¸ºæ­¤ä»˜å‡ºä»£ä»·ï¼Œä¸€ç›´ç­‰åˆ°ä»¤ç‰Œäºç©ºè¡¥ä¸Šã€‚å†æ¥çœ‹ä¸€ä¸ª<code>RateLimiter</code>çš„ä¾‹å­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RateLimiterTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        RateLimiter limiter = RateLimiter.create(<span class="number">1</span>);</span><br><span class="line">        System.out.println(limiter.acquire(<span class="number">4</span>));</span><br><span class="line">        System.out.println(limiter.acquire(<span class="number">3</span>));</span><br><span class="line">        System.out.println(limiter.acquire(<span class="number">2</span>));</span><br><span class="line">        System.out.println(limiter.acquire(<span class="number">1</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ç¨‹åºè¾“å‡ºå¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">0.0</span><br><span class="line">3.996602</span><br><span class="line">2.997448</span><br><span class="line">2.000229</span><br></pre></td></tr></table></figure><p></p><p>ä¸Šé¢ä¾‹å­é’Ÿï¼Œä¸€ç§’é’Ÿäº§ç”Ÿä¸€å¼ ä»¤ç‰Œï¼Œç¬¬ä¸€æ¬¡è¯·æ±‚ç›´æ¥å–å‡º4å¼ ä»¤ç‰Œï¼Œæ‰€ä»¥ç¬¬äºŒæ¬¡è¯·æ±‚éœ€è¦ç­‰å¾…4/1ç§’æ‰èƒ½å–åˆ°ä»¤ç‰Œã€‚ç»è¿‡å¤§çº¦4ç§’åï¼Œç¬¬äºŒæ¬¡è¯·æ±‚ç›´æ¥å–å‡º3å¼ ä»¤ç‰Œï¼Œæ‰€ä»¥ç¬¬ä¸‰æ¬¡è¯·æ±‚éœ€è¦ç­‰å¾…3/1ç§’åæ‰èƒ½å–åˆ°ä»¤ç‰Œï¼Œä¾æ­¤ç±»æ¨ã€‚</p><h2 id="è®¾ç½®è¶…æ—¶æ—¶é—´"><a href="#è®¾ç½®è¶…æ—¶æ—¶é—´" class="headerlink" title="è®¾ç½®è¶…æ—¶æ—¶é—´"></a>è®¾ç½®è¶…æ—¶æ—¶é—´</h2><p>æˆ‘ä»¬å¯ä»¥è®¾ç½®ç­‰å¾…ä»¤ç‰Œçš„è¶…æ—¶æ—¶é—´ï¼Œå¦‚æœç­‰å¾…ä»¤ç‰Œçš„æ—¶é—´å¤§äºè¶…æ—¶æ—¶é—´ï¼Œå°†ç›´æ¥è¿”å›falseï¼Œä¸å†ç­‰å¾…ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RateLimiterTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        RateLimiter limiter = RateLimiter.create(<span class="number">1</span>);</span><br><span class="line">        System.out.println(limiter.acquire(<span class="number">3</span>));</span><br><span class="line">        System.out.println(limiter.tryAcquire(<span class="number">1</span>, <span class="number">2</span>, TimeUnit.SECONDS));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ä¸Šé¢ä¾‹å­<code>limiter.tryAcquire</code>è®¾ç½®äº†è¶…æ—¶æ—¶é—´ä¸º2ç§’ï¼Œç”±äºç¬¬ä¸€æ¬¡è¯·æ±‚ä¸€æ¬¡æ€§è·å–äº†3å¼ ä»¤ç‰Œï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦ç­‰å¾…å¤§çº¦3ç§’é’Ÿï¼Œè¶…å‡ºäº†2ç§’çš„è¶…æ—¶æ—¶é—´ï¼Œæ‰€ä»¥<code>limiter.tryAcquire</code>ä¸ä¼šç­‰å¾…3ç§’ï¼Œè€Œæ˜¯ç›´æ¥è¿”å›falseã€‚</p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Wed May 15 2019 17:13:42 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;Google Guavaæä¾›çš„&lt;code&gt;RateLimiter&lt;/code&gt;ä½¿ç”¨çš„æ˜¯ä»¤ç‰Œæ¡¶ç®—æ³•ã€‚ä»¤ç‰Œæ¡¶ç®—æ³•çš„åŸºæœ¬æ€æƒ³æ˜¯ä»¥å›ºå®šçš„é€Ÿç‡ç”Ÿæˆä»¤ç‰Œï¼Œåœ¨æ‰§è¡Œè¯·æ±‚ä¹‹å‰éƒ½éœ€è¦ä»ä»¤ç‰Œæ¡¶é‡Œè·å–è¶³å¤Ÿçš„ä»¤ç‰Œã€‚å½“ä»¤ç‰Œæ•°é‡ä¸è¶³çš„æ—¶å€™ï¼Œè¯·æ±‚å°†è¢«é˜»å¡è¿›å…¥ç­‰å¾…çŠ¶æ€æˆ–è€…ç›´æ¥è¿”å›å¤±è´¥ã€‚&lt;code&gt;RateLimiter&lt;/code&gt;å¸¸ç”¨äºé™åˆ¶è®¿é—®èµ„æºçš„é€Ÿç‡ã€‚
    
    </summary>
    
    
      <category term="guava" scheme="http://mrbird.cc/tags/guava/"/>
    
  </entry>
  
  <entry>
    <title>Guava ç¼“å­˜</title>
    <link href="http://mrbird.cc/Guava-Cache.html"/>
    <id>http://mrbird.cc/Guava-Cache.html</id>
    <published>2019-01-07T02:11:26.000Z</published>
    <updated>2019-04-24T06:34:31.852Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Wed May 15 2019 17:13:43 GMT+0800 (GMT+08:00) --><p>Guavaç¼“å­˜æ˜¯è½»é‡çº§çš„ï¼Œå®ƒå°†å†…å®¹ç¼“å­˜åˆ°è¿è¡Œå†…å­˜ä¸­ã€‚å¦‚æœç³»ç»Ÿä¸­æŸäº›å€¼ï¼ˆæ¯”å¦‚ä¸€äº›é…ç½®è¡¨ï¼‰è¢«é¢‘ç¹æŸ¥è¯¢ä½¿ç”¨ï¼Œå¹¶ä¸”æˆ‘ä»¬æ„¿æ„æ¶ˆè€—ä¸€äº›å†…å­˜ç©ºé—´æ¥æå‡åº”ç”¨çš„é€Ÿåº¦ï¼Œå‡è½»æ•°æ®åº“å‹åŠ›çš„è¯ï¼ŒGuavaç¼“å­˜å°†ä¼šæ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ã€‚ç”±äºç¼“å­˜æ˜¯å­˜å‚¨åœ¨è¿è¡Œå†…å­˜ä¸­çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ç¡®ä¿ç¼“å­˜çš„å¤§å°ä¸è¶…å‡ºå†…å­˜çš„å®¹é‡ã€‚<a id="more"></a></p><h2 id="åˆ›å»ºç¼“å­˜"><a href="#åˆ›å»ºç¼“å­˜" class="headerlink" title="åˆ›å»ºç¼“å­˜"></a>åˆ›å»ºç¼“å­˜</h2><p>æˆ‘ä»¬å¯ä»¥ç›´æ¥åˆ›å»ºGuavaç¼“å­˜å¯¹è±¡ï¼Œè€Œä¸ä½¿ç”¨ä»»ä½•çš„CacheLoaderï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Cache&lt;String, String&gt; cache = CacheBuilder.newBuilder().build();</span><br><span class="line"></span><br><span class="line">cache.put(<span class="string">"hello"</span>, <span class="string">"world"</span>);</span><br><span class="line">System.out.println(cache.getIfPresent(<span class="string">"hello"</span>)); <span class="comment">//  world</span></span><br></pre></td></tr></table></figure><p></p><p>keyå€¼æ˜¯å¤§å°å†™æ•æ„Ÿçš„ï¼Œæ‰€ä»¥ä½¿ç”¨<code>cache.getIfPresent(&quot;HELLO&quot;)</code>å°†è¿”å›nullå€¼ã€‚</p><p>æ¥ä¸‹æ¥çœ‹çœ‹å¦‚ä½•ä½¿ç”¨CacheLoaderåˆ›å»ºç¼“å­˜å¯¹è±¡ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">CacheLoader&lt;String, String&gt; loader = <span class="keyword">new</span> CacheLoader&lt;String, String&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">load</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> sayHello(key);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line">LoadingCache&lt;String, String&gt; cache = CacheBuilder.newBuilder().build(loader);</span><br><span class="line"></span><br><span class="line">String mrbird = cache.getUnchecked(<span class="string">"mrbird"</span>);</span><br><span class="line">System.out.println(mrbird); <span class="comment">// hello mrbird</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">sayHello</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> String.format(<span class="string">"hello %s"</span>, key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>æ–¹æ³•<code>getUnchecked</code>ä½œç”¨ä¸ºï¼šå½“å€¼ä¸å­˜åœ¨æ—¶ï¼Œä¼šé€šè¿‡CacheLoaderè®¡ç®—å‡ºå€¼ï¼Œç„¶åå­˜åˆ°ç¼“å­˜ä¸­ã€‚</p><h2 id="é©±é€æœºåˆ¶"><a href="#é©±é€æœºåˆ¶" class="headerlink" title="é©±é€æœºåˆ¶"></a>é©±é€æœºåˆ¶</h2><p>æˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸€äº›é©±é€ç¼“å­˜çš„æœºåˆ¶æ¥é™åˆ¶ç¼“å­˜çš„å¤§å°ã€‚</p><h3 id="é™åˆ¶ç¼“å­˜æ•°ç›®"><a href="#é™åˆ¶ç¼“å­˜æ•°ç›®" class="headerlink" title="é™åˆ¶ç¼“å­˜æ•°ç›®"></a>é™åˆ¶ç¼“å­˜æ•°ç›®</h3><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡<code>maximumSize</code>æ¥é™åˆ¶ç¼“å­˜çš„æ¡ç›®ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Cache&lt;String, String&gt; cache = CacheBuilder.newBuilder().maximumSize(<span class="number">3</span>).build();</span><br><span class="line"></span><br><span class="line">cache.put(<span class="string">"k1"</span>, <span class="string">"v1"</span>);</span><br><span class="line">cache.put(<span class="string">"k2"</span>, <span class="string">"v2"</span>);</span><br><span class="line">cache.put(<span class="string">"k3"</span>, <span class="string">"v3"</span>);</span><br><span class="line">cache.put(<span class="string">"k4"</span>, <span class="string">"v4"</span>);</span><br><span class="line"></span><br><span class="line">System.out.println(cache.size()); <span class="comment">// 3</span></span><br><span class="line">System.out.println(cache.getIfPresent(<span class="string">"k1"</span>)); <span class="comment">// null</span></span><br><span class="line">System.out.println(cache.asMap()); <span class="comment">// &#123;k3=v3, k4=v4, k2=v2&#125;</span></span><br></pre></td></tr></table></figure><p></p><p>æˆ‘ä»¬é™åˆ¶æœ€å¤šåªèƒ½å­˜å‚¨3ä¸ªå€¼ï¼Œæ‰€ä»¥k4çš„å­˜å…¥æŠŠæœ€æ—©çš„k1ç»™é©±é€å‡ºå»äº†ï¼Œç±»ä¼¼äºFIFOã€‚</p><h3 id="é™åˆ¶ç¼“å­˜å¤§å°"><a href="#é™åˆ¶ç¼“å­˜å¤§å°" class="headerlink" title="é™åˆ¶ç¼“å­˜å¤§å°"></a>é™åˆ¶ç¼“å­˜å¤§å°</h3><p>æˆ‘ä»¬å¯ä»¥è‡ªå®šä¹‰æƒé‡å‡½æ•°æ¥é™åˆ¶ç¼“å­˜çš„å¤§å°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Weigher&lt;String, String&gt; weigher = (key, value) -&gt; value.length();</span><br><span class="line">Cache&lt;String, String&gt; cache = CacheBuilder.newBuilder().maximumWeight(<span class="number">15</span>).weigher(weigher).build();</span><br><span class="line"></span><br><span class="line">cache.put(<span class="string">"k1"</span>, <span class="string">"11111"</span>);</span><br><span class="line">cache.put(<span class="string">"k2"</span>, <span class="string">"22222"</span>);</span><br><span class="line">cache.put(<span class="string">"k3"</span>, <span class="string">"33333"</span>);</span><br><span class="line">cache.put(<span class="string">"k4"</span>, <span class="string">"4444"</span>);</span><br><span class="line">cache.put(<span class="string">"k5"</span>, <span class="string">"5555"</span>);</span><br><span class="line"></span><br><span class="line">System.out.println(cache.size()); <span class="comment">// 3</span></span><br><span class="line">System.out.println(cache.getIfPresent(<span class="string">"k1"</span>)); <span class="comment">// null</span></span><br><span class="line">System.out.println(cache.asMap()); <span class="comment">// &#123;k3=33333, k5=5555, k4=4444&#125;</span></span><br></pre></td></tr></table></figure><p></p><p>ä¸Šé¢ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡<code>maximumWeight(15)</code>æŒ‡å®šäº†ç¼“å­˜çš„æœ€å¤§å®¹é‡ï¼Œæƒé‡è§„åˆ™ä¸ºvalueçš„é•¿åº¦ã€‚k3ï¼Œk4å’Œk5çš„valueé•¿åº¦åŠ èµ·æ¥ä¸º13ï¼Œæ‰€ä»¥k1å’Œk2çš„å€¼å­˜ä¸å°äº†ï¼Œè¢«é©±é€ã€‚</p><h3 id="è®¾ç½®ç¼“å­˜æ—¶é—´"><a href="#è®¾ç½®ç¼“å­˜æ—¶é—´" class="headerlink" title="è®¾ç½®ç¼“å­˜æ—¶é—´"></a>è®¾ç½®ç¼“å­˜æ—¶é—´</h3><p>æˆ‘ä»¬å¯ä»¥è®¾ç½®ç¼“å­˜çš„æœ‰æ•ˆæ—¶é—´å’Œç¼“å­˜çš„æ´»è·ƒæ—¶é—´ã€‚</p><p>è®¾ç½®ç¼“å­˜çš„æ´»è·ƒæ—¶é—´ä¸º2sï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Cache&lt;String, String&gt; cache = CacheBuilder.newBuilder().expireAfterAccess(<span class="number">2</span>, TimeUnit.SECONDS).build();</span><br><span class="line"></span><br><span class="line">cache.put(<span class="string">"k1"</span>, <span class="string">"v1"</span>);</span><br><span class="line">cache.put(<span class="string">"k2"</span>, <span class="string">"v2"</span>);</span><br><span class="line"></span><br><span class="line">cache.getIfPresent(<span class="string">"k1"</span>);</span><br><span class="line">TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">cache.getIfPresent(<span class="string">"k1"</span>);</span><br><span class="line">TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">System.out.println(cache.getIfPresent(<span class="string">"k1"</span>)); <span class="comment">// v1</span></span><br><span class="line">System.out.println(cache.getIfPresent(<span class="string">"k2"</span>)); <span class="comment">// null</span></span><br><span class="line">System.out.println(cache.size()); <span class="comment">// 1</span></span><br><span class="line">System.out.println(cache.asMap()); <span class="comment">// &#123;k1=v1&#125;</span></span><br></pre></td></tr></table></figure><p></p><p>ä¸Šé¢ä»£ç ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡<code>cache.getIfPresent(&quot;k1&quot;)</code>è·å–äº†k1çš„å€¼ï¼Œç„¶åè®©çº¿ç¨‹é˜»å¡1ç§’ï¼Œè¿™æ—¶å€™k1å’Œk2çš„æœ‰æ•ˆæ—¶é—´å¤§çº¦ä¸º1ç§’å·¦å³ã€‚æ¥ç€åˆè·å–äº†k1çš„å€¼ï¼Œæ‰€ä»¥k1çš„æœ‰æ•ˆæ—¶é—´è¿˜æ˜¯2ç§’ï¼Œk2ä¸º1ç§’ï¼Œå†æ¬¡è®©çº¿ç¨‹é˜»å¡1ç§’åï¼Œk1çš„æœ‰æ•ˆæ—¶é—´ä¸º1ç§’ï¼Œk2å·²ç»å¤±æ•ˆäº†ã€‚æ‰“å°è¾“å‡ºçš„ç»“æœå’Œæˆ‘ä»¬é¢„æœŸçš„ä¸€è‡´ã€‚</p><p>è®¾ç½®ç¼“å­˜çš„æœ‰æ•ˆæ—¶é—´ä¸º2sï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"> Cache&lt;String, String&gt; cache = CacheBuilder.newBuilder().expireAfterWrite(<span class="number">2</span>, TimeUnit.SECONDS).build();</span><br><span class="line"></span><br><span class="line">cache.put(<span class="string">"k1"</span>, <span class="string">"v1"</span>);</span><br><span class="line">cache.put(<span class="string">"k2"</span>, <span class="string">"v2"</span>);</span><br><span class="line"></span><br><span class="line">cache.getIfPresent(<span class="string">"k1"</span>);</span><br><span class="line">TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">cache.getIfPresent(<span class="string">"k1"</span>);</span><br><span class="line">TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">System.out.println(cache.getIfPresent(<span class="string">"k1"</span>)); <span class="comment">// null</span></span><br><span class="line">System.out.println(cache.getIfPresent(<span class="string">"k2"</span>)); <span class="comment">// null</span></span><br><span class="line">System.out.println(cache.size()); <span class="comment">// 0</span></span><br><span class="line">System.out.println(cache.asMap()); <span class="comment">// &#123;&#125;</span></span><br></pre></td></tr></table></figure><p></p><p>å› ä¸ºæˆ‘ä»¬è®¾ç½®ç¼“å­˜æœ‰æ•ˆæ—¶é—´ä¸º2ç§’ï¼Œæ‰€ä»¥2ç§’åæ‰€æœ‰ç¼“å­˜éƒ½è¿‡æœŸå¤±æ•ˆäº†ï¼Œæ— è®ºæœŸé—´è·å–è¿‡å¤šå°‘æ¬¡ç¼“å­˜ã€‚</p><h3 id="weakKeys-amp-softValues"><a href="#weakKeys-amp-softValues" class="headerlink" title="weakKeys&amp;softValues"></a>weakKeys&amp;softValues</h3><p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒGuavaç¼“å­˜é”®å€¼éƒ½æœ‰å¼ºå¼•ç”¨ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨weakKeyså’ŒsoftValuesæ¥è®©é”®å€¼å˜ä¸ºå¼±å¼•ç”¨ï¼Œè¿™æ ·åƒåœ¾æ”¶é›†å™¨åœ¨å¿…è¦çš„æƒ…å†µä¸‹å°†ä¼šå·¥ä½œï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Cache&lt;String, String&gt; cache = CacheBuilder.newBuilder().weakKeys().softValues().build();</span><br></pre></td></tr></table></figure><p></p><h2 id="åˆ·æ–°ç¼“å­˜"><a href="#åˆ·æ–°ç¼“å­˜" class="headerlink" title="åˆ·æ–°ç¼“å­˜"></a>åˆ·æ–°ç¼“å­˜</h2><p>å¯ä»¥é€šè¿‡<code>refreshAfterWrite</code>è®¾ç½®ç¼“å­˜è‡ªåŠ¨åˆ·æ–°é—´éš”ï¼Œæˆ–è€…å¯ä»¥ç›´æ¥è°ƒç”¨<code>refresh</code>æ–¹æ³•æ¥æ‰‹åŠ¨åˆ·æ–°ç¼“å­˜ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Cache&lt;String, String&gt; cache = CacheBuilder.newBuilder().refreshAfterWrite(<span class="number">1</span>,TimeUnit.SECONDS).build();</span><br></pre></td></tr></table></figure><p></p><h2 id="æ·»åŠ å¤šä¸ªç¼“å­˜"><a href="#æ·»åŠ å¤šä¸ªç¼“å­˜" class="headerlink" title="æ·»åŠ å¤šä¸ªç¼“å­˜"></a>æ·»åŠ å¤šä¸ªç¼“å­˜</h2><p>å¯ä»¥é€šè¿‡<code>putAll</code>æ¥ä¸€æ¬¡æ€§æ·»åŠ å¤šä¸ªç¼“å­˜ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Cache&lt;String, String&gt; cache = CacheBuilder.newBuilder().build();</span><br><span class="line"></span><br><span class="line">Map&lt;String, String&gt; map = Maps.newHashMap();</span><br><span class="line">map.put(<span class="string">"k1"</span>, <span class="string">"v1"</span>);</span><br><span class="line">map.put(<span class="string">"k2"</span>, <span class="string">"v2"</span>);</span><br><span class="line">map.put(<span class="string">"k3"</span>, <span class="string">"v3"</span>);</span><br><span class="line"></span><br><span class="line">cache.putAll(map);</span><br><span class="line">System.out.println(cache.size()); <span class="comment">// 3</span></span><br><span class="line">System.out.println(cache.asMap()); <span class="comment">// &#123;k3=v3, k1=v1, k2=v2&#125;</span></span><br></pre></td></tr></table></figure><p></p><h2 id="åˆ é™¤ç¼“å­˜"><a href="#åˆ é™¤ç¼“å­˜" class="headerlink" title="åˆ é™¤ç¼“å­˜"></a>åˆ é™¤ç¼“å­˜</h2><p><code>Cache.invalidate(key)</code>æ–¹æ³•é€šè¿‡keyæ¥åˆ é™¤ç¼“å­˜ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Cache&lt;String, String&gt; cache = CacheBuilder.newBuilder().build();</span><br><span class="line"></span><br><span class="line">Map&lt;String, String&gt; map = Maps.newHashMap();</span><br><span class="line">map.put(<span class="string">"k1"</span>, <span class="string">"v1"</span>);</span><br><span class="line">cache.putAll(map);</span><br><span class="line"></span><br><span class="line">System.out.println(cache.asMap()); <span class="comment">// &#123;k1=v1&#125;</span></span><br><span class="line">cache.invalidate(<span class="string">"k1"</span>);</span><br><span class="line">System.out.println(cache.asMap()); <span class="comment">// &#123;&#125;</span></span><br></pre></td></tr></table></figure><p></p><p>é™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡<code>Cache.invalidateAll(keys)</code>ä¸€æ¬¡æ€§åˆ é™¤å¤šä¸ªç¼“å­˜æˆ–è€…<code>Cache.invalidateAll()</code>åˆ é™¤å…¨éƒ¨ç¼“å­˜ã€‚</p><p>æˆ‘ä»¬è¿˜å¯ä»¥ç»™åˆ é™¤äº‹ä»¶æ·»åŠ ç›‘å¬å™¨ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">RemovalListener&lt;String, String&gt; listener</span><br><span class="line">                = notification -&gt; System.out.println(<span class="string">"ç›‘å¬åˆ°åˆ é™¤äº‹ä»¶ï¼Œkey="</span> + notification.getKey() + <span class="string">"ï¼Œvalue="</span> + notification.getValue());</span><br><span class="line"></span><br><span class="line">Cache&lt;String, String&gt; cache = CacheBuilder.newBuilder().removalListener(listener).build();</span><br><span class="line">cache.put(<span class="string">"k1"</span>, <span class="string">"v1"</span>);</span><br><span class="line"></span><br><span class="line">cache.invalidate(<span class="string">"k1"</span>); <span class="comment">// ç›‘å¬åˆ°åˆ é™¤äº‹ä»¶ï¼Œkey=k1ï¼Œvalue=v1</span></span><br></pre></td></tr></table></figure><p></p><h2 id="å¢åˆ æ”¹æŸ¥"><a href="#å¢åˆ æ”¹æŸ¥" class="headerlink" title="å¢åˆ æ”¹æŸ¥"></a>å¢åˆ æ”¹æŸ¥</h2><p>ç®€å•å°è£…ä¸€ä¸ªGuavaç¼“å­˜å·¥å…·ç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GuavaCacheUtil</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Logger logger = LoggerFactory.getLogger(GuavaCacheUtil.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Cache&lt;String, String&gt; cache;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        RemovalListener&lt;String, String&gt; listener</span><br><span class="line">                = n -&gt; logger.info(<span class="string">"ç›‘å¬åˆ°åˆ é™¤äº‹ä»¶ï¼Œkey=&#123;&#125;ï¼Œvalue=&#123;&#125;"</span>, n.getKey(), n.getValue());</span><br><span class="line">        cache = CacheBuilder.newBuilder()</span><br><span class="line">                .removalListener(listener).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ·»åŠ ç¼“å­˜</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key   é”®</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value å€¼</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(String key, String value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotBlank(key) &amp;&amp; StringUtils.isNotBlank(value)) &#123;</span><br><span class="line">            cache.put(key, value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ‰¹é‡æ·»åŠ ç¼“å­˜</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> map key,valueé›†åˆ</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">putAll</span><span class="params">(Map&lt;String, String&gt; map)</span> </span>&#123;</span><br><span class="line">        cache.putAll(map);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆ é™¤ç¼“å­˜</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key é”®</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotBlank(key)) &#123;</span><br><span class="line">            cache.invalidate(key);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ‰¹é‡åˆ é™¤ç¼“å­˜</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> keys keyé›†åˆ</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">(List&lt;String&gt; keys)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (CollectionUtils.isNotEmpty(keys)) &#123;</span><br><span class="line">            cache.invalidateAll(keys);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ¸…ç©ºç¼“å­˜</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        cache.invalidateAll();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è·å–ç¼“å­˜</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key é”®</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> å€¼</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">get</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> StringUtils.isNotBlank(key) ? cache.getIfPresent(key) : <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ‰¹é‡è·å–ç¼“å­˜</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> keys é”®é›†åˆ</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> å€¼é›†åˆ</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ImmutableMap&lt;String, String&gt; <span class="title">get</span><span class="params">(List&lt;String&gt; keys)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> CollectionUtils.isNotEmpty(keys) ? cache.getAllPresent(keys) : <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Wed May 15 2019 17:13:43 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;Guavaç¼“å­˜æ˜¯è½»é‡çº§çš„ï¼Œå®ƒå°†å†…å®¹ç¼“å­˜åˆ°è¿è¡Œå†…å­˜ä¸­ã€‚å¦‚æœç³»ç»Ÿä¸­æŸäº›å€¼ï¼ˆæ¯”å¦‚ä¸€äº›é…ç½®è¡¨ï¼‰è¢«é¢‘ç¹æŸ¥è¯¢ä½¿ç”¨ï¼Œå¹¶ä¸”æˆ‘ä»¬æ„¿æ„æ¶ˆè€—ä¸€äº›å†…å­˜ç©ºé—´æ¥æå‡åº”ç”¨çš„é€Ÿåº¦ï¼Œå‡è½»æ•°æ®åº“å‹åŠ›çš„è¯ï¼ŒGuavaç¼“å­˜å°†ä¼šæ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ã€‚ç”±äºç¼“å­˜æ˜¯å­˜å‚¨åœ¨è¿è¡Œå†…å­˜ä¸­çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ç¡®ä¿ç¼“å­˜çš„å¤§å°ä¸è¶…å‡ºå†…å­˜çš„å®¹é‡ã€‚
    
    </summary>
    
    
      <category term="guava" scheme="http://mrbird.cc/tags/guava/"/>
    
  </entry>
  
  <entry>
    <title>Guava é›†åˆæ“ä½œ</title>
    <link href="http://mrbird.cc/Guava-Collection.html"/>
    <id>http://mrbird.cc/Guava-Collection.html</id>
    <published>2019-01-05T06:05:25.000Z</published>
    <updated>2019-04-24T02:10:09.987Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Wed May 15 2019 17:13:45 GMT+0800 (GMT+08:00) --><h2 id="ä¸å¯å˜é›†åˆ"><a href="#ä¸å¯å˜é›†åˆ" class="headerlink" title="ä¸å¯å˜é›†åˆ"></a>ä¸å¯å˜é›†åˆ</h2><p>ä¸å¯å˜é›†åˆä¾‹å­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ImmutableSet&lt;String&gt; FRUITS = ImmutableSet.of(<span class="string">"apple"</span>, <span class="string">"watermelon"</span>, <span class="string">"cherry"</span>, <span class="string">"mango"</span>);</span><br><span class="line">FRUITS.remove(<span class="string">"apple"</span>);</span><br></pre></td></tr></table></figure><p></p><p>å°†æŠ›å‡º<code>java.lang.UnsupportedOperationException</code>å¼‚å¸¸ï¼š<a id="more"></a> <img src="img/febsvue/QQæˆªå›¾20190422144849.png" alt="QQæˆªå›¾20190422144849.png"></p><h3 id="åˆ›å»ºä¸å¯å˜é›†åˆ"><a href="#åˆ›å»ºä¸å¯å˜é›†åˆ" class="headerlink" title="åˆ›å»ºä¸å¯å˜é›†åˆ"></a>åˆ›å»ºä¸å¯å˜é›†åˆ</h3><p><strong>of</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ImmutableList&lt;String&gt; immutableList = ImmutableList.of(<span class="string">"a"</span>, <span class="string">"b"</span>, <span class="string">"c"</span>);</span><br><span class="line">ImmutableMap&lt;Integer, String&gt; immutableMap = ImmutableMap.of(<span class="number">1</span>, <span class="string">"v1"</span>, <span class="number">2</span>, <span class="string">"v2"</span>, <span class="number">3</span>, <span class="string">"v3"</span>)</span><br></pre></td></tr></table></figure><p></p><p><strong>copyOf</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;String, String&gt; map = Maps.newHashMap();</span><br><span class="line">ImmutableMap&lt;String, String&gt; immutableMap = ImmutableMap.copyOf(map);</span><br></pre></td></tr></table></figure><p></p><p><strong>builder</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;String, String&gt; map = Maps.newHashMap();</span><br><span class="line">ImmutableMap&lt;String, String&gt; immutableMap = ImmutableMap.&lt;String, String&gt;builder()</span><br><span class="line">                .putAll(map)</span><br><span class="line">                .put(<span class="string">"k1"</span>, <span class="string">"v1"</span>)</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">List&lt;String&gt; list = Lists.newArrayList();</span><br><span class="line">ImmutableList&lt;String&gt; immutableList = ImmutableList.&lt;String&gt;builder()</span><br><span class="line">                .addAll(list)</span><br><span class="line">                .build();</span><br></pre></td></tr></table></figure><p></p><p>é™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä»Java 8 Streamä¸­åˆ›å»ºä¸å¯å˜é›†åˆï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> java.util.stream.Collectors.*;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">List&lt;String&gt; list = Arrays.asList(<span class="string">"a"</span>, <span class="string">"b"</span>, <span class="string">"c"</span>);</span><br><span class="line">List&lt;String&gt; immutableList = list.stream()</span><br><span class="line">        .collect(collectingAndThen(toList(), ImmutableList::copyOf));</span><br><span class="line"></span><br><span class="line">System.out.println(immutableList.getClass()); <span class="comment">// class com.google.common.collect.RegularImmutableList</span></span><br></pre></td></tr></table></figure><p></p><p>ä¸Šé¢çš„ä¾‹å­æˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨Guavaæä¾›çš„æ”¶é›†å™¨ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">List&lt;String&gt; list = Arrays.asList(<span class="string">"a"</span>, <span class="string">"b"</span>, <span class="string">"c"</span>);</span><br><span class="line">List&lt;String&gt; immutableList = list.stream()</span><br><span class="line">        .collect(ImmutableList.toImmutableList());</span><br><span class="line"></span><br><span class="line">System.out.println(immutableList.getClass()); <span class="comment">// class com.google.common.collect.RegularImmutableList</span></span><br></pre></td></tr></table></figure><p></p><h3 id="ä¸å¯å˜é›†åˆä¼˜ç‚¹"><a href="#ä¸å¯å˜é›†åˆä¼˜ç‚¹" class="headerlink" title="ä¸å¯å˜é›†åˆä¼˜ç‚¹"></a>ä¸å¯å˜é›†åˆä¼˜ç‚¹</h3><ol><li><p>å½“å¯¹è±¡è¢«ä¸å¯ä¿¡çš„åº“è°ƒç”¨æ—¶ï¼Œä¸å¯å˜å½¢å¼æ˜¯å®‰å…¨çš„ï¼›</p></li><li><p>ä¸å¯å˜å¯¹è±¡è¢«å¤šä¸ªçº¿ç¨‹è°ƒç”¨æ—¶ï¼Œä¸å­˜åœ¨ç«æ€æ¡ä»¶é—®é¢˜</p></li><li><p>ä¸å¯å˜é›†åˆä¸éœ€è¦è€ƒè™‘å˜åŒ–ï¼Œå› æ­¤å¯ä»¥èŠ‚çœæ—¶é—´å’Œç©ºé—´ã€‚æ‰€æœ‰ä¸å¯å˜çš„é›†åˆéƒ½æ¯”å®ƒä»¬çš„å¯å˜å½¢å¼æœ‰æ›´å¥½çš„å†…å­˜åˆ©ç”¨ç‡ï¼ˆåˆ†æå’Œæµ‹è¯•ç»†èŠ‚ï¼‰ï¼›</p></li><li><p>ä¸å¯å˜å¯¹è±¡å› ä¸ºæœ‰å›ºå®šä¸å˜ï¼Œå¯ä»¥ä½œä¸ºå¸¸é‡æ¥å®‰å…¨ä½¿ç”¨ã€‚</p></li></ol><h2 id="æ–°é›†åˆç±»å‹"><a href="#æ–°é›†åˆç±»å‹" class="headerlink" title="æ–°é›†åˆç±»å‹"></a>æ–°é›†åˆç±»å‹</h2><p>Guavaæä¾›äº†è®¸å¤šJDKæ²¡æœ‰çš„é›†åˆç±»å‹ã€‚</p><h3 id="RangeSet"><a href="#RangeSet" class="headerlink" title="RangeSet"></a>RangeSet</h3><p>RangeSetä¸€ç»„ä¸ç›¸è¿çš„ã€éç©ºçš„åŒºé—´ï¼ŒåŸºæœ¬å®ç°ä¸ºTreeRangeSetï¼Œçœ‹ä¸ªRangeSetçš„ä¾‹å­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">RangeSet&lt;Integer&gt; rangeSet = TreeRangeSet.create();</span><br><span class="line">rangeSet.add(Range.closed(<span class="number">1</span>, <span class="number">10</span>));</span><br><span class="line">System.out.println(rangeSet); <span class="comment">// [[1..10]]</span></span><br><span class="line"></span><br><span class="line">rangeSet.add(Range.closedOpen(<span class="number">11</span>, <span class="number">15</span>));</span><br><span class="line">System.out.println(rangeSet); <span class="comment">// ä¸ç›¸è¿åŒºé—´ [[1..10], [11..15)]</span></span><br><span class="line"></span><br><span class="line">rangeSet.add(Range.closedOpen(<span class="number">15</span>, <span class="number">20</span>));</span><br><span class="line">System.out.println(rangeSet); <span class="comment">// ç›¸è¿åŒºé—´ [[1..10], [11..20)]</span></span><br><span class="line"></span><br><span class="line">rangeSet.add(Range.openClosed(<span class="number">0</span>, <span class="number">0</span>));</span><br><span class="line">System.out.println(rangeSet); <span class="comment">// ç©ºåŒºé—´ [[1..10], [11..20)]</span></span><br><span class="line"></span><br><span class="line">rangeSet.remove(Range.open(<span class="number">5</span>, <span class="number">10</span>)); </span><br><span class="line">System.out.println(rangeSet); <span class="comment">// åŒºé—´åˆ†å‰² [[1..5], [10..10], [11..20)]</span></span><br></pre></td></tr></table></figure><p></p><p>æŸ¥çœ‹RangeSetçš„èŒƒå›´è·¨åº¦ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">RangeSet&lt;Integer&gt; rangeSet = TreeRangeSet.create();</span><br><span class="line">rangeSet.add(Range.closed(<span class="number">1</span>, <span class="number">10</span>));</span><br><span class="line">rangeSet.add(Range.closedOpen(<span class="number">11</span>, <span class="number">15</span>));</span><br><span class="line"></span><br><span class="line">Range&lt;Integer&gt; span = rangeSet.span();</span><br><span class="line">System.out.println(span.lowerEndpoint().intValue()); <span class="comment">// 1</span></span><br><span class="line">System.out.println(span.upperEndpoint().intValue()); <span class="comment">// 15</span></span><br></pre></td></tr></table></figure><p></p><p>ä»å·²æœ‰çš„RangeSetè·å–ä¸€ä¸ªå­èŒƒå›´RangeSetï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">RangeSet&lt;Integer&gt; numberRangeSet = TreeRangeSet.create();</span><br><span class="line"></span><br><span class="line">numberRangeSet.add(Range.closed(<span class="number">0</span>, <span class="number">2</span>));</span><br><span class="line">numberRangeSet.add(Range.closed(<span class="number">3</span>, <span class="number">5</span>));</span><br><span class="line">numberRangeSet.add(Range.closed(<span class="number">5</span>, <span class="number">8</span>));</span><br><span class="line">RangeSet&lt;Integer&gt; numberSubRangeSet = numberRangeSet.subRangeSet(Range.closed(<span class="number">4</span>, <span class="number">14</span>));</span><br><span class="line"></span><br><span class="line">System.out.println(numberRangeSet); <span class="comment">// [[0..2], [3..8]]</span></span><br><span class="line">System.out.println(numberSubRangeSet); <span class="comment">// [[4..8]]</span></span><br></pre></td></tr></table></figure><p></p><p>è·å–é™¤äº†RangeSetèŒƒå›´å¤–çš„RangeSetï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">RangeSet&lt;Integer&gt; numberRangeSet = TreeRangeSet.create();</span><br><span class="line"></span><br><span class="line">numberRangeSet.add(Range.closed(<span class="number">0</span>, <span class="number">2</span>));</span><br><span class="line">numberRangeSet.add(Range.closed(<span class="number">3</span>, <span class="number">5</span>));</span><br><span class="line">numberRangeSet.add(Range.closed(<span class="number">6</span>, <span class="number">8</span>));</span><br><span class="line">RangeSet&lt;Integer&gt; numberRangeComplementSet = numberRangeSet.complement();</span><br><span class="line"></span><br><span class="line">System.out.println(numberRangeSet); <span class="comment">// [[0..2], [3..5], [6..8]]</span></span><br><span class="line">System.out.println(numberRangeComplementSet); <span class="comment">// [(-âˆ..0), (2..3), (5..6), (8..+âˆ)]</span></span><br></pre></td></tr></table></figure><p></p><p>åˆ¤æ–­ä¸€ä¸ªRangeSetæ˜¯å¦å’Œå¦ä¸€ä¸ªèŒƒå›´æœ‰äº¤é›†ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">RangeSet&lt;Integer&gt; numberRangeSet = TreeRangeSet.create();</span><br><span class="line"></span><br><span class="line">numberRangeSet.add(Range.closed(<span class="number">0</span>, <span class="number">2</span>));</span><br><span class="line">numberRangeSet.add(Range.closed(<span class="number">3</span>, <span class="number">10</span>));</span><br><span class="line">numberRangeSet.add(Range.closed(<span class="number">15</span>, <span class="number">18</span>));</span><br><span class="line"></span><br><span class="line">System.out.println(numberRangeSet); <span class="comment">// [[0..2], [3..10], [15..18]]</span></span><br><span class="line">System.out.println(numberRangeSet.intersects(Range.closed(<span class="number">4</span>, <span class="number">17</span>))); <span class="comment">// true</span></span><br></pre></td></tr></table></figure><p></p><p>éå†RangeSetçš„èŒƒå›´åŒºé—´ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">RangeSet&lt;Integer&gt; numberRangeSet = TreeRangeSet.create();</span><br><span class="line"></span><br><span class="line">numberRangeSet.add(Range.closed(<span class="number">0</span>, <span class="number">2</span>));</span><br><span class="line">numberRangeSet.add(Range.closed(<span class="number">3</span>, <span class="number">10</span>));</span><br><span class="line">numberRangeSet.add(Range.closed(<span class="number">15</span>, <span class="number">18</span>));</span><br><span class="line"></span><br><span class="line">Set&lt;Range&lt;Integer&gt;&gt; ranges = numberRangeSet.asRanges();</span><br><span class="line">ranges.forEach(System.out::print); <span class="comment">// [0..2][3..10][15..18]</span></span><br></pre></td></tr></table></figure><p></p><p>ä»RangeSetä¸­è·å–åŒ…å«æŸä¸ªå€¼çš„è®¿é—®åŒºé—´ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">RangeSet&lt;Integer&gt; numberRangeSet = TreeRangeSet.create();</span><br><span class="line"></span><br><span class="line">numberRangeSet.add(Range.closed(<span class="number">0</span>, <span class="number">2</span>));</span><br><span class="line">numberRangeSet.add(Range.closed(<span class="number">3</span>, <span class="number">10</span>));</span><br><span class="line">numberRangeSet.add(Range.closed(<span class="number">15</span>, <span class="number">18</span>));</span><br><span class="line"></span><br><span class="line">System.out.println(numberRangeSet.rangeContaining(<span class="number">7</span>)); <span class="comment">// [3..10]</span></span><br></pre></td></tr></table></figure><p></p><h3 id="RangeMap"><a href="#RangeMap" class="headerlink" title="RangeMap"></a>RangeMap</h3><p>RangeMapæ˜¯ä¸€ç»„ä¸ç›¸è¿çš„ã€éç©ºçš„åŒºé—´ä¸æŒ‡å®šå€¼çš„æ˜ å°„ï¼ŒåŸºæœ¬å®ç°ä¸ºTreeRangeMapå…‰è¿™æ ·è¯´æœ‰ç‚¹æŠ½è±¡ï¼Œçœ‹äº›ä¾‹å­:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">RangeMap&lt;Integer, String&gt; rangeMap = TreeRangeMap.create();</span><br><span class="line">rangeMap.put(Range.closed(<span class="number">1</span>, <span class="number">10</span>), <span class="string">"foo"</span>);</span><br><span class="line">System.out.println(rangeMap); <span class="comment">// [[1..10]=foo]</span></span><br><span class="line"></span><br><span class="line">rangeMap.put(Range.open(<span class="number">3</span>, <span class="number">6</span>), <span class="string">"bar"</span>);</span><br><span class="line">System.out.println(rangeMap); <span class="comment">// [[1..3]=foo, (3..6)=bar, [6..10]=foo]</span></span><br><span class="line"></span><br><span class="line">rangeMap.put(Range.open(<span class="number">10</span>, <span class="number">20</span>), <span class="string">"eoo"</span>);</span><br><span class="line">System.out.println(rangeMap); <span class="comment">// [[1..3]=foo, (3..6)=bar, [6..10]=foo, (10..20)=eoo]</span></span><br><span class="line"></span><br><span class="line">rangeMap.remove(Range.closed(<span class="number">5</span>, <span class="number">11</span>));</span><br><span class="line">System.out.println(rangeMap); <span class="comment">// [[1..3]=foo, (3..5)=bar, (11..20)=eoo]</span></span><br></pre></td></tr></table></figure><p></p><p>ä»RangeMapä¸­è·å–ä¸€ä¸ªEntryï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">RangeMap&lt;Integer, String&gt; rangeMap = TreeRangeMap.create();</span><br><span class="line"></span><br><span class="line">rangeMap.put(Range.closed(<span class="number">0</span>, <span class="number">2</span>), <span class="string">"foo"</span>);</span><br><span class="line">rangeMap.put(Range.closed(<span class="number">3</span>, <span class="number">5</span>), <span class="string">"bar"</span>);</span><br><span class="line">rangeMap.put(Range.closed(<span class="number">6</span>, <span class="number">8</span>), <span class="string">"eoo"</span>);</span><br><span class="line">Map.Entry&lt;Range&lt;Integer&gt;, String&gt; entry = rangeMap.getEntry(<span class="number">7</span>);</span><br><span class="line"></span><br><span class="line">System.out.println(entry.getKey()); <span class="comment">// [6..8]</span></span><br><span class="line">System.out.println(entry.getValue()); <span class="comment">// eoo</span></span><br></pre></td></tr></table></figure><p></p><p>å‰©ä¸‹çš„æ“ä½œå’ŒRangeSetå·®ä¸å¤šã€‚</p><h3 id="BiMap"><a href="#BiMap" class="headerlink" title="BiMap"></a>BiMap</h3><p>BiMapæ˜¯ä¸€ç§ç‰¹æ®Šçš„ï¼ŒåŒå‘æ˜ å°„çš„Mapï¼Œå¯ä»¥ç¡®ä¿ä¸ä¼šå‡ºç°é‡å¤çš„å€¼å¹¶ä¸”æˆ‘ä»¬æ€»æ˜¯å¯ä»¥å®‰å…¨åœ°é€šè¿‡keyè·å–åˆ°valueã€‚BiMapçš„åŸºæœ¬å®ç°ä¸ºHashBiMapã€‚</p><p>çœ‹çœ‹ä¾‹å­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">BiMap&lt;String, String&gt; biMap = HashBiMap.create();</span><br><span class="line">biMap.put(<span class="string">"k1"</span>, <span class="string">"v1"</span>);</span><br><span class="line">biMap.put(<span class="string">"k2"</span>, <span class="string">"v2"</span>);</span><br><span class="line">biMap.put(<span class="string">"k3"</span>, <span class="string">"v3"</span>);</span><br><span class="line">System.out.println(biMap); <span class="comment">// &#123;k1=v1, k2=v2, k3=v3&#125;</span></span><br><span class="line"></span><br><span class="line">BiMap&lt;String, String&gt; inverse = biMap.inverse();</span><br><span class="line">System.out.println(inverse); <span class="comment">// &#123;v1=k1, v2=k2, v3=k3&#125;</span></span><br></pre></td></tr></table></figure><p></p><p>é€šè¿‡<code>inverse</code>å¯ä»¥å¾—åˆ°å€¼ï¼Œé”®æ˜ å°„çš„BiMapã€‚</p><p>å¾€BiMapé‡Œæ·»åŠ é‡å¤çš„å€¼å°†ä¼šæŠ¥é”™ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">BiMap&lt;String, String&gt; biMap = HashBiMap.create();</span><br><span class="line">biMap.put(<span class="string">"k1"</span>, <span class="string">"v1"</span>);</span><br><span class="line">biMap.put(<span class="string">"k2"</span>, <span class="string">"v2"</span>);</span><br><span class="line">biMap.put(<span class="string">"k3"</span>, <span class="string">"v1"</span>);</span><br></pre></td></tr></table></figure><p><img src="img/QQæˆªå›¾20190422172835.png" alt="QQæˆªå›¾20190422172835.png"></p><p>å¦‚æœéè¦æ·»åŠ é‡å¤çš„å€¼çš„è¯ï¼Œå¯ä»¥ç”¨<code>forcePut</code>æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">BiMap&lt;String, String&gt; biMap = HashBiMap.create();</span><br><span class="line">biMap.put(<span class="string">"k1"</span>, <span class="string">"v1"</span>);</span><br><span class="line">biMap.put(<span class="string">"k2"</span>, <span class="string">"v2"</span>);</span><br><span class="line">biMap.forcePut(<span class="string">"k3"</span>, <span class="string">"v1"</span>);</span><br><span class="line">System.out.println(biMap); <span class="comment">// &#123;k2=v2, k3=v1&#125;</span></span><br></pre></td></tr></table></figure><p></p><h3 id="Table"><a href="#Table" class="headerlink" title="Table"></a>Table</h3><p>Tableæ˜¯ä¸€ä¸ªåŒ…å«è¡Œï¼Œåˆ—å’Œå•å…ƒæ ¼çš„é›†åˆç±»å‹ï¼Œè¡Œå’Œåˆ—ç»„æˆæœ‰åºé”®å¯¹ã€‚</p><p>åˆ›å»ºä¸€ä¸ªHashBasedTableï¼ˆå†…éƒ¨ä½¿ç”¨LinkedHashMapï¼‰ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Table&lt;String, String, Integer&gt; hashBasedTable = HashBasedTable.create();</span><br></pre></td></tr></table></figure><p></p><p>å¦‚æœéœ€è¦å¯¹tableçš„è¡Œå’Œåˆ—æŒ‰ç…§è‡ªç„¶é¡ºåºæˆ–è€…æä¾›çš„æ’åºè§„åˆ™è¿›è¡Œæ’åºçš„è¯ï¼Œå¯ä»¥åˆ›å»ºä¸€ä¸ªTreeBasedTableï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Table&lt;String, String, Integer&gt; treeBasedTable = TreeBasedTable.create();</span><br></pre></td></tr></table></figure><p></p><p>å¦‚æœäº‹å…ˆçŸ¥é“è¡Œå’Œåˆ—çš„å€¼ï¼Œå¹¶ä¸”tableå¤§å°æ˜¯å›ºå®šçš„è¯ï¼Œå¯ä»¥ä½¿ç”¨ArrayTableï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">List&lt;String&gt; row = Lists.newArrayList(<span class="string">"r1"</span>, <span class="string">"r2"</span>);</span><br><span class="line">List&lt;String&gt; column = Lists.newArrayList(<span class="string">"c1"</span>, <span class="string">"c2"</span>, <span class="string">"c3"</span>);</span><br><span class="line">Table&lt;String, String, Integer&gt; arrayTable = ArrayTable.create(row, column);</span><br><span class="line">System.out.println(arrayTable); <span class="comment">// &#123;r1=&#123;c1=null, c2=null, c3=null&#125;, r2=&#123;c1=null, c2=null, c3=null&#125;&#125;</span></span><br></pre></td></tr></table></figure><p></p><p>ä¸Šé¢ä¾‹å­åˆ›å»ºäº†ä¸€ä¸ªä¸¤è¡Œä¸‰åˆ—çš„tableã€‚</p><p>åˆ›å»ºä¸å¯å˜tableï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Table&lt;String, String, String&gt; immutableTable = ImmutableTable.&lt;String, String, String&gt; builder()</span><br><span class="line">        .put(<span class="string">"r1"</span>, <span class="string">"c1"</span>, <span class="string">"hello"</span>)</span><br><span class="line">        .build();</span><br></pre></td></tr></table></figure><p></p><p>é€šè¿‡è¡Œå’Œåˆ—è·å–å•å…ƒæ ¼çš„å€¼ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Table&lt;String, String, String&gt; hashBasedTable = HashBasedTable.create();</span><br><span class="line">hashBasedTable.put(<span class="string">"r1"</span>, <span class="string">"c1"</span>, <span class="string">"hello"</span>);</span><br><span class="line">hashBasedTable.put(<span class="string">"r1"</span>, <span class="string">"c2"</span>, <span class="string">"world"</span>);</span><br><span class="line">hashBasedTable.put(<span class="string">"r2"</span>, <span class="string">"c1"</span>, <span class="string">"good"</span>);</span><br><span class="line">hashBasedTable.put(<span class="string">"r2"</span>, <span class="string">"c2"</span>, <span class="string">"bye"</span>);</span><br><span class="line"></span><br><span class="line">System.out.println(hashBasedTable); <span class="comment">// &#123;r1=&#123;c1=hello, c2=world&#125;, r2=&#123;c1=good, c2=bye&#125;&#125;</span></span><br><span class="line"></span><br><span class="line">String v1 = hashBasedTable.get(<span class="string">"r1"</span>, <span class="string">"c1"</span>);</span><br><span class="line">String v2 = hashBasedTable.get(<span class="string">"r2"</span>, <span class="string">"c3"</span>);</span><br><span class="line"></span><br><span class="line">System.out.println(v1); <span class="comment">// hello</span></span><br><span class="line">System.out.println(v2); <span class="comment">// null</span></span><br></pre></td></tr></table></figure><p></p><p>æˆ‘ä»¬å¯ä»¥æ£€æµ‹tableæ˜¯å¦åŒ…å«æŸä¸ªè¡Œé”®ï¼ŒæŸä¸ªåˆ—é”®ï¼ŒæŸä¸ªå€¼å’ŒæŸä¸ªè¡Œå’Œåˆ—ç»„åˆçš„é”®ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Table&lt;String, String, String&gt; hashBasedTable = HashBasedTable.create();</span><br><span class="line">hashBasedTable.put(<span class="string">"r1"</span>, <span class="string">"c1"</span>, <span class="string">"hello"</span>);</span><br><span class="line">hashBasedTable.put(<span class="string">"r1"</span>, <span class="string">"c2"</span>, <span class="string">"world"</span>);</span><br><span class="line">hashBasedTable.put(<span class="string">"r2"</span>, <span class="string">"c1"</span>, <span class="string">"good"</span>);</span><br><span class="line">hashBasedTable.put(<span class="string">"r2"</span>, <span class="string">"c2"</span>, <span class="string">"bye"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">boolean</span> b1 = hashBasedTable.contains(<span class="string">"r1"</span>, <span class="string">"c2"</span>); <span class="comment">// true</span></span><br><span class="line"><span class="keyword">boolean</span> b2 = hashBasedTable.containsColumn(<span class="string">"c3"</span>); <span class="comment">// false</span></span><br><span class="line"><span class="keyword">boolean</span> b3 = hashBasedTable.containsRow(<span class="string">"r2"</span>); <span class="comment">// true</span></span><br><span class="line"><span class="keyword">boolean</span> b4 = hashBasedTable.containsValue(<span class="string">"world"</span>); <span class="comment">// true</span></span><br></pre></td></tr></table></figure><p></p><p>é€šè¿‡è¡Œå’Œåˆ—åˆ é™¤å•å…ƒæ ¼ï¼Œè¿”å›è¢«åˆ é™¤çš„å€¼ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Table&lt;String, String, String&gt; hashBasedTable = HashBasedTable.create();</span><br><span class="line">hashBasedTable.put(<span class="string">"r1"</span>, <span class="string">"c1"</span>, <span class="string">"hello"</span>);</span><br><span class="line">hashBasedTable.put(<span class="string">"r1"</span>, <span class="string">"c2"</span>, <span class="string">"world"</span>);</span><br><span class="line">hashBasedTable.put(<span class="string">"r2"</span>, <span class="string">"c1"</span>, <span class="string">"good"</span>);</span><br><span class="line">hashBasedTable.put(<span class="string">"r2"</span>, <span class="string">"c2"</span>, <span class="string">"bye"</span>);</span><br><span class="line"></span><br><span class="line">String removeValue = hashBasedTable.remove(<span class="string">"r1"</span>, <span class="string">"c1"</span>);</span><br><span class="line"></span><br><span class="line">System.out.println(removeValue); <span class="comment">// hello</span></span><br><span class="line">System.out.println(hashBasedTable); <span class="comment">// &#123;r1=&#123;c2=world&#125;, r2=&#123;c1=good, c2=bye&#125;&#125;</span></span><br></pre></td></tr></table></figure><p></p><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡è¡Œæˆ–åˆ—å¾—åˆ°ä¸€ä¸ªMapï¼Œå¦‚æœé€šè¿‡è¡Œå¾—åˆ°Mapï¼Œé‚£ä¹ˆMapçš„é”®ä¸ºåˆ—å€¼ï¼ŒMapçš„å€¼ä¸ºå¯¹åº”å•å…ƒæ ¼çš„å€¼ï¼Œå…‰è¯´æœ‰ç‚¹æŠ½è±¡ï¼Œçœ‹ä¸ªä¾‹å­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Table&lt;String, String, String&gt; hashBasedTable = HashBasedTable.create();</span><br><span class="line">hashBasedTable.put(<span class="string">"r1"</span>, <span class="string">"c1"</span>, <span class="string">"hello"</span>);</span><br><span class="line">hashBasedTable.put(<span class="string">"r1"</span>, <span class="string">"c2"</span>, <span class="string">"world"</span>);</span><br><span class="line">hashBasedTable.put(<span class="string">"r2"</span>, <span class="string">"c1"</span>, <span class="string">"good"</span>);</span><br><span class="line">hashBasedTable.put(<span class="string">"r2"</span>, <span class="string">"c2"</span>, <span class="string">"bye"</span>);</span><br><span class="line"></span><br><span class="line">Map&lt;String, String&gt; c2Map = hashBasedTable.column(<span class="string">"c2"</span>);</span><br><span class="line">Map&lt;String, String&gt; r1Map = hashBasedTable.row(<span class="string">"r1"</span>);</span><br><span class="line"></span><br><span class="line">System.out.println(c2Map); <span class="comment">// &#123;r1=world, r2=bye&#125;</span></span><br><span class="line">System.out.println(r1Map); <span class="comment">// &#123;c1=hello, c2=world&#125;</span></span><br><span class="line">System.out.println(c2Map.get(<span class="string">"r1"</span>)); <span class="comment">// world</span></span><br></pre></td></tr></table></figure><p></p><p>æˆ‘ä»¬è¿˜å¯ä»¥å•ç‹¬è·å–æ‰€æœ‰è¡Œæˆ–è€…æ‰€æœ‰åˆ—ç»„æˆçš„Mapï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Table&lt;String, String, String&gt; hashBasedTable = HashBasedTable.create();</span><br><span class="line">hashBasedTable.put(<span class="string">"r1"</span>, <span class="string">"c1"</span>, <span class="string">"hello"</span>);</span><br><span class="line">hashBasedTable.put(<span class="string">"r1"</span>, <span class="string">"c2"</span>, <span class="string">"world"</span>);</span><br><span class="line">hashBasedTable.put(<span class="string">"r2"</span>, <span class="string">"c1"</span>, <span class="string">"good"</span>);</span><br><span class="line">hashBasedTable.put(<span class="string">"r2"</span>, <span class="string">"c2"</span>, <span class="string">"bye"</span>);</span><br><span class="line"></span><br><span class="line">Map&lt;String, Map&lt;String, String&gt;&gt; columnMap = hashBasedTable.columnMap();</span><br><span class="line">Map&lt;String, Map&lt;String, String&gt;&gt; rowMap = hashBasedTable.rowMap();</span><br><span class="line"></span><br><span class="line">System.out.println(columnMap); <span class="comment">// &#123;c1=&#123;r1=hello, r2=good&#125;, c2=&#123;r1=world, r2=bye&#125;&#125;</span></span><br><span class="line">System.out.println(rowMap); <span class="comment">// &#123;r1=&#123;c1=hello, c2=world&#125;, r2=&#123;c1=good, c2=bye&#125;&#125;</span></span><br></pre></td></tr></table></figure><p></p><p>è·å–æ‰€æœ‰è¡Œé”®ã€åˆ—é”®æˆ–è€…å€¼çš„é›†åˆï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Table&lt;String, String, String&gt; hashBasedTable = HashBasedTable.create();</span><br><span class="line">hashBasedTable.put(<span class="string">"r1"</span>, <span class="string">"c1"</span>, <span class="string">"hello"</span>);</span><br><span class="line">hashBasedTable.put(<span class="string">"r1"</span>, <span class="string">"c2"</span>, <span class="string">"world"</span>);</span><br><span class="line">hashBasedTable.put(<span class="string">"r2"</span>, <span class="string">"c1"</span>, <span class="string">"good"</span>);</span><br><span class="line">hashBasedTable.put(<span class="string">"r2"</span>, <span class="string">"c2"</span>, <span class="string">"bye"</span>);</span><br><span class="line"></span><br><span class="line">Set&lt;String&gt; rowKeySet = hashBasedTable.rowKeySet();</span><br><span class="line">Set&lt;String&gt; columnKeySet = hashBasedTable.columnKeySet();</span><br><span class="line">Set&lt;Table.Cell&lt;String, String, String&gt;&gt; cells = hashBasedTable.cellSet();</span><br><span class="line"></span><br><span class="line">System.out.println(rowKeySet); <span class="comment">// [r1, r2]</span></span><br><span class="line">System.out.println(columnKeySet); <span class="comment">// [c1, c2]</span></span><br><span class="line">System.out.println(cells); <span class="comment">// [(r1,c1)=hello, (r1,c2)=world, (r2,c1)=good, (r2,c2)=bye]</span></span><br></pre></td></tr></table></figure><p></p><h3 id="Multiset"><a href="#Multiset" class="headerlink" title="Multiset"></a>Multiset</h3><p>Multisetå’Œjava.util.setç±»ä¼¼ï¼Œä¸è¿‡Mutisetå¯ä»¥æ·»åŠ é‡å¤çš„å€¼ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">HashMultiset&lt;String&gt; hashMultiset = HashMultiset.create();</span><br><span class="line">hashMultiset.add(<span class="string">"are you ok?"</span>);</span><br><span class="line">hashMultiset.add(<span class="string">"are you ok?"</span>);</span><br><span class="line">hashMultiset.add(<span class="string">"are you ok?"</span>);</span><br><span class="line"></span><br><span class="line">System.out.println(hashMultiset); <span class="comment">// [are you ok? x 3]</span></span><br><span class="line"></span><br><span class="line">hashMultiset.remove(<span class="string">"are you ok?"</span>);</span><br><span class="line">System.out.println(hashMultiset); <span class="comment">// [are you ok? x 2]</span></span><br><span class="line"></span><br><span class="line">hashMultiset.setCount(<span class="string">"are you ok?"</span>, <span class="number">10</span>); <span class="comment">// ç›´æ¥è®¾ç½®å…ƒç´ ä¸ªæ•°</span></span><br><span class="line">System.out.println(hashMultiset); <span class="comment">// [are you ok? x 10]</span></span><br></pre></td></tr></table></figure><p></p><p>åœ¨å¹¶å‘ç¯å¢ƒä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ConcurrentHashMultisetï¼Œå®ƒçš„addå’Œremoveæ–¹æ³•æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚å”¯ä¸€å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œåœ¨å¹¶å‘ç¯å¢ƒä¸‹ä½¿ç”¨setCountæ–¹æ³•æ—¶å€™ï¼Œéœ€ä½¿ç”¨ä¸‹é¢è¿™ç§æ–¹å¼ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">HashMultiset&lt;String&gt; hashMultiset = HashMultiset.create();</span><br><span class="line">hashMultiset.setCount(<span class="string">"are you ok?"</span>, <span class="number">0</span>, <span class="number">5</span>);</span><br><span class="line">hashMultiset.setCount(<span class="string">"are you ok?"</span>, <span class="number">10</span>, <span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">System.out.println(hashMultiset); <span class="comment">// [are you ok? x 5]</span></span><br></pre></td></tr></table></figure><p></p><p>ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºéœ€è¦æ·»åŠ çš„å€¼ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸ºå½“å‰Multiseté‡Œå…ƒç´ ä¸ªæ•°ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°ä¸ºéœ€è¦æ·»åŠ çš„å…ƒç´ ä¸ªæ•°ã€‚åªæœ‰ç¬¬äºŒä¸ªå‚æ•°çš„å€¼æ­£ç¡®çš„æ—¶å€™ï¼ŒsetCountæ‰æœ‰æ•ˆï¼Œæ‰€ä»¥<code>hashMultiset.setCount(&quot;are you ok?&quot;, 10, 5)</code>å®é™…ä¸Šæ˜¯ä¸ç”Ÿæ•ˆçš„ã€‚</p><h3 id="Multimap"><a href="#Multimap" class="headerlink" title="Multimap"></a>Multimap</h3><p>Multimapå¯ä»¥é€šè¿‡ä¸€ä¸ªé”®æ˜ å°„å¤šä¸ªå€¼ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">String key = <span class="string">"hello"</span>;</span><br><span class="line">ArrayListMultimap&lt;String, String&gt; multimap = ArrayListMultimap.create();</span><br><span class="line">multimap.put(key, <span class="string">"world"</span>);</span><br><span class="line">multimap.put(key, <span class="string">"java"</span>);</span><br><span class="line"></span><br><span class="line">System.out.println(multimap); <span class="comment">// &#123;hello=[world, java]&#125;</span></span><br><span class="line">System.out.println(multimap.get(key)); <span class="comment">// [world, java]</span></span><br></pre></td></tr></table></figure><p></p><h3 id="ClassToInstanceMap"><a href="#ClassToInstanceMap" class="headerlink" title="ClassToInstanceMap"></a>ClassToInstanceMap</h3><p>ä½¿ç”¨ç±»å‹ä½œä¸ºé”®ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">MutableClassToInstanceMap&lt;Object&gt; classToInstanceMap = MutableClassToInstanceMap.create();</span><br><span class="line">classToInstanceMap.put(String.class, <span class="string">"hello"</span>);</span><br><span class="line">classToInstanceMap.put(Integer.class, <span class="number">777</span>);</span><br><span class="line">classToInstanceMap.put(Double.class, <span class="number">43.96</span>);</span><br><span class="line"></span><br><span class="line">System.out.println(classToInstanceMap); <span class="comment">// &#123;class java.lang.Double=43.96, class java.lang.String=hello, class java.lang.Integer=777&#125;</span></span><br><span class="line">System.out.println(classToInstanceMap.get(Double.class)); <span class="comment">// 43.96</span></span><br></pre></td></tr></table></figure><p></p><h2 id="Listsã€Maps-amp-Sets"><a href="#Listsã€Maps-amp-Sets" class="headerlink" title="Listsã€Maps&amp;Sets"></a>Listsã€Maps&amp;Sets</h2><h3 id="Lists"><a href="#Lists" class="headerlink" title="Lists"></a>Lists</h3><p>åˆ›å»ºä¸€ä¸ªListï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ArrayList&lt;String&gt; list = Lists.newArrayList(<span class="string">"a"</span>, <span class="string">"b"</span>, <span class="string">"c"</span>);</span><br></pre></td></tr></table></figure><p></p><p>åè½¬Listï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ArrayList&lt;String&gt; list = Lists.newArrayList(<span class="string">"a"</span>, <span class="string">"b"</span>, <span class="string">"c"</span>);</span><br><span class="line"></span><br><span class="line">List&lt;String&gt; reverse = Lists.reverse(list);</span><br><span class="line">System.out.println(reverse); <span class="comment">// [c, b, a]</span></span><br></pre></td></tr></table></figure><p></p><p>é€šè¿‡å­—ç¬¦ä¸²ç”Ÿæˆå­—ç¬¦é›†åˆï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Character&gt; characters = Lists.charactersOf(<span class="string">"mrbird"</span>);</span><br><span class="line">System.out.println(characters); <span class="comment">// [m, r, b, i, r, d]</span></span><br></pre></td></tr></table></figure><p></p><p>å°†é›†åˆæŒ‰ç…§æŒ‡å®šåŒºå—å¤§å°åˆ†åŒºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">List&lt;String&gt; list = Lists.newArrayList(<span class="string">"java"</span>, <span class="string">"php"</span>, <span class="string">"go"</span>, <span class="string">"python"</span>, <span class="string">"c#"</span>, <span class="string">"javascript"</span>);</span><br><span class="line">List&lt;List&lt;String&gt;&gt; partition = Lists.partition(list, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">System.out.println(partition); <span class="comment">// [[java, php], [go, python], [c#, javascript]]</span></span><br></pre></td></tr></table></figure><p></p><p>ä¸€ä¸ªåˆ é™¤Listä¸­é‡å¤é¡¹çš„æŠ€å·§ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">List&lt;String&gt; list = Lists.newArrayList(<span class="string">"a"</span>, <span class="string">"p"</span>, <span class="string">"p"</span>, <span class="string">"l"</span>, <span class="string">"e"</span>);</span><br><span class="line"></span><br><span class="line">ImmutableList&lt;String&gt; newList = ImmutableSet.copyOf(list).asList();</span><br><span class="line">System.out.println(newList); <span class="comment">// [a, p, l, e]</span></span><br></pre></td></tr></table></figure><p></p><p>ä»é›†åˆä¸­åˆ é™¤nullå€¼ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">List&lt;String&gt; list = Lists.newArrayList(<span class="string">"java"</span>, <span class="keyword">null</span>,<span class="string">" python"</span>);</span><br><span class="line"></span><br><span class="line">Iterables.removeIf(list, Objects::isNull);</span><br><span class="line">System.out.println(list); <span class="comment">// [java, python]</span></span><br></pre></td></tr></table></figure><p></p><h3 id="Sets"><a href="#Sets" class="headerlink" title="Sets"></a>Sets</h3><p>é€šè¿‡Setsåˆ›å»ºsetï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Set&lt;Object&gt; hashSet = Sets.newHashSet();</span><br></pre></td></tr></table></figure><p></p><p>åˆå¹¶ä¸¤ä¸ªSetï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Set&lt;String&gt; set1 = ImmutableSet.of(<span class="string">"a"</span>, <span class="string">"b"</span>, <span class="string">"c"</span>);</span><br><span class="line">Set&lt;String&gt; set2 = ImmutableSet.of(<span class="string">"b"</span>, <span class="string">"c"</span>, <span class="string">"d"</span>);</span><br><span class="line"></span><br><span class="line">Set&lt;String&gt; union = Sets.union(set1, set2);</span><br><span class="line">System.out.println(union); <span class="comment">// [a, b, c, d]</span></span><br></pre></td></tr></table></figure><p></p><p>å¯ä»¥é€šè¿‡<code>Sets.cartesianProduct()</code>è·å–ä¸¤ä¸ªSetçš„ç¬›å¡å°”ç§¯ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Set&lt;Character&gt; first = ImmutableSet.of(<span class="string">'a'</span>, <span class="string">'b'</span>);</span><br><span class="line">Set&lt;Character&gt; second = ImmutableSet.of(<span class="string">'c'</span>, <span class="string">'d'</span>);</span><br><span class="line">Set&lt;List&lt;Character&gt;&gt; result = Sets.cartesianProduct(first, second);</span><br><span class="line"></span><br><span class="line">System.out.println(result); <span class="comment">// [[a, c], [a, d], [b, c], [b, d]]</span></span><br></pre></td></tr></table></figure><p></p><p>è·å–ä¸¤ä¸ªSetçš„äº¤é›†ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Set&lt;Character&gt; first = ImmutableSet.of(<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>);</span><br><span class="line">Set&lt;Character&gt; second = ImmutableSet.of(<span class="string">'c'</span>, <span class="string">'d'</span>, <span class="string">'e'</span>);</span><br><span class="line">Set&lt;Character&gt; intersection = Sets.intersection(first, second);</span><br><span class="line"></span><br><span class="line">System.out.println(intersection); <span class="comment">// [c]</span></span><br></pre></td></tr></table></figure><p></p><p>è·å–ä¸¤ä¸ªSetçš„å·®é›†ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Set&lt;Character&gt; first = ImmutableSet.of(<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>);</span><br><span class="line">Set&lt;Character&gt; second = ImmutableSet.of(<span class="string">'c'</span>, <span class="string">'d'</span>, <span class="string">'e'</span>);</span><br><span class="line">Set&lt;Character&gt; difference = Sets.symmetricDifference(first, second);</span><br><span class="line"></span><br><span class="line">System.out.println(difference); <span class="comment">// [a, b, d, e]</span></span><br></pre></td></tr></table></figure><p></p><h3 id="Maps"><a href="#Maps" class="headerlink" title="Maps"></a>Maps</h3><p>é€šè¿‡Mapsåˆ›å»ºMapï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HashMap&lt;Object, Object&gt; map = Maps.newHashMap();</span><br></pre></td></tr></table></figure><p></p><p>åˆ›å»ºæœŸæœ›å¤§å°çš„Mapï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HashMap&lt;Object, Object&gt; map = Maps.newHashMapWithExpectedSize(<span class="number">5</span>);</span><br></pre></td></tr></table></figure><p></p><h2 id="Joinerä¸Splitter"><a href="#Joinerä¸Splitter" class="headerlink" title="Joinerä¸Splitter"></a>Joinerä¸Splitter</h2><h3 id="Joiner"><a href="#Joiner" class="headerlink" title="Joiner"></a>Joiner</h3><p>Joinerç”¨äºè¿æ¥æ“ä½œã€‚æ¯”å¦‚å°†Listé‡Œçš„å…ƒç´ é€šè¿‡â€œ,â€è¿æ¥æˆä¸€ä¸ªå­—ç¬¦ä¸²ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">List&lt;String&gt; list = Lists.newArrayList(<span class="string">"a"</span>, <span class="string">"b"</span>, <span class="string">"c"</span>);</span><br><span class="line">String join = Joiner.on(<span class="string">","</span>).join(list);</span><br><span class="line"></span><br><span class="line">System.out.println(join); <span class="comment">// a,b,c</span></span><br></pre></td></tr></table></figure><p></p><p>ä½¿ç”¨Joinerå°†Mapè½¬æ¢ä¸ºStringï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">HashMap&lt;String, Integer&gt; map = Maps.newHashMap();</span><br><span class="line">map.put(<span class="string">"mrbird"</span>, <span class="number">18</span>);</span><br><span class="line">map.put(<span class="string">"scott"</span>, <span class="number">28</span>);</span><br><span class="line"></span><br><span class="line">String join = Joiner.on(<span class="string">","</span>).withKeyValueSeparator(<span class="string">"~"</span>).join(map);</span><br><span class="line">System.out.println(join); <span class="comment">// mrbird~18,scott~28</span></span><br></pre></td></tr></table></figure><p></p><p>åœ¨ä½¿ç”¨Joinerçš„æ—¶å€™ï¼Œå¦‚æœé›†åˆä¸­å«æœ‰nullå€¼ï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©è·³è¿‡å®ƒï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">List&lt;String&gt; list = Lists.newArrayList(<span class="string">"a"</span>, <span class="keyword">null</span>, <span class="string">"b"</span>, <span class="string">"c"</span>, <span class="string">"d"</span>);</span><br><span class="line">String result = Joiner.on(<span class="string">","</span>).skipNulls().join(list);</span><br><span class="line"></span><br><span class="line">System.out.println(result); <span class="comment">// a,b,c,d</span></span><br></pre></td></tr></table></figure><p></p><p>æˆ–è€…ä½¿ç”¨æŒ‡å®šå€¼æ›¿ä»£nullï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">List&lt;String&gt; list = Lists.newArrayList(<span class="string">"a"</span>, <span class="keyword">null</span>, <span class="string">"b"</span>, <span class="string">"c"</span>, <span class="string">"d"</span>);</span><br><span class="line">String result = Joiner.on(<span class="string">","</span>).useForNull(<span class="string">"ç©º"</span>).join(list);</span><br><span class="line"></span><br><span class="line">System.out.println(result); <span class="comment">// a,ç©º,b,c,d</span></span><br></pre></td></tr></table></figure><p></p><h3 id="Splitter"><a href="#Splitter" class="headerlink" title="Splitter"></a>Splitter</h3><p>Splitterç”¨äºå°†Stringæ‹†åˆ†ä¸ºé›†åˆç±»å‹ï¼Œçœ‹ä¸ªä¾‹å­:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">String value = <span class="string">"a,b,c,d      "</span>;</span><br><span class="line">List&lt;String&gt; list = Splitter.on(<span class="string">","</span>).trimResults().splitToList(value);</span><br><span class="line"></span><br><span class="line">System.out.println(list); <span class="comment">// [a, b, c, d]</span></span><br></pre></td></tr></table></figure><p></p><p>ä½¿ç”¨Splitterå°†Stringæ‹†åˆ†ä¸ºMapï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> String value = <span class="string">"mrbird=18,scott=28"</span>;</span><br><span class="line">Map&lt;String, String&gt; map = Splitter.on(<span class="string">","</span>).withKeyValueSeparator(<span class="string">"="</span>).split(value);</span><br><span class="line"></span><br><span class="line">System.out.println(map); <span class="comment">// &#123;mrbird=18, scott=28&#125;</span></span><br></pre></td></tr></table></figure><p></p><p>åˆ†å‰²å…·æœ‰å¤šç§åˆ†éš”ç¬¦çš„Stringï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">String value = <span class="string">"a.b,,c,,.."</span>;</span><br><span class="line">List&lt;String&gt; result = Splitter.onPattern(<span class="string">"[.,]"</span>).omitEmptyStrings().splitToList(value);</span><br><span class="line"></span><br><span class="line">System.out.println(result); <span class="comment">// [a, b, c]</span></span><br></pre></td></tr></table></figure><p></p><p><code>omitEmptyStrings</code>ç”¨äºå¿½ç•¥ç©ºå­—ç¬¦ä¸²ã€‚</p><p>æˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡æŒ‡å®šé•¿åº¦æ¥æ‹†åˆ†å­—ç¬¦ä¸²ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">String value = <span class="string">"äººä»¬éƒ½è¯´ï¼šâ€œæ¡‚æ—å±±æ°´ç”²å¤©ä¸‹â€ï¼Œæˆ‘ä»¬ä¹˜ç€æœ¨èˆ¹è¡æ¼¾åœ¨æ¼“æ±Ÿä¸Šï¼Œæ¥è§‚èµæ¡‚æ—çš„å±±æ°´ã€‚"</span>;</span><br><span class="line"></span><br><span class="line">List&lt;String&gt; list = Splitter.fixedLength(<span class="number">3</span>).splitToList(value);</span><br><span class="line">System.out.println(list); <span class="comment">// [äººä»¬éƒ½, è¯´ï¼šâ€œ, æ¡‚æ—å±±, æ°´ç”²å¤©, ä¸‹â€ï¼Œ, æˆ‘ä»¬ä¹˜, ç€æœ¨èˆ¹, è¡æ¼¾åœ¨, æ¼“æ±Ÿä¸Š, ï¼Œæ¥è§‚, èµæ¡‚æ—, çš„å±±æ°´, ã€‚]</span></span><br></pre></td></tr></table></figure><p></p><p>ä¹Ÿå¯ä»¥æŒ‡å®šæ‹†åˆ†é¡¹çš„é•¿åº¦ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">String value = <span class="string">"a-b-c-d-e"</span>;</span><br><span class="line">List&lt;String&gt; result = Splitter.on(<span class="string">"-"</span>).limit(<span class="number">4</span>).splitToList(value);</span><br><span class="line"></span><br><span class="line">System.out.println(result); <span class="comment">// [a, b, c, d-e]</span></span><br></pre></td></tr></table></figure><p></p><p>å¯ä»¥çœ‹åˆ°d-eæ²¡æœ‰è¢«æ‹†åˆ†ã€‚</p><h2 id="Filter-amp-Transform"><a href="#Filter-amp-Transform" class="headerlink" title="Filter&amp;Transform"></a>Filter&amp;Transform</h2><h3 id="Filter"><a href="#Filter" class="headerlink" title="Filter"></a>Filter</h3><p>å¯ä»¥é€šè¿‡Guavaæä¾›çš„Predicatesæ¥å®ç°å„ç§é›†åˆè¿‡æ»¤æ“ä½œã€‚</p><p>æ¯”å¦‚æ‰¾å‡ºé›†åˆä¸­åŒ…å«açš„å…ƒç´ ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">List&lt;String&gt; list = Lists.newArrayList(<span class="string">"java"</span>, <span class="string">"javascript"</span>, <span class="string">"c#"</span>, <span class="string">"golang"</span>);</span><br><span class="line">Iterable&lt;String&gt; result = Iterables.filter(list, Predicates.containsPattern(<span class="string">"a"</span>));</span><br><span class="line"></span><br><span class="line">System.out.println(result); <span class="comment">// [java, javascript, golang]</span></span><br></pre></td></tr></table></figure><p></p><p>ä¸Šé¢çš„ä¾‹å­ä¹Ÿå¯ä»¥é€šè¿‡<code>Collections2.filter</code>æ¥å®ç°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">List&lt;String&gt; list = Lists.newArrayList(<span class="string">"java"</span>, <span class="string">"javascript"</span>, <span class="string">"c#"</span>, <span class="string">"golang"</span>);</span><br><span class="line">Collection&lt;String&gt; result = Collections2.filter(list, Predicates.containsPattern(<span class="string">"a"</span>));</span><br><span class="line"></span><br><span class="line">System.out.println(result);</span><br></pre></td></tr></table></figure><p></p><p>æˆ‘ä»¬ä¹Ÿå¯ä»¥ç¼–å†™è‡ªå®šä¹‰çš„è¿‡æ»¤è§„åˆ™ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"> Predicate&lt;String&gt; predicate = <span class="keyword">new</span> Predicate&lt;String&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">apply</span><span class="params">(@Nullable String input)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> input.endsWith(<span class="string">"a"</span>) || input.contains(<span class="string">"#"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">test</span><span class="params">(String input)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.apply(input);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line">List&lt;String&gt; list = Lists.newArrayList(<span class="string">"java"</span>, <span class="string">"javascript"</span>, <span class="string">"c#"</span>, <span class="string">"golang"</span>);</span><br><span class="line">Collection&lt;String&gt; result = Collections2.filter(list, predicate);</span><br><span class="line"></span><br><span class="line">System.out.println(result); <span class="comment">// [java, c#]</span></span><br></pre></td></tr></table></figure><p></p><p>ç»„åˆå¤šä¸ªè¿‡æ»¤æ¡ä»¶ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">List&lt;String&gt; list = Lists.newArrayList(<span class="string">"java"</span>, <span class="string">"javascript"</span>, <span class="string">"c#"</span>, <span class="string">"golang"</span>);</span><br><span class="line">Collection&lt;String&gt; result = Collections2.filter(list,</span><br><span class="line">        Predicates.or(</span><br><span class="line">                Predicates.containsPattern(<span class="string">"a"</span>),</span><br><span class="line">                Predicates.containsPattern(<span class="string">"#"</span>)</span><br><span class="line">        ));</span><br><span class="line">System.out.println(result); <span class="comment">// [java, javascript, c#, golang]</span></span><br></pre></td></tr></table></figure><p></p><p>è¿‡æ»¤æ‰é›†åˆä¸­çš„nullï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">List&lt;String&gt; list = Lists.newArrayList(<span class="string">"java"</span>, <span class="keyword">null</span>,<span class="string">" python"</span>);</span><br><span class="line">Collection&lt;String&gt; result = Collections2.filter(list, Predicates.&lt;String&gt;notNull());</span><br><span class="line"></span><br><span class="line">System.out.println(result); <span class="comment">// [java,  python]</span></span><br></pre></td></tr></table></figure><p></p><p>æ£€æµ‹é›†åˆä¸­æ˜¯å¦æœ‰åŒ…å«aå­—ç¬¦çš„å…ƒç´ ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">List&lt;String&gt; list = Lists.newArrayList(<span class="string">"java"</span>, <span class="string">"c#"</span>,<span class="string">" python"</span>);</span><br><span class="line"><span class="keyword">boolean</span> result = Iterables.any(list, Predicates.containsPattern(<span class="string">"a"</span>));</span><br><span class="line"></span><br><span class="line">System.out.println(result); <span class="comment">// true</span></span><br></pre></td></tr></table></figure><p></p><h3 id="Transform"><a href="#Transform" class="headerlink" title="Transform"></a>Transform</h3><p>å°†é›†åˆè½¬æ¢ä¸ºå…ƒç´ é•¿åº¦çš„é›†åˆï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Function&lt;String, Integer&gt; function = <span class="keyword">new</span> Function&lt;String, Integer&gt;() &#123;</span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">apply</span><span class="params">(@Nullable String s)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> s.length();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line">List&lt;String&gt; list = Lists.newArrayList(<span class="string">"java"</span>, <span class="string">"c#"</span>, <span class="string">" python"</span>);</span><br><span class="line">Iterable&lt;Integer&gt; result = Iterables.transform(list, function);</span><br><span class="line"></span><br><span class="line">System.out.println(result); <span class="comment">// [4, 2, 7]</span></span><br></pre></td></tr></table></figure><p></p><p>ä¸Šé¢çš„ä¾‹å­åŒæ ·å¯ä»¥ä½¿ç”¨<code>Collections2.transform</code>æ¥ä»£æ›¿<code>Iterables.transform</code>ã€‚</p><p>æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡<code>Functions.fromPredicate</code>æ¥åˆ›å»ºç®€å•çš„è½¬æ¢å‡½æ•°Functionï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">List&lt;String&gt; list = Lists.newArrayList(<span class="string">"java"</span>, <span class="string">"c#"</span>, <span class="string">" python"</span>);</span><br><span class="line">Iterable&lt;Boolean&gt; result = Iterables.transform(list, Functions.forPredicate(Predicates.containsPattern(<span class="string">"#"</span>)));</span><br><span class="line"></span><br><span class="line">System.out.println(result); <span class="comment">// [false, true, false]</span></span><br></pre></td></tr></table></figure><p></p><p>ç»„åˆå¤šä¸ªè½¬æ¢å‡½æ•°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Function&lt;String, String&gt; f1 = <span class="keyword">new</span> Function&lt;String, String&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">apply</span><span class="params">(String input)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"i like "</span> + input;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Function&lt;String, String&gt; f2 = <span class="keyword">new</span> Function&lt;String, String&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">apply</span><span class="params">(String input)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> input.toUpperCase();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line">List&lt;String&gt; list = Lists.newArrayList(<span class="string">"java"</span>, <span class="string">"c#"</span>, <span class="string">" python"</span>);</span><br><span class="line">Iterable&lt;String&gt; result = Iterables.transform(list, Functions.compose(f2, f1));</span><br><span class="line"></span><br><span class="line">System.out.println(result); <span class="comment">// [I LIKE JAVA, I LIKE C#, I LIKE  PYTHON]</span></span><br></pre></td></tr></table></figure><p></p><p>æˆ‘ä»¬ä¹Ÿå¯ä»¥å°†è¿‡æ»¤å’Œè½¬æ¢ç»„åˆåœ¨ä¸€èµ·ä½¿ç”¨ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">Predicate&lt;String&gt; predicate = <span class="keyword">new</span> Predicate&lt;String&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">apply</span><span class="params">(String input)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> input.startsWith(<span class="string">"j"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">test</span><span class="params">(String input)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.apply(input);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Function&lt;String, String&gt; function = <span class="keyword">new</span> Function&lt;String,String&gt;()&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">apply</span><span class="params">(String input)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> input.toUpperCase();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">List&lt;String&gt; list = Lists.newArrayList(<span class="string">"java"</span>, <span class="string">"c#"</span>, <span class="string">"javascript"</span>, <span class="string">"python"</span>);</span><br><span class="line">ImmutableList&lt;String&gt; result = FluentIterable.from(list)</span><br><span class="line">        .filter(predicate)</span><br><span class="line">        .transform(function)</span><br><span class="line">        .toList();</span><br><span class="line"></span><br><span class="line">System.out.println(result); <span class="comment">// [JAVA, JAVASCRIPT]</span></span><br></pre></td></tr></table></figure><p></p><h2 id="Iterables"><a href="#Iterables" class="headerlink" title="Iterables"></a>Iterables</h2><p>é™¤äº†ä¸Šé¢æ¶‰åŠçš„Iterablesçš„ç”¨æ³•å¤–ï¼Œå…¶è¿˜æä¾›äº†è®¸å¤šåˆ«çš„å¥½ç”¨çš„æ–¹æ³•ã€‚</p><h3 id="removeAll"><a href="#removeAll" class="headerlink" title="removeAll"></a>removeAll</h3><p>è¯¥æ–¹æ³•ç”¨äºä»ç‰¹å®šé›†åˆä¸­åˆ é™¤ç»™å®šé›†åˆä¸­çš„å…ƒç´ ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">List&lt;String&gt; removeFrom = Lists.newArrayList(<span class="string">"a"</span>, <span class="string">"b"</span>, <span class="string">"c"</span>);</span><br><span class="line">List&lt;String&gt; elementsToRemove = Lists.newArrayList(<span class="string">"b"</span>, <span class="string">"c"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">boolean</span> result = Iterables.removeAll(removeFrom, elementsToRemove);</span><br><span class="line">System.out.println(result); <span class="comment">// true</span></span><br><span class="line">System.out.println(removeFrom); <span class="comment">// [a]</span></span><br></pre></td></tr></table></figure><p></p><h3 id="retainAll"><a href="#retainAll" class="headerlink" title="retainAll"></a>retainAll</h3><p>retainAllçš„åŠŸèƒ½å’ŒremoveAllç›¸åï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">List&lt;String&gt; removeFrom = Lists.newArrayList(<span class="string">"a"</span>, <span class="string">"b"</span>, <span class="string">"c"</span>);</span><br><span class="line">List&lt;String&gt; elementsToRetain = Lists.newArrayList(<span class="string">"b"</span>, <span class="string">"c"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">boolean</span> result = Iterables.retainAll(removeFrom, elementsToRetain);</span><br><span class="line">System.out.println(result); <span class="comment">// true</span></span><br><span class="line">System.out.println(removeFrom); <span class="comment">// [b, c]</span></span><br></pre></td></tr></table></figure><p></p><h3 id="addAll"><a href="#addAll" class="headerlink" title="addAll"></a>addAll</h3><p>addAllç”¨äºå°†ç»™å®šé›†åˆæ·»åŠ åˆ°ç°æœ‰é›†åˆä¸­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">List&lt;String&gt; list1 = Lists.newArrayList(<span class="string">"a"</span>, <span class="string">"b"</span>, <span class="string">"c"</span>);</span><br><span class="line">List&lt;String&gt; list2 = Lists.newArrayList(<span class="string">"b"</span>, <span class="string">"c"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">boolean</span> b = Iterables.addAll(list1, list2); <span class="comment">// true</span></span><br><span class="line">System.out.println(list1); <span class="comment">// [a, b, c, b, c]</span></span><br></pre></td></tr></table></figure><p></p><h3 id="concat"><a href="#concat" class="headerlink" title="concat"></a>concat</h3><p>concatç”¨äºåˆå¹¶é›†åˆï¼Œç»„æˆä¸€ä¸ªæ–°çš„é›†åˆå¯¹è±¡ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">List&lt;String&gt; list1 = Lists.newArrayList(<span class="string">"a"</span>, <span class="string">"b"</span>, <span class="string">"c"</span>);</span><br><span class="line">List&lt;String&gt; list2 = Lists.newArrayList(<span class="string">"b"</span>, <span class="string">"c"</span>);</span><br><span class="line"></span><br><span class="line">Iterable&lt;String&gt; result = Iterables.concat(list1,list2);</span><br><span class="line">System.out.println(result); <span class="comment">// [a, b, c, b, c]</span></span><br></pre></td></tr></table></figure><p></p><p>Iterablesè¿˜åŒ…å«è®¸å¤šåˆ«çš„å®ç”¨æ–¹æ³•ï¼š</p><p><img src="img/QQæˆªå›¾20190423231111.png" alt="QQæˆªå›¾20190423231111.png"></p><p>è¿™é‡Œå°±ä¸ä¸€ä¸€æ¼”ç¤ºäº†ï¼Œæºœäº†ã€‚</p><p><img src="img/QQå›¾ç‰‡20190423231252.png" alt="QQå›¾ç‰‡20190423231252.png"></p><p>æ›´è¯¦ç»†çš„å†…å®¹å¯ä»¥å‚è€ƒguavaå®˜æ–¹wikiï¼š<a href="https://github.com/google/guava/wiki" target="_blank" rel="noopener">https://github.com/google/guava/wiki</a></p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Wed May 15 2019 17:13:45 GMT+0800 (GMT+08:00) --&gt;&lt;h2 id=&quot;ä¸å¯å˜é›†åˆ&quot;&gt;&lt;a href=&quot;#ä¸å¯å˜é›†åˆ&quot; class=&quot;headerlink&quot; title=&quot;ä¸å¯å˜é›†åˆ&quot;&gt;&lt;/a&gt;ä¸å¯å˜é›†åˆ&lt;/h2&gt;&lt;p&gt;ä¸å¯å˜é›†åˆä¾‹å­ï¼š&lt;/p&gt;&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;ImmutableSet&amp;lt;String&amp;gt; FRUITS = ImmutableSet.of(&lt;span class=&quot;string&quot;&gt;&quot;apple&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;watermelon&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;cherry&quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&quot;mango&quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;FRUITS.remove(&lt;span class=&quot;string&quot;&gt;&quot;apple&quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;å°†æŠ›å‡º&lt;code&gt;java.lang.UnsupportedOperationException&lt;/code&gt;å¼‚å¸¸ï¼š
    
    </summary>
    
    
      <category term="guava" scheme="http://mrbird.cc/tags/guava/"/>
    
  </entry>
  
  <entry>
    <title>FEBS-Vueæ–‡æ¡£</title>
    <link href="http://mrbird.cc/FEBS-Vue-Document.html"/>
    <id>http://mrbird.cc/FEBS-Vue-Document.html</id>
    <published>2019-01-01T01:24:51.000Z</published>
    <updated>2019-05-14T10:41:41.937Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Wed May 15 2019 17:13:45 GMT+0800 (GMT+08:00) --><p>FEBS-Vueä¸º<a href="https://github.com/wuyouzhuguli/FEBS-Shiro" target="_blank" rel="noopener">FEBS-Shiro</a>çš„å‰åç«¯åˆ†ç¦»ç‰ˆæœ¬ï¼Œå‰ç«¯ä½¿ç”¨Vueå…¨å®¶æ¡¶ï¼Œç»„ä»¶åº“é‡‡ç”¨<a href="https://vuecomponent.github.io/ant-design-vue/docs/vue/introduce-cn/" target="_blank" rel="noopener">Ant-Design-Vue</a>ã€‚</p><p>æ–‡æ¡£é‡Œä»‹ç»çš„ç¤ºä¾‹æ˜¯åœ¨Windows10æ“ä½œç³»ç»Ÿä¸‹å®Œæˆçš„ï¼Œåç«¯ç¼–è¾‘å™¨ä½¿ç”¨IDEAï¼Œå‰ç«¯ç¼–è¾‘å™¨ä½¿ç”¨WebStormã€‚<a id="more"></a></p><h2 id="é¡¹ç›®å¯¼å…¥"><a href="#é¡¹ç›®å¯¼å…¥" class="headerlink" title="é¡¹ç›®å¯¼å…¥"></a>é¡¹ç›®å¯¼å…¥</h2><p>ä¸ºäº†æ–¹ä¾¿ï¼Œæˆ‘ç›´æ¥åœ¨æ¡Œé¢ä¸Šé€šè¿‡git bashå…‹éš†é¡¹ç›®ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/wuyouzhuguli/FEBS-Vue.git</span><br></pre></td></tr></table></figure><p></p><p>å…‹éš†åï¼Œæ¡Œé¢ä¸Šå¤šå‡ºä¸€ä¸ªFEBS-Vueæ–‡ä»¶å¤¹ï¼š</p><p><img src="img/febsvue/20190409165245.png" alt="QQæˆªå›¾20190409165245.png"></p><p>backendä¸ºåç«¯é¡¹ç›®æºç ï¼Œfrontendä¸ºå‰ç«¯é¡¹ç›®æºç ï¼Œsqlä¸ºæ•°æ®åº“åˆå§‹åŒ–è„šæœ¬ã€‚</p><h3 id="JDK"><a href="#JDK" class="headerlink" title="JDK"></a>JDK</h3><p>å› ä¸ºé¡¹ç›®ç”¨åˆ°äº†JDK 8çš„ä¸€äº›ç‰¹æ€§ï¼Œæ‰€ä»¥JDKæœ€ä½ç‰ˆæœ¬ä¸èƒ½ä½äº8ã€‚</p><p>JDK 8å®˜æ–¹ä¸‹è½½åœ°å€ï¼š<a href="https://www.oracle.com/technetwork/java/javase/downloadsã€‚" target="_blank" rel="noopener">https://www.oracle.com/technetwork/java/javase/downloadsã€‚</a></p><h3 id="å®‰è£…Node-js"><a href="#å®‰è£…Node-js" class="headerlink" title="å®‰è£…Node.js"></a>å®‰è£…Node.js</h3><p>Node.jsä¸‹è½½åœ°å€ï¼š<a href="http://nodejs.cn/download/" target="_blank" rel="noopener">http://nodejs.cn/download/</a>ï¼Œç›´æ¥å®‰è£…å³å¯ï¼Œå®‰è£…åæŸ¥çœ‹å…¶ç‰ˆæœ¬ï¼š</p><p><img src="img/febsvue/QQæˆªå›¾20190409170853.png" alt="QQæˆªå›¾20190409170853.png"></p><p>Node.jsé›†æˆäº†npmï¼Œæ‰€ä»¥å®‰è£…å¥½Node.jsånpmå°±å¯ä»¥ä½¿ç”¨äº†ï¼š</p><p><img src="img/febsvue/QQæˆªå›¾20190409171301.png" alt="QQæˆªå›¾20190409171301.png"></p><h3 id="å®‰è£…yarn"><a href="#å®‰è£…yarn" class="headerlink" title="å®‰è£…yarn"></a>å®‰è£…yarn</h3><p>åœ¨CMDä¸­æ‰§è¡Œ<code>npm install -g yarn</code>ï¼š</p><p><img src="img/febsvue/QQæˆªå›¾20190409171954.png" alt="QQæˆªå›¾20190409171954.png"></p><p>å› ä¸ºæˆ‘ä¹‹å‰å·²ç»å®‰è£…è¿‡äº†ï¼Œæ‰€ä»¥è¿™é‡Œå°±ç›¸å½“äºæ›´æ–°æ“ä½œäº†ã€‚</p><h3 id="å®‰è£…Redis"><a href="#å®‰è£…Redis" class="headerlink" title="å®‰è£…Redis"></a>å®‰è£…Redis</h3><p>é¡¹ç›®ç¼“å­˜æ•°æ®åº“ä½¿ç”¨çš„æ˜¯Redisï¼Œæ‰€ä»¥åœ¨å¯¼å…¥é¡¹ç›®å‰éœ€å…ˆå®‰è£…Redisã€‚</p><p>Redis Windowsç‰ˆæœ¬ä¸‹è½½åœ°å€ï¼š<a href="https://github.com/MicrosoftArchive/redis/releases" target="_blank" rel="noopener">https://github.com/MicrosoftArchive/redis/releases</a>ã€‚ç›´æ¥ä¸‹è½½zipç‰ˆæœ¬è§£å‹åˆ°ä»»æ„ç›®å½•å³å¯ã€‚</p><p>ä¸‹è½½åï¼Œä½¿ç”¨cmdå‘½ä»¤åˆ‡æ¢åˆ°Redisæ ¹ç›®å½•ï¼Œç„¶åè¿è¡Œ<code>redis-server.exe redis.windows.conf</code>å¯åŠ¨å³å¯ï¼š</p><p><img src="img/febsvue/QQæˆªå›¾20190409172902.png" alt="QQæˆªå›¾20190409172902.png"></p><h3 id="å®‰è£…MySQL"><a href="#å®‰è£…MySQL" class="headerlink" title="å®‰è£…MySQL"></a>å®‰è£…MySQL</h3><p>é¡¹ç›®æ•°æ®åº“é‡‡ç”¨MySQLç¤¾åŒºç‰ˆï¼Œç‰ˆæœ¬ä¸º5.7.xã€‚</p><p>ä¸‹è½½åœ°å€ï¼š<a href="https://dev.mysql.com/downloads/windows/installer/5.7.html" target="_blank" rel="noopener">https://dev.mysql.com/downloads/windows/installer/5.7.html</a></p><h3 id="å¯¼å…¥SQL"><a href="#å¯¼å…¥SQL" class="headerlink" title="å¯¼å…¥SQL"></a>å¯¼å…¥SQL</h3><p>ä½¿ç”¨Navicatæ–°å»ºä¸€ä¸ªæ•°æ®åº“ï¼š</p><p><img src="img/febsvue/QQæˆªå›¾20190409173934.png" alt="QQæˆªå›¾20190409173934.png"></p><p>ç„¶åå¯¼å…¥SQLè„šæœ¬å³å¯ã€‚</p><h3 id="å¯¼å…¥åç«¯é¡¹ç›®"><a href="#å¯¼å…¥åç«¯é¡¹ç›®" class="headerlink" title="å¯¼å…¥åç«¯é¡¹ç›®"></a>å¯¼å…¥åç«¯é¡¹ç›®</h3><p>IDEAé€‰æ‹©backendï¼š <img src="img/febsvue/QQæˆªå›¾20190409184301.png" alt="QQæˆªå›¾20190409184301.png"></p><p>å¯¼å…¥é¡¹ç›®åå®‰è£…lombokæ’ä»¶ï¼ˆä¸æ‡‚lombokå¯ä»¥è‡ªè¡Œç™¾åº¦ï¼‰ï¼š</p><p><img src="img/febsvue/QQæˆªå›¾20190409185417.png" alt="QQæˆªå›¾20190409185417.png"></p><p>å®‰è£…å®Œé‡å¯IDEAæ‰èƒ½ç”Ÿæ•ˆã€‚</p><p>æ¥ç€ä¿®æ”¹application.ymlä¸­çš„æ•°æ®åº“å’ŒRedisé…ç½®ï¼Œä¿®æ”¹å®Œåé€šè¿‡Spring Bootå…¥å£ç±»FebsApplicationå¯åŠ¨å³å¯ï¼š</p><p><img src="img/febsvue/QQæˆªå›¾20190409184818.png" alt="QQæˆªå›¾20190409184818.png"></p><p><img src="img/febsvue/QQæˆªå›¾20190409185112.png" alt="QQæˆªå›¾20190409185112.png"></p><p>æ¥ç€å¼€å§‹å¯¼å…¥å‰ç«¯é¡¹ç›®ã€‚</p><h3 id="å¯¼å…¥å‰ç«¯é¡¹ç›®"><a href="#å¯¼å…¥å‰ç«¯é¡¹ç›®" class="headerlink" title="å¯¼å…¥å‰ç«¯é¡¹ç›®"></a>å¯¼å…¥å‰ç«¯é¡¹ç›®</h3><p>ä½¿ç”¨WebStormæ‰“å¼€frontendï¼š</p><p><img src="img/febsvue/QQæˆªå›¾20190409185643.png" alt="QQæˆªå›¾20190409185643.png"></p><p>åœ¨ç»ˆç«¯è¾“å…¥<code>yarn install</code>å‘½ä»¤å®‰è£…ä¾èµ–ï¼š</p><p><img src="img/febsvue/QQæˆªå›¾20190409190322.png" alt="QQæˆªå›¾20190409190322.png"></p><p>ç¨ç­‰ç‰‡åˆ»ï¼Œåä¸æ”¾å®½ã€‚</p><p>ä¾èµ–ä¸‹è½½å®Œæ¯•åï¼Œè¾“å…¥yarn startå¯åŠ¨å‰ç«¯é¡¹ç›®ï¼š</p><p><img src="img/febsvue/QQæˆªå›¾20190409191649.png" alt="QQæˆªå›¾20190409191649.png"></p><p>æµè§ˆå™¨è®¿é—®<a href="http://localhost:8081" target="_blank" rel="noopener">http://localhost:8081</a>ï¼š</p><p><img src="img/febsvue/QQæˆªå›¾20190409191833.png" alt="QQæˆªå›¾20190409191833.png"></p><h2 id="é¡¹ç›®éƒ¨ç½²"><a href="#é¡¹ç›®éƒ¨ç½²" class="headerlink" title="é¡¹ç›®éƒ¨ç½²"></a>é¡¹ç›®éƒ¨ç½²</h2><p>ä¸‹é¢æ¼”ç¤ºå¦‚ä½•åœ¨Linuxä¸Šéƒ¨ç½²é¡¹ç›®ï¼ˆä¾‹å­é‡‡ç”¨CentOS7ï¼‰ã€‚</p><h3 id="Vagrantåˆ›å»ºCentOS"><a href="#Vagrantåˆ›å»ºCentOS" class="headerlink" title="Vagrantåˆ›å»ºCentOS"></a>Vagrantåˆ›å»ºCentOS</h3><p>å¦‚æœæ²¡æœ‰CentOS7ç¯å¢ƒå¯ä»¥ä½¿ç”¨Vagrantå¿«é€Ÿæ„å»ºä¸€ä¸ªCentOSè™šæ‹Ÿæœºï¼Œå…·ä½“å¯ä»¥å‚è€ƒï¼š<a href="https://mrbird.cc/Create-Virtual-Machine-By-Vagrant.html">https://mrbird.cc/Create-Virtual-Machine-By-Vagrant.html</a>ã€‚æˆ‘çš„CentOSè™šæ‹ŸæœºIPä¸ºï¼š192.168.33.11ã€‚</p><div class="note danger"><p>ä½¿ç”¨å‘½ä»¤<code>timedatectl set-timezone Asia/Shanghai</code>è®¾ç½®CentOSçš„æ—¶åŒºï¼Œä»¥é¿å…å› æ—¶åŒºå¸¦æ¥çš„BUGã€‚</p></div><h3 id="Javaç¯å¢ƒé…ç½®"><a href="#Javaç¯å¢ƒé…ç½®" class="headerlink" title="Javaç¯å¢ƒé…ç½®"></a>Javaç¯å¢ƒé…ç½®</h3><ol><li>ä¸‹è½½JDK8ï¼š</li></ol><p><img src="img/febsvue/QQæˆªå›¾20190409204143.png" alt="QQæˆªå›¾20190409204143.png"></p><p>ä¸‹è½½åé€šè¿‡Vagrantå…±äº«åˆ°CentOSä¸Šï¼ˆæˆ‘çš„Vagrantfileå…±äº«é…ç½®ä¸º<code>config.vm.synced_folder &quot;./sync&quot;, &quot;/vagrant&quot;, create:true, owner: &quot;root&quot;, group: &quot;root&quot;</code>ï¼‰ï¼š</p><p><img src="img/febsvue/QQæˆªå›¾20190409204745.png" alt="QQæˆªå›¾20190409204745.png"></p><ol start="2"><li>å®‰è£…JDK8ï¼š</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpm -ivh jdk-8u201-linux-x64.rpm</span><br></pre></td></tr></table></figure><p><img src="img/febsvue/QQæˆªå›¾20190409204849.png" alt="QQæˆªå›¾20190409204849.png"></p><ol start="3"><li>é…ç½®ç¯å¢ƒå˜é‡</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/profile</span><br></pre></td></tr></table></figure><p>è¾“å…¥ä»¥ä¸‹å†…å®¹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">JAVA_HOME=/usr/java/jdk1.8.0_201</span><br><span class="line">JRE_HOME=/usr/java/jdk1.8.0_201/jre</span><br><span class="line">PATH=<span class="variable">$PATH</span>:<span class="variable">$JAVA_HOME</span>/bin:<span class="variable">$JRE_HOME</span>/bin</span><br><span class="line">CLASSPATH=.:<span class="variable">$JAVA_HOME</span>/lib/dt.jar:<span class="variable">$JAVA_HOME</span>/lib/tools.jar:<span class="variable">$JRE_HOME</span>/lib</span><br><span class="line"><span class="built_in">export</span> JAVA_HOME JRE_HOME PATH CLASSPATH</span><br></pre></td></tr></table></figure><p>ç„¶åæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ç”Ÿæ•ˆï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> /etc/profile</span><br></pre></td></tr></table></figure><p></p><h3 id="å®‰è£…Docker"><a href="#å®‰è£…Docker" class="headerlink" title="å®‰è£…Docker"></a>å®‰è£…Docker</h3><p>å®˜æ–¹å®‰è£…æ•™ç¨‹ï¼š<a href="https://docs.docker.com/install/linux/docker-ce/centos/" target="_blank" rel="noopener">https://docs.docker.com/install/linux/docker-ce/centos/</a></p><p>å®‰è£…å¥½åï¼š</p><p><img src="img/febsvue/QQæˆªå›¾20190409205834.png" alt="QQæˆªå›¾20190409205834.png"></p><h3 id="Dockerå®‰è£…MySQL"><a href="#Dockerå®‰è£…MySQL" class="headerlink" title="Dockerå®‰è£…MySQL"></a>Dockerå®‰è£…MySQL</h3><ol><li>æ‹‰å–MySQLé•œåƒï¼š</li></ol><p><img src="img/febsvue/QQæˆªå›¾20190409210335.png" alt="QQæˆªå›¾20190409210335.png"></p><ol start="2"><li>åˆ›å»ºç›®å½•/home/febs/mysqlï¼Œç”¨äºæŒ‚è½½MySQL volume:</li></ol><p><img src="img/febsvue/QQæˆªå›¾20190409210901.png" alt="QQæˆªå›¾20190409210901.png"></p><ol start="3"><li>åˆ›å»ºMySQLå®¹å™¨ï¼š</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --name mysql -p 3306:3306 \</span><br><span class="line"> -v $(<span class="built_in">pwd</span>):/var/lib/mysql -e MYSQL_ROOT_PASSWORD=123456 mysql:5.7.25</span><br></pre></td></tr></table></figure><p><img src="img/febsvue/QQæˆªå›¾20190409211225.png" alt="QQæˆªå›¾20190409211225.png"></p><ol start="4"><li>ä½¿ç”¨Navicatè¿æ¥MySQLï¼Œåˆ›å»ºæ•°æ®åº“å¹¶å¯¼å…¥æ•°æ®ï¼š</li></ol><p>è¿æ¥ï¼š</p><p><img src="img/febsvue/QQæˆªå›¾20190409211912.png" alt="QQæˆªå›¾20190409211912.png"></p><p>æ–°å¢æ•°æ®åº“ï¼š</p><p><img src="img/febsvue/QQæˆªå›¾20190409212130.png" alt="QQæˆªå›¾20190409212130.png"></p><p>å¯¼å…¥SQLï¼š</p><p><img src="img/febsvue/QQæˆªå›¾20190409212334.png" alt="QQæˆªå›¾20190409212334.png"></p><h3 id="Dockerå®‰è£…Redis"><a href="#Dockerå®‰è£…Redis" class="headerlink" title="Dockerå®‰è£…Redis"></a>Dockerå®‰è£…Redis</h3><ol><li>æ‹‰å–Redisé•œåƒ:</li></ol><p><img src="img/febsvue/QQæˆªå›¾20190409213345.png" alt="QQæˆªå›¾20190409213345.png"></p><ol start="2"><li>åˆ›å»ºæ–‡ä»¶/home/febs/redis/conf/redis.confï¼Œç”¨äºæŒ‚è½½Redisé…ç½®æ–‡ä»¶ï¼š</li></ol><p><img src="img/febsvue/QQæˆªå›¾20190409223016.png" alt="QQæˆªå›¾20190409213604.png"></p><ol start="3"><li>åˆ›å»ºRediså®¹å™¨ï¼š</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 6379:6379 \</span><br><span class="line"> -v /home/febs/redis/conf/redis.conf:/usr/<span class="built_in">local</span>/etc/redis/redis.conf \</span><br><span class="line"> --name redis redis:4.0.14</span><br></pre></td></tr></table></figure><p>æµ‹è¯•è¿æ¥ï¼š</p><p><img src="img/febsvue/2019-04-10_094404.png" alt="QQæˆªå›¾20190410094147.png"></p><h3 id="Dockerå®‰è£…Nginx"><a href="#Dockerå®‰è£…Nginx" class="headerlink" title="Dockerå®‰è£…Nginx"></a>Dockerå®‰è£…Nginx</h3><ol><li>æ‹‰å–Nginxé•œåƒ:</li></ol><p><img src="img/febsvue/QQæˆªå›¾20190409220000.png" alt="QQæˆªå›¾20190409220000.png"></p><ol start="2"><li>åˆ›å»ºç›®å½•/home/febs/nginx/htmlã€/home/febs/nginx/logså’Œæ–‡ä»¶/home/febs/nginx/conf/nginx.confï¼Œåˆ†åˆ«ç”¨äºæŒ‚è½½Nginx html,logså’Œé…ç½®æ–‡ä»¶ï¼š</li></ol><p><img src="img/febsvue/20190409225225.png" alt="QQæˆªå›¾20190409225225.png"> <img src="img/febsvue/20190409223442.png" alt="QQæˆªå›¾20190409220212.png"></p><ol start="3"><li>ä¿®æ”¹Nginxé…ç½®ï¼š</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /home/febs/nginx/conf/nginx.conf</span><br></pre></td></tr></table></figure><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">worker_processes</span>  auto;</span><br><span class="line"></span><br><span class="line"><span class="attribute">error_log</span>   /var/log/nginx/error.log;</span><br><span class="line"><span class="attribute">pid</span>   /run/nginx.pid;</span><br><span class="line"></span><br><span class="line"><span class="section">events</span> &#123;</span><br><span class="line">    <span class="attribute">worker_connections</span>  <span class="number">1024</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">        <span class="attribute">include</span> mime.types;</span><br><span class="line">        <span class="attribute">default_type</span>  application/octet-stream;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">server_names_hash_bucket_size</span> <span class="number">512</span>;</span><br><span class="line">        <span class="attribute">client_header_buffer_size</span> <span class="number">32k</span>;</span><br><span class="line">        <span class="attribute">large_client_header_buffers</span> <span class="number">4</span> <span class="number">32k</span>;</span><br><span class="line">        <span class="attribute">client_max_body_size</span> <span class="number">50m</span>;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">sendfile</span>   <span class="literal">on</span>;</span><br><span class="line">        <span class="attribute">tcp_nopush</span> <span class="literal">on</span>;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">keepalive_timeout</span> <span class="number">60</span>;</span><br><span class="line">        <span class="attribute">tcp_nodelay</span> <span class="literal">on</span>;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">fastcgi_connect_timeout</span> <span class="number">300</span>;</span><br><span class="line">        <span class="attribute">fastcgi_send_timeout</span> <span class="number">300</span>;</span><br><span class="line">        <span class="attribute">fastcgi_read_timeout</span> <span class="number">300</span>;</span><br><span class="line">        <span class="attribute">fastcgi_buffer_size</span> <span class="number">64k</span>;</span><br><span class="line">        <span class="attribute">fastcgi_buffers</span> <span class="number">4</span> <span class="number">64k</span>;</span><br><span class="line">        <span class="attribute">fastcgi_busy_buffers_size</span> <span class="number">128k</span>;</span><br><span class="line">        <span class="attribute">fastcgi_temp_file_write_size</span> <span class="number">256k</span>;</span><br><span class="line">        <span class="attribute">fastcgi_intercept_errors</span> <span class="literal">on</span>;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">gzip</span> <span class="literal">on</span>;</span><br><span class="line">        <span class="attribute">gzip_min_length</span>  <span class="number">1k</span>;</span><br><span class="line">        <span class="attribute">gzip_buffers</span>     <span class="number">16</span> <span class="number">8k</span>;</span><br><span class="line">        <span class="attribute">gzip_http_version</span> <span class="number">1</span>.<span class="number">1</span>;</span><br><span class="line">        <span class="attribute">gzip_comp_level</span> <span class="number">6</span>;</span><br><span class="line">        <span class="attribute">gzip_types</span>     text/plain application/javascript application/x-javascript text/javascript text/css application/xml;</span><br><span class="line">        <span class="attribute">gzip_vary</span> <span class="literal">on</span>;</span><br><span class="line">        <span class="attribute">gzip_proxied</span>   expired <span class="literal">no</span>-cache <span class="literal">no</span>-store private auth;</span><br><span class="line">        <span class="attribute">gzip_disable</span>   <span class="string">"MSIE [1-6]\."</span>;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">limit_conn_zone</span> <span class="variable">$binary_remote_addr</span> zone=perip:<span class="number">10m</span>;</span><br><span class="line">        <span class="attribute">limit_conn_zone</span> <span class="variable">$server_name</span> zone=perserver:<span class="number">10m</span>;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">server_tokens</span> <span class="literal">off</span>;</span><br><span class="line">        <span class="attribute">access_log</span> <span class="literal">off</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span>       <span class="number">80</span>;</span><br><span class="line">        <span class="attribute">server_name</span>  localhost;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">charset</span> utf-<span class="number">8</span>;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">location</span> / &#123;</span><br><span class="line">            <span class="attribute">root</span>   html;</span><br><span class="line">            <span class="attribute">index</span>  index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="attribute">location</span> = /50x.html &#123;</span><br><span class="line">            <span class="attribute">root</span>   html;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="4"><li>åˆ›å»ºNginxå®¹å™¨ï¼š</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker run --name nginx -d -p 80:80  \</span><br><span class="line">-v /home/febs/nginx/conf/nginx.conf:/etc/ng inx/nginx.conf  \</span><br><span class="line">-v /home/febs/nginx/html:/etc/nginx/html \</span><br><span class="line">-v /home/febs/nginx/logs:/var/<span class="built_in">log</span>/nginx nginx:1.14.2</span><br></pre></td></tr></table></figure><h3 id="åç«¯éƒ¨ç½²"><a href="#åç«¯éƒ¨ç½²" class="headerlink" title="åç«¯éƒ¨ç½²"></a>åç«¯éƒ¨ç½²</h3><p>ä¿®æ”¹application.ymlä¸­æ•°æ®åº“å’Œredisçš„è¿æ¥é…ç½®ï¼Œç„¶åå°†é¡¹ç›®æ‰“åŒ…æˆjaræ–‡ä»¶ï¼š</p><p><img src="img/febsvue/2019-04-10_094842.png" alt="2019-04-10_094842.png"></p><p>å°†å…¶ä¸Šä¼ åˆ°CentOSè™šæ‹Ÿæœºçš„/home/febs/backendç›®å½•ä¸‹ï¼š</p><p><img src="img/febsvue/asdfasdfasd.png" alt="2019-04-10_100008.png"></p><p>ç¼–å†™ä¸€ä¸ªå¯åŠ¨é¡¹ç›®çš„shellè„šæœ¬ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim start.sh</span><br></pre></td></tr></table></figure><p></p><p>å†…å®¹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nohup java -jar febs_shiro_jwt-1.0.0-release.jar &amp;</span><br></pre></td></tr></table></figure><p></p><p>ç¼–å†™ä¸€ä¸ªå…³åœé¡¹ç›®çš„shellè„šæœ¬ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim stop.sh</span><br></pre></td></tr></table></figure><p></p><p>å†…å®¹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">PID=`ps -ef | grep febs_shiro_jwt-1.0.0-release.jar | grep -v grep | awk &apos;&#123;print $2&#125;&apos;`</span><br><span class="line">if [ -z &quot;$PID&quot; ]</span><br><span class="line">then</span><br><span class="line">    echo Application is already stopped</span><br><span class="line">else</span><br><span class="line">    echo kill $PID</span><br><span class="line">    kill -9 $PID</span><br><span class="line">fi</span><br></pre></td></tr></table></figure><p></p><p>æˆæƒï¼Œè®©å…¶å¯æ‰§è¡Œï¼š</p><p><img src="img/febsvue/2019-04-10_100815.png" alt="2019-04-10_100815.png"></p><p>å¯åŠ¨é¡¹ç›®ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./start.sh</span><br><span class="line"></span><br><span class="line">tail -f nohup.out</span><br></pre></td></tr></table></figure><p></p><p>çœ‹åˆ°å¦‚ä¸‹è¾“å‡ºçš„æ—¶å€™è¯´æ˜åç«¯é¡¹ç›®å¯åŠ¨æˆåŠŸï¼š</p><p><img src="img/febsvue/2019-04-10_101222.png" alt="2019-04-10_101222.png"></p><h3 id="å‰ç«¯éƒ¨ç½²"><a href="#å‰ç«¯éƒ¨ç½²" class="headerlink" title="å‰ç«¯éƒ¨ç½²"></a>å‰ç«¯éƒ¨ç½²</h3><p>ç‚¹å‡»buildï¼š</p><p><img src="img/febsvue/2019-04-10_095141.png" alt="2019-04-10_095141.png"></p><p>buildæˆåŠŸåï¼Œé¡¹ç›®ç›®å½•ä¸‹ä¼šå¤šå‡ºä¸ªdistæ–‡ä»¶å¤¹ï¼š</p><p><img src="img/febsvue/2019-04-10_095533.png" alt="2019-04-10_095533.png"></p><p>å°†è¿™ä¸ªç›®å½•ä¸‹çš„æ–‡ä»¶ä¸Šä¼ åˆ°CentOSè™šæ‹Ÿæœºçš„/home/febs/nginx/htmlç›®å½•ä¸‹ï¼š</p><p><img src="img/febsvue/2019-04-10_101510.png" alt="2019-04-10_101510.png"></p><p>æµè§ˆå™¨è®¿é—®<a href="http://192.168.33.11/#/login" target="_blank" rel="noopener">http://192.168.33.11/#/login</a>ï¼š</p><p><img src="img/febsvue/2019-04-10_101826.png" alt="2019-04-10_101826.png"></p><p><img src="img/febsvue/2019-04-10_104514.png" alt="2019-04-10_104514.png"></p><p>éƒ¨ç½²æˆåŠŸã€‚</p><h2 id="åç«¯é¡¹ç›®ä»‹ç»"><a href="#åç«¯é¡¹ç›®ä»‹ç»" class="headerlink" title="åç«¯é¡¹ç›®ä»‹ç»"></a>åç«¯é¡¹ç›®ä»‹ç»</h2><h3 id="é¡¹ç›®ç»“æ„"><a href="#é¡¹ç›®ç»“æ„" class="headerlink" title="é¡¹ç›®ç»“æ„"></a>é¡¹ç›®ç»“æ„</h3><p>åç«¯é¡¹ç›®ç›®å½•å«ä¹‰å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="img/febsvue/backend-xmind.png" alt="backend-xmind.png"></p><p>Commonæ¨¡å—æ–‡ä»¶å«ä¹‰å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="img/febsvue/2019-04-08_113758.png" alt="2019-04-08_113758.png"></p><p>å…¶ä»–æ¨¡å—æ–‡ä»¶è¾ƒä¸ºç®€å•ï¼Œç•¥ã€‚</p><h3 id="é¡¹ç›®é…ç½®"><a href="#é¡¹ç›®é…ç½®" class="headerlink" title="é¡¹ç›®é…ç½®"></a>é¡¹ç›®é…ç½®</h3><p>application.ymlä¸­é™¤äº†å„ä¸ªæ’ä»¶çš„é…ç½®å¤–ï¼Œä¸‹é¢è¿™æ®µé…ç½®ä¸ºç³»ç»Ÿé…ç½®ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">febs:</span></span><br><span class="line"><span class="attr">  openAopLog:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  max:</span></span><br><span class="line"><span class="attr">    batch:</span></span><br><span class="line"><span class="attr">      insert:</span></span><br><span class="line"><span class="attr">        num:</span> <span class="number">1000</span></span><br><span class="line"><span class="attr">  shiro:</span></span><br><span class="line"><span class="attr">    anonUrl:</span> <span class="string">/login,/logout/**,/regist,/user/check/**</span></span><br><span class="line"><span class="attr">    jwtTimeOut:</span> <span class="number">3600</span></span><br></pre></td></tr></table></figure><p></p><ul><li><p><code>febs.opAopLog</code>ï¼šBooleanç±»å‹ï¼Œå–å€¼trueæˆ–è€…falseï¼Œä¸ºtrueæ—¶è¡¨ç¤ºå¼€å¯Aopè®°å½•ç”¨æˆ·çš„æ“ä½œæ—¥å¿—ï¼Œéœ€å’Œ<code>@Log</code>æ³¨è§£æ­é…ä½¿ç”¨ã€‚</p></li><li><p><code>febs.max.batch.insert.num</code>ï¼šå¤§äº0çš„Integerç±»å‹ï¼Œè¡¨ç¤ºExcelå¯¼å…¥æ•°æ®å½“æ¬¡æœ€å¤§å…¥åº“æ•°æ®é‡ã€‚æ¯”å¦‚é…ç½®ä¸º1000æ—¶è¡¨ç¤ºå…¥åº“æ•°æ®ä¸º0 - 1000 æ—¶åªä¼šæ‰§è¡Œä¸€æ¬¡æ•°æ®åº“commitæ“ä½œã€‚</p></li><li><p><code>febs.shiro.anonUrl</code>ï¼šé€—å·åˆ†éš”çš„å­—ç¬¦ä¸²ï¼Œè¡¨ç¤ºæ— éœ€è®¤è¯çš„èµ„æºè·¯å¾„ã€‚</p></li><li><p><code>febs.shiro.jwtTimeOut</code>ï¼šå®šä¹‰tokençš„æœ‰æ•ˆæ—¶é—´ï¼Œå•ä½ä¸ºç§’ï¼Œæ¯”å¦‚é…ç½®ä¸º3600è¡¨ç¤ºtokenä¸€ä¸ªå°æ—¶å†…æœ‰æ•ˆï¼Œè¶…è¿‡ä¸€ä¸ªå°æ—¶åéœ€è¦é‡æ–°è®¤è¯ã€‚</p></li></ul><h3 id="RESTfulé£æ ¼"><a href="#RESTfulé£æ ¼" class="headerlink" title="RESTfulé£æ ¼"></a>RESTfulé£æ ¼</h3><p>ç³»ç»ŸControlleræš´éœ²çš„æ¥å£é£æ ¼ä¸ºRESTfulï¼Œé€šè¿‡HTTPè¯·æ±‚methodå¯¹åº”å¢åˆ æ”¹æŸ¥ç±»å‹ï¼Œå“åº”ä»¥HTTP Codeä¸ºåˆ¤æ–­ä¾æ®ã€‚</p><p>ä»¥UserControllerä¸ºä¾‹å­ï¼š</p><table><tr><th>æè¿°</th><th>è¯·æ±‚URI</th><th>HTTP Method</th><th>å¯¹åº”æ³¨è§£</th></tr><tr><td>æŸ¥è¯¢æ‰€æœ‰ç”¨æˆ·</td><td>/user</td><td>GET</td><td>@GetMapping</td></tr><tr><td>é€šè¿‡ç”¨æˆ·åæŸ¥æ‰¾ç”¨æˆ·</td><td>/user/{username}</td><td>GET</td><td>@GetMapping</td></tr><tr><td>æ–°å¢ç”¨æˆ·</td><td>/user</td><td>POST</td><td>@PostMapping</td></tr><tr><td>ä¿®æ”¹ç”¨æˆ·</td><td>/user</td><td>PUT</td><td>@PutMapping</td></tr><tr><td>åˆ é™¤ç”¨æˆ·</td><td>/user/{userIds}</td><td>DELETE</td><td>@DeleteMapping</td></tr></table><p>Controlleræ–¹æ³•é»˜è®¤è¿”å›200çŠ¶æ€ç ï¼Œå½“ControlleræŠ›å‡ºå¼‚å¸¸æ—¶ï¼Œå°†è¢«<code>GlobalExceptionHandler</code>æ•è·ï¼Œæ ¹æ®å¼‚å¸¸ç±»å‹ï¼Œè¿”å›ä¸åŒçš„HTTPçŠ¶æ€ç ï¼š</p><table><tr><th>å¼‚å¸¸ç±»å‹</th><th>å¼‚å¸¸æè¿°</th><th>çŠ¶æ€ç </th><th>å¯¹åº”å¸¸é‡</th></tr><tr><td>UnauthorizedException</td><td>æœªæˆæƒå¼‚å¸¸ï¼Œæƒé™ä¸è¶³å¼‚å¸¸</td><td>403</td><td>HttpStatus.FORBIDDEN</td></tr><tr><td>LimitAccessException</td><td>é™åˆ¶è®¿é—®å¼‚å¸¸ï¼Œè®¿é—®æ¥å£é¢‘ç‡è¶…é™</td><td>429</td><td>HttpStatus.TOO_MANY_REQUESTS</td></tr><tr><td>ConstraintViolationException</td><td>å‚æ•°æ ¡éªŒå¼‚å¸¸ï¼ˆæ™®é€šä¼ å‚ï¼‰</td><td>400</td><td>HttpStatus.BAD_REQUEST</td></tr><tr><td>BindException</td><td>å‚æ•°æ ¡éªŒå¼‚å¸¸ï¼ˆå®ä½“å¯¹è±¡ä¼ å‚ï¼‰</td><td>400</td><td>HttpStatus.BAD_REQUEST</td></tr><tr><td>FebsException</td><td>Febsç³»ç»Ÿå¼‚å¸¸</td><td>500</td><td>HttpStatus.INTERNAL_SERVER_ERROR</td></tr><tr><td>Exception</td><td>å‰©ä¸‹çš„åˆ«çš„å¼‚å¸¸</td><td>500</td><td>HttpStatus.INTERNAL_SERVER_ERROR</td></tr></table><h3 id="æ•°æ®å±‚ä»‹ç»"><a href="#æ•°æ®å±‚ä»‹ç»" class="headerlink" title="æ•°æ®å±‚ä»‹ç»"></a>æ•°æ®å±‚ä»‹ç»</h3><p>é¦–å…ˆçœ‹çœ‹è¡¨ç»“æ„ï¼Œæ•°æ®è¡¨åˆ†ä¸ºä¸¤å¤§ç±»ï¼šå®šæ—¶ä»»åŠ¡è¡¨å’Œç³»ç»Ÿè¡¨ã€‚</p><p><img src="img/febsvue/20190408141755.png" alt="QQæˆªå›¾20190408141755.png"></p><p>ä»¥qrtz_å¼€å¤´çš„ä¸ºå®šæ—¶ä»»åŠ¡è¡¨ï¼Œå®šæ—¶ä»»åŠ¡æœ‰åŸºäºå†…å­˜å’ŒåŸºäºæ•°æ®åº“çš„ï¼Œæœ¬é¡¹ç›®ä½¿ç”¨çš„æ˜¯åŸºäºæ•°æ®åº“æŒä¹…åŒ–çš„æ–¹æ¡ˆã€‚è¦è¯¦ç»†äº†è§£è¿™äº›è¡¨å¯ä»¥å‚è€ƒæ–‡ç« ï¼š<a href="http://www.ibloger.net/article/2650.html" target="_blank" rel="noopener">http://www.ibloger.net/article/2650.html</a>ã€‚</p><p>ä»¥t_å¼€å¤´çš„ä¸ºç³»ç»Ÿè¡¨ï¼Œä»–ä»¬çš„å…³ç³»å¦‚ä¸‹æ‰€ç¤º:</p><p><img src="img/febsvue/2019-04-08_145115.png" alt="2019-04-08_145115.png"></p><p>å…¶ä¸­ç”¨æˆ·ï¼Œè§’è‰²å’Œæƒé™ä¹‹é—´çš„å…³ç³»ä½¿ç”¨çš„æ˜¯ç»å…¸çš„RBACï¼ˆRole-Based Access Controlï¼ŒåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼‰æ¨¡å‹ã€‚ç®€å•åœ°è¯´ï¼Œä¸€ä¸ªç”¨æˆ·æ‹¥æœ‰è‹¥å¹²è§’è‰²ï¼Œæ¯ä¸€ä¸ªè§’è‰²æ‹¥æœ‰è‹¥å¹²æƒé™ã€‚è¿™æ ·ï¼Œå°±æ„é€ æˆâ€œç”¨æˆ·-è§’è‰²-æƒé™â€çš„æˆæƒæ¨¡å‹ã€‚åœ¨è¿™ç§æ¨¡å‹ä¸­ï¼Œç”¨æˆ·ä¸è§’è‰²ä¹‹é—´ï¼Œè§’è‰²ä¸æƒé™ä¹‹é—´ï¼Œä¸€èˆ¬è€…æ˜¯å¤šå¯¹å¤šçš„å…³ç³»ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="img/febsvue/QQæˆªå›¾20190408145646.png" alt="QQæˆªå›¾20190408145646.png"></p><p>æ¯”å¦‚è·å–ç”¨æˆ·åä¸ºmrbridçš„ç”¨æˆ·æƒé™è¿‡ç¨‹ä¸ºï¼š</p><ol><li><p>é€šè¿‡mrbridçš„user_idä»t_user_roleè¡¨è·å–å¯¹åº”çš„role_idï¼›</p></li><li><p>é€šè¿‡ç¬¬1æ­¥è·å–çš„role_idä»t_role_menuè¡¨è·å–å¯¹åº”çš„menu_idï¼›</p></li><li><p>é€šè¿‡ç¬¬2æ­¥è·å–çš„menu_idä»t_menuè·å–menuç›¸å…³ä¿¡æ¯ï¼ˆt_menuè¡¨çš„permissionä¸ºæƒé™ä¿¡æ¯ï¼‰ã€‚</p></li></ol><p>æ•°æ®å±‚æ¡†æ¶é‡‡ç”¨çš„æ˜¯<a href="https://mp.baomidou.com/guide/" target="_blank" rel="noopener">MybatisPlus</a>ï¼Œå…·ä½“å¯ä»¥å‚è€ƒå…¶å®˜æ–¹æ–‡æ¡£ã€‚</p><h3 id="ç™»å½•é€»è¾‘"><a href="#ç™»å½•é€»è¾‘" class="headerlink" title="ç™»å½•é€»è¾‘"></a>ç™»å½•é€»è¾‘</h3><p>ç™»å½•é€»è¾‘å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="img/febsvue/QQæˆªå›¾20190408153154.png" alt="QQæˆªå›¾20190408153154.png"></p><p>è¿™é‡Œè¯¦ç»†è¯´æ˜ä¸‹ç™»å½•æˆåŠŸåçš„ç¬¬2æ­¥ã€ç¬¬3æ­¥å’Œç¬¬4æ­¥è¿‡ç¨‹ï¼š</p><ul><li><p>ç™»å½•æˆåŠŸåï¼Œæ„å»ºä¸€ä¸ªActiveUserå¯¹è±¡ï¼Œå¯¹åº”<code>LoginController</code>çš„<code>saveTokenToRedis</code>æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ„å»ºåœ¨çº¿ç”¨æˆ·</span></span><br><span class="line">ActiveUser activeUser = <span class="keyword">new</span> ActiveUser();</span><br><span class="line">activeUser.setUsername(user.getUsername());</span><br><span class="line">activeUser.setIp(ip);</span><br><span class="line">activeUser.setToken(token.getToken());</span><br><span class="line">activeUser.setLoginAddress(AddressUtil.getCityInfo(DbSearcher.BTREE_ALGORITHM, ip));</span><br><span class="line"></span><br><span class="line"><span class="comment">// zset å­˜å‚¨ç™»å½•ç”¨æˆ·ï¼Œscore ä¸ºè¿‡æœŸæ—¶é—´æˆ³</span></span><br><span class="line"><span class="keyword">this</span>.redisService.zadd(FebsConstant.ACTIVE_USERS_ZSET_PREFIX, Double.valueOf(token.getExipreAt()), mapper.writeValueAsString(activeUser));</span><br></pre></td></tr></table></figure><p>ç„¶åå°†<code>activeUser</code>é€šè¿‡<code>ObjectMapper</code>åºåˆ—åŒ–ï¼Œå­˜å‚¨åˆ°Redisçš„Zsetç»“æ„ä¸­ï¼Œkeyä¸º<code>FebsConstant.ACTIVE_USERS_ZSET_PREFIX</code>ï¼ˆå³febs.user.activeï¼‰ï¼Œscoreä¸ºè¯¥ç”¨æˆ·çš„ç™»å½•è¿‡æœŸæ—¶é—´ç‚¹ï¼ˆå³Tokeanå¤±æ•ˆæ—¶é—´ï¼‰ï¼Œvalueä¸º<code>activeUser</code>åºåˆ—åŒ–å€¼ã€‚</p><div class="note info"><p>Zsetå®ƒåœ¨setçš„åŸºç¡€ä¸Šå¢åŠ äº†ä¸€ä¸ªé¡ºåºå±æ€§(score)ï¼Œè¿™ä¸€å±æ€§åœ¨æ·»åŠ ä¿®æ”¹å…ƒç´ æ—¶å€™å¯ä»¥æŒ‡å®šï¼Œæ¯æ¬¡æŒ‡å®šåï¼Œzsetä¼šè‡ªåŠ¨é‡æ–°æŒ‰æ–°çš„å€¼è°ƒæ•´é¡ºåºã€‚å¯ä»¥ç†è§£ä¸ºæœ‰ä¸¤åˆ—å­—æ®µçš„æ•°æ®è¡¨ï¼Œä¸€åˆ—å­˜value,ä¸€åˆ—å­˜é¡ºåºç¼–å·ã€‚</p></div><p>Zsetç›¸å…³Rediså‘½ä»¤ï¼š</p><p><img src="img/febsvue/redis-zset.png" alt="redis-zset.png"></p><p>æ¯”å¦‚å½“ç”¨æˆ·mrbirdå’Œscottç™»å½•æˆåŠŸåï¼ŒæŸ¥çœ‹Redisä¸­keyä¸ºfebs.user.activeçš„å€¼:</p><p><img src="img/febsvue/QQæˆªå›¾20190408154805.png" alt="QQæˆªå›¾20190408154805.png"></p></li><li><p>å°†Tokenå­˜å‚¨åˆ°Redisä¸­ï¼škeyä¸ºfebs.cache.token.tokenå€¼.IPåœ°å€ï¼Œvalueä¸ºtokenå€¼ï¼Œæœ‰æ•ˆæœŸä¸ºtokençš„æœ‰æ•ˆæ—¶é•¿ï¼Œå¯¹åº”çš„æºç ä¸ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.redisService.set(FebsConstant.TOKEN_CACHE_PREFIX + token.getToken() + StringPool.DOT + ip, token.getToken(), properties.getShiro().getJwtTimeOut() * <span class="number">1000</span>);</span><br></pre></td></tr></table></figure></li><li><p>è¿”å›å‰ç«¯æ•°æ®åŒ…æ‹¬:</p><p>1.tokenï¼štokenï¼›</p><p>2.exipreTimeï¼štokenè¿‡æœŸæ—¶é—´ï¼›</p><p>3.rolesï¼šç”¨æˆ·è§’è‰²ï¼›</p><p>4.permissionsï¼šç”¨æˆ·æƒé™ï¼›</p><p>5.configï¼šç”¨æˆ·å‰ç«¯ç³»ç»Ÿçš„ä¸ªæ€§åŒ–é…ç½®ï¼›</p><p>6.userï¼šç”¨æˆ·ä¿¡æ¯ï¼ˆä¸åŒ…æ‹¬å¯†ç ï¼‰ã€‚</p><p>æ¯”å¦‚ï¼Œå½“scottç™»å½•æˆåŠŸåï¼Œæ¥å£è¿”å›æ•°æ®å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"data"</span>: &#123;</span><br><span class="line">        <span class="attr">"permissions"</span>: [</span><br><span class="line">            <span class="string">"user:view"</span>,</span><br><span class="line">            <span class="string">"dept:add"</span>,</span><br><span class="line">            <span class="string">"job:export"</span>,</span><br><span class="line">            <span class="string">"role:add"</span>,</span><br><span class="line">            <span class="string">"weather:view"</span>,</span><br><span class="line">            <span class="string">"dict:add"</span>,</span><br><span class="line">            <span class="string">"role:export"</span>,</span><br><span class="line">            <span class="string">"menu:export"</span>,</span><br><span class="line">            <span class="string">"dict:view"</span>,</span><br><span class="line">            <span class="string">"dept:export"</span>,</span><br><span class="line">            <span class="string">"menu:view"</span>,</span><br><span class="line">            <span class="string">"role:view"</span>,</span><br><span class="line">            <span class="string">"user:export"</span>,</span><br><span class="line">            <span class="string">"job:add"</span>,</span><br><span class="line">            <span class="string">"dept:view"</span>,</span><br><span class="line">            <span class="string">"article:view"</span>,</span><br><span class="line">            <span class="string">"log:view"</span>,</span><br><span class="line">            <span class="string">"jobLog:view"</span>,</span><br><span class="line">            <span class="string">"job:view"</span>,</span><br><span class="line">            <span class="string">"menu:add"</span>,</span><br><span class="line">            <span class="string">"redis:view"</span>,</span><br><span class="line">            <span class="string">"log:export"</span>,</span><br><span class="line">            <span class="string">"movie:coming"</span>,</span><br><span class="line">            <span class="string">"movie:hot"</span>,</span><br><span class="line">            <span class="string">"dict:export"</span>,</span><br><span class="line">            <span class="string">"jobLog:export"</span>,</span><br><span class="line">            <span class="string">"user:online"</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="attr">"roles"</span>: [</span><br><span class="line">            <span class="string">"æ³¨å†Œç”¨æˆ·"</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="attr">"exipreTime"</span>: <span class="string">"20190408164521"</span>,</span><br><span class="line">        <span class="attr">"config"</span>: &#123;</span><br><span class="line">            <span class="attr">"userId"</span>: <span class="number">2</span>,</span><br><span class="line">            <span class="attr">"theme"</span>: <span class="string">"light"</span>,</span><br><span class="line">            <span class="attr">"layout"</span>: <span class="string">"side"</span>,</span><br><span class="line">            <span class="attr">"multiPage"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"fixSiderbar"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"fixHeader"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"color"</span>: <span class="string">"rgb(24, 144, 255)"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"user"</span>: &#123;</span><br><span class="line">            <span class="attr">"userId"</span>: <span class="number">2</span>,</span><br><span class="line">            <span class="attr">"username"</span>: <span class="string">"scott"</span>,</span><br><span class="line">            <span class="attr">"password"</span>: <span class="string">"it's a secret"</span>,</span><br><span class="line">            <span class="attr">"deptId"</span>: <span class="number">6</span>,</span><br><span class="line">            <span class="attr">"deptName"</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">"email"</span>: <span class="string">"scott@qq.com"</span>,</span><br><span class="line">            <span class="attr">"mobile"</span>: <span class="string">"15134627380"</span>,</span><br><span class="line">            <span class="attr">"status"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"createTime"</span>: <span class="string">"2017-12-30 00:16:39"</span>,</span><br><span class="line">            <span class="attr">"modifyTime"</span>: <span class="string">"2019-01-18 08:59:09"</span>,</span><br><span class="line">            <span class="attr">"lastLoginTime"</span>: <span class="string">"2019-01-23 15:34:28"</span>,</span><br><span class="line">            <span class="attr">"ssex"</span>: <span class="string">"0"</span>,</span><br><span class="line">            <span class="attr">"description"</span>: <span class="string">"æˆ‘æ˜¯scottï¼Œå—¯å—¯"</span>,</span><br><span class="line">            <span class="attr">"avatar"</span>: <span class="string">"gaOngJwsRYRaVAuXXcmB.png"</span>,</span><br><span class="line">            <span class="attr">"roleId"</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">"roleName"</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">"sortField"</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">"sortOrder"</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">"createTimeFrom"</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">"createTimeTo"</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">"id"</span>: <span class="string">"YBeNsMJ0ZJm9GLJP1rlO"</span>,</span><br><span class="line">            <span class="attr">"authCacheKey"</span>: <span class="number">2</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"token"</span>: <span class="string">"b25e39b47e774b4a05b3cb1555fc377f209457c3fd339d373d3fca7b1ea8be56fdc6ed05b7ffb0700e7300d242fb83b57b35f45ee1b155b380 50a0671bc7ec54c2f2c5bb1aee0651db69ce657e8ab4cb79c7806209103eda8a3bc96aa043a0144ae3c06a5c549ac168183c37384cf4347e450bf11644d0 62c31ffc3059e63722f849a5de4540b0d1"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"message"</span>: <span class="string">"è®¤è¯æˆåŠŸ"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h3 id="Redisç¼“å­˜ä½¿ç”¨"><a href="#Redisç¼“å­˜ä½¿ç”¨" class="headerlink" title="Redisç¼“å­˜ä½¿ç”¨"></a>Redisç¼“å­˜ä½¿ç”¨</h3><p>åœ¨ç³»ç»Ÿå¯åŠ¨è¿‡ç¨‹ä¸­ï¼Œä¼šæ‰§è¡Œç¼“å­˜åˆå§‹åŒ–æ“ä½œï¼Œå¯¹åº”<code>CacheInitRunner</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CacheInitRunner</span> <span class="keyword">implements</span> <span class="title">ApplicationRunner</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserManager userManager;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(ApplicationArguments args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ...</span><br><span class="line">            List&lt;User&gt; list = <span class="keyword">this</span>.userService.list();</span><br><span class="line">            <span class="keyword">for</span> (User user : list) &#123;</span><br><span class="line">                userManager.loadUserRedisCache(user);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>loadUserRedisCache</code>æ–¹æ³•æºç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å°†ç”¨æˆ·ç›¸å…³ä¿¡æ¯æ·»åŠ åˆ° Redisç¼“å­˜ä¸­</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> user user</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadUserRedisCache</span><span class="params">(User user)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">// ç¼“å­˜ç”¨æˆ·</span></span><br><span class="line">    cacheService.saveUser(user.getUsername());</span><br><span class="line">    <span class="comment">// ç¼“å­˜ç”¨æˆ·è§’è‰²</span></span><br><span class="line">    cacheService.saveRoles(user.getUsername());</span><br><span class="line">    <span class="comment">// ç¼“å­˜ç”¨æˆ·æƒé™</span></span><br><span class="line">    cacheService.savePermissions(user.getUsername());</span><br><span class="line">    <span class="comment">// ç¼“å­˜ç”¨æˆ·ä¸ªæ€§åŒ–é…ç½®</span></span><br><span class="line">    cacheService.saveUserConfigs(String.valueOf(user.getUserId()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸€è¿‡ç¨‹ç¼“å­˜äº†ç”¨æˆ·ä¿¡æ¯ï¼Œç”¨æˆ·è§’è‰²ä¿¡æ¯ï¼Œç”¨æˆ·æƒé™ä¿¡æ¯ï¼Œç”¨æˆ·çš„ä¸ªæ€§åŒ–é…ç½®ä¿¡æ¯ï¼Œç¼“å­˜çš„å…·ä½“keyï¼Œvalueå¯ä»¥æŸ¥çœ‹ä¸Šè¿°æ–¹æ³•çš„æºç ã€‚é€šè¿‡è¿™äº›ç¼“å­˜ï¼Œå¯ä»¥ä¸€å®šç¨‹åº¦å‡è½»æ•°æ®åº“å‹åŠ›ã€‚</p><p>ä¸ºäº†ç¡®ä¿ç¼“å­˜æ•°æ®å’Œæ•°æ®åº“æ•°æ®çš„ä¸€è‡´æ€§ï¼Œæˆ‘ä»¬å¿…é¡»åœ¨ç›¸åº”çš„å¢åˆ æ”¹æ–¹æ³•ä¸­å¯¹ç¼“å­˜è¿›è¡Œç›¸åº”çš„æ“ä½œã€‚æ¯”å¦‚åœ¨æ›´æ–°ç”¨æˆ·åï¼Œæˆ‘ä»¬å¿…é¡»æ›´æ–°ç›¸åº”çš„ç¼“å­˜ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateUser</span><span class="params">(User user)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é‡æ–°å°†ç”¨æˆ·ä¿¡æ¯ï¼Œç”¨æˆ·è§’è‰²ä¿¡æ¯ï¼Œç”¨æˆ·æƒé™ä¿¡æ¯ åŠ è½½åˆ° redisä¸­</span></span><br><span class="line">    cacheService.saveUser(user.getUsername());</span><br><span class="line">    cacheService.saveRoles(user.getUsername());</span><br><span class="line">    cacheService.savePermissions(user.getUsername());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><div class="note danger"><p>æ€»è€Œè¨€ä¹‹ï¼Œç”±äºæˆ‘ä»¬åœ¨å¯åŠ¨ç³»ç»Ÿçš„æ—¶å€™ç¼“å­˜äº†ç”¨æˆ·ä¿¡æ¯ï¼Œç”¨æˆ·è§’è‰²ä¿¡æ¯ï¼Œç”¨æˆ·æƒé™ä¿¡æ¯ï¼Œç”¨æˆ·çš„ä¸ªæ€§åŒ–é…ç½®ä¿¡æ¯ï¼Œä¹‹åå‡¡æ˜¯æ¶‰åŠåˆ°ç”¨æˆ·ï¼Œç”¨æˆ·è§’è‰²ï¼Œç”¨æˆ·æƒé™å’Œç”¨æˆ·ä¸ªæ€§åŒ–é…ç½®çš„ç›¸å…³å¢åˆ æ”¹æ“ä½œéƒ½åº”è¯¥åŠæ—¶æ›´æ–°ç›¸åº”çš„ç¼“å­˜ã€‚</p></div><h3 id="åŠ¨æ€è·¯ç”±æ„å»º"><a href="#åŠ¨æ€è·¯ç”±æ„å»º" class="headerlink" title="åŠ¨æ€è·¯ç”±æ„å»º"></a>åŠ¨æ€è·¯ç”±æ„å»º</h3><p>ä¸åŒçš„ç”¨æˆ·æ‹¥æœ‰ä¸åŒçš„è§’è‰²ï¼Œä¸åŒçš„è§’è‰²å¯¹åº”ä¸åŒçš„èœå•æƒé™ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦é€šè¿‡ç”¨æˆ·æŸ¥è¯¢å‡ºå¯¹åº”çš„èœå•åˆ—è¡¨ï¼Œç„¶åå°†åˆ—è¡¨æ„å»ºæˆå‰ç«¯éœ€è¦çš„è·¯ç”±ï¼ˆå‰ç«¯æ ¹æ®è·¯ç”±ä¿¡æ¯æ„å»ºç›¸åº”çš„èœå•ï¼‰ã€‚</p><p>è·å–ç”¨æˆ·è·¯ç”±çš„æ–¹æ³•ä¸º<code>UserManage#getUserRouters</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * é€šè¿‡ç”¨æˆ·åæ„å»º Vueè·¯ç”±</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> username ç”¨æˆ·å</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> è·¯ç”±é›†åˆ</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> ArrayList&lt;VueRouter&lt;Menu&gt;&gt; getUserRouters(String username) &#123;</span><br><span class="line">    List&lt;VueRouter&lt;Menu&gt;&gt; routes = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    List&lt;Menu&gt; menus = <span class="keyword">this</span>.menuService.findUserMenus(username);</span><br><span class="line">    menus.forEach(menu -&gt; &#123;</span><br><span class="line">        VueRouter&lt;Menu&gt; route = <span class="keyword">new</span> VueRouter&lt;&gt;();</span><br><span class="line">        route.setId(menu.getMenuId().toString());</span><br><span class="line">        route.setParentId(menu.getParentId().toString());</span><br><span class="line">        route.setIcon(menu.getIcon());</span><br><span class="line">        route.setPath(menu.getPath());</span><br><span class="line">        route.setComponent(menu.getComponent());</span><br><span class="line">        route.setName(menu.getMenuName());</span><br><span class="line">        route.setMeta(<span class="keyword">new</span> RouterMeta(<span class="keyword">true</span>, <span class="keyword">null</span>));</span><br><span class="line">        routes.add(route);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> TreeUtil.buildVueRouter(routes);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>æ¯”å¦‚ç”¨æˆ·mrbirdå¯¹åº”çš„å‰ç«¯è·¯ç”±ä¸ºï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">"path"</span>: <span class="string">"/"</span>,</span><br><span class="line">        <span class="attr">"name"</span>: <span class="string">"ä¸»é¡µ"</span>,</span><br><span class="line">        <span class="attr">"component"</span>: <span class="string">"MenuView"</span>,</span><br><span class="line">        <span class="attr">"icon"</span>: <span class="string">"none"</span>,</span><br><span class="line">        <span class="attr">"redirect"</span>: <span class="string">"/home"</span>,</span><br><span class="line">        <span class="attr">"children"</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">"path"</span>: <span class="string">"/home"</span>,</span><br><span class="line">                <span class="attr">"name"</span>: <span class="string">"ç³»ç»Ÿä¸»é¡µ"</span>,</span><br><span class="line">                <span class="attr">"component"</span>: <span class="string">"HomePageView"</span>,</span><br><span class="line">                <span class="attr">"icon"</span>: <span class="string">"home"</span>,</span><br><span class="line">                <span class="attr">"meta"</span>: &#123;</span><br><span class="line">                    <span class="attr">"closeable"</span>: <span class="literal">false</span>,</span><br><span class="line">                    <span class="attr">"isShow"</span>: <span class="literal">true</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">"path"</span>: <span class="string">"/system"</span>,</span><br><span class="line">                <span class="attr">"name"</span>: <span class="string">"ç³»ç»Ÿç®¡ç†"</span>,</span><br><span class="line">                <span class="attr">"component"</span>: <span class="string">"PageView"</span>,</span><br><span class="line">                <span class="attr">"icon"</span>: <span class="string">"appstore-o"</span>,</span><br><span class="line">                <span class="attr">"meta"</span>: &#123;</span><br><span class="line">                    <span class="attr">"closeable"</span>: <span class="literal">true</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">"children"</span>: [</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="attr">"path"</span>: <span class="string">"/system/user"</span>,</span><br><span class="line">                        <span class="attr">"name"</span>: <span class="string">"ç”¨æˆ·ç®¡ç†"</span>,</span><br><span class="line">                        <span class="attr">"component"</span>: <span class="string">"system/user/User"</span>,</span><br><span class="line">                        <span class="attr">"icon"</span>: <span class="string">""</span>,</span><br><span class="line">                        <span class="attr">"meta"</span>: &#123;</span><br><span class="line">                            <span class="attr">"closeable"</span>: <span class="literal">true</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="attr">"path"</span>: <span class="string">"/system/role"</span>,</span><br><span class="line">                        <span class="attr">"name"</span>: <span class="string">"è§’è‰²ç®¡ç†"</span>,</span><br><span class="line">                        <span class="attr">"component"</span>: <span class="string">"system/role/Role"</span>,</span><br><span class="line">                        <span class="attr">"icon"</span>: <span class="string">""</span>,</span><br><span class="line">                        <span class="attr">"meta"</span>: &#123;</span><br><span class="line">                            <span class="attr">"closeable"</span>: <span class="literal">true</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="attr">"path"</span>: <span class="string">"/system/menu"</span>,</span><br><span class="line">                        <span class="attr">"name"</span>: <span class="string">"èœå•ç®¡ç†"</span>,</span><br><span class="line">                        <span class="attr">"component"</span>: <span class="string">"system/menu/Menu"</span>,</span><br><span class="line">                        <span class="attr">"icon"</span>: <span class="string">""</span>,</span><br><span class="line">                        <span class="attr">"meta"</span>: &#123;</span><br><span class="line">                            <span class="attr">"closeable"</span>: <span class="literal">true</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="attr">"path"</span>: <span class="string">"/system/dept"</span>,</span><br><span class="line">                        <span class="attr">"name"</span>: <span class="string">"éƒ¨é—¨ç®¡ç†"</span>,</span><br><span class="line">                        <span class="attr">"component"</span>: <span class="string">"system/dept/Dept"</span>,</span><br><span class="line">                        <span class="attr">"icon"</span>: <span class="string">""</span>,</span><br><span class="line">                        <span class="attr">"meta"</span>: &#123;</span><br><span class="line">                            <span class="attr">"closeable"</span>: <span class="literal">true</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="attr">"path"</span>: <span class="string">"/system/dict"</span>,</span><br><span class="line">                        <span class="attr">"name"</span>: <span class="string">"å­—å…¸ç®¡ç†"</span>,</span><br><span class="line">                        <span class="attr">"component"</span>: <span class="string">"system/dict/Dict"</span>,</span><br><span class="line">                        <span class="attr">"icon"</span>: <span class="string">""</span>,</span><br><span class="line">                        <span class="attr">"meta"</span>: &#123;</span><br><span class="line">                            <span class="attr">"closeable"</span>: <span class="literal">true</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                ]</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">"path"</span>: <span class="string">"/monitor"</span>,</span><br><span class="line">                <span class="attr">"name"</span>: <span class="string">"ç³»ç»Ÿç›‘æ§"</span>,</span><br><span class="line">                <span class="attr">"component"</span>: <span class="string">"PageView"</span>,</span><br><span class="line">                <span class="attr">"icon"</span>: <span class="string">"dashboard"</span>,</span><br><span class="line">                <span class="attr">"meta"</span>: &#123;</span><br><span class="line">                    <span class="attr">"closeable"</span>: <span class="literal">true</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">"children"</span>: [</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="attr">"path"</span>: <span class="string">"/monitor/online"</span>,</span><br><span class="line">                        <span class="attr">"name"</span>: <span class="string">"åœ¨çº¿ç”¨æˆ·"</span>,</span><br><span class="line">                        <span class="attr">"component"</span>: <span class="string">"monitor/Online"</span>,</span><br><span class="line">                        <span class="attr">"icon"</span>: <span class="string">""</span>,</span><br><span class="line">                        <span class="attr">"meta"</span>: &#123;</span><br><span class="line">                            <span class="attr">"closeable"</span>: <span class="literal">true</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="attr">"path"</span>: <span class="string">"/monitor/systemlog"</span>,</span><br><span class="line">                        <span class="attr">"name"</span>: <span class="string">"ç³»ç»Ÿæ—¥å¿—"</span>,</span><br><span class="line">                        <span class="attr">"component"</span>: <span class="string">"monitor/SystemLog"</span>,</span><br><span class="line">                        <span class="attr">"icon"</span>: <span class="string">""</span>,</span><br><span class="line">                        <span class="attr">"meta"</span>: &#123;</span><br><span class="line">                            <span class="attr">"closeable"</span>: <span class="literal">true</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="attr">"path"</span>: <span class="string">"/monitor/redis/info"</span>,</span><br><span class="line">                        <span class="attr">"name"</span>: <span class="string">"Redisç›‘æ§"</span>,</span><br><span class="line">                        <span class="attr">"component"</span>: <span class="string">"monitor/RedisInfo"</span>,</span><br><span class="line">                        <span class="attr">"icon"</span>: <span class="string">""</span>,</span><br><span class="line">                        <span class="attr">"meta"</span>: &#123;</span><br><span class="line">                            <span class="attr">"closeable"</span>: <span class="literal">true</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="attr">"path"</span>: <span class="string">"/monitor/httptrace"</span>,</span><br><span class="line">                        <span class="attr">"name"</span>: <span class="string">"è¯·æ±‚è¿½è¸ª"</span>,</span><br><span class="line">                        <span class="attr">"component"</span>: <span class="string">"monitor/Httptrace"</span>,</span><br><span class="line">                        <span class="attr">"meta"</span>: &#123;</span><br><span class="line">                            <span class="attr">"closeable"</span>: <span class="literal">true</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="attr">"path"</span>: <span class="string">"/monitor/system"</span>,</span><br><span class="line">                        <span class="attr">"name"</span>: <span class="string">"ç³»ç»Ÿä¿¡æ¯"</span>,</span><br><span class="line">                        <span class="attr">"component"</span>: <span class="string">"EmptyPageView"</span>,</span><br><span class="line">                        <span class="attr">"meta"</span>: &#123;</span><br><span class="line">                            <span class="attr">"closeable"</span>: <span class="literal">true</span></span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="attr">"children"</span>: [</span><br><span class="line">                            &#123;</span><br><span class="line">                                <span class="attr">"path"</span>: <span class="string">"/monitor/system/jvminfo"</span>,</span><br><span class="line">                                <span class="attr">"name"</span>: <span class="string">"JVMä¿¡æ¯"</span>,</span><br><span class="line">                                <span class="attr">"component"</span>: <span class="string">"monitor/JvmInfo"</span>,</span><br><span class="line">                                <span class="attr">"meta"</span>: &#123;</span><br><span class="line">                                    <span class="attr">"closeable"</span>: <span class="literal">true</span></span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;,</span><br><span class="line">                            &#123;</span><br><span class="line">                                <span class="attr">"path"</span>: <span class="string">"/monitor/system/tomcatinfo"</span>,</span><br><span class="line">                                <span class="attr">"name"</span>: <span class="string">"Tomcatä¿¡æ¯"</span>,</span><br><span class="line">                                <span class="attr">"component"</span>: <span class="string">"monitor/TomcatInfo"</span>,</span><br><span class="line">                                <span class="attr">"meta"</span>: &#123;</span><br><span class="line">                                    <span class="attr">"closeable"</span>: <span class="literal">true</span></span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;,</span><br><span class="line">                            &#123;</span><br><span class="line">                                <span class="attr">"path"</span>: <span class="string">"/monitor/system/info"</span>,</span><br><span class="line">                                <span class="attr">"name"</span>: <span class="string">"æœåŠ¡å™¨ä¿¡æ¯"</span>,</span><br><span class="line">                                <span class="attr">"component"</span>: <span class="string">"monitor/SystemInfo"</span>,</span><br><span class="line">                                <span class="attr">"meta"</span>: &#123;</span><br><span class="line">                                    <span class="attr">"closeable"</span>: <span class="literal">true</span></span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        ]</span><br><span class="line">                    &#125;</span><br><span class="line">                ]</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">"path"</span>: <span class="string">"/job"</span>,</span><br><span class="line">                <span class="attr">"name"</span>: <span class="string">"ä»»åŠ¡è°ƒåº¦"</span>,</span><br><span class="line">                <span class="attr">"component"</span>: <span class="string">"PageView"</span>,</span><br><span class="line">                <span class="attr">"icon"</span>: <span class="string">"clock-circle-o"</span>,</span><br><span class="line">                <span class="attr">"meta"</span>: &#123;</span><br><span class="line">                    <span class="attr">"closeable"</span>: <span class="literal">true</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">"children"</span>: [</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="attr">"path"</span>: <span class="string">"/job/job"</span>,</span><br><span class="line">                        <span class="attr">"name"</span>: <span class="string">"å®šæ—¶ä»»åŠ¡"</span>,</span><br><span class="line">                        <span class="attr">"component"</span>: <span class="string">"quartz/job/Job"</span>,</span><br><span class="line">                        <span class="attr">"icon"</span>: <span class="string">""</span>,</span><br><span class="line">                        <span class="attr">"meta"</span>: &#123;</span><br><span class="line">                            <span class="attr">"closeable"</span>: <span class="literal">true</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="attr">"path"</span>: <span class="string">"/job/log"</span>,</span><br><span class="line">                        <span class="attr">"name"</span>: <span class="string">"è°ƒåº¦æ—¥å¿—"</span>,</span><br><span class="line">                        <span class="attr">"component"</span>: <span class="string">"quartz/log/JobLog"</span>,</span><br><span class="line">                        <span class="attr">"icon"</span>: <span class="string">""</span>,</span><br><span class="line">                        <span class="attr">"meta"</span>: &#123;</span><br><span class="line">                            <span class="attr">"closeable"</span>: <span class="literal">true</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                ]</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">"path"</span>: <span class="string">"/web"</span>,</span><br><span class="line">                <span class="attr">"name"</span>: <span class="string">"ç½‘ç»œèµ„æº"</span>,</span><br><span class="line">                <span class="attr">"component"</span>: <span class="string">"PageView"</span>,</span><br><span class="line">                <span class="attr">"icon"</span>: <span class="string">"compass"</span>,</span><br><span class="line">                <span class="attr">"meta"</span>: &#123;</span><br><span class="line">                    <span class="attr">"closeable"</span>: <span class="literal">true</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">"children"</span>: [</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="attr">"path"</span>: <span class="string">"/web/weather"</span>,</span><br><span class="line">                        <span class="attr">"name"</span>: <span class="string">"å¤©æ°”æŸ¥è¯¢"</span>,</span><br><span class="line">                        <span class="attr">"component"</span>: <span class="string">"web/Weather"</span>,</span><br><span class="line">                        <span class="attr">"icon"</span>: <span class="string">""</span>,</span><br><span class="line">                        <span class="attr">"meta"</span>: &#123;</span><br><span class="line">                            <span class="attr">"closeable"</span>: <span class="literal">true</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="attr">"path"</span>: <span class="string">"/web/dailyArticle"</span>,</span><br><span class="line">                        <span class="attr">"name"</span>: <span class="string">"æ¯æ—¥ä¸€æ–‡"</span>,</span><br><span class="line">                        <span class="attr">"component"</span>: <span class="string">"web/DailyArticle"</span>,</span><br><span class="line">                        <span class="attr">"icon"</span>: <span class="string">""</span>,</span><br><span class="line">                        <span class="attr">"meta"</span>: &#123;</span><br><span class="line">                            <span class="attr">"closeable"</span>: <span class="literal">true</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="attr">"path"</span>: <span class="string">"/web/movie"</span>,</span><br><span class="line">                        <span class="attr">"name"</span>: <span class="string">"å½±è§†èµ„è®¯"</span>,</span><br><span class="line">                        <span class="attr">"component"</span>: <span class="string">"EmptyPageView"</span>,</span><br><span class="line">                        <span class="attr">"meta"</span>: &#123;</span><br><span class="line">                            <span class="attr">"closeable"</span>: <span class="literal">true</span></span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="attr">"children"</span>: [</span><br><span class="line">                            &#123;</span><br><span class="line">                                <span class="attr">"path"</span>: <span class="string">"/web/movie/hot"</span>,</span><br><span class="line">                                <span class="attr">"name"</span>: <span class="string">"æ­£åœ¨çƒ­æ˜ "</span>,</span><br><span class="line">                                <span class="attr">"component"</span>: <span class="string">"web/MovieHot"</span>,</span><br><span class="line">                                <span class="attr">"icon"</span>: <span class="string">""</span>,</span><br><span class="line">                                <span class="attr">"meta"</span>: &#123;</span><br><span class="line">                                    <span class="attr">"closeable"</span>: <span class="literal">true</span></span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;,</span><br><span class="line">                            &#123;</span><br><span class="line">                                <span class="attr">"path"</span>: <span class="string">"/web/movie/coming"</span>,</span><br><span class="line">                                <span class="attr">"name"</span>: <span class="string">"å³å°†ä¸Šæ˜ "</span>,</span><br><span class="line">                                <span class="attr">"component"</span>: <span class="string">"web/MovieComing"</span>,</span><br><span class="line">                                <span class="attr">"icon"</span>: <span class="string">""</span>,</span><br><span class="line">                                <span class="attr">"meta"</span>: &#123;</span><br><span class="line">                                    <span class="attr">"closeable"</span>: <span class="literal">true</span></span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        ]</span><br><span class="line">                    &#125;</span><br><span class="line">                ]</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">"path"</span>: <span class="string">"/others"</span>,</span><br><span class="line">                <span class="attr">"name"</span>: <span class="string">"å…¶ä»–æ¨¡å—"</span>,</span><br><span class="line">                <span class="attr">"component"</span>: <span class="string">"PageView"</span>,</span><br><span class="line">                <span class="attr">"icon"</span>: <span class="string">"coffee"</span>,</span><br><span class="line">                <span class="attr">"meta"</span>: &#123;</span><br><span class="line">                    <span class="attr">"closeable"</span>: <span class="literal">true</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">"children"</span>: [</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="attr">"path"</span>: <span class="string">"/others/excel"</span>,</span><br><span class="line">                        <span class="attr">"name"</span>: <span class="string">"å¯¼å…¥å¯¼å‡º"</span>,</span><br><span class="line">                        <span class="attr">"component"</span>: <span class="string">"others/Excel"</span>,</span><br><span class="line">                        <span class="attr">"meta"</span>: &#123;</span><br><span class="line">                            <span class="attr">"closeable"</span>: <span class="literal">true</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                ]</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">"path"</span>: <span class="string">"/profile"</span>,</span><br><span class="line">                <span class="attr">"name"</span>: <span class="string">"ä¸ªäººä¸­å¿ƒ"</span>,</span><br><span class="line">                <span class="attr">"component"</span>: <span class="string">"personal/Profile"</span>,</span><br><span class="line">                <span class="attr">"icon"</span>: <span class="string">"none"</span>,</span><br><span class="line">                <span class="attr">"meta"</span>: &#123;</span><br><span class="line">                    <span class="attr">"closeable"</span>: <span class="literal">true</span>,</span><br><span class="line">                    <span class="attr">"isShow"</span>: <span class="literal">false</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">"path"</span>: <span class="string">"*"</span>,</span><br><span class="line">        <span class="attr">"name"</span>: <span class="string">"404"</span>,</span><br><span class="line">        <span class="attr">"component"</span>: <span class="string">"error/404"</span></span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p></p><p>å…³äºVue Routerå¯ä»¥å‚è€ƒï¼š<a href="https://router.vuejs.org/zh/" target="_blank" rel="noopener">https://router.vuejs.org/zh/</a>ã€‚</p><h3 id="æƒé™æ§åˆ¶"><a href="#æƒé™æ§åˆ¶" class="headerlink" title="æƒé™æ§åˆ¶"></a>æƒé™æ§åˆ¶</h3><p>æˆ‘ä»¬å¯ä»¥åœ¨Controllerçš„æ–¹æ³•ä¸Šé€šè¿‡Shiroç›¸å…³çš„æƒé™æ³¨è§£è¿›è¡Œæƒé™æ§åˆ¶ï¼Œæ¯”å¦‚ä¸‹é¢è¿™ä¸ªæ–¹æ³•åªæœ‰å½“ç”¨æˆ·æ‹¥æœ‰<code>user:add</code>æƒé™æ‰èƒ½è®¿é—®ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping</span>(<span class="string">"/user"</span>)</span><br><span class="line"><span class="meta">@RequiresPermissions</span>(<span class="string">"user:add"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addUser</span><span class="params">(@Valid User user)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>å½“ç”¨æˆ·æ²¡æœ‰<code>user:add</code>æƒé™æ—¶ï¼Œç³»ç»Ÿå°†æŠ›å‡º<code>UnauthorizedException</code>å¼‚å¸¸ï¼Œç”±<code>GlobalExceptionHandler</code>æ•è·ï¼Œè¿”å›403çŠ¶æ€ç ã€‚</p><p>æ›´å¤šShiroæä¾›çš„æƒé™æ³¨è§£å¯ä»¥å‚è€ƒï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¡¨ç¤ºå½“å‰Subjectå·²ç»é€šè¿‡loginè¿›è¡Œäº†èº«ä»½éªŒè¯ï¼›å³Subject.isAuthenticated()è¿”å›trueã€‚</span></span><br><span class="line"><span class="meta">@RequiresAuthentication</span>  </span><br><span class="line"> </span><br><span class="line"><span class="comment">// è¡¨ç¤ºå½“å‰Subjectå·²ç»èº«ä»½éªŒè¯æˆ–è€…é€šè¿‡è®°ä½æˆ‘ç™»å½•çš„ã€‚</span></span><br><span class="line"><span class="meta">@RequiresUser</span>  </span><br><span class="line"></span><br><span class="line"><span class="comment">// è¡¨ç¤ºå½“å‰Subjectæ²¡æœ‰èº«ä»½éªŒè¯æˆ–é€šè¿‡è®°ä½æˆ‘ç™»å½•è¿‡ï¼Œå³æ˜¯æ¸¸å®¢èº«ä»½ã€‚</span></span><br><span class="line"><span class="meta">@RequiresGuest</span>  </span><br><span class="line"></span><br><span class="line"><span class="comment">// è¡¨ç¤ºå½“å‰Subjectéœ€è¦è§’è‰²adminå’Œuserã€‚  </span></span><br><span class="line"><span class="meta">@RequiresRoles</span>(value=&#123;<span class="string">"admin"</span>, <span class="string">"user"</span>&#125;, logical= Logical.AND)  </span><br><span class="line"></span><br><span class="line"><span class="comment">// è¡¨ç¤ºå½“å‰Subjectéœ€è¦æƒé™user:aæˆ–user:bã€‚</span></span><br><span class="line"><span class="meta">@RequiresPermissions</span> (value=&#123;<span class="string">"user:a"</span>, <span class="string">"user:b"</span>&#125;, logical= Logical.OR)</span><br></pre></td></tr></table></figure><p></p><h3 id="å¤šæ•°æ®æº"><a href="#å¤šæ•°æ®æº" class="headerlink" title="å¤šæ•°æ®æº"></a>å¤šæ•°æ®æº</h3><p>å¤šæ•°æ®æºé‡‡ç”¨çš„æ˜¯MyBatis Plusæä¾›çš„æ–¹æ¡ˆï¼š<a href="https://mp.baomidou.com/guide/dynamic-datasource.html" target="_blank" rel="noopener">https://mp.baomidou.com/guide/dynamic-datasource.html</a></p><h3 id="ä»£ç ç”Ÿæˆ"><a href="#ä»£ç ç”Ÿæˆ" class="headerlink" title="ä»£ç ç”Ÿæˆ"></a>ä»£ç ç”Ÿæˆ</h3><p>ç›®å‰åªæœ‰åç«¯ä»£ç ç”Ÿæˆå™¨ï¼Œé‡‡ç”¨çš„æ˜¯MyBatis Plusæä¾›çš„æ–¹æ¡ˆï¼Œå¯¹åº”æºç <code>cc.mrbird.febs.common.generator.CodeGenerator</code>ï¼Œæ‰§è¡Œå…¶mainæ–¹æ³•ï¼Œç„¶åè¾“å…¥è¡¨åï¼Œå°±å¯ä»¥ç”Ÿæˆç›¸åº”çš„domainã€daoã€serviceã€controllerã€mapper.xmlã€‚</p><h3 id="Excelå¯¼å…¥å¯¼å‡º"><a href="#Excelå¯¼å…¥å¯¼å‡º" class="headerlink" title="Excelå¯¼å…¥å¯¼å‡º"></a>Excelå¯¼å…¥å¯¼å‡º</h3><p>Excelå¯¼å…¥å¯¼å‡ºä½¿ç”¨çš„æ’ä»¶ä¸ºï¼š<a href="https://gitee.com/wuwenze/ExcelKit" target="_blank" rel="noopener">https://gitee.com/wuwenze/ExcelKit</a>ï¼Œå…·ä½“æ“ä½œè§„åˆ™å¯ä»¥ä»”ç»†é˜…è¯»è¿™ä¸ªé¡¹ç›®çš„Readme.md</p><h3 id="ç»Ÿä¸€å‚æ•°æ ¡éªŒ"><a href="#ç»Ÿä¸€å‚æ•°æ ¡éªŒ" class="headerlink" title="ç»Ÿä¸€å‚æ•°æ ¡éªŒ"></a>ç»Ÿä¸€å‚æ•°æ ¡éªŒ</h3><p>ç»Ÿä¸€å‚æ•°æ ¡éªŒå¯ä»¥å‚è€ƒæˆ‘çš„åšå®¢ï¼š<a href="https://mrbird.cc/Spring-Boot-Hibernate-Validator-Params-Check.html">Spring Booté…åˆHibernate Validatorå‚æ•°æ ¡éªŒ</a>ã€‚</p><h3 id="SQLæ‰“å°"><a href="#SQLæ‰“å°" class="headerlink" title="SQLæ‰“å°"></a>SQLæ‰“å°</h3><p>SQLæ‰“å°é‡‡ç”¨çš„æ’ä»¶ä¸º<a href="https://p6spy.readthedocs.io/en/latest/index.html" target="_blank" rel="noopener">p6spy</a>ï¼Œè¦å¼€å¯p6spyçš„SQLæ‰“å°åŠŸèƒ½ï¼Œåªéœ€å°†é…ç½®æ–‡ä»¶application.ymlä¸­çš„<code>spring.datasource.dynamic.p6spy</code>æ”¹ä¸º<code>true</code>å³å¯ã€‚</p><p>åœ¨p6spy.propertiesæ–‡ä»¶ä¸­å¯ä»¥é…ç½®æ‰“å°è§„åˆ™ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># ä½¿ç”¨æ—¥å¿—ç³»ç»Ÿè®°å½• sql</span><br><span class="line">appender=com.p6spy.engine.spy.appender.Slf4JLogger</span><br><span class="line"># è‡ªå®šä¹‰æ—¥å¿—æ‰“å°</span><br><span class="line">logMessageFormat=cc.mrbird.febs.common.config.P6spySqlFormatConfig</span><br><span class="line"># æ˜¯å¦å¼€å¯æ…¢ SQLè®°å½•</span><br><span class="line">outagedetection=true</span><br><span class="line"># æ…¢ SQLè®°å½•æ ‡å‡† 2 ç§’</span><br><span class="line">outagedetectioninterval=2</span><br><span class="line"># å¼€å¯è¿‡æ»¤</span><br><span class="line">filter=true</span><br><span class="line"># åŒ…å« QRTZçš„ä¸æ‰“å°</span><br><span class="line">exclude=QRTZ</span><br></pre></td></tr></table></figure><p></p><p>SQLæ‰“å°æ•ˆæœå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">2019-04-08 15:29:50 | INFO  | http-nio-9527-exec-1 | p6spy | 2019-04-08 15:29:50 | è€—æ—¶ 73 ms | SQL è¯­å¥ï¼š</span><br><span class="line">UPDATE t_user SET last_login_time=&apos;2019-04-08T15:29:50.724+0800&apos; WHERE username = &apos;mrbird&apos;;</span><br><span class="line">2019-04-08 15:29:50 | INFO  | http-nio-9527-exec-1 | p6spy | 2019-04-08 15:29:50 | è€—æ—¶ 0 ms | SQL è¯­å¥ï¼š</span><br><span class="line">SELECT USER_ID,username,password,dept_id,email,mobile,status,create_time,modify_time,last_login_time,ssex,description,avatar FROM t_user WHERE username = &apos;mrbird&apos;;</span><br><span class="line">2019-04-08 15:29:52 | INFO  | http-nio-9527-exec-1 | p6spy | 2019-04-08 15:29:52 | è€—æ—¶ 489 ms | SQL è¯­å¥ï¼š</span><br><span class="line">INSERT INTO t_login_log ( username, login_time, location, ip ) VALUES ( &apos;mrbird&apos;, &apos;2019-04-08T15:29:50.874+0800&apos;, &apos;&apos;, &apos;127.0.0.1&apos; );</span><br><span class="line">2019-04-08 15:45:20 | INFO  | http-nio-9527-exec-7 | p6spy | 2019-04-08 15:45:20 | è€—æ—¶ 1 ms | SQL è¯­å¥ï¼š</span><br><span class="line">UPDATE t_user SET last_login_time=&apos;2019-04-08T15:45:20.193+0800&apos; WHERE username = &apos;scott&apos;;</span><br><span class="line">2019-04-08 15:45:20 | INFO  | http-nio-9527-exec-7 | p6spy | 2019-04-08 15:45:20 | è€—æ—¶ 0 ms | SQL è¯­å¥ï¼š</span><br><span class="line">SELECT USER_ID,username,password,dept_id,email,mobile,status,create_time,modify_time,last_login_time,ssex,description,avatar FROM t_user WHERE username = &apos;scott&apos;;</span><br><span class="line">2019-04-08 15:45:21 | INFO  | http-nio-9527-exec-7 | p6spy | 2019-04-08 15:45:21 | è€—æ—¶ 89 ms | SQL è¯­å¥ï¼š</span><br><span class="line">INSERT INTO t_login_log ( username, login_time, location, ip ) VALUES ( &apos;scott&apos;, &apos;2019-04-08T15:45:20.466+0800&apos;, &apos;&apos;, &apos;127.0.0.1&apos; );</span><br></pre></td></tr></table></figure><div class="note info"><p>å¼€å¯è¿™ä¸ªåŠŸèƒ½æ–¹ä¾¿æˆ‘ä»¬å¼€å‘è°ƒè¯•ï¼Œç”Ÿäº§ç¯å¢ƒæœ€å¥½å…³é—­è¿™ä¸ªåŠŸèƒ½ï¼Œå› ä¸ºå®ƒåœ¨ä¸€å®šç¨‹åº¦ä¸Šä¼šé€ æˆæ€§èƒ½è€—æŸã€‚</p></div><p>æ›´å¤šp6psyçš„é…ç½®å¯ä»¥å‚è€ƒï¼š<a href="https://p6spy.readthedocs.io/en/latest/configandusage.html" target="_blank" rel="noopener">https://p6spy.readthedocs.io/en/latest/configandusage.html</a></p><h3 id="AOPè®°å½•æ“ä½œæ—¥å¿—"><a href="#AOPè®°å½•æ“ä½œæ—¥å¿—" class="headerlink" title="AOPè®°å½•æ“ä½œæ—¥å¿—"></a>AOPè®°å½•æ“ä½œæ—¥å¿—</h3><p>å…·ä½“å¯ä»¥å‚è€ƒæˆ‘çš„åšå®¢ï¼š<a href="https://mrbird.cc/Spring-Boot-AOP%20log.html">Spring Boot AOPè®°å½•ç”¨æˆ·æ“ä½œæ—¥å¿—</a>ã€‚</p><p>è®°å½•æ“ä½œæ—¥å¿—çš„è¿‡ç¨‹å¯ä»¥æ”¹ä¸ºå¼‚æ­¥çš„æ–¹å¼ï¼Œè¿™æ ·ä¸ä¼šé€ æˆæ¥å£æ€§èƒ½æŸè€—ï¼Œå¯ä»¥å‚è€ƒæˆ‘çš„åšå®¢ï¼š<a href="https://mrbird.cc/Spring-Boot-Async.html">Spring Boot ä¸­çš„å¼‚æ­¥è°ƒç”¨</a>ã€‚</p><h3 id="æ¥å£é™æµ"><a href="#æ¥å£é™æµ" class="headerlink" title="æ¥å£é™æµ"></a>æ¥å£é™æµ</h3><p>é¡¹ç›®ä¸­<code>@Limit</code>æ³¨è§£å¯ä»¥å®ç°æ¥å£çš„é™æµã€‚å³è§„å®šä¸€æ®µæ—¶é—´å†…æœ€å¤šå¯ä»¥è®¿é—®è¯¥æ¥å£çš„æ¬¡æ•°ï¼Œè¶…è¿‡è¿™ä¸ªæ¬¡æ•°åˆ™æŠ›å‡º<code>LimitAccessException</code>å¼‚å¸¸ã€‚<code>@Limit</code>æ³¨è§£å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cc.mrbird.common.domain.LimitType;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Target</span>(ElementType.METHOD)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Limit &#123;</span><br><span class="line">    <span class="comment">// èµ„æºåç§°ï¼Œç”¨äºæè¿°æ¥å£åŠŸèƒ½</span></span><br><span class="line">    <span class="function">String <span class="title">name</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</span><br><span class="line">    <span class="comment">// èµ„æº key</span></span><br><span class="line">    <span class="function">String <span class="title">key</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</span><br><span class="line">    <span class="comment">// key prefix</span></span><br><span class="line">    <span class="function">String <span class="title">prefix</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</span><br><span class="line">    <span class="comment">// æ—¶é—´çš„ï¼Œå•ä½ç§’</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">period</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">// é™åˆ¶è®¿é—®æ¬¡æ•°</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">count</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">// é™åˆ¶ç±»å‹</span></span><br><span class="line">    <span class="function">LimitType <span class="title">limitType</span><span class="params">()</span> <span class="keyword">default</span> LimitType.CUSTOMER</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>å…¶ä¸­ï¼ŒlimitTypeåŒ…å«ä¼ ç»Ÿç±»å‹é™æµå’Œæ ¹æ®IPé™æµï¼Œå…¶ä¸ºæšä¸¾ç±»å‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> LimitType &#123;</span><br><span class="line">    <span class="comment">// ä¼ ç»Ÿç±»å‹</span></span><br><span class="line">    CUSTOMER,</span><br><span class="line">    <span class="comment">// æ ¹æ® IP é™åˆ¶</span></span><br><span class="line">    IP;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ä¸‹é¢ä¸¾ä¸ªä½¿ç”¨ç¤ºä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cc.mrbird.common.annotation.Limit;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicInteger;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> AtomicInteger ATOMIC_INTEGER = <span class="keyword">new</span> AtomicInteger();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Limit</span>(key = <span class="string">"test"</span>, period = <span class="number">600</span>, count = <span class="number">10</span>, name = <span class="string">"resource"</span>, prefix = <span class="string">"limit"</span>)</span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/test"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">testLimiter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ATOMIC_INTEGER.incrementAndGet();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ä¸Šé¢é…ç½®è¡¨ç¤ºä½¿ç”¨ä¼ ç»Ÿé™æµçš„æ–¹å¼ï¼ŒtestLimiteræ–¹æ³•åœ¨600ç§’å†…æœ€å¤šåªèƒ½è®¿é—®10æ¬¡ã€‚å½“600ç§’å†…ç¬¬11æ¬¡è®¿é—®è¯¥æ¥å£æ—¶ï¼Œæ¥å£å°†æŠ›å‡º<code>LimitAccessException</code>å¼‚å¸¸ã€‚</p><h3 id="Shiroæ•™ç¨‹"><a href="#Shiroæ•™ç¨‹" class="headerlink" title="Shiroæ•™ç¨‹"></a>Shiroæ•™ç¨‹</h3><ol><li><p><a href="https://mrbird.cc/Apache%20Shiro%E7%AE%80%E4%BB%8B.html">Apache Shiroç®€ä»‹</a></p></li><li><p><a href="https://mrbird.cc/Spring-Boot-shiro%20Authentication.html">Spring Boot Shiroç”¨æˆ·è®¤è¯</a></p></li><li><p><a href="https://mrbird.cc/Spring-Boot-Shiro%20Remember-Me.html">Spring Boot Shiro æ·»åŠ è®°ä½æˆ‘åŠŸèƒ½</a></p></li><li><p><a href="https://mrbird.cc/Spring-Boot-Shiro%20Authorization.html">Spring Boot Shiroæƒé™æ§åˆ¶</a></p></li><li><p><a href="https://mrbird.cc/Spring-Boot-Shiro%20cache.html">Spring Boot Shiroä¸­ä½¿ç”¨ç¼“å­˜</a></p></li><li><p><a href="https://mrbird.cc/Spring-Boot-Themeleaf%20Shiro%20tag.html">Spring Boot Thymeleafä¸­ä½¿ç”¨Shiroæ ‡ç­¾</a></p></li><li><p><a href="https://mrbird.cc/Spring-Boot-Shiro%20session.html">Spring Boot Shiroåœ¨çº¿ä¼šè¯ç®¡ç†</a></p></li></ol><h3 id="Shiroå¦‚ä½•æ•´åˆJWT"><a href="#Shiroå¦‚ä½•æ•´åˆJWT" class="headerlink" title="Shiroå¦‚ä½•æ•´åˆJWT"></a>Shiroå¦‚ä½•æ•´åˆJWT</h3><p>Shiroå¦‚ä½•æ•´åˆJWTå¯ä»¥å‚è€ƒï¼š<a href="https://gitlab.com/wuyouzhuguli/shiro_jwt" target="_blank" rel="noopener">https://gitlab.com/wuyouzhuguli/shiro_jwt</a></p><p>ä¸ºäº†ç®€åŒ–è¿‡ç¨‹ï¼Œä¾‹å­æ²¡æœ‰ä½¿ç”¨æ•°æ®åº“å’ŒRedisï¼Œåœ¨å†…å­˜ä¸­æ¨¡æ‹Ÿäº†ä¸¤ä¸ªç”¨æˆ·ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ¨¡æ‹Ÿä¸¤ä¸ªç”¨æˆ·</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> List&lt;User&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> List&lt;User&gt; <span class="title">users</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    List&lt;User&gt; users = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="comment">// æ¨¡æ‹Ÿä¸¤ä¸ªç”¨æˆ·ï¼š</span></span><br><span class="line">    <span class="comment">// 1. ç”¨æˆ·å adminï¼Œå¯†ç  123456ï¼Œè§’è‰² adminï¼ˆç®¡ç†å‘˜ï¼‰ï¼Œæƒé™ "user:add"ï¼Œ"user:view"</span></span><br><span class="line">    <span class="comment">// 1. ç”¨æˆ·å scottï¼Œå¯†ç  123456ï¼Œè§’è‰² registï¼ˆæ³¨å†Œç”¨æˆ·ï¼‰ï¼Œæƒé™ "user:view"</span></span><br><span class="line">    users.add(<span class="keyword">new</span> User(</span><br><span class="line">            <span class="string">"admin"</span>,</span><br><span class="line">            <span class="string">"bfc62b3f67a4c3e57df84dad8cc48a3b"</span>,</span><br><span class="line">            <span class="keyword">new</span> HashSet&lt;&gt;(Collections.singletonList(<span class="string">"admin"</span>)),</span><br><span class="line">            <span class="keyword">new</span> HashSet&lt;&gt;(Arrays.asList(<span class="string">"user:add"</span>, <span class="string">"user:view"</span>))));</span><br><span class="line">    users.add(<span class="keyword">new</span> User(</span><br><span class="line">            <span class="string">"scott"</span>,</span><br><span class="line">            <span class="string">"11bd73355c7bbbac151e4e4f943e59be"</span>,</span><br><span class="line">            <span class="keyword">new</span> HashSet&lt;&gt;(Collections.singletonList(<span class="string">"regist"</span>)),</span><br><span class="line">            <span class="keyword">new</span> HashSet&lt;&gt;(Collections.singletonList(<span class="string">"user:view"</span>))));</span><br><span class="line">    <span class="keyword">return</span> users;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>å¯ä»¥ä½¿ç”¨PostManè¿›è¡Œæ¥å£æµ‹è¯•ã€‚</p><h2 id="å‰ç«¯é¡¹ç›®ä»‹ç»"><a href="#å‰ç«¯é¡¹ç›®ä»‹ç»" class="headerlink" title="å‰ç«¯é¡¹ç›®ä»‹ç»"></a>å‰ç«¯é¡¹ç›®ä»‹ç»</h2><h3 id="é¡¹ç›®ç»“æ„-1"><a href="#é¡¹ç›®ç»“æ„-1" class="headerlink" title="é¡¹ç›®ç»“æ„"></a>é¡¹ç›®ç»“æ„</h3><p>é¡¹ç›®æœºæ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="img/febsvue/2019-04-08_185510.png" alt="2019-04-08_185510.png"></p><h3 id="æ•°æ®å­˜å‚¨"><a href="#æ•°æ®å­˜å‚¨" class="headerlink" title="æ•°æ®å­˜å‚¨"></a>æ•°æ®å­˜å‚¨</h3><p>åœ¨ç”¨æˆ·ç™»å½•æˆåŠŸåï¼Œé¡¹ç›®ä¼šé€šè¿‡Vuexå’Œlocalstorageå­˜å‚¨ä¸€äº›æ•°æ®ä¾›é¡¹ç›®å…¨å±€ä½¿ç”¨ã€‚</p><p>æ­£å¦‚å‰é¢æ‰€è¯´ï¼Œå½“ç”¨æˆ·ç™»å½•æˆåŠŸåï¼Œåç«¯ä¼šè¿”å›å¦‚ä¸‹æ•°æ®ï¼š</p><ol><li><p>tokenï¼štokenï¼›</p></li><li><p>exipreTimeï¼štokenè¿‡æœŸæ—¶é—´ï¼›</p></li><li><p>rolesï¼šç”¨æˆ·è§’è‰²ï¼›</p></li><li><p>permissionsï¼šç”¨æˆ·æƒé™ï¼›</p></li><li><p>configï¼šç”¨æˆ·å‰ç«¯ç³»ç»Ÿçš„ä¸ªæ€§åŒ–é…ç½®ï¼›</p></li><li><p>userï¼šç”¨æˆ·ä¿¡æ¯ï¼ˆä¸åŒ…æ‹¬å¯†ç ï¼‰ã€‚</p></li></ol><p>åœ¨src/views/login/Login.vueæ–‡ä»¶ä¸­ä½ ä¼šçœ‹åˆ°å¦‚ä¸‹ä»£ç ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">...mapMutations(&#123;</span><br><span class="line">  setToken: <span class="string">'account/setToken'</span>,</span><br><span class="line">  setExpireTime: <span class="string">'account/setExpireTime'</span>,</span><br><span class="line">  setPermissions: <span class="string">'account/setPermissions'</span>,</span><br><span class="line">  setRoles: <span class="string">'account/setRoles'</span>,</span><br><span class="line">  setUser: <span class="string">'account/setUser'</span>,</span><br><span class="line">  setTheme: <span class="string">'setting/setTheme'</span>,</span><br><span class="line">  setLayout: <span class="string">'setting/setLayout'</span>,</span><br><span class="line">  setMultipage: <span class="string">'setting/setMultipage'</span>,</span><br><span class="line">  fixSiderbar: <span class="string">'setting/fixSiderbar'</span>,</span><br><span class="line">  fixHeader: <span class="string">'setting/fixHeader'</span>,</span><br><span class="line">  setColor: <span class="string">'setting/setColor'</span></span><br><span class="line">&#125;),</span><br><span class="line">saveLoginData (data) &#123;</span><br><span class="line">  <span class="keyword">this</span>.setToken(data.token)</span><br><span class="line">  <span class="keyword">this</span>.setExpireTime(data.exipreTime)</span><br><span class="line">  <span class="keyword">this</span>.setUser(data.user)</span><br><span class="line">  <span class="keyword">this</span>.setPermissions(data.permissions)</span><br><span class="line">  <span class="keyword">this</span>.setRoles(data.roles)</span><br><span class="line">  <span class="keyword">this</span>.setTheme(data.config.theme)</span><br><span class="line">  <span class="keyword">this</span>.setLayout(data.config.layout)</span><br><span class="line">  <span class="keyword">this</span>.setMultipage(data.config.multiPage === <span class="string">'1'</span>)</span><br><span class="line">  <span class="keyword">this</span>.fixSiderbar(data.config.fixSiderbar === <span class="string">'1'</span>)</span><br><span class="line">  <span class="keyword">this</span>.fixHeader(data.config.fixHeader === <span class="string">'1'</span>)</span><br><span class="line">  <span class="keyword">this</span>.setColor(data.config.color)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>è¿™å°†æŠŠç™»å½•æ¥å£è¿”å›çš„æ•°æ®å­˜å‚¨åˆ°Vuexå’Œæµè§ˆå™¨çš„localstorageä¸­ã€‚</p><p>å­˜å‚¨Tokençš„åŸå› æ˜¯ï¼Œåç»­éœ€è¦è®¤è¯çš„è¯·æ±‚ï¼Œéƒ½ä¼šåœ¨è¯·æ±‚å¤´ä¸­æºå¸¦è¿™ä¸ªTokenï¼›å­˜å‚¨ExpireTimeçš„åŸå› æ˜¯ä¸ºäº†ä¼˜åŒ–è®¤è¯è¿‡æœŸæ—¶çš„ç”¨æˆ·ä½“éªŒï¼›å­˜å‚¨ç”¨æˆ·ä¿¡æ¯çš„åŸå› æ˜¯ä¸ºäº†ä¾›ä¸ªäººä¸­å¿ƒå’Œç³»ç»Ÿä¸»é¡µä½¿ç”¨ï¼›å­˜å‚¨è§’è‰²å’Œæƒé™æ˜¯ä¸ºäº†åˆ¤æ–­é¡µé¢æŒ‰é’®æ¸²æŸ“ä¸å¦ï¼›å­˜å‚¨ç”¨æˆ·ä¸ªæ€§åŒ–é…ç½®çš„åŸå› æ˜¯ä¸ºäº†é€šè¿‡è¿™äº›é…ç½®æ¸²æŸ“ä¸åŒçš„ç³»ç»Ÿç•Œé¢ã€‚</p><h3 id="è·¯ç”±å¯¼èˆªå®ˆå«"><a href="#è·¯ç”±å¯¼èˆªå®ˆå«" class="headerlink" title="è·¯ç”±å¯¼èˆªå®ˆå«"></a>è·¯ç”±å¯¼èˆªå®ˆå«</h3><p>è·¯ç”±å¯¼èˆªå®ˆå«ä»£ç ä½ç½®ï¼šfrontend/src/router/index.jsï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">const</span> whiteList = [<span class="string">'/login'</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> asyncRouter</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¯¼èˆªå®ˆå«ï¼Œæ¸²æŸ“åŠ¨æ€è·¯ç”±</span></span><br><span class="line">router.beforeEach(<span class="function">(<span class="params">to, <span class="keyword">from</span>, next</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (whiteList.indexOf(to.path) !== <span class="number">-1</span>) &#123;</span><br><span class="line">    next()</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">let</span> token = db.get(<span class="string">'USER_TOKEN'</span>)</span><br><span class="line">  <span class="keyword">let</span> user = db.get(<span class="string">'USER'</span>)</span><br><span class="line">  <span class="keyword">let</span> userRouter = get(<span class="string">'USER_ROUTER'</span>)</span><br><span class="line">  <span class="keyword">if</span> (token.length &amp;&amp; user) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!asyncRouter) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!userRouter) &#123;</span><br><span class="line">        request.get(<span class="string">`menu/<span class="subst">$&#123;user.username&#125;</span>`</span>).then(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">          asyncRouter = res.data</span><br><span class="line">          save(<span class="string">'USER_ROUTER'</span>, asyncRouter)</span><br><span class="line">          go(to, next)</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        asyncRouter = userRouter</span><br><span class="line">        go(to, next)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      next()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    next(<span class="string">'/login'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">go</span> (<span class="params">to, next</span>) </span>&#123;</span><br><span class="line">  asyncRouter = filterAsyncRouter(asyncRouter)</span><br><span class="line">  router.addRoutes(asyncRouter)</span><br><span class="line">  next(&#123;...to, <span class="attr">replace</span>: <span class="literal">true</span>&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure><p></p><p>ä¸»è¦é€»è¾‘åˆ†ä¸ºä¸‹é¢å‡ æ­¥ï¼š</p><ol><li><p>åˆ¤æ–­è¦è·³è½¬çš„è·¯ç”±åœ°å€æ˜¯å¦åœ¨è·¯ç”±ç™½åå•å†…ï¼Œæ˜¯çš„è¯æ”¾è¡Œï¼Œä¸æ˜¯çš„è¯è¿›è¡Œç¬¬2æ­¥ï¼›</p></li><li><p>ä»å†…å­˜ä¸­è·å–tokenå’Œç”¨æˆ·ä¿¡æ¯ï¼Œå¦‚æœå­˜åœ¨åˆ™è¿›è¡Œç¬¬3æ­¥ï¼Œä¸å­˜åœ¨è·³è½¬åˆ°ç™»å½•é¡µï¼›</p></li><li><p>åˆ¤æ–­åŠ¨æ€è·¯ç”±ä¿¡æ¯æ˜¯å¦å­˜åœ¨ï¼Œå­˜åœ¨åˆ™æ”¾è¡Œï¼Œä¸å­˜åœ¨åˆ™è¿›è¡Œç¬¬4æ­¥ï¼›</p></li><li><p>åˆ¤æ–­ç”¨æˆ·è·¯ç”±æ˜¯å¦å·²ç»åŠ è½½ï¼Œæ˜¯çš„è¯å°†ç”¨æˆ·è·¯ç”±èµ‹å€¼ç»™åŠ¨æ€è·¯ç”±ï¼Œå¹¶æ‰§è¡Œè·¯ç”±æ·»åŠ æ“ä½œï¼Œç„¶åè·³è½¬ï¼›å¦‚æœç”¨æˆ·è·¯ç”±ä¸å­˜åœ¨ï¼Œåˆ™æ‰§è¡Œç¬¬5æ­¥ï¼›</p></li><li><p>æ ¹æ®ç”¨æˆ·åä»åå°è·å–ç”¨æˆ·è·¯ç”±ä¿¡æ¯ï¼Œå¹¶å°†å…¶ä¿å­˜åˆ°å†…å­˜ä¸­ï¼Œå†æ‰§è¡Œè·¯ç”±æ·»åŠ æ“ä½œï¼Œç„¶åè·³è½¬ã€‚</p></li></ol><h3 id="æƒé™æ§åˆ¶-1"><a href="#æƒé™æ§åˆ¶-1" class="headerlink" title="æƒé™æ§åˆ¶"></a>æƒé™æ§åˆ¶</h3><p>åœ¨å‰ç«¯é¡µé¢ä¸­ï¼Œæˆ‘ä»¬å·²ç»å®ç°äº†é€šè¿‡ä¸åŒç”¨æˆ·è·å–ä¸åŒçš„è·¯ç”±ï¼Œä»¥æ­¤æ¸²æŸ“å‡ºä¸åŒçš„èœå•åˆ—è¡¨åŠŸèƒ½ï¼Œæ­¤å¤–é¡µé¢ä¸Šçš„æ“ä½œæŒ‰é’®ä¹Ÿå¿…é¡»è¿›è¡Œæƒé™æ§åˆ¶ã€‚</p><p>æ­£å¦‚å‰é¢æ‰€è¿°ï¼Œåœ¨ç™»å½•æˆåŠŸåï¼Œç³»ç»Ÿä¼šæŠŠç”¨æˆ·çš„è§’è‰²å’Œæƒé™ä¿¡æ¯å­˜å‚¨åˆ°äº†å†…å­˜ä¸­ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™äº›ä¿¡æ¯ç»“åˆ<a href="https://cn.vuejs.org/v2/guide/custom-directive.html" target="_blank" rel="noopener"> è‡ªå®šä¹‰VueæŒ‡ä»¤ </a>çš„æ–¹å¼æ¥å®ç°æŒ‰é’®çš„æƒé™æ§åˆ¶ã€‚</p><p>ç›®å‰æ”¯æŒçš„å’Œæƒé™ç›¸å…³çš„VueæŒ‡ä»¤æœ‰ï¼š</p><table><thead><tr><th>æŒ‡ä»¤</th><th>å«ä¹‰</th><th>ç¤ºä¾‹</th></tr></thead><tbody><tr><td>v-hasPermission</td><td>å½“ç”¨æˆ·æ‹¥æœ‰åˆ—å‡ºçš„æƒé™çš„æ—¶å€™ï¼Œæ¸²æŸ“è¯¥å…ƒç´ </td><td><code>&lt;template v-hasPermission=&quot;&#39;user:add&#39;,&#39;user:update&#39;&quot;&gt;&lt;span&gt;hello&lt;/span&gt;&lt;/template&gt;</code></td></tr><tr><td>v-hasAnyPermission</td><td>å½“ç”¨æˆ·æ‹¥æœ‰åˆ—å‡ºçš„ä»»æ„ä¸€é¡¹æƒé™çš„æ—¶å€™ï¼Œæ¸²æŸ“è¯¥å…ƒç´ </td><td><code>&lt;template v-hasAnyPermission=&quot;&#39;user:add&#39;,&#39;user:update&#39;&quot;&gt;&lt;span&gt;hello&lt;/span&gt;&lt;/template&gt;</code></td></tr><tr><td>v-hasRole</td><td>å½“ç”¨æˆ·æ‹¥æœ‰åˆ—å‡ºçš„è§’è‰²çš„æ—¶å€™ï¼Œæ¸²æŸ“è¯¥å…ƒç´ </td><td><code>&lt;template v-hasRole=&quot;&#39;admin&#39;,&#39;register&#39;&quot;&gt;&lt;span&gt;hello&lt;/span&gt;&lt;/template&gt;</code></td></tr><tr><td>v-hasAnyRole</td><td>å½“ç”¨æˆ·æ‹¥æœ‰åˆ—å‡ºçš„ä»»æ„ä¸€ä¸ªè§’è‰²çš„æ—¶å€™ï¼Œæ¸²æŸ“è¯¥å…ƒç´ </td><td><code>&lt;template v-hasAnyRole=&quot;&#39;admin&#39;,&#39;register&#39;&quot;&gt;&lt;span&gt;hello&lt;/span&gt;&lt;/template&gt;</code></td></tr><tr><td>hasNoPermission</td><td>å½“ç”¨æˆ·æ²¡æœ‰åˆ—å‡ºçš„æƒé™çš„æ—¶å€™ï¼Œæ¸²æŸ“è¯¥å…ƒç´ </td><td><code>&lt;template v-hasNoPermission=&quot;&#39;user:add&#39;,&#39;register&#39;&quot;&gt;&lt;span&gt;æ— æ“ä½œæƒé™&lt;/span&gt;&lt;/template&gt;</code></td></tr></tbody></table><p>ä»¥<code>v-hasPermission=&quot;user:add&quot;</code>ä¸ºä¾‹ï¼Œè¯¦ç»†ä»‹ç»ä¸‹è‡ªå®šä¹‰æƒé™VueæŒ‡ä»¤çš„å®ç°è¿‡ç¨‹ï¼š</p><ol><li><p>åœ¨src/utils/permissionDirect.jsä¸­å®šä¹‰å¦‚ä¸‹ä»£ç ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">export</span> <span class="keyword">const</span> hasPermission = &#123;</span><br><span class="line">  install (Vue) &#123;</span><br><span class="line">    Vue.directive(<span class="string">'hasPermission'</span>, &#123;</span><br><span class="line">      bind (el, binding, vnode) &#123;</span><br><span class="line">        <span class="keyword">let</span> permissions = vnode.context.$store.state.account.permissions</span><br><span class="line">        <span class="keyword">let</span> value = binding.value.split(<span class="string">','</span>)</span><br><span class="line">        <span class="keyword">let</span> flag = <span class="literal">true</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> v <span class="keyword">of</span> value) &#123;</span><br><span class="line">          <span class="keyword">if</span> (!permissions.includes(v)) &#123;</span><br><span class="line">            flag = <span class="literal">false</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!flag) &#123;</span><br><span class="line">          <span class="keyword">if</span> (!el.parentNode) &#123;</span><br><span class="line">            el.style.display = <span class="string">'none'</span></span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            el.parentNode.removeChild(el)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢ä»£ç ä¸­ï¼Œæˆ‘ä»¬ä»Vuexä¸­è·å–äº†ç”¨æˆ·æ‰€æ‹¥æœ‰çš„æƒé™ï¼Œç„¶ååˆ¤æ–­è¿™äº›æƒé™ä¸­æ˜¯å¦åŒ…å«<code>user:add</code>ï¼Œå¦‚æœä¸åŒ…å«ï¼Œåˆ™å°†å¯¹åº”çš„å…ƒç´ ï¼ˆelï¼‰ç§»é™¤æˆ–è€…éšè—ã€‚æ‰€ä»¥å½“ç”¨æˆ·æ²¡æœ‰<code>user:add</code>æƒé™æ—¶ï¼Œä¸‹é¢çš„æŒ‰é’®å°†ä¸ä¼šè¢«æ¸²æŸ“åœ¨é¡µé¢ä¸Šï¼š</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span> <span class="attr">v-hasPermission</span>=<span class="string">"'user:add'"</span>&gt;</span><span class="tag">&lt;<span class="name">button</span>&gt;</span>æ–°å¢ç”¨æˆ·<span class="tag">&lt;/<span class="name">button</span>&gt;</span><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>è¦è®©è‡ªå®šä¹‰VueæŒ‡ä»¤ç”Ÿæ•ˆï¼Œè¿˜éœ€è¦åœ¨src/utils/install.jsä¸­å°†å…¶æ·»åŠ åˆ°Pluginsåˆ—è¡¨ã€‚</p></li></ol><h3 id="Axioså°è£…"><a href="#Axioså°è£…" class="headerlink" title="Axioså°è£…"></a>Axioså°è£…</h3><p>é¡¹ç›®ä½¿ç”¨Axiosæ’ä»¶æ¥å‘é€HTTPè¯·æ±‚ï¼Œå¹¶å¯¹å®ƒè¿›è¡Œäº†å°è£…ï¼ˆfrontend/src/utils/request.jsï¼‰ï¼Œè¿™é‡Œä¸»è¦è®²è¿°ä¸‹request.jsä¸­ä¸»è¦é€»è¾‘ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç»Ÿä¸€é…ç½®</span></span><br><span class="line"><span class="keyword">let</span> FEBS_REQUEST = axios.create(&#123;</span><br><span class="line">  baseURL: <span class="string">'http://127.0.0.1:9527/'</span>,</span><br><span class="line">  responseType: <span class="string">'json'</span>,</span><br><span class="line">  validateStatus (status) &#123;</span><br><span class="line">    <span class="comment">// 200 å¤–çš„çŠ¶æ€ç éƒ½è®¤å®šä¸ºå¤±è´¥</span></span><br><span class="line">    <span class="keyword">return</span> status === <span class="number">200</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>ä¸Šé¢è¿™æ®µä»£ç å¯¹è¯·æ±‚è¿›è¡Œäº†ç»Ÿä¸€é…ç½®ï¼ŒbaseURLå®šä¹‰äº†åç«¯åœ°å€çš„åŸºç¡€è·¯å¾„ï¼ŒresponseTypeå®šä¹‰äº†å“åº”æ•°æ®ç±»å‹ä¸ºJSONï¼Œåªæœ‰çŠ¶æ€ç ä¸º200æ—¶æ‰è®¤å®šè¯·æ±‚æˆåŠŸã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ‹¦æˆªè¯·æ±‚</span></span><br><span class="line">FEBS_REQUEST.interceptors.request.use(<span class="function">(<span class="params">config</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> expireTime = store.state.account.expireTime</span><br><span class="line">  <span class="keyword">let</span> now = moment().format(<span class="string">'YYYYMMDDHHmmss'</span>)</span><br><span class="line">  <span class="comment">// è®©tokenæ—©10ç§’ç§è¿‡æœŸï¼Œæå‡â€œè¯·é‡æ–°ç™»å½•â€å¼¹çª—ä½“éªŒ</span></span><br><span class="line">  <span class="keyword">if</span> (now - expireTime &gt;= <span class="number">-10</span>) &#123;</span><br><span class="line">    Modal.error(&#123;</span><br><span class="line">      title: <span class="string">'ç™»å½•å·²è¿‡æœŸ'</span>,</span><br><span class="line">      content: <span class="string">'å¾ˆæŠ±æ­‰ï¼Œç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•'</span>,</span><br><span class="line">      okText: <span class="string">'é‡æ–°ç™»å½•'</span>,</span><br><span class="line">      mask: <span class="literal">false</span>,</span><br><span class="line">      onOk: <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    	  <span class="comment">// ä¸ºä»€ä¹ˆä¸ç›´æ¥è·³è½¬åˆ°ç™»å½•é¡µå‘¢ï¼Ÿé‚£æ˜¯å› ä¸ºVueæ²¡æœ‰æä¾›æ¸…ç©ºè·¯ç”±çš„æ–¹æ³•ï¼Œåªèƒ½é€šè¿‡åˆ·æ–°é¡µé¢çš„æ–¹å¼</span></span><br><span class="line">    	  <span class="comment">// æ¥æ¸…é™¤ä¹‹å‰åŠ¨æ€æ·»åŠ çš„è·¯ç”±ä¿¡æ¯ã€‚</span></span><br><span class="line">          db.clear()</span><br><span class="line">          location.reload()</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// æœ‰ tokenå°±å¸¦ä¸Š</span></span><br><span class="line">  <span class="keyword">if</span> (store.state.account.token) &#123;</span><br><span class="line">    config.headers.Authentication = store.state.account.token</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> config</span><br><span class="line">&#125;, (error) =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Promise</span>.reject(error)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>åœ¨Axiosçš„å‰ç½®æ‹¦æˆªä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆåˆ¤æ–­äº†tokenæ˜¯å¦å·²ç»è¿‡æœŸï¼Œå¦‚æœè¿‡æœŸäº†åˆ™æ¸…ç©ºåœ¨ç™»å½•æ—¶ä¿å­˜çš„æ•°æ®ï¼Œå¹¶ä¸”åˆ·æ–°é¡µé¢ã€‚è¿™æ—¶å€™é€šè¿‡è·¯ç”±å¯¼èˆªå®ˆå«ï¼Œé¡µé¢ä¼šè¢«é‡å®šå‘åˆ°ç™»å½•é¡µé¢ï¼Œå¼•å¯¼ç”¨æˆ·é‡æ–°ç™»å½•ã€‚</p><p>å¦‚æœtokenæ²¡æœ‰è¿‡æœŸï¼Œåˆ™åœ¨è¯·æ±‚å¤´ä¸Šå¸¦ä¸Štokenä¿¡æ¯ã€‚<code>headers.Authentication</code>å’Œåç«¯ä»£ç ä¸­çš„TOKENåç§°ç›¸å¯¹åº”ï¼š</p><p><img src="img/febsvue/QQæˆªå›¾20190409101831.png" alt="QQæˆªå›¾20190409101831.png"></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ‹¦æˆªå“åº”</span></span><br><span class="line">FEBS_REQUEST.interceptors.response.use(<span class="function">(<span class="params">config</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> config</span><br><span class="line">&#125;, (error) =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (error.response) &#123;</span><br><span class="line">    <span class="keyword">let</span> errorMessage = error.response.data === <span class="literal">null</span> ? <span class="string">'ç³»ç»Ÿå†…éƒ¨å¼‚å¸¸ï¼Œè¯·è”ç³»ç½‘ç«™ç®¡ç†å‘˜'</span> : error.response.data.message</span><br><span class="line">    <span class="keyword">switch</span> (error.response.status) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">404</span>:</span><br><span class="line">        notification.error(&#123;</span><br><span class="line">          message: <span class="string">'ç³»ç»Ÿæç¤º'</span>,</span><br><span class="line">          description: <span class="string">'å¾ˆæŠ±æ­‰ï¼Œèµ„æºæœªæ‰¾åˆ°'</span>,</span><br><span class="line">          duration: <span class="number">4</span></span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      <span class="keyword">case</span> <span class="number">403</span>:</span><br><span class="line">      <span class="keyword">case</span> <span class="number">401</span>:</span><br><span class="line">        notification.warn(&#123;</span><br><span class="line">          message: <span class="string">'ç³»ç»Ÿæç¤º'</span>,</span><br><span class="line">          description: <span class="string">'å¾ˆæŠ±æ­‰ï¼Œæ‚¨æ— æ³•è®¿é—®è¯¥èµ„æºï¼Œå¯èƒ½æ˜¯å› ä¸ºæ²¡æœ‰ç›¸åº”æƒé™æˆ–è€…ç™»å½•å·²å¤±æ•ˆ'</span>,</span><br><span class="line">          duration: <span class="number">4</span></span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        notification.error(&#123;</span><br><span class="line">          message: <span class="string">'ç³»ç»Ÿæç¤º'</span>,</span><br><span class="line">          description: errorMessage,</span><br><span class="line">          duration: <span class="number">4</span></span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Promise</span>.reject(error)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>ä¸Šé¢ä»£ç ä¸­æˆ‘ä»¬å®ç°äº†å¼‚å¸¸å“åº”çš„ç»Ÿä¸€å¤„ç†ï¼Œæ ¹æ®ä¸åŒçš„çŠ¶æ€ç ç»™äºˆä¸åŒçš„æç¤ºä¿¡æ¯ã€‚</p><p>æ­¤å¤–ï¼Œé¡¹ç›®è¿˜å¯¹å„ç§HTTPè¯·æ±‚è¿›è¡Œäº†å°è£…ï¼Œä¸‹é¢ä¸€ä¸€åˆ—ä¸¾å‡ºå®ƒä»¬çš„ç”¨æ³•ï¼š</p><p><strong>GETè¯·æ±‚</strong></p><p>æ–¹å¼ä¸€ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.$get(<span class="string">'user'</span>, &#123;</span><br><span class="line">   ...params</span><br><span class="line">&#125;).then(<span class="function">(<span class="params">r</span>) =&gt;</span> &#123;</span><br><span class="line">   <span class="built_in">console</span>.log(r)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p></p><p>å› ä¸ºæˆ‘ä»¬åœ¨å‰é¢å·²ç»å®šä¹‰äº†åç«¯åœ°å€çš„åŸºç¡€è·¯å¾„ï¼Œæ‰€ä»¥ä¸Šé¢è¿™ä¸ªè¯·æ±‚çš„å®é™…åœ°å€ä¸ºï¼š<a href="http://127.0.0.1:9527/userã€‚" target="_blank" rel="noopener">http://127.0.0.1:9527/userã€‚</a></p><p>åœ¨å‰é¢æˆ‘ä»¬å·²ç»å¯¹å¼‚å¸¸å“åº”è¿›è¡Œç»Ÿä¸€å¤„ç†ï¼Œå½“ç„¶ä½ ä¹Ÿå¯ä»¥é€šè¿‡catchæ¥è¦†ç›–ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.$get(<span class="string">'user'</span>, &#123;</span><br><span class="line">   ...params</span><br><span class="line">&#125;).then(<span class="function">(<span class="params">r</span>) =&gt;</span> &#123;</span><br><span class="line">   <span class="built_in">console</span>.log(r)</span><br><span class="line">&#125;).catch(<span class="function">(<span class="params">error</span>) =&gt;</span> &#123;</span><br><span class="line">   alert(<span class="string">'å‡ºé”™å•¦'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>æ–¹å¼äºŒï¼ˆè·¯å¾„ä¼ å‚ï¼‰ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.$get(<span class="string">`menu/<span class="subst">$&#123;user.username&#125;</span>`</span>).then(<span class="function">(<span class="params">r</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(r)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p></p><p>æ–¹å¼ä¸‰ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.$get(<span class="string">`user?username=<span class="subst">$&#123;user.username&#125;</span>`</span>).then(<span class="function">(<span class="params">r</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(r)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p></p><p><strong>POSTè¯·æ±‚</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.$post(<span class="string">'user'</span>, &#123;</span><br><span class="line">   ...params</span><br><span class="line">&#125;).then(<span class="function">(<span class="params">r</span>) =&gt;</span> &#123;</span><br><span class="line">   <span class="built_in">console</span>.log(r)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p></p><p><strong>PUTè¯·æ±‚</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.$put(<span class="string">'user'</span>, &#123;</span><br><span class="line">   ...params</span><br><span class="line">&#125;).then(<span class="function">(<span class="params">r</span>) =&gt;</span> &#123;</span><br><span class="line">   <span class="built_in">console</span>.log(r)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p></p><p><strong>DELETEè¯·æ±‚</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.$<span class="keyword">delete</span>(<span class="string">'user/$&#123;user.userId&#125;'</span>).then(<span class="function">(<span class="params">r</span>) =&gt;</span> &#123;</span><br><span class="line">   <span class="built_in">console</span>.log(r)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p></p><p><strong>ä¸‹è½½æ–‡ä»¶</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.$download(<span class="string">'file'</span>, &#123; ...params &#125;, <span class="string">'xxx.xx'</span>)</span><br></pre></td></tr></table></figure><p></p><p>xxx.xxä¸ºä¸‹è½½çš„æ–‡ä»¶åï¼Œæ¯”å¦‚ä¸‹è½½xlsxæ–‡ä»¶çš„è¯ä¸º Excelæ–‡ä»¶.xlsxï¼Œåç«¯æ¥å£è¿”å›æ•°æ®æµå³å¯ã€‚</p><p><strong>ä¸Šä¼ æ–‡ä»¶</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> formData = <span class="keyword">new</span> FormData($(<span class="string">"#form"</span>)[<span class="number">0</span>]);</span><br><span class="line"><span class="keyword">this</span>.$upload(<span class="string">'upload'</span>, formData).then(<span class="function">(<span class="params">r</span>) =&gt;</span> &#123;</span><br><span class="line">   <span class="built_in">console</span>.log(r)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p></p><p>åç«¯ä»¥<code>MultipartFile</code>æ¥æ”¶æ–‡ä»¶å³å¯ã€‚</p><h3 id="è·¯å¾„é…ç½®"><a href="#è·¯å¾„é…ç½®" class="headerlink" title="è·¯å¾„é…ç½®"></a>è·¯å¾„é…ç½®</h3><p>åœ¨build/webpack.base.conf.jsä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€äº›è·¯å¾„å˜é‡ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  ...</span><br><span class="line">  resolve: &#123;</span><br><span class="line">    ...</span><br><span class="line">    alias: &#123;</span><br><span class="line">      <span class="string">'vue$'</span>: <span class="string">'vue/dist/vue.esm.js'</span>,</span><br><span class="line">      <span class="string">'@'</span>: resolve(<span class="string">'src'</span>),</span><br><span class="line">      <span class="string">'~'</span>: resolve(<span class="string">'src/components'</span>),</span><br><span class="line">      <span class="string">'utils'</span>: resolve(<span class="string">'src/utils'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>æ¯”å¦‚<code>~</code>ä»£è¡¨<code>src/components</code>è·¯å¾„ï¼Œåœ¨é¡¹ç›®ä¸­ï¼Œå¦‚æœè¦å¼•å…¥<code>src/components/test.vue</code>åªéœ€è¦è¿™æ ·åšå³å¯ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> ~<span class="regexp">/test.vue</span></span><br></pre></td></tr></table></figure><p></p><p>å½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ç›¸å¯¹è·¯å¾„å’Œç»å¯¹è·¯å¾„ï¼Œè€Œä¸ä½¿ç”¨è¿™äº›å˜é‡ã€‚</p><h3 id="ç¬¬ä¸‰æ–¹ç»„ä»¶ä»‹ç»"><a href="#ç¬¬ä¸‰æ–¹ç»„ä»¶ä»‹ç»" class="headerlink" title="ç¬¬ä¸‰æ–¹ç»„ä»¶ä»‹ç»"></a>ç¬¬ä¸‰æ–¹ç»„ä»¶ä»‹ç»</h3><p><a href="https://vue.ant.design/docs/vue/introduce-cn/" target="_blank" rel="noopener">Ant Design Vue</a>å·²ç»æä¾›äº†éå¸¸ä¸°å¯Œçš„ç»„ä»¶ï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œé¡¹ç›®é‡Œä½¿ç”¨çš„å›¾è¡¨æ’ä»¶ä¸ºï¼š<a href="https://apexcharts.com/vue-chart-demos/line-charts/basic/" target="_blank" rel="noopener">apexcharts.js</a>ï¼Œå…¶å®˜æ–¹æ–‡æ¡£æä¾›äº†å¾ˆå¤šç¤ºä¾‹ï¼Œè¿™é‡Œå°±ä¸èµ˜è¿°äº†ã€‚</p><h3 id="å¼€å‘å»ºè®®"><a href="#å¼€å‘å»ºè®®" class="headerlink" title="å¼€å‘å»ºè®®"></a>å¼€å‘å»ºè®®</h3><p>ç›¸ä¿¡æ­£åœ¨é˜…è¯»æ–‡æ¡£çš„ä½ åæœ‰å…«ä¹æ˜¯ä¸€ååç«¯å¼€å‘è€…ï¼Œå¯èƒ½å¯¹å‰ç«¯ç‰¹åˆ«æ˜¯å¯¹Vueä¸å¤ªç†Ÿæ‚‰ï¼Œè¿™é‡Œç»™å‡ºå‡ ç‚¹æ”¹é€ frontendçš„å»ºè®®ï¼š</p><ol><li><p>è¦æœ‰ä¸€å®šçš„ES6è¯­æ³•åŸºç¡€ï¼Œå¯ä»¥å‚è€ƒ<a href="https://mrbird.cc/ES2015-Learn-Note.html"> ES6å­¦ä¹ ç¬”è®° </a>ï¼Œå¦‚æœè¦ç³»ç»Ÿå­¦ä¹ ES6ï¼Œæ¨èé˜®ä¸€å³°çš„ï¼š<a href="http://es6.ruanyifeng.com/" target="_blank" rel="noopener"> ECMAScript 6 å…¥é—¨ </a>ã€‚</p></li><li><p>Vueçš„å®˜æ–¹æ–‡æ¡£è¿˜æ˜¯æŒºè¯¦ç»†çš„ï¼Œå»ºè®®ä»”ç»†é˜…è¯»ï¼Œæˆ‘åœ¨å­¦ä¹ Vueçš„æ—¶å€™ä¹Ÿåšäº†ä¸€äº›ç¬”è®°ï¼Œå¯ä»¥å‚è€ƒï¼š<a href="https://mrbird.cc/Vue-Learn-Note.html">https://mrbird.cc/Vue-Learn-Note.html</a>ã€‚Vueçš„å­¦ä¹ è·¯çº¿ï¼šVueåŸºç¡€è¯­æ³• -&gt; Vuex -&gt; Vue Routerã€‚</p></li><li><p>å‰ç«¯ç»„ä»¶ç”¨çš„æ˜¯<a href="https://vue.ant.design/docs/vue/introduce-cn/" target="_blank" rel="noopener">Ant Design Vue</a>ï¼Œæ‰€ä»¥åœ¨ä½¿ç”¨å®ƒæä¾›çš„ç»„ä»¶çš„æ—¶å€™ï¼Œå¤šé˜…è¯»å®ƒçš„ä½¿ç”¨æ–‡æ¡£ã€‚</p></li></ol><h2 id="å¼€å‘ç¤ºä¾‹"><a href="#å¼€å‘ç¤ºä¾‹" class="headerlink" title="å¼€å‘ç¤ºä¾‹"></a>å¼€å‘ç¤ºä¾‹</h2><h3 id="æ–°å»ºä¸€ä¸ªé¡µé¢"><a href="#æ–°å»ºä¸€ä¸ªé¡µé¢" class="headerlink" title="æ–°å»ºä¸€ä¸ªé¡µé¢"></a>æ–°å»ºä¸€ä¸ªé¡µé¢</h3><p>åœ¨frontendå·¥ç¨‹çš„src/viewsä¸‹æ–°å»ºä¸€ä¸ªtestç›®å½•ï¼Œåœ¨è¯¥ç›®å½•ä¸‹æ–°å»ºä¸€ä¸ªtest.vueæ–‡ä»¶ï¼š <img src="img/febsvue/QQæˆªå›¾20190409133947.png" alt="QQæˆªå›¾20190409133947.png"></p><p>å†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"test"</span>&gt;</span>&#123;&#123;hello&#125;&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="javascript">  name: <span class="string">'test'</span>,</span></span><br><span class="line"><span class="undefined">  data () &#123;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="javascript">      hello: <span class="string">'hello world'</span></span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined">  &#125;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">lang</span>=<span class="string">"less"</span> <span class="attr">scoped</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="css">  <span class="selector-class">.test</span> &#123;</span></span><br><span class="line"><span class="css">    <span class="selector-tag">color</span>: <span class="selector-id">#42b984</span>;</span></span><br><span class="line"><span class="css">    <span class="selector-tag">font-size</span>: 1<span class="selector-class">.1rem</span>;</span></span><br><span class="line"><span class="undefined">    font-weight: 600;</span></span><br><span class="line"><span class="undefined">  &#125;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure><p></p><p>å¯åŠ¨é¡¹ç›®ï¼Œä½¿ç”¨ç®¡ç†å‘˜è´¦å·ç™»å½•ï¼Œç„¶ååœ¨èœå•ç®¡ç†ä¸­æ–°å»ºä¸€ä¸ªèœå•ï¼š</p><p><img src="img/febsvue/20190409134916.png" alt="QQæˆªå›¾20190409134916.png"></p><ol><li><p>èœå•URLï¼šè¿™é‡Œå¡«å†™/testçš„è¯ï¼Œåœ¨è®¿é—®è¿™ä¸ªé¡µé¢çš„æ—¶å€™ï¼Œæµè§ˆå™¨åœ°å€æ ä¸º<a href="http://localhost:8081/#/test" target="_blank" rel="noopener">http://localhost:8081/#/test</a>ï¼Œåªè¦ç¡®ä¿è¿™ä¸ªå€¼ä¸é‡å¤å³å¯ï¼›</p></li><li><p>ç»„ä»¶åœ°å€ï¼šå¯¹åº”è¦æ¸²æŸ“çš„Vueç»„ä»¶åœ°å€ï¼Œåœ¨è·¯ç”±å¯¼èˆªå®ˆå«ä¸­æœ‰å¦‚ä¸‹ä¸€æ®µä»£ç ï¼š</p><p><img src="img/febsvue/20190409135425.png" alt="QQæˆªå›¾20190409135425.png"></p><p>æ‰€ä»¥è¿™é‡Œå¡«test/testï¼Œå¯¹åº”<code>@/views/test/test.vue</code>ç»„ä»¶ã€‚</p></li><li><p>ç›¸å…³æƒé™ï¼šè®¿é—®è¿™ä¸ªé¡µé¢éœ€è¦<code>test:view</code>æƒé™ã€‚</p></li></ol><p>ç‚¹å‡»ç¡®å®šåï¼Œè¿™ä¸ªèœå•å°±è¢«å»ºå¥½äº†ï¼š</p><p><img src="img/febsvue/20190409135740.png" alt="QQæˆªå›¾20190409135740.png"></p><p>æ¥ç€ä¿®æ”¹ç®¡ç†å‘˜è§’è‰²ï¼Œå°†åˆšåˆšæ–°å»ºçš„èœå•æˆæƒç»™ç®¡ç†å‘˜ï¼š</p><p><img src="img/febsvue/QQæˆªå›¾20190409141220.png" alt="QQæˆªå›¾20190409141220.png"></p><p>ç‚¹å‡»ç¡®å®šä¿®æ”¹åï¼Œé‡æ–°ç™»å½•ç³»ç»Ÿï¼š</p><p><img src="img/febsvue/asdfasdfasfdasdf.png" alt="QQæˆªå›¾20190409141410.png"></p><h3 id="å¦‚ä½•æ–°å»ºä¸€ä¸ªå¤šçº§èœå•"><a href="#å¦‚ä½•æ–°å»ºä¸€ä¸ªå¤šçº§èœå•" class="headerlink" title="å¦‚ä½•æ–°å»ºä¸€ä¸ªå¤šçº§èœå•"></a>å¦‚ä½•æ–°å»ºä¸€ä¸ªå¤šçº§èœå•</h3><p>åœ¨æ–°å¢å¤šçº§èœå•å‰ï¼Œå…ˆäº†è§£ä¸‹ç³»ç»Ÿä¸­çš„ä¸€ä¸ªçº¦å®šï¼šåœ¨ä¸€ä¸ªå¤šçº§èœå•ä¸­ï¼Œ<strong>é¡¶çº§èœå•å¯¹åº”çš„ç»„ä»¶ä¸ºPageViewï¼Œæœ«çº§èœå•å¯¹åº”çš„ç»„ä»¶ä¸ºéœ€è¦æ¸²æŸ“çš„é¡µé¢ç»„ä»¶ï¼Œå‰©ä¸‹çš„ï¼ˆéé¡¶çº§ï¼Œéæœ«çº§çš„ä¸­é—´èœå•å¯¹åº”çš„ç»„ä»¶ä¸ºEmptyPageViewï¼‰</strong>ã€‚</p><p>æˆ‘ä»¬æ¥å»ºä¸€ä¸ªå››çº§èœå•ï¼Œé¦–å…ˆæ–°å¢ä¸€ä¸ªé¡¶çº§èœå•ï¼š</p><p><img src="img/febsvue/QQæˆªå›¾20190409142251.png" alt="QQæˆªå›¾20190409142251.png"></p><p>å› ä¸ºæ˜¯é¡¶çº§èœå•ï¼Œæ‰€ä»¥å¯¹åº”ç»„ä»¶å¡«PageViewã€‚</p><p>æ¥ç€æ–°å¢ç¬¬äºŒçº§èœå•ï¼š</p><p><img src="img/febsvue/QQæˆªå›¾20190409142642.png" alt="QQæˆªå›¾20190409142642.png"></p><p>å› ä¸ºå®ƒæ•°æ®ä¸­é—´èœå•ï¼ˆéé¡¶çº§éæœ«çº§ï¼‰æ‰€ä»¥å¯¹åº”ç»„ä»¶å¡«EmptyPageViewï¼Œä¸Šçº§èœå•å‹¾é€‰åˆšåˆšæ–°å»ºçš„ä¸€çº§èœå•ã€‚</p><p>ç»§ç»­æ–°å¢ä¸‰çº§èœå•ï¼š</p><p><img src="img/febsvue/QQæˆªå›¾20190409143223.png" alt="QQæˆªå›¾20190409143223.png"></p><p>å› ä¸ºå®ƒä¹Ÿæ˜¯ä¸€ä¸ªä¸­é—´èœå•ï¼Œæ‰€ä»¥å¯¹åº”ç»„ä»¶å¡«EmptyPageViewï¼Œä¸Šçº§èœå•å‹¾é€‰åˆšåˆšæ–°å»ºçš„äºŒçº§èœå•ã€‚</p><p>æœ€åå°†æˆ‘ä»¬å‰é¢å»ºå¥½çš„æµ‹è¯•é¡µé¢ä½œä¸ºæœ«çº§ï¼Œç‚¹å‡»æµ‹è¯•é¡µé¢åé¢çš„å°é½¿è½®æŒ‰é’®ï¼Œè¿›è¡Œä¿®æ”¹ï¼š</p><p><img src="img/febsvue/QQæˆªå›¾20190409143905.png" alt="QQæˆªå›¾20190409143905.png"></p><p>ç‚¹å‡»ç¡®å®šåä¸€ä¸ªå››çº§èœå•å°±å»ºå¥½äº†ï¼š</p><p><img src="img/febsvue/QQæˆªå›¾20190409143943.png" alt="QQæˆªå›¾20190409143943.png"></p><p>æœ€åä¸€æ­¥æˆæƒï¼ä¿®æ”¹ç®¡ç†å‘˜è§’è‰²ï¼š</p><p><img src="img/febsvue/QQæˆªå›¾20190409144206.png" alt="QQæˆªå›¾20190409144206.png"></p><p>ä¿®æ”¹åï¼Œé‡æ–°ç™»å½•ç³»ç»Ÿï¼š</p><p><img src="img/febsvue/QQæˆªå›¾20190409144908.png" alt="QQæˆªå›¾20190409144908.png"></p><p>å› ä¸ºæˆ‘æ²¡æœ‰è®¾ç½®æ’åºï¼Œæ‰€ä»¥é»˜è®¤æ’åœ¨æœ€å‰é¢äº†ã€‚</p><h3 id="å¦‚ä½•éšè—è·¯ç”±"><a href="#å¦‚ä½•éšè—è·¯ç”±" class="headerlink" title="å¦‚ä½•éšè—è·¯ç”±"></a>å¦‚ä½•éšè—è·¯ç”±</h3><p>æœ‰çš„æ—¶å€™ï¼Œä¸€äº›è·¯ç”±å¹¶ä¸éœ€è¦æ¸²æŸ“æˆèœå•ï¼Œæ¯”å¦‚ä¸ªäººä¸­å¿ƒè¿™ç±»é¡µé¢ã€‚è€Œè¿™äº›é¡µé¢ä¸€èˆ¬éƒ½æ˜¯æ‰€æœ‰ç”¨æˆ·å…±æœ‰çš„ï¼Œæ‰€ä»¥åœ¨åå°ç³»ç»Ÿé‡Œæ„å»ºè·¯ç”±çš„æ—¶å€™å†™æ­»å³å¯ã€‚è¦éšè—è·¯ç”±åªéœ€è¦å°†è·¯ç”±metaçš„isShowå±æ€§è®¾ç½®ä¸ºfalseå³å¯ï¼š</p><p>å‚è€ƒåå°ä»£ç cc.mrbird.febs.common.utils.TreeUtilï¼š</p><p><img src="img/febsvue/20190409150427.png" alt="QQæˆªå›¾20190409150427.png"></p><h3 id="å¦‚ä½•åˆ†é…æƒé™"><a href="#å¦‚ä½•åˆ†é…æƒé™" class="headerlink" title="å¦‚ä½•åˆ†é…æƒé™"></a>å¦‚ä½•åˆ†é…æƒé™</h3><p>æƒé™æ˜¯å’Œè§’è‰²ç»‘å®šçš„ï¼Œæ‰€ä»¥è¦åˆ†é…æƒé™å®é™…å°±æ˜¯å¯¹è§’è‰²çš„å¢åˆ æ”¹ã€‚å‡å¦‚ç°åœ¨è¦é…ç½®ä¸€ä¸ªè§’è‰² â€”â€”â€” ç³»ç»Ÿç›‘æ§ç®¡ç†å‘˜ï¼Œè´Ÿè´£ç³»ç»Ÿç›‘æ§æ¨¡å—çš„æŸ¥çœ‹ï¼š</p><p><img src="img/febsvue/QQæˆªå›¾20190409152413.png" alt="QQæˆªå›¾20190409152413.png"></p><p>ç„¶åæ–°å¢ä¸€ä¸ªç”¨æˆ· â€”â€”â€” yuukiï¼Œè§’è‰²ä¸ºç³»ç»Ÿç›‘æ§ç®¡ç†å‘˜ï¼š</p><p><img src="img/febsvue/QQæˆªå›¾20190409152550.png" alt="QQæˆªå›¾20190409152550.png"></p><p>æ–°å»ºå¥½åï¼Œä½¿ç”¨yuukiçš„è´¦å·ç™»å½•ï¼š</p><p><img src="img/febsvue/QQæˆªå›¾20190409153002.png" alt="QQæˆªå›¾20190409153002.png"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œyuukiåªæœ‰ç³»ç»Ÿç›‘æ§æ¨¡å—çš„æƒé™ã€‚</p><h3 id="å‰ç«¯å¦‚ä½•æ·»åŠ ä¾èµ–"><a href="#å‰ç«¯å¦‚ä½•æ·»åŠ ä¾èµ–" class="headerlink" title="å‰ç«¯å¦‚ä½•æ·»åŠ ä¾èµ–"></a>å‰ç«¯å¦‚ä½•æ·»åŠ ä¾èµ–</h3><p>åœ¨<a href="https://www.npmjs.com/" target="_blank" rel="noopener">https://www.npmjs.com/</a>æœç´¢éœ€è¦å®‰è£…çš„ä¾èµ–ï¼Œæ¯”å¦‚jQueryï¼š</p><p><img src="img/febsvue/QQæˆªå›¾20190409153227.png" alt="QQæˆªå›¾20190409153227.png"></p><p>æ¯”å¦‚æˆ‘éœ€è¦å®‰è£…jQuery 3.3.1ç‰ˆæœ¬ï¼Œåªéœ€è¦åœ¨ç»ˆç«¯è¾“å…¥å¦‚ä¸‹å‘½ä»¤å³å¯ï¼š</p><p><img src="img/febsvue/QQæˆªå›¾20190409153710.png" alt="QQæˆªå›¾20190409153710.png"></p><p>å®‰è£…å¥½åï¼Œåœ¨package.jsonçš„ä¾èµ–åˆ—è¡¨é‡Œä¼šå¤šå‡ºä¸€ä¸ªjquery 3.3.1ï¼š</p><p><img src="img/febsvue/QQæˆªå›¾20190409153800.png" alt="QQæˆªå›¾20190409153800.png"></p><h3 id="å¦‚ä½•å¤„ç†æ’åº"><a href="#å¦‚ä½•å¤„ç†æ’åº" class="headerlink" title="å¦‚ä½•å¤„ç†æ’åº"></a>å¦‚ä½•å¤„ç†æ’åº</h3><p>å¯¹äºå‰ç«¯æ¥è¯´ï¼Œéœ€è¦ä¸Šé€ä¸¤ä¸ªå‚æ•°ï¼š</p><ol><li><p>sortFieldï¼šéœ€è¦æ’åºçš„å­—æ®µï¼›</p></li><li><p>sortOrderï¼šæ’åºè§„åˆ™ï¼Œascendæˆ–è€…descendã€‚</p></li></ol><p>å¯¹äºåç«¯æ¥è¯´ï¼Œæ’åºä¸»è¦åˆ†ä¸ºå››ç§æƒ…å†µï¼š</p><ol><li>ç»“æœéœ€è¦åˆ†é¡µçš„ï¼Œå¹¶ä¸”æ˜¯é€šè¿‡xmlå®šä¹‰çš„SQLæŸ¥è¯¢å‡ºæ¥çš„ç»“æœï¼š</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SortUtil.handlePageSort(request, page, <span class="string">"userId"</span>, FebsConstant.ORDER_ASC, <span class="keyword">false</span>);</span><br></pre></td></tr></table></figure><p><code>userId</code>å’Œ<code>FebsConstant.ORDER_ASC</code>æŒ‡å®šäº†é»˜è®¤çš„æ’åºè§„åˆ™ï¼Œå³é»˜è®¤æŒ‰ç…§<code>userId</code>å­—æ®µå‡åºæ’åºã€‚æœ€åä¸€ä¸ªå‚æ•°è¡¨ç¤ºæ˜¯å¦éœ€è¦å¼€å¯é©¼å³°è½¬ä¸‹åˆ’çº¿ï¼Œè¿™ç§æƒ…å†µä¸‹ä¸éœ€è¦ï¼Œfalseå³å¯ã€‚</p><p>å…·ä½“å¯ä»¥å‚è€ƒcc.mrbird.febs.system.service.impl.UserServiceImpl#findUserDetailã€‚</p><p>å¦‚æœä¸éœ€è¦æŒ‡å®šé»˜è®¤æ’åºè§„åˆ™ï¼Œä½¿ç”¨handlePageSortçš„é‡è½½æ–¹æ³•å³å¯ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SortUtil.handlePageSort(request, page, <span class="keyword">false</span>);</span><br></pre></td></tr></table></figure><ol start="2"><li>ç»“æœéœ€è¦åˆ†é¡µçš„ï¼Œå¹¶ä¸”æ˜¯é€šè¿‡Mybatis Plusæ’ä»¶æŸ¥è¯¢å‡ºæ¥çš„ç»“æœï¼š</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SortUtil.handlePageSort(request, page, <span class="keyword">true</span>);</span><br></pre></td></tr></table></figure><p>è¿™ç§æƒ…å†µä¸‹ï¼Œæœ€åä¸€ä¸ªå‚æ•°å€¼å¿…é¡»ä¸ºtrueã€‚</p><p>å…·ä½“å¯ä»¥å‚è€ƒcc.mrbird.febs.system.service.impl.DictServiceImpl#findDictsã€‚</p><div class="note info"><p>1å’Œ2ä¸»è¦åŒºåˆ«å°±æ˜¯æ˜¯å¦éœ€è¦å¼€å¯é©¼å³°è½¬ä¸‹åˆ’çº¿ã€‚</p></div><ol start="3"><li>ç»“æœä¸éœ€è¦åˆ†é¡µï¼Œå¹¶ä¸”æ˜¯é€šè¿‡xmlå®šä¹‰çš„SQLæŸ¥è¯¢å‡ºæ¥çš„ç»“æœï¼š</li></ol><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SortUtil.handleWrapperSort(request, queryWrapper, <span class="string">"orderNum"</span>, FebsConstant.ORDER_ASC, <span class="literal">false</span>);</span><br></pre></td></tr></table></figure><p>å…·ä½“å¯ä»¥å‚è€ƒï¼šcc.mrbird.febs.system.service.impl.DeptServiceImpl#findDepts</p><ol start="4"><li>ç»“æœä¸éœ€è¦åˆ†é¡µï¼Œå¹¶ä¸”æ˜¯é€šè¿‡Mybatis Plusæ’ä»¶æŸ¥è¯¢å‡ºæ¥çš„ç»“æœï¼š</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SortUtil.handleWrapperSort(request, queryWrapper, <span class="string">"orderNum"</span>, FebsConstant.ORDER_ASC, <span class="keyword">true</span>);</span><br></pre></td></tr></table></figure><p>æ€»ä¹‹ï¼Œå¯¹äºå¤„ç†æ’åºçš„æ–¹æ³•ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ä¸€å®šæ˜¯cc.mrbird.febs.common.domain.QueryRequestã€‚ç¬¬äºŒä¸ªå‚æ•°å¦‚æœéœ€è¦åˆ†é¡µï¼Œåˆ™ä¼ é€’com.baomidou.mybatisplus.extension.plugins.pagination.Pageï¼Œä¸éœ€è¦åˆ†é¡µåˆ™ä¼ é€’com.baomidou.mybatisplus.core.conditions.query.QueryWrapperã€‚æœ€åä¸€ä¸ªå‚æ•°å¦‚æœæŸ¥è¯¢ç»“æœæ˜¯Mybatis PlusæŸ¥è¯¢å‡ºæ¥çš„ç»“æœï¼Œåˆ™éœ€è®¾ç½®ä¸ºtrueï¼Œå¦åˆ™ä¸ºfalseã€‚</p><h3 id="åç«¯æ¥å£æµ‹è¯•"><a href="#åç«¯æ¥å£æµ‹è¯•" class="headerlink" title="åç«¯æ¥å£æµ‹è¯•"></a>åç«¯æ¥å£æµ‹è¯•</h3><p>ç”±äºåç«¯æ¥å£ä¸ºRESTfulæ¥å£ï¼Œæ‰€ä»¥ä¸èƒ½ä½¿ç”¨æµè§ˆå™¨æ¥æµ‹è¯•ï¼Œå¯ä»¥ä½¿ç”¨PostManæˆ–è€…Chromeæ’ä»¶RestLetæ¥æµ‹è¯•åç«¯æ¥å£ã€‚æ–‡æ¡£ä»¥PostManä¸ºä¾‹ã€‚</p><p>å› ä¸ºåå°æ¥å£å¤§éƒ¨åˆ†éƒ½éœ€è¦ç”¨æˆ·è®¤è¯åæ‰èƒ½è®¿é—®ï¼Œæ‰€ä»¥åœ¨æµ‹è¯•ä¹‹å‰éœ€è¦é€šè¿‡ç™»å½•æ¥å£è·å–ä¸€ä¸ªå¯ç”¨çš„tokenã€‚</p><p><img src="img/febsvue/QQæˆªå›¾20190409161742.png" alt="QQæˆªå›¾20190409161742.png"></p><p>æˆåŠŸè·å–åˆ°äº†tokenã€‚</p><p>æµ‹è¯•è·å–mrbirdçš„å‰ç«¯è·¯ç”±ä¿¡æ¯ï¼š</p><p><img src="img/febsvue/QQæˆªå›¾20190409161947.png" alt="QQæˆªå›¾20190409161947.png"></p><p>åœ¨Headersè®¾ç½®ä¸€ä¸ªé”®å€¼å¯¹ï¼Œkeyä¸ºAuthenticationï¼Œvalueä¸ºåˆšåˆšè·å–åˆ°çš„tokenï¼Œå‘é€è¯·æ±‚ä¾¿å¯ä»¥è·å–åˆ°mrbirdçš„è·¯ç”±ä¿¡æ¯ã€‚å…¶ä»–æ¥å£æµ‹è¯•ä»¥æ­¤ç±»æ¨ã€‚</p><p>å¦‚æœtokenå¡«é”™æˆ–è€…ä¸å¡«ï¼š</p><p><img src="img/febsvue/QQæˆªå›¾20190409162214.png" alt="QQæˆªå›¾20190409162214.png"></p><p>åç«¯å°†è¿”å›401ã€‚</p><h2 id="å¸¸è§é—®é¢˜"><a href="#å¸¸è§é—®é¢˜" class="headerlink" title="å¸¸è§é—®é¢˜"></a>å¸¸è§é—®é¢˜</h2><h3 id="å¯¼å…¥é¡¹ç›®ç¼–è¯‘å‡ºé”™ï¼Œä»£ç æ˜¯å¦ä¸å…¨ï¼Ÿ"><a href="#å¯¼å…¥é¡¹ç›®ç¼–è¯‘å‡ºé”™ï¼Œä»£ç æ˜¯å¦ä¸å…¨ï¼Ÿ" class="headerlink" title="å¯¼å…¥é¡¹ç›®ç¼–è¯‘å‡ºé”™ï¼Œä»£ç æ˜¯å¦ä¸å…¨ï¼Ÿ"></a>å¯¼å…¥é¡¹ç›®ç¼–è¯‘å‡ºé”™ï¼Œä»£ç æ˜¯å¦ä¸å…¨ï¼Ÿ</h3><p>ç¼–è¾‘å™¨å®‰è£…lombokæ’ä»¶å³å¯ã€‚</p><h3 id="å¯¼å…¥SQLä¸ºä½•å‡ºé”™ï¼Ÿ"><a href="#å¯¼å…¥SQLä¸ºä½•å‡ºé”™ï¼Ÿ" class="headerlink" title="å¯¼å…¥SQLä¸ºä½•å‡ºé”™ï¼Ÿ"></a>å¯¼å…¥SQLä¸ºä½•å‡ºé”™ï¼Ÿ</h3><p>MySQLæ•°æ®åº“è¯·ä½¿ç”¨5.7.xç‰ˆæœ¬ï¼Œä¸åŒç‰ˆæœ¬SQLè¯­æ³•æœ‰å·®å¼‚ã€‚å¦‚æœä½ SQLæŠ€æœ¯è¿‡ç¡¬å¯ä»¥é€šè¿‡é”™è¯¯ä¿¡æ¯å»ä¿®æ”¹å‡ºé”™çš„SQLï¼Œæ›´æ¨èçš„åšæ³•æ˜¯å®‰è£…æ¨èç‰ˆæœ¬çš„MySQLæ•°æ®åº“ã€‚</p><h3 id="ip2regionæ˜¯å•¥ç©æ„ï¼Œæ‰“å¼€æ€ä¹ˆä¹±ç ï¼Ÿ"><a href="#ip2regionæ˜¯å•¥ç©æ„ï¼Œæ‰“å¼€æ€ä¹ˆä¹±ç ï¼Ÿ" class="headerlink" title="ip2regionæ˜¯å•¥ç©æ„ï¼Œæ‰“å¼€æ€ä¹ˆä¹±ç ï¼Ÿ"></a>ip2regionæ˜¯å•¥ç©æ„ï¼Œæ‰“å¼€æ€ä¹ˆä¹±ç ï¼Ÿ</h3><p>é€šè¿‡ipè·å–åœ°å€çš„å¼€æºè½¯ä»¶æ•°æ®åº“æ–‡ä»¶ï¼Œä¸è¦ç›´æ¥æ‰“å¼€ã€‚ip2regionåœ°å€ï¼š<a href="https://github.com/lionsoul2014/ip2region" target="_blank" rel="noopener">https://github.com/lionsoul2014/ip2region</a>ã€‚</p><h2 id="é¡¹ç›®ç¼ºé™·"><a href="#é¡¹ç›®ç¼ºé™·" class="headerlink" title="é¡¹ç›®ç¼ºé™·"></a>é¡¹ç›®ç¼ºé™·</h2><ol><li><p>å‰ç«¯é¡µé¢ä¸æ”¯æŒç§»åŠ¨ç«¯ï¼ˆä¸èƒ½è‡ªé€‚åº”ï¼‰ï¼›</p></li><li><p>å‰ç«¯æ‰“åŒ…åvendor.jsè¾ƒå¤§ï¼Œé€šè¿‡nginxå‹ç¼©ååœ¨591kbå·¦å³ï¼Œåœ¨æˆ‘çš„æ¸£æ¸£æœåŠ¡å™¨ï¼ˆ1æ ¸1G1Mï¼‰ä¸‹ï¼Œè®¿é—®æ—¶é—´å¤§çº¦ä¸º7 - 8ç§’å·¦å³ï¼š</p></li></ol><p><img src="img/febsvue/QQæˆªå›¾20190409162930.png" alt="QQæˆªå›¾20190409162930.png"></p><p>å¦‚æœä½ çš„æœåŠ¡å™¨å¸¦å®½å¤Ÿå¤§ï¼Œæˆ–è€…æ˜¯éƒ¨ç½²åœ¨å…¬å¸å±€åŸŸç½‘å†…çš„è¯ï¼Œè¿™ä¸ªé—®é¢˜å¯ä»¥å¿½ç•¥ã€‚å¦‚æœè¦åœ¨æ ¹æºä¸Šè§£å†³è¿™ä¸ªé—®é¢˜ä¸ªäººè§‰å¾—å¯ä»¥ä»è¿™å‡ ä¸ªåœ°æ–¹å…¥æ‰‹ï¼š</p><ul><li><p>Ant Designé‡‡ç”¨SVGæ ¼å¼çš„å›¾æ ‡åï¼Œå¯¼è‡´é¡¹ç›®æ‰“åŒ…ä½“ç§¯è¿‡å¤§ï¼Œå¯ä»¥å‚è€ƒå®˜æ–¹issueçš„è®¨è®ºï¼š<a href="https://github.com/vueComponent/ant-design-vue/issues/325" target="_blank" rel="noopener">https://github.com/vueComponent/ant-design-vue/issues/325</a>å’Œ<a href="https://github.com/ant-design/ant-design/issues/12011" target="_blank" rel="noopener">https://github.com/ant-design/ant-design/issues/12011</a>ï¼›</p></li><li><p>å¯ä»¥å°†ä¾èµ–é€šè¿‡CDNæ¥åŠ è½½ï¼Œå‚è€ƒè¿æ¥ï¼š<a href="https://blog.csdn.net/qq_35844177/article/details/78599064" target="_blank" rel="noopener">https://blog.csdn.net/qq_35844177/article/details/78599064</a>ï¼›</p></li><li><p>webpackæ‰“åŒ…é…ç½®å¯èƒ½å­˜åœ¨å¯ä¼˜åŒ–çš„åœ°æ–¹ã€‚</p></li></ul><p>ç”±äºæˆ‘æ‰ç–å­¦æµ…ï¼Œå‰ç«¯æŠ€èƒ½è–„å¼±ï¼Œæ‰€ä»¥æ²¡èƒ½å¤Ÿå¾ˆå¥½åœ°è§£å†³è¿™ä¸ªé—®é¢˜ã€‚æ¬¢è¿æ¥è‡ªäº”æ¹–å››æµ·çš„èƒ½äººå¿—å£«pull requestæ¥æ”¹å–„è¿™ä¸ªé—®é¢˜ï¼Œæ„Ÿæ¿€ä¸å°½ã€‚</p><p><img src="img/febsvue/QQå›¾ç‰‡20190409164403.jpg" alt="QQå›¾ç‰‡20190409164403.jpg"></p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Wed May 15 2019 17:13:45 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;FEBS-Vueä¸º&lt;a href=&quot;https://github.com/wuyouzhuguli/FEBS-Shiro&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;FEBS-Shiro&lt;/a&gt;çš„å‰åç«¯åˆ†ç¦»ç‰ˆæœ¬ï¼Œå‰ç«¯ä½¿ç”¨Vueå…¨å®¶æ¡¶ï¼Œç»„ä»¶åº“é‡‡ç”¨&lt;a href=&quot;https://vuecomponent.github.io/ant-design-vue/docs/vue/introduce-cn/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Ant-Design-Vue&lt;/a&gt;ã€‚&lt;/p&gt;&lt;p&gt;æ–‡æ¡£é‡Œä»‹ç»çš„ç¤ºä¾‹æ˜¯åœ¨Windows10æ“ä½œç³»ç»Ÿä¸‹å®Œæˆçš„ï¼Œåç«¯ç¼–è¾‘å™¨ä½¿ç”¨IDEAï¼Œå‰ç«¯ç¼–è¾‘å™¨ä½¿ç”¨WebStormã€‚
    
    </summary>
    
    
      <category term="FEBS" scheme="http://mrbird.cc/tags/FEBS/"/>
    
  </entry>
  
  <entry>
    <title>Spring Boot WebFluxå¢åˆ æ”¹æŸ¥æ ·ä¾‹</title>
    <link href="http://mrbird.cc/Spring-Boot-WebFlux-CRUD.html"/>
    <id>http://mrbird.cc/Spring-Boot-WebFlux-CRUD.html</id>
    <published>2018-12-02T08:00:36.000Z</published>
    <updated>2019-04-04T03:49:46.096Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Wed May 15 2019 17:13:43 GMT+0800 (GMT+08:00) --><p>åœ¨<a href="/Spring-Boot-2-0-WebFlux.html]"> Spring Boot 2.0 WebFluxç¼–ç¨‹ </a>ä¸€èŠ‚æˆ‘ä»¬å¤§è‡´äº†è§£äº†WebFluxçš„ç”¨æ³•ï¼Œè¿™èŠ‚æˆ‘ä»¬å°†ç»“åˆMongo DBåœ¨WebFluxçš„æ¶æ„ä¸‹å®ç°å¢åˆ æ”¹æŸ¥æ ·ä¾‹ã€‚å’Œ<a href="/Spring-Boot-Mongo-DB-CRUD.html"> Spring Bootæ•´åˆMongo DB </a>ä¸åŒçš„æ˜¯ï¼Œæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯Reactive Mongo DBä¾èµ–ï¼Œæ‰€æœ‰å¢åˆ æ”¹æŸ¥æ–¹æ³•è¿”å›å€¼ç±»å‹ä¸ºFluxæˆ–è€…Monoã€‚</p><a id="more"></a><h2 id="é¡¹ç›®å‡†å¤‡"><a href="#é¡¹ç›®å‡†å¤‡" class="headerlink" title="é¡¹ç›®å‡†å¤‡"></a>é¡¹ç›®å‡†å¤‡</h2><p>æ–°å»ºä¸€ä¸ªSpring Booté¡¹ç›®ï¼Œç‰ˆæœ¬ä¸º2.1.3.RELEASEï¼Œå¹¶å¼•å…¥<code>webflux</code>å’Œ<code>reactive mongodb</code>ä¾èµ–ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-webflux<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-mongodb-reactive<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p></p><p>è¦å¼€å¯<code>Reactive Mongo DB</code>çš„ç›¸å…³é…ç½®ï¼Œéœ€è¦åœ¨Spring Bootå¯åŠ¨ç±»ä¸Šæ·»åŠ <code>@EnableReactiveMongoRepositories</code>æ³¨è§£ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableReactiveMongoRepositories</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebfluxApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(WebfluxApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>æ¥ç€åœ¨é…ç½®æ–‡ä»¶application.ymlé‡Œé…ç½®Mongo DBè¿æ¥ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  data:</span></span><br><span class="line"><span class="attr">    mongodb:</span></span><br><span class="line"><span class="attr">      host:</span> <span class="string">localhost</span></span><br><span class="line"><span class="attr">      port:</span> <span class="number">27017</span></span><br><span class="line"><span class="attr">      database:</span> <span class="string">webflux</span></span><br></pre></td></tr></table></figure><p></p><p>ä½¿ç”¨çš„æ˜¯<code>webflux</code>æ•°æ®åº“ï¼Œæ‰€ä»¥éœ€è¦åœ¨Mongo DBé‡Œæ–°å»ºä¸€ä¸ª<code>webflux</code>æ•°æ®åº“ï¼ˆå¹¶åˆ›å»ºuseræ–‡æ¡£/è¡¨ï¼Œä»¥ä¾›å¾…ä¼šä½¿ç”¨ï¼‰ï¼š</p><p><img src="img/QQæˆªå›¾20190404105640.png" alt="QQæˆªå›¾20190404105640.png"></p><p>åˆ›å»º<code>User</code>å®ä½“ç±»:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Document</span>(collection = <span class="string">"user"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">    <span class="keyword">private</span> String description;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// get set ç•¥</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><h2 id="ç®€å•å¢åˆ æ”¹æŸ¥"><a href="#ç®€å•å¢åˆ æ”¹æŸ¥" class="headerlink" title="ç®€å•å¢åˆ æ”¹æŸ¥"></a>ç®€å•å¢åˆ æ”¹æŸ¥</h2><p>åˆ›å»º<code>UserDao</code>æ¥å£ï¼Œç»§æ‰¿è‡ª<code>ReactiveMongoRepository</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserDao</span> <span class="keyword">extends</span> <span class="title">ReactiveMongoRepository</span>&lt;<span class="title">User</span>, <span class="title">String</span>&gt; </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>å’Œ<a href="/Spring-Boot-Mongo-DB-CRUD.html"> Spring Bootæ•´åˆMongo DB </a>ä¸åŒçš„æ˜¯ï¼Œæˆ‘ä»¬ç»§æ‰¿çš„æ˜¯<code>ReactiveMongoRepository</code>è€Œé<code>MongoRepository</code>ï¼Œå®ƒæ‰€æä¾›çš„æ–¹æ³•éƒ½æ˜¯å“åº”å¼çš„ï¼š</p><p><img src="img/QQæˆªå›¾20190404110050.png" alt="QQæˆªå›¾20190404110050.png"></p><p>åœ¨<code>UserService</code>é‡Œé€šè¿‡<code>UserDao</code>å®šä¹‰ç®€å•å¢åˆ æ”¹æŸ¥æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserDao userDao;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Flux&lt;User&gt; <span class="title">getUsers</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userDao.findAll();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;User&gt; <span class="title">getUser</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.userDao.findById(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;User&gt; <span class="title">createUser</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userDao.save(user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">deleteUser</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.userDao.findById(id)</span><br><span class="line">                .flatMap(user -&gt; <span class="keyword">this</span>.userDao.delete(user));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;User&gt; <span class="title">updateUser</span><span class="params">(String id, User user)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.userDao.findById(id)</span><br><span class="line">            .flatMap(u -&gt; &#123;</span><br><span class="line">                u.setName(user.getName());</span><br><span class="line">                u.setAge(user.getAge());</span><br><span class="line">                u.setDescription(user.getDescription());</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">this</span>.userDao.save(u);</span><br><span class="line">            &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>å¤§è‡´ä¸Šå’Œ<a href="/Spring-Boot-Mongo-DB-CRUD.html"> Spring Bootæ•´åˆMongo DB </a>ä¸­çš„<code>UserService</code>å·®ä¸å¤šï¼Œä¸åŒçš„æ˜¯è¿”å›å€¼ç±»å‹ä¸ºFluxæˆ–è€…Monoï¼Œå³å®ƒä»¬æ˜¯å“åº”å¼éé˜»å¡çš„æ–¹æ³•ã€‚</p><p>ç¼–å†™RESTful<code>UserController</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"user"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä»¥æ•°ç»„çš„å½¢å¼ä¸€æ¬¡æ€§è¿”å›æ‰€æœ‰æ•°æ®</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Flux&lt;User&gt; <span class="title">getUsers</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userService.getUsers();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä»¥ Server sent eventså½¢å¼å¤šæ¬¡è¿”å›æ•°æ®</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping</span>(value = <span class="string">"/stream"</span>, produces = MediaType.TEXT_EVENT_STREAM_VALUE)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Flux&lt;User&gt; <span class="title">getUsersStream</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userService.getUsers();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;User&gt; <span class="title">createUser</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userService.createUser(user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å­˜åœ¨è¿”å› 200ï¼Œä¸å­˜åœ¨è¿”å› 404</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@DeleteMapping</span>(<span class="string">"/&#123;id&#125;"</span>)</span><br><span class="line">    <span class="keyword">public</span> Mono&lt;ResponseEntity&lt;Void&gt;&gt; deleteUser(<span class="meta">@PathVariable</span> String id) &#123;</span><br><span class="line">        <span class="keyword">return</span> userService.deleteUser(id)</span><br><span class="line">                .then(Mono.just(<span class="keyword">new</span> ResponseEntity&lt;Void&gt;(HttpStatus.OK)))</span><br><span class="line">                .defaultIfEmpty(<span class="keyword">new</span> ResponseEntity&lt;&gt;(HttpStatus.NOT_FOUND));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å­˜åœ¨è¿”å›ä¿®æ”¹åçš„ User</span></span><br><span class="line"><span class="comment">     * ä¸å­˜åœ¨è¿”å› 404</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PutMapping</span>(<span class="string">"/&#123;id&#125;"</span>)</span><br><span class="line">    <span class="keyword">public</span> Mono&lt;ResponseEntity&lt;User&gt;&gt; updateUser(<span class="meta">@PathVariable</span> String id, User user) &#123;</span><br><span class="line">        <span class="keyword">return</span> userService.updateUser(id, user)</span><br><span class="line">                .map(u -&gt; <span class="keyword">new</span> ResponseEntity&lt;&gt;(u, HttpStatus.OK))</span><br><span class="line">                .defaultIfEmpty(<span class="keyword">new</span> ResponseEntity&lt;&gt;(HttpStatus.NOT_FOUND));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ ¹æ®ç”¨æˆ· idæŸ¥æ‰¾</span></span><br><span class="line"><span class="comment">     * å­˜åœ¨è¿”å›ï¼Œä¸å­˜åœ¨è¿”å› 404</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/&#123;id&#125;"</span>)</span><br><span class="line">    <span class="keyword">public</span> Mono&lt;ResponseEntity&lt;User&gt;&gt; getUser(<span class="meta">@PathVariable</span> String id) &#123;</span><br><span class="line">        <span class="keyword">return</span> userService.getUser(id)</span><br><span class="line">                .map(user -&gt; <span class="keyword">new</span> ResponseEntity&lt;&gt;(user, HttpStatus.OK))</span><br><span class="line">                .defaultIfEmpty(<span class="keyword">new</span> ResponseEntity&lt;&gt;(HttpStatus.NOT_FOUND));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>å¯¹äºè¿”å›å€¼ä¸º<code>Flux&lt;T&gt;</code>ç±»å‹çš„æ–¹æ³•ï¼Œæ¨èå®šä¹‰ä¸¤ä¸ªä¸€æ ·çš„æ–¹æ³•ï¼Œä¸€ä¸ªä»¥æ™®é€šå½¢å¼è¿”å›ï¼Œä¸€ä¸ªä»¥Server Sent Eventçš„å½¢å¼è¿”å›ã€‚å¯¹äºä¿®æ”¹å’Œåˆ é™¤ï¼Œå¦‚æœéœ€è¦ä¿®æ”¹å’Œåˆ é™¤çš„ç”¨æˆ·ä¸å­˜åœ¨ï¼Œæˆ‘ä»¬è¿”å›404ã€‚</p><p>å¯¹äºFluxå’ŒMonoçš„æ“ä½œï¼Œåœ¨<a href="/Spring-Boot-2-0-WebFlux.html]"> Spring Boot 2.0 WebFluxç¼–ç¨‹ </a>ä¸€èŠ‚ä¸­å·²ç»ä»‹ç»è¿‡äº†ï¼Œè¿™é‡Œå°±ä¸å†èµ˜è¿°äº†ã€‚</p><h2 id="æ’åºä¸åˆ†é¡µ"><a href="#æ’åºä¸åˆ†é¡µ" class="headerlink" title="æ’åºä¸åˆ†é¡µ"></a>æ’åºä¸åˆ†é¡µ</h2><p>åœ¨<a href="/Spring-Boot-Mongo-DB-CRUD.html"> Spring Bootæ•´åˆMongo DB </a>ä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡<code>MongoTemplate</code>å®ç°äº†æ’åºä¸åˆ†é¡µã€‚ä¸<code>MongoTemplate</code>å¯¹äºçš„å“åº”å¼çš„å¯¹è±¡ä¸º<code>ReactiveMongoTemplate</code>ï¼Œæ‰€ä»¥æˆ‘ä»¬ç…§è‘«èŠ¦ç”»ç“¢ï¼Œä»¿ç…§<code>MongoTemplate</code>çš„å†™æ³•æ¥å®ç°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åˆ†é¡µæŸ¥è¯¢ï¼Œåªè¿”å›åˆ†é¡µåçš„æ•°æ®ï¼Œcountå€¼éœ€è¦é€šè¿‡ getUserByConditionCount</span></span><br><span class="line"><span class="comment"> * æ–¹æ³•è·å–</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Flux&lt;User&gt; <span class="title">getUserByCondition</span><span class="params">(<span class="keyword">int</span> size, <span class="keyword">int</span> page, User user)</span> </span>&#123;</span><br><span class="line">    Query query = getQuery(user);</span><br><span class="line">    Sort sort = <span class="keyword">new</span> Sort(Sort.Direction.DESC, <span class="string">"age"</span>);</span><br><span class="line">    Pageable pageable = PageRequest.of(page, size, sort);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> template.find(query.with(pageable), User.class);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è¿”å› countï¼Œé…åˆ getUserByConditionä½¿ç”¨</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Mono&lt;Long&gt; <span class="title">getUserByConditionCount</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">    Query query = getQuery(user);</span><br><span class="line">    <span class="keyword">return</span> template.count(query, User.class);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> Query <span class="title">getQuery</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">    Query query = <span class="keyword">new</span> Query();</span><br><span class="line">    Criteria criteria = <span class="keyword">new</span> Criteria();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!StringUtils.isEmpty(user.getName())) &#123;</span><br><span class="line">        criteria.and(<span class="string">"name"</span>).is(user.getName());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!StringUtils.isEmpty(user.getDescription())) &#123;</span><br><span class="line">        criteria.and(<span class="string">"description"</span>).regex(user.getDescription());</span><br><span class="line">    &#125;</span><br><span class="line">    query.addCriteria(criteria);</span><br><span class="line">    <span class="keyword">return</span> query;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¹‹æ‰€ä»¥æ‹†åˆ†æ˜¯å› ä¸ºæ²¡æ‰¾åˆ°ä¸<code>PageableExecutionUtils</code>ç±»çš„<code>getPage</code>æ–¹æ³•ç±»ä¼¼çš„æ–¹æ³•ï¼Œå¦‚æœæ˜¯å“åº”å¼çš„è¯ï¼Œè¿”å›å€¼ç±»å‹åº”è¯¥æ˜¯<code>Mono&lt;Page&lt;User&gt;&gt;</code>ï¼Œä¸æ‡‚å¤§å®¶æœ‰æ²¡åˆ«çš„æ›´å¥½çš„å®ç°æ–¹æ³•ï¼Ÿ</p><p>æºç å’ŒPostManæµ‹è¯•æ ·ä¾‹é“¾æ¥ï¼š<a href="https://github.com/wuyouzhuguli/SpringAll/tree/master/58.Spring-Boot-WebFlux-crud" target="_blank" rel="noopener">https://github.com/wuyouzhuguli/SpringAll/tree/master/58.Spring-Boot-WebFlux-crud</a></p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Wed May 15 2019 17:13:43 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;åœ¨&lt;a href=&quot;/Spring-Boot-2-0-WebFlux.html]&quot;&gt; Spring Boot 2.0 WebFluxç¼–ç¨‹ &lt;/a&gt;ä¸€èŠ‚æˆ‘ä»¬å¤§è‡´äº†è§£äº†WebFluxçš„ç”¨æ³•ï¼Œè¿™èŠ‚æˆ‘ä»¬å°†ç»“åˆMongo DBåœ¨WebFluxçš„æ¶æ„ä¸‹å®ç°å¢åˆ æ”¹æŸ¥æ ·ä¾‹ã€‚å’Œ&lt;a href=&quot;/Spring-Boot-Mongo-DB-CRUD.html&quot;&gt; Spring Bootæ•´åˆMongo DB &lt;/a&gt;ä¸åŒçš„æ˜¯ï¼Œæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯Reactive Mongo DBä¾èµ–ï¼Œæ‰€æœ‰å¢åˆ æ”¹æŸ¥æ–¹æ³•è¿”å›å€¼ç±»å‹ä¸ºFluxæˆ–è€…Monoã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Spring" scheme="http://mrbird.cc/tags/Spring/"/>
    
      <category term="Spring Boot" scheme="http://mrbird.cc/tags/Spring-Boot/"/>
    
      <category term="MongoDB" scheme="http://mrbird.cc/tags/MongoDB/"/>
    
      <category term="WebFlux" scheme="http://mrbird.cc/tags/WebFlux/"/>
    
  </entry>
  
  <entry>
    <title>Spring Cloud ConsulæœåŠ¡æ²»ç†</title>
    <link href="http://mrbird.cc/Spring-Cloud-Consul.html"/>
    <id>http://mrbird.cc/Spring-Cloud-Consul.html</id>
    <published>2018-11-29T08:00:31.000Z</published>
    <updated>2019-03-28T06:44:59.912Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Wed May 15 2019 17:13:44 GMT+0800 (GMT+08:00) --><p>Consulæ˜¯ä¸€æ¬¾ç”±<a href="https://www.hashicorp.com/" target="_blank" rel="noopener">HashiCorp</a>å…¬å¸å¼€æºçš„ï¼Œç”¨äºæœåŠ¡æ²»ç†çš„è½¯ä»¶ï¼Œ<a href="https://spring.io/projects/spring-cloud-consul" target="_blank" rel="noopener">Spring Cloud Consul</a>å¯¹å…¶è¿›è¡Œäº†å°è£…ã€‚Consulå…·æœ‰å¦‚ä¸‹ç‰¹ç‚¹:</p><ol><li><p>æœåŠ¡æ³¨å†Œ - è‡ªåŠ¨æ³¨å†Œå’Œå–æ¶ˆæ³¨å†ŒæœåŠ¡å®ä¾‹çš„ç½‘ç»œä½ç½®</p></li><li><p>è¿è¡ŒçŠ¶å†µæ£€æŸ¥ - æ£€æµ‹æœåŠ¡å®ä¾‹ä½•æ—¶å¯åŠ¨å¹¶è¿è¡Œ</p></li><li><p>åˆ†å¸ƒå¼é…ç½® - ç¡®ä¿æ‰€æœ‰æœåŠ¡å®ä¾‹ä½¿ç”¨ç›¸åŒçš„é…ç½®</p></li></ol><a id="more"></a><p>Consul agentæœ‰ä¸¤ç§è¿è¡Œæ¨¡å¼ï¼šServerå’ŒClientã€‚è¿™é‡Œçš„Serverå’ŒClientåªæ˜¯Consulé›†ç¾¤å±‚é¢çš„åŒºåˆ†ï¼Œä¸æ­å»ºåœ¨Clusterä¹‹ä¸Š çš„åº”ç”¨æœåŠ¡æ— å…³ã€‚ ä»¥Serveræ¨¡å¼è¿è¡Œçš„Consul agentèŠ‚ç‚¹ç”¨äºç»´æŠ¤Consulé›†ç¾¤çš„çŠ¶æ€ï¼Œå®˜æ–¹å»ºè®®æ¯ä¸ªConsul Clusterè‡³å°‘æœ‰3ä¸ªæˆ–ä»¥ä¸Šçš„è¿è¡Œåœ¨Server modeçš„Agentï¼ŒClientèŠ‚ç‚¹ä¸é™ã€‚</p><h2 id="å®‰è£…Consul"><a href="#å®‰è£…Consul" class="headerlink" title="å®‰è£…Consul"></a>å®‰è£…Consul</h2><p>Consulä¸‹è½½åœ°å€ï¼š<a href="https://www.consul.io/downloads.html" target="_blank" rel="noopener">https://www.consul.io/downloads.html</a>ï¼Œæœ¬æ–‡é€‰æ‹©Linux 64bit ç‰ˆæœ¬è¿›è¡Œæ¼”ç¤ºã€‚</p><p>ä¸‹è½½åè§£å‹ï¼Œç„¶ååœ¨è§£å‹ç›®å½•ä¸‹è¿è¡Œ<code>./consul</code>å‘½ä»¤ï¼š</p><p><img src="img/QQæˆªå›¾20190328094517.png" alt="QQæˆªå›¾20190328094517.png"></p><p>å¯ä»¥çœ‹åˆ°Consulæ‰€åŒ…å«çš„å‘½ä»¤ï¼Œä½¿ç”¨<code>consul [å‘½ä»¤] --help</code>å¯ä»¥æŸ¥çœ‹æŸä¸ªå‘½ä»¤çš„å…·ä½“ç”¨æ³•ã€‚</p><p>æ‰§è¡Œä¸‹é¢è¿™æ¡å‘½ä»¤æ¥å¯åŠ¨ä¸€ä¸ªConsul agentï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./consul agent -dev -client 192.168.140.215</span><br></pre></td></tr></table></figure><p></p><p><code>-dev</code>è¡¨ç¤ºåˆ›å»ºä¸€ä¸ªå¼€å‘ç¯å¢ƒä¸‹çš„serverèŠ‚ç‚¹ï¼Œä¸è¯¥æ¨¡å¼ä¸‹ä¼šæœ‰ä»»ä½•æŒä¹…åŒ–æ“ä½œï¼Œå³ä¸ä¼šæœ‰ä»»ä½•æ•°æ®å†™å…¥åˆ°ç£ç›˜ï¼Œæ‰€ä»¥è¿™ä¸ªæ¨¡å¼é€‚åˆç”¨äºå¼€å‘è¿‡ç¨‹ï¼Œè€Œä¸é€‚ç”¨äºç”Ÿäº§ç¯å¢ƒã€‚<code>-client 192.168.140.215</code>è¡¨ç¤ºè¿è¡Œå®¢æˆ·ç«¯ä½¿ç”¨ipåœ°å€<code>192.168.140.215</code>ï¼ˆæœ¬æ–‡Linuxç¯å¢ƒIPåœ°å€ï¼‰å»è®¿é—®ã€‚</p><p>å¯åŠ¨åï¼Œé»˜è®¤çš„ç«¯å£å·ä¸º8500ï¼Œè®¿é—®<a href="http://192.168.140.215:8500" target="_blank" rel="noopener">http://192.168.140.215:8500</a></p><p><img src="img/QQæˆªå›¾20190328100116.png" alt="QQæˆªå›¾20190328100116.png"></p><p>å½“å‰å°±ä¸€ä¸ªconsulæœåŠ¡ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å¼€å§‹åˆ›å»ºæœåŠ¡æä¾›è€…å’ŒæœåŠ¡æ¶ˆè´¹è€…ã€‚</p><h2 id="Server-Provider"><a href="#Server-Provider" class="headerlink" title="Server-Provider"></a>Server-Provider</h2><p>åˆ›å»ºä¸€ä¸ªSpring Booté¡¹ç›®ï¼Œç‰ˆæœ¬ä¸º2.0.2.RELEASEï¼Œ<code>artifactId</code>ä¸ºserver-providerï¼ŒSpring Cloudç‰ˆæœ¬ä¸ºFinchley.RELEASEï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">spring-cloud.version</span>&gt;</span>Finchley.RELEASE<span class="tag">&lt;/<span class="name">spring-cloud.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-consul-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-cloud.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br></pre></td></tr></table></figure><p></p><p>ç„¶ååœ¨é…ç½®æ–‡ä»¶é‡Œæ·»åŠ å¦‚ä¸‹é…ç½®ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">9000</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  application:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">server-provider</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    consul:</span></span><br><span class="line"><span class="attr">      host:</span> <span class="number">192.168</span><span class="number">.140</span><span class="number">.215</span></span><br><span class="line"><span class="attr">      port:</span> <span class="number">8500</span></span><br><span class="line"><span class="attr">      discovery:</span></span><br><span class="line"><span class="attr">        health-check-interval:</span> <span class="number">10</span><span class="string">s</span></span><br><span class="line"><span class="attr">        service-name:</span> <span class="string">$&#123;spring.application.name&#125;</span></span><br><span class="line"><span class="attr">        register-health-check:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">        health-check-path:</span> <span class="string">/check</span></span><br></pre></td></tr></table></figure><p></p><p><code>spring.cloud.consul.host</code>å’Œ<code>spring.cloud.consul.port</code>é…ç½®äº†consulçš„ipå’Œç«¯å£ï¼›<code>spring.cloud.consul.discovery.service-name</code>é…ç½®äº†è¯¥æœåŠ¡åœ¨consulé‡Œæ³¨å†Œçš„æœåŠ¡åç§°ï¼›<code>spring.cloud.consul.discovery.register-health-check</code>ç”¨äºå¼€å¯å¥åº·æ£€æŸ¥ï¼Œ<code>spring.cloud.consul.discovery.health-check-interval</code>é…ç½®äº†å¥åº·æ£€æŸ¥çš„å‘¨æœŸä¸º10ç§’ï¼Œ<code>spring.cloud.consul.discovery.health-check-path</code>é…ç½®äº†å¥åº·æ£€æŸ¥è·¯å¾„ã€‚</p><p>æ¥ç€æ–°å»ºTestControllerï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestController</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Logger logger = LoggerFactory.getLogger(<span class="keyword">this</span>.getClass());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"check"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">check</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"health check"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"ok"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"hello"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"hello"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"hello from server provider"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p><code>check</code>æ–¹æ³•ç”¨äºç›‘æ§æ£€æŸ¥ï¼ŒTestControllerè¿˜æä¾›äº†ä¸€ä¸ª<code>hello</code>æ–¹æ³•ï¼Œä»¥ä¾›åç»­æœåŠ¡æ¶ˆè´¹è€…è°ƒç”¨ã€‚</p><p><code>spring.cloud.consul.discovery.health-check-path</code>çš„é»˜è®¤å€¼ä¸º<code>/actuator/health</code>ï¼Œå¦‚æœé‡‡ç”¨è¯¥é»˜è®¤å€¼çš„è¯ï¼Œè¿˜éœ€è¦å¯¼å…¥<code>spring-boot-starter-actuator</code>ä¾èµ–ã€‚</p><p>æœ€åï¼Œè¦å¼€å¯æœåŠ¡æ³¨å†Œä¸å‘è¡Œï¼Œéœ€è¦åœ¨Spring Bootå…¥å£ç±»ä¸Šæ·»åŠ <code>@EnableDiscoveryClient</code>æ³¨è§£ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServerProviderApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(ServerProviderApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>å‡†å¤‡å®Œæ¯•åï¼Œæ‰“åŒ…é¡¹ç›®ï¼Œç„¶åå¯åŠ¨ä¸¤ä¸ªå®ä¾‹ï¼Œç«¯å£å·åˆ†åˆ«ä¸º9000å’Œ9001ï¼Œå¯åŠ¨åï¼Œå†æ¬¡è®¿é—®consulç®¡ç†ç•Œé¢ï¼š</p><p><img src="img/QQæˆªå›¾20190328104441.png" alt="QQæˆªå›¾20190328104441.png"></p><p><img src="img/QQæˆªå›¾20190328104520.png" alt="QQæˆªå›¾20190328104520.png"></p><p>æœåŠ¡æä¾›è€…æ³¨å†ŒæˆåŠŸï¼Œæ¥ä¸‹æ¥å¼€å§‹æ­å»ºæœåŠ¡æ¶ˆè´¹è€…ã€‚</p><h2 id="Server-Consumer"><a href="#Server-Consumer" class="headerlink" title="Server-Consumer"></a>Server-Consumer</h2><p>åˆ›å»ºä¸€ä¸ªSpring Booté¡¹ç›®ï¼Œç‰ˆæœ¬ä¸º2.0.2.RELEASEï¼ŒartifactIdä¸ºserver-providerï¼ŒSpring Cloudç‰ˆæœ¬ä¸ºFinchley.RELEASEï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">spring-cloud.version</span>&gt;</span>Finchley.RELEASE<span class="tag">&lt;/<span class="name">spring-cloud.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-consul-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-cloud.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br></pre></td></tr></table></figure><p></p><p>å¼•å…¥<code>spring-boot-starter-actuator</code>ç”¨äºé»˜è®¤çš„å¥åº·æ£€æŸ¥ã€‚</p><p>é…ç½®application.ymlï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">9002</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  application:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">server-consumer</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    consul:</span></span><br><span class="line"><span class="attr">      host:</span> <span class="number">192.168</span><span class="number">.140</span><span class="number">.215</span></span><br><span class="line"><span class="attr">      port:</span> <span class="number">8500</span></span><br><span class="line"><span class="attr">      discovery:</span></span><br><span class="line"><span class="attr">        service-name:</span> <span class="string">$&#123;spring.application.name&#125;</span></span><br></pre></td></tr></table></figure><p></p><p>åŒæ ·çš„ï¼Œéœ€è¦å¼€å¯æœåŠ¡æ³¨å†Œä¸å‘ç°éœ€è¦åœ¨å…¥å£ç±»ä¸Šæ·»åŠ <code>@EnableDiscoveryClient</code>æ³¨è§£ã€‚</p><p>æ¥ç€åˆ›å»ºTestControlleræ¥æ¶ˆè´¹Server-Provideræä¾›çš„<code>hello</code>æœåŠ¡ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Logger loggr = LoggerFactory.getLogger(<span class="keyword">this</span>.getClass());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DiscoveryClient discoveryClient;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> LoadBalancerClient loadBalancerClient;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RestTemplate restTemplate = <span class="keyword">new</span> RestTemplate();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SERVER_ID = <span class="string">"server-provider"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"uri"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;URI&gt; <span class="title">getServerUris</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.discoveryClient.getInstances(SERVER_ID)</span><br><span class="line">                .stream()</span><br><span class="line">                .map(ServiceInstance::getUri).collect(Collectors.toList());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"hello"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ServiceInstance instance = loadBalancerClient.choose(SERVER_ID);</span><br><span class="line">        String url = instance.getUri().toString() + <span class="string">"/hello"</span>;</span><br><span class="line">        loggr.info(<span class="string">"remote server urlï¼š&#123;&#125;"</span>, url);</span><br><span class="line">        <span class="keyword">return</span> restTemplate.getForObject(url, String.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p><strong>SERVER_ID</strong>çš„å€¼ä¸ºæœåŠ¡æä¾›è€…åœ¨consulæ³¨å†Œä¸­å¿ƒçš„å®ä¾‹åç§°ï¼Œå³<code>server-provider</code>ã€‚é€šè¿‡<code>DiscoveryClient</code>æˆ‘ä»¬å¯ä»¥è·å–åˆ°æ‰€æœ‰åç§°ä¸º<code>server-provider</code>çš„æœåŠ¡å®ä¾‹ä¿¡æ¯ã€‚é€šè¿‡<code>LoadBalancerClient</code>æˆ‘ä»¬å¯ä»¥å®ç°è´Ÿè½½å‡è¡¡åœ°å»è·å–æœåŠ¡å®ä¾‹ï¼Œå¹¶é€šè¿‡<code>RestTemplate</code>å»è°ƒç”¨æœåŠ¡ã€‚</p><p>æ‰“åŒ…éƒ¨ç½²é¡¹ç›®ï¼Œç„¶åæŸ¥çœ‹consulæ§åˆ¶å°ï¼š</p><p><img src="img/QQæˆªå›¾20190328110004.png" alt="QQæˆªå›¾20190328110004.png"></p><p>è®¿é—®ï¼š<a href="http://192.168.140.215:9002/uri" target="_blank" rel="noopener">http://192.168.140.215:9002/uri</a>ï¼š</p><p><img src="img/QQæˆªå›¾20190328110116.png" alt="QQæˆªå›¾20190328110116.png"></p><p>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬æˆåŠŸè·å–åˆ°äº†æœåŠ¡åç§°ä¸º<code>server-provider</code>çš„ä¸¤ä¸ªå…·ä½“å®ä¾‹ã€‚</p><p>å¤šæ¬¡è°ƒç”¨<a href="http://192.168.140.215:9002/hello" target="_blank" rel="noopener">http://192.168.140.215:9002/hello</a>ï¼š</p><p><img src="img/QQæˆªå›¾20190328110243.png" alt="QQæˆªå›¾20190328110243.png"></p><p>æ§åˆ¶å°è¾“å‡ºå¦‚ä¸‹ï¼š</p><p><img src="img/QQæˆªå›¾20190328110406.png" alt="QQæˆªå›¾20190328110406.png"></p><p>æœåŠ¡è°ƒç”¨æ˜¯å‡è¡¡çš„ã€‚</p><p>é™¤æ­¤ä¹‹å¤–ï¼Œconsulå†…ç½®äº†Ribbonï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡<code>@LoadBalanced</code>æ ‡æ³¨çš„<code>RestTemplate</code>æ¥å®ç°è´Ÿè½½å‡è¡¡æœåŠ¡è°ƒç”¨ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SERVER_ID = <span class="string">"server-provider"</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@LoadBalanced</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RestTemplate <span class="title">restTemplate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> RestTemplate();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@GetMapping</span>(<span class="string">"hello"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    String url = <span class="string">"http://"</span> + SERVER_ID + <span class="string">"/hello"</span>;</span><br><span class="line">    <span class="keyword">return</span> restTemplate.getForObject(url, String.class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>æ•ˆæœæ˜¯ä¸€æ ·çš„ã€‚</p><h2 id="consulé›†ç¾¤"><a href="#consulé›†ç¾¤" class="headerlink" title="consulé›†ç¾¤"></a>consulé›†ç¾¤</h2><p>ä¸Šé¢æˆ‘ä»¬åªæ˜¯ä»¥<code>-dev</code>æ¨¡å¼å¼€å¯äº†ä¸€ä¸ªå•èŠ‚ç‚¹consul agentï¼Œç”Ÿäº§ç¯å¢ƒä¸‹éœ€è¦æ­å»ºconsulé›†ç¾¤æ¥ç¡®ä¿é«˜å¯ç”¨ã€‚</p><p>æ­å»ºconsulé›†ç¾¤æ—¶å¸¸ç”¨çš„å‘½ä»¤æœ‰:</p><table><thead><tr><th>å‘½ä»¤</th><th>è§£é‡Š</th><th>ç¤ºä¾‹</th></tr></thead><tbody><tr><td>agent</td><td>è¿è¡Œä¸€ä¸ªconsul agent</td><td>consul agent -dev</td></tr><tr><td>join</td><td>å°†agentåŠ å…¥åˆ°consulé›†ç¾¤</td><td>consul join IP</td></tr><tr><td>members</td><td>åˆ—å‡ºconsul clusteré›†ç¾¤ä¸­çš„members</td><td>consul members</td></tr><tr><td>leave</td><td>å°†èŠ‚ç‚¹ç§»é™¤æ‰€åœ¨é›†ç¾¤</td><td>consul leave</td></tr></tbody></table><p>å‡†å¤‡äº†ä¸‰å°LinuxæœåŠ¡å™¨ï¼Œé…ç½®å¦‚ä¸‹ï¼š</p><table><tbody><tr><th width="27px"><p>åºå·</p></th><th><p>èŠ‚ç‚¹ip</p></th><th><p>èŠ‚ç‚¹åç§°</p></th><th><p>è§’è‰²</p></th></tr><tr><td><p>1</p></td><td><p>192.168.140.215</p></td><td><p>consul-server-215</p></td><td><p>server</p></td></tr><tr><td><p>2</p></td><td><p>192.168.140.213</p></td><td><p>consul-server-213</p></td><td><p>server</p></td></tr><tr><td><p>3</p></td><td><p>192.168.140.216</p></td><td><p>consul-server-216</p></td><td><p>server &amp; web ui</p></td></tr></tbody></table><p>åœ¨è¿™ä¸‰å°æœåŠ¡å™¨ä¸Šä¸‹è½½å¹¶è§£å‹consulï¼Œç„¶ååœ¨è§£å‹çš„æ ¹ç›®å½•ä¸Šåˆ›å»ºä¸€ä¸ªdataç›®å½•ã€‚</p><p>ç”±äºæˆ‘ä»¬ä¹‹å‰å·²ç»åœ¨215ä¸Šå¯åŠ¨äº†consulï¼Œæ‰€ä»¥å…ˆæ‰§è¡Œ<code>killall consul</code>æ¥æ€æ‰è¿›ç¨‹ï¼Œç„¶åæ‰§è¡Œä¸‹é¢è¿™æ¡å‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nohup ./consul agent -server -<span class="built_in">bind</span> 192.168.140.215 -client=0.0.0.0 -bootstrap-expect=3 -data-dir=data -node=consul-server-215 &amp;</span><br></pre></td></tr></table></figure><p></p><p>è§£é‡Šä¸€ä¸‹ä¸Šé¢è¿™æ¡å‘½ä»¤çš„å«ä¹‰:</p><ul><li><p><code>-server</code>è¡¨ç¤ºä»¥æœåŠ¡çš„å½¢å¼å¯åŠ¨agent</p></li><li><p><code>-bind</code>è¡¨ç¤ºç»‘å®šåˆ°å½“å‰Linuxçš„ipï¼ˆæœ‰äº›æœåŠ¡å™¨ä¼šç»‘å®šå¤šå—ç½‘å¡ï¼Œå¯ä»¥é€šè¿‡bindå‚æ•°å¼ºåˆ¶æŒ‡å®šç»‘å®šçš„ipï¼‰</p></li><li><p><code>-client</code>æŒ‡å®šå®¢æˆ·ç«¯è®¿é—®çš„ipï¼ˆconsulæœ‰ä¸°å¯Œçš„apiæ¥å£ï¼Œè¿™é‡Œçš„å®¢æˆ·ç«¯æŒ‡æµè§ˆå™¨æˆ–è°ƒç”¨æ–¹ï¼‰ï¼Œ0.0.0.0è¡¨ç¤ºä¸é™å®¢æˆ·ç«¯ip</p></li><li><p><code>-bootstrap-expect=3</code>è¡¨ç¤ºserveré›†ç¾¤æœ€ä½èŠ‚ç‚¹æ•°ä¸º3ï¼Œä½äºè¿™ä¸ªå€¼å°†å·¥ä½œä¸æ­£å¸¸(æ³¨ï¼šç±»ä¼¼zookeeperä¸€æ ·ï¼Œé€šå¸¸é›†ç¾¤æ•°ä¸ºå¥‡æ•°ï¼Œæ–¹ä¾¿é€‰ä¸¾ï¼Œconsulé‡‡ç”¨çš„æ˜¯raftç®—æ³•)</p></li><li><p><code>-data-dir</code>è¡¨ç¤ºæŒ‡å®šæ•°æ®çš„å­˜æ”¾ç›®å½•ï¼ˆè¯¥ç›®å½•å¿…é¡»å­˜åœ¨ï¼‰</p></li><li><p><code>-node</code>è¡¨ç¤ºèŠ‚ç‚¹çš„åç§°</p></li></ul><p>æ¥ç€åœ¨213æœåŠ¡å™¨ä¸Šæ‰§è¡Œä¸‹é¢è¿™æ¡å‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nohup ./consul agent -server -<span class="built_in">bind</span> 192.168.140.213 -client=0.0.0.0 -bootstrap-expect=3 -data-dir=data -node=consul-server-213 &amp;</span><br></pre></td></tr></table></figure><p></p><p>æœ€ååœ¨216ä¸Šæ‰§è¡Œä¸‹é¢è¿™æ¡å‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nohup ./consul agent -server -<span class="built_in">bind</span> 192.168.140.216 -client=0.0.0.0 -bootstrap-expect=3 -data-dir=data -node=consul-server-216 -ui &amp;</span><br></pre></td></tr></table></figure><p></p><p>å’Œå‰ä¸¤æ¡å‘½ä»¤ç›¸æ¯”ï¼Œè¿™æ¡å‘½ä»¤å¤šäº†<code>-ui</code>é€‰é¡¹ï¼Œè¡¨ç¤ºå¼€å¯ç®¡ç†ç•Œé¢UIã€‚</p><p>ç„¶ååˆ†åˆ«åœ¨213å’Œ215ä¸‹æ‰§è¡Œä¸‹é¢è¿™æ¡å‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./consul join 192.168.140.216</span><br></pre></td></tr></table></figure><p></p><p>è¿™æ ·213å’Œ215æˆåŠŸåŠ å…¥åˆ°äº†216æ„æˆäº†ä¸€ä¸ªä¸‰èŠ‚ç‚¹é›†ç¾¤ï¼Œè¿è¡Œ<code>./consul members</code>æŸ¥çœ‹ï¼š</p><p><img src="img/QQæˆªå›¾20190328143323.png" alt="QQæˆªå›¾20190328143323.png"></p><p>è®¿é—®<a href="http://192.168.140.216:8500" target="_blank" rel="noopener">http://192.168.140.216:8500</a>ï¼š</p><p><img src="img/QQæˆªå›¾20190328143504.png" alt="QQæˆªå›¾20190328143504.png"></p><p>è®¿é—®<a href="http://192.168.140.215:9002/hello" target="_blank" rel="noopener">http://192.168.140.215:9002/hello</a>ï¼š</p><p><img src="img/QQæˆªå›¾20190328143922.png" alt="QQæˆªå›¾20190328143922.png"></p><p>è¿™æ—¶å€™åœ¨215æ‰§è¡Œ<code>killall consul</code>å‘½ä»¤ï¼Œæ€æ­»consulæœåŠ¡ï¼Œç„¶ååœ¨216ä¸Šæ‰§è¡Œ<code>./consul members</code>ï¼š</p><p><img src="img/QQæˆªå›¾20190328143837.png" alt="QQæˆªå›¾20190328143837.png"></p><p><img src="img/QQæˆªå›¾20190328144326.png" alt="QQæˆªå›¾20190328144326.png"></p><p>å¯ä»¥çœ‹åˆ°215èŠ‚ç‚¹å·²ç»æŒ‚äº†ï¼Œå†æ¬¡è®¿é—®<a href="http://192.168.140.215:9002/hello" target="_blank" rel="noopener">http://192.168.140.215:9002/hello</a>ï¼š</p><p><img src="img/QQæˆªå›¾20190328143922.png" alt="QQæˆªå›¾20190328143922.png"></p><p>æœåŠ¡ä¾æ—§è·å–æˆåŠŸã€‚</p><p>å¯è§ï¼Œè™½ç„¶æˆ‘ä»¬åœ¨application.ymlä¸­é…ç½®consulçš„åœ°å€æ˜¯192.168.140.215:8500ï¼Œä½†ç”±äºæˆ‘ä»¬æ„å»ºçš„æ˜¯consulé›†ç¾¤ï¼Œæ‰€ä»¥å¾®æœåŠ¡å¯åŠ¨æ—¶ä¼šè·å–åˆ°æ•´ä¸ªé›†ç¾¤ä¿¡æ¯ï¼Œå³ä½¿215è¿™ä¸ªèŠ‚ç‚¹æŒ‚äº†ï¼Œå¾®æœåŠ¡å¯ä»¥ä»åˆ«çš„consulèŠ‚ç‚¹ä¸Šè·å–æ³¨å†Œçš„æœåŠ¡ä¿¡æ¯ã€‚</p><p>å‚è€ƒæ–‡æ¡£ï¼š</p><ol><li><p><a href="https://learn.hashicorp.com/consul/getting-started/install.html" target="_blank" rel="noopener">https://learn.hashicorp.com/consul/getting-started/install.html</a></p></li><li><p><a href="https://cloud.spring.io/spring-cloud-consul/spring-cloud-consul.html#spring-cloud-consul-hystrix" target="_blank" rel="noopener">https://cloud.spring.io/spring-cloud-consul/spring-cloud-consul.html#spring-cloud-consul-hystrix</a></p></li></ol><blockquote><p>æºç é“¾æ¥ï¼š<a href="https://github.com/wuyouzhuguli/SpringAll/tree/master/55.Spring-Cloud-Consul" target="_blank" rel="noopener">https://github.com/wuyouzhuguli/SpringAll/tree/master/55.Spring-Cloud-Consul</a></p></blockquote><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Wed May 15 2019 17:13:44 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;Consulæ˜¯ä¸€æ¬¾ç”±&lt;a href=&quot;https://www.hashicorp.com/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;HashiCorp&lt;/a&gt;å…¬å¸å¼€æºçš„ï¼Œç”¨äºæœåŠ¡æ²»ç†çš„è½¯ä»¶ï¼Œ&lt;a href=&quot;https://spring.io/projects/spring-cloud-consul&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Spring Cloud Consul&lt;/a&gt;å¯¹å…¶è¿›è¡Œäº†å°è£…ã€‚Consulå…·æœ‰å¦‚ä¸‹ç‰¹ç‚¹:&lt;/p&gt;&lt;ol&gt;&lt;li&gt;&lt;p&gt;æœåŠ¡æ³¨å†Œ - è‡ªåŠ¨æ³¨å†Œå’Œå–æ¶ˆæ³¨å†ŒæœåŠ¡å®ä¾‹çš„ç½‘ç»œä½ç½®&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;è¿è¡ŒçŠ¶å†µæ£€æŸ¥ - æ£€æµ‹æœåŠ¡å®ä¾‹ä½•æ—¶å¯åŠ¨å¹¶è¿è¡Œ&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;åˆ†å¸ƒå¼é…ç½® - ç¡®ä¿æ‰€æœ‰æœåŠ¡å®ä¾‹ä½¿ç”¨ç›¸åŒçš„é…ç½®&lt;/p&gt;&lt;/li&gt;&lt;/ol&gt;
    
    </summary>
    
    
      <category term="Spring Cloud" scheme="http://mrbird.cc/tags/Spring-Cloud/"/>
    
      <category term="Consul" scheme="http://mrbird.cc/tags/Consul/"/>
    
  </entry>
  
  <entry>
    <title>Spring Bootæ•´åˆKafka</title>
    <link href="http://mrbird.cc/Spring-Boot-Kafka.html"/>
    <id>http://mrbird.cc/Spring-Boot-Kafka.html</id>
    <published>2018-11-21T08:26:17.000Z</published>
    <updated>2019-03-27T02:20:01.126Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Wed May 15 2019 17:13:45 GMT+0800 (GMT+08:00) --><p>Kafkaæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼çš„ã€å¯åˆ†åŒºçš„ã€å¯å¤åˆ¶çš„æ¶ˆæ¯ç³»ç»Ÿï¼Œä¸‹é¢æ˜¯Kafkaçš„å‡ ä¸ªåŸºæœ¬æœ¯è¯­ï¼š</p><ol><li><p>Kafkaå°†æ¶ˆæ¯ä»¥<strong>topic</strong>ä¸ºå•ä½è¿›è¡Œå½’çº³ï¼›</p></li><li><p>å°†å‘Kafka topicå‘å¸ƒæ¶ˆæ¯çš„ç¨‹åºæˆä¸º<strong>producers</strong>ï¼›</p></li><li><p>å°†é¢„è®¢topicså¹¶æ¶ˆè´¹æ¶ˆæ¯çš„ç¨‹åºæˆä¸º<strong>consumer</strong>ï¼›</p></li><li><p>Kafkaä»¥é›†ç¾¤çš„æ–¹å¼è¿è¡Œï¼Œå¯ä»¥ç”±ä¸€ä¸ªæˆ–å¤šä¸ªæœåŠ¡ç»„æˆï¼Œæ¯ä¸ªæœåŠ¡å«åšä¸€ä¸ª<strong>broker</strong>ã€‚</p></li></ol><a id="more"></a><p>producersé€šè¿‡ç½‘ç»œå°†æ¶ˆæ¯å‘é€åˆ°Kafkaé›†ç¾¤ï¼Œé›†ç¾¤å‘æ¶ˆè´¹è€…æä¾›æ¶ˆæ¯ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="img/140721072031172.png" alt="140721072031172.png"></p><p>åˆ›å»ºä¸€ä¸ªtopicæ—¶ï¼Œå¯ä»¥æŒ‡å®š<strong>partitions</strong>ï¼ˆåˆ†åŒºï¼‰æ•°ç›®ï¼Œpartitionsæ•°è¶Šå¤šï¼Œå…¶ååé‡ä¹Ÿè¶Šå¤§ï¼Œä½†æ˜¯éœ€è¦çš„èµ„æºä¹Ÿè¶Šå¤šï¼ŒåŒæ—¶ä¹Ÿä¼šå¯¼è‡´æ›´é«˜çš„ä¸å¯ç”¨æ€§ï¼Œkafkaåœ¨æ¥æ”¶åˆ°producerså‘é€çš„æ¶ˆæ¯ä¹‹åï¼Œä¼šæ ¹æ®å‡è¡¡ç­–ç•¥å°†æ¶ˆæ¯å­˜å‚¨åˆ°ä¸åŒçš„partitionsä¸­ï¼š</p><p><img src="img/log_anatomy.png" alt="log_anatomy.png"></p><p>åœ¨æ¯ä¸ªpartitionsä¸­ï¼Œæ¶ˆæ¯ä»¥é¡ºåºå­˜å‚¨ï¼Œæœ€æ™šæ¥æ”¶çš„çš„æ¶ˆæ¯ä¼šæœ€åè¢«æ¶ˆè´¹ã€‚</p><p>producersåœ¨å‘kafkaé›†ç¾¤å‘é€æ¶ˆæ¯çš„æ—¶å€™ï¼Œå¯ä»¥é€šè¿‡æŒ‡å®špartitionsæ¥å‘é€åˆ°æŒ‡å®šçš„partitionsä¸­ã€‚ä¹Ÿå¯ä»¥é€šè¿‡æŒ‡å®šå‡è¡¡ç­–ç•¥æ¥å°†æ¶ˆæ¯å‘é€åˆ°ä¸åŒçš„partitionsä¸­ã€‚å¦‚æœä¸æŒ‡å®šï¼Œå°±ä¼šé‡‡ç”¨é»˜è®¤çš„éšæœºå‡è¡¡ç­–ç•¥ï¼Œå°†æ¶ˆæ¯éšæœºçš„å­˜å‚¨åˆ°ä¸åŒçš„partitionsä¸­ã€‚</p><p>åœ¨consumeræ¶ˆè´¹æ¶ˆæ¯æ—¶ï¼Œkafkaä½¿ç”¨offsetæ¥è®°å½•å½“å‰æ¶ˆè´¹çš„ä½ç½®ï¼š</p><p><img src="img/log_consumer.png" style="width:25rem"></p><p>åœ¨kafkaçš„è®¾è®¡ä¸­ï¼Œå¯ä»¥æœ‰å¤šä¸ªä¸åŒçš„groupæ¥åŒæ—¶æ¶ˆè´¹åŒä¸€ä¸ªtopicä¸‹çš„æ¶ˆæ¯ï¼Œå¦‚å›¾ï¼Œæˆ‘ä»¬æœ‰ä¸¤ä¸ªä¸åŒçš„groupåŒæ—¶æ¶ˆè´¹ï¼Œä»–ä»¬çš„çš„æ¶ˆè´¹çš„è®°å½•ä½ç½®offsetå„ä¸é¡¹ç›®ï¼Œä¸äº’ç›¸å¹²æ‰°ã€‚</p><p>å¯¹äºä¸€ä¸ªgroupè€Œè¨€ï¼Œconsumerçš„æ•°é‡ä¸åº”è¯¥å¤šäºpartitionsçš„æ•°é‡ï¼Œå› ä¸ºåœ¨ä¸€ä¸ªgroupä¸­ï¼Œæ¯ä¸ªpartitionsè‡³å¤šåªèƒ½ç»‘å®šåˆ°ä¸€ä¸ªconsumerä¸Šï¼Œå³ä¸€ä¸ªconsumerå¯ä»¥æ¶ˆè´¹å¤šä¸ªpartitionsï¼Œä¸€ä¸ªpartitionsåªèƒ½ç»™ä¸€ä¸ªconsumeræ¶ˆè´¹ã€‚å› æ­¤ï¼Œè‹¥ä¸€ä¸ªgroupä¸­çš„consumeræ•°é‡å¤§äºpartitionsæ•°é‡çš„è¯ï¼Œå¤šä½™çš„consumerå°†ä¸ä¼šæ”¶åˆ°ä»»ä½•æ¶ˆæ¯ã€‚</p><p><img src="img/consumer-groups.png" style="width:25rem"></p><h2 id="Kafkaå®‰è£…ä½¿ç”¨"><a href="#Kafkaå®‰è£…ä½¿ç”¨" class="headerlink" title="Kafkaå®‰è£…ä½¿ç”¨"></a>Kafkaå®‰è£…ä½¿ç”¨</h2><p>è¿™é‡Œæ¼”ç¤ºåœ¨Windowsä¸‹Kafkaå®‰è£…ä¸ä½¿ç”¨ã€‚Kafkaä¸‹è½½åœ°å€ï¼š<a href="http://kafka.apache.org/downloads" target="_blank" rel="noopener">http://kafka.apache.org/downloads</a>ï¼Œé€‰æ‹©äºŒè¿›åˆ¶æ–‡ä»¶ä¸‹è½½ï¼ˆBinary downloadsï¼‰ï¼Œç„¶åè§£å‹å³å¯ã€‚</p><p>Kafkaçš„é…ç½®æ–‡ä»¶ä½äºconfigç›®å½•ä¸‹ï¼Œå› ä¸ºKafkaé›†æˆäº†Zookeeperï¼ˆKafkaå­˜å‚¨æ¶ˆæ¯çš„åœ°æ–¹ï¼‰ï¼Œæ‰€ä»¥configç›®å½•ä¸‹é™¤äº†æœ‰Kafkaçš„é…ç½®æ–‡ä»¶server.propertieså¤–ï¼Œè¿˜å¯ä»¥çœ‹åˆ°ä¸€ä¸ªZookeeperé…ç½®æ–‡ä»¶zookeeper.propertiesï¼š</p><p><img src="img/QQæˆªå›¾20190326103520.png" alt="QQæˆªå›¾20190326103520.png"></p><p>æ‰“å¼€server.propertiesï¼Œå°†<code>broker.id</code>çš„å€¼ä¿®æ”¹ä¸º1ï¼Œæ¯ä¸ªbrokerçš„idéƒ½å¿…é¡»è®¾ç½®ä¸ºIntegerç±»å‹ï¼Œä¸”ä¸èƒ½é‡å¤ã€‚Zookeeperçš„é…ç½®ä¿æŒé»˜è®¤å³å¯ã€‚</p><p>æ¥ä¸‹æ¥å¼€å§‹ä½¿ç”¨Kafkaã€‚</p><h3 id="å¯åŠ¨Zookeeper"><a href="#å¯åŠ¨Zookeeper" class="headerlink" title="å¯åŠ¨Zookeeper"></a>å¯åŠ¨Zookeeper</h3><p>åœ¨Windowsä¸‹æ‰§è¡Œä¸‹é¢è¿™äº›å‘½ä»¤å¯èƒ½ä¼šå‡ºç°<span style="color:red">æ‰¾ä¸åˆ°æˆ–æ— æ³•åŠ è½½ä¸»ç±»</span>çš„é—®é¢˜ï¼Œè§£å†³æ–¹æ¡ˆå¯å‚è€ƒï¼š<a href="https://blog.csdn.net/cx2932350/article/details/78870135" target="_blank" rel="noopener">https://blog.csdn.net/cx2932350/article/details/78870135</a>ã€‚</p><p>åœ¨Kafkaæ ¹ç›®å½•ä¸‹ä½¿ç”¨cmdæ‰§è¡Œä¸‹é¢è¿™æ¡å‘½ä»¤ï¼Œå¯åŠ¨ZKï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin\windows\zookeeper-server-start.bat config\zookeeper.properties</span><br></pre></td></tr></table></figure><p></p><p>åœ¨Linuxä¸‹ï¼Œå¯ä»¥ä½¿ç”¨åå°è¿›ç¨‹çš„æ–¹å¼å¯åŠ¨ZKï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/zookeeper-server-start.sh -daemon config/zookeeper.properties</span><br></pre></td></tr></table></figure><p></p><h3 id="å¯åŠ¨Kafka"><a href="#å¯åŠ¨Kafka" class="headerlink" title="å¯åŠ¨Kafka"></a>å¯åŠ¨Kafka</h3><p>æ‰§è¡Œä¸‹é¢è¿™æ¡å‘½ä»¤å¯åŠ¨Kafkaï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin\windows\kafka-server-start.bat config\server.properties</span><br></pre></td></tr></table></figure><p></p><p>Linuxå¯¹åº”å‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/kafka-server-start.sh config/server.properties</span><br></pre></td></tr></table></figure><p></p><p>å½“çœ‹åˆ°å‘½ä»¤è¡Œæ‰“å°å¦‚ä¸‹ä¿¡æ¯ï¼Œè¯´æ˜å¯åŠ¨å®Œæ¯•:</p><p><img src="img/QQæˆªå›¾20190326110506.png" alt="QQæˆªå›¾20190326110506.png"></p><h3 id="åˆ›å»ºTopic"><a href="#åˆ›å»ºTopic" class="headerlink" title="åˆ›å»ºTopic"></a>åˆ›å»ºTopic</h3><p>æ‰§è¡Œä¸‹é¢è¿™æ¡å‘½ä»¤åˆ›å»ºä¸€ä¸ªTopic</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin\windows\kafka-topics.bat --create --zookeeper localhost:2181 --replication-factor 1 --partitions 1 --topic <span class="built_in">test</span></span><br></pre></td></tr></table></figure><p></p><p>è¿™æ¡å‘½ä»¤çš„æ„æ€æ˜¯ï¼Œåˆ›å»ºä¸€ä¸ªTopicåˆ°ZKï¼ˆæŒ‡å®šZKçš„åœ°å€ï¼‰ï¼Œå‰¯æœ¬ä¸ªæ•°ä¸º1ï¼Œåˆ†åŒºæ•°ä¸º1ï¼ŒTopicçš„åç§°ä¸ºtestã€‚</p><p>Linuxå¯¹åº”çš„å‘½ä»¤ä¸º:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/kafka-topics.sh --create --zookeeper localhost:2181 --replication-factor 1 --partitions 1 --topic <span class="built_in">test</span></span><br></pre></td></tr></table></figure><p></p><p>åˆ›å»ºå¥½åæˆ‘ä»¬å¯ä»¥æŸ¥çœ‹Kafkaé‡Œçš„Topicåˆ—è¡¨ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin\windows\kafka-topics.bat --list --zookeeper localhost:2181</span><br></pre></td></tr></table></figure><p></p><p><img src="img/QQæˆªå›¾20190326111559.png" alt="QQæˆªå›¾20190326111559.png"></p><p>å¯çœ‹åˆ°ç›®å‰åªåŒ…å«ä¸€ä¸ªæˆ‘ä»¬åˆšåˆ›å»ºçš„test Topicã€‚</p><p>Linuxå¯¹åº”çš„å‘½ä»¤ä¸ºï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/kafka-topics.sh --list --zookeeper localhost:2181</span><br></pre></td></tr></table></figure><p></p><p>æŸ¥çœ‹test Topicçš„å…·ä½“ä¿¡æ¯ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin\windows\kafka-topics.bat --describe --zookeeper localhost:2181 --topic <span class="built_in">test</span></span><br></pre></td></tr></table></figure><p></p><p><img src="img/QQæˆªå›¾20190326111928.png" alt="QQæˆªå›¾20190326111928.png"></p><p>Linuxå¯¹åº”çš„å‘½ä»¤ä¸ºï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/kafka-topics.sh --describe --zookeeper localhost:2181 --topic <span class="built_in">test</span></span><br></pre></td></tr></table></figure><p></p><h3 id="ç”Ÿäº§æ¶ˆæ¯å’Œæ¶ˆè´¹æ¶ˆæ¯"><a href="#ç”Ÿäº§æ¶ˆæ¯å’Œæ¶ˆè´¹æ¶ˆæ¯" class="headerlink" title="ç”Ÿäº§æ¶ˆæ¯å’Œæ¶ˆè´¹æ¶ˆæ¯"></a>ç”Ÿäº§æ¶ˆæ¯å’Œæ¶ˆè´¹æ¶ˆæ¯</h3><p><strong>å¯åŠ¨Producers</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin\windows\kafka-console-producer.bat --broker-list localhost:9092 --topic <span class="built_in">test</span></span><br></pre></td></tr></table></figure><p></p><p>9092ä¸ºç”Ÿäº§è€…çš„é»˜è®¤ç«¯å£å·ã€‚è¿™é‡Œå¯åŠ¨äº†ç”Ÿäº§è€…ï¼Œå‡†å¤‡å¾€test Topicé‡Œå‘é€æ•°æ®ã€‚</p><p>Linuxä¸‹å¯¹åº”çš„å‘½ä»¤ä¸ºï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/kafka-console-producer.sh --broker-list localhost:9092 --topic <span class="built_in">test</span></span><br></pre></td></tr></table></figure><p></p><p><strong>å¯åŠ¨Consumers</strong></p><p>æ¥ç€å¯åŠ¨ä¸€ä¸ªæ¶ˆè´¹è€…ç”¨äºæ¶ˆè´¹ç”Ÿäº§è€…ç”Ÿäº§çš„æ•°æ®ï¼Œæ–°å»ºä¸€ä¸ªcmdçª—å£ï¼Œè¾“å…¥ä¸‹é¢è¿™æ¡å‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin\windows\kafka-console-consumer.bat --bootstrap-server localhost:9092 --topic <span class="built_in">test</span> --from-beginning</span><br></pre></td></tr></table></figure><p></p><p><code>from-beginning</code>è¡¨ç¤ºä»å¤´å¼€å§‹è¯»å–æ•°æ®ã€‚</p><p>Linuxä¸‹å¯¹åº”çš„å‘½ä»¤ä¸ºï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic <span class="built_in">test</span> --from-beginning</span><br></pre></td></tr></table></figure><p></p><p>å¯åŠ¨å¥½ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…åæˆ‘ä»¬åœ¨ç”Ÿäº§è€…é‡Œç”Ÿäº§å‡ æ¡æ•°æ®:</p><p><img src="img/QQæˆªå›¾20190326113911.png" alt="QQæˆªå›¾20190326113911.png"></p><p>æ¶ˆè´¹è€…æˆåŠŸæ¥æ”¶åˆ°æ•°æ®ï¼š</p><p><img src="img/QQæˆªå›¾20190326113950.png" alt="QQæˆªå›¾20190326113950.png"></p><h2 id="Spring-Bootæ•´åˆKafaka"><a href="#Spring-Bootæ•´åˆKafaka" class="headerlink" title="Spring Bootæ•´åˆKafaka"></a>Spring Bootæ•´åˆKafaka</h2><p>ä¸Šé¢ç®€å•ä»‹ç»äº†Kafkaçš„ä½¿ç”¨ï¼Œä¸‹é¢æˆ‘ä»¬å¼€å§‹åœ¨Spring Booté‡Œä½¿ç”¨Kafkaã€‚</p><p>æ–°å»ºä¸€ä¸ªSpring Booté¡¹ç›®ï¼Œç‰ˆæœ¬ä¸º2.1.3.RELEASEï¼Œå¹¶å¼•å…¥å¦‚ä¸‹ä¾èµ–:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.kafka<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-kafka<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p></p><h3 id="ç”Ÿäº§è€…é…ç½®"><a href="#ç”Ÿäº§è€…é…ç½®" class="headerlink" title="ç”Ÿäº§è€…é…ç½®"></a>ç”Ÿäº§è€…é…ç½®</h3><p>æ–°å»ºä¸€ä¸ªJavaé…ç½®ç±»<code>KafkaProducerConfig</code>ï¼Œç”¨äºé…ç½®ç”Ÿäº§è€…ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">KafkaProducerConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;spring.kafka.bootstrap-servers&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String bootstrapServers;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ProducerFactory&lt;String, String&gt; <span class="title">producerFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Map&lt;String, Object&gt; configProps = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        configProps.put(</span><br><span class="line">                ProducerConfig.BOOTSTRAP_SERVERS_CONFIG,</span><br><span class="line">                bootstrapServers);</span><br><span class="line">        configProps.put(</span><br><span class="line">                ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG,</span><br><span class="line">                StringSerializer.class);</span><br><span class="line">        configProps.put(</span><br><span class="line">                ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG,</span><br><span class="line">                StringSerializer.class);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DefaultKafkaProducerFactory&lt;&gt;(configProps);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> KafkaTemplate&lt;String, String&gt; <span class="title">kafkaTemplate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> KafkaTemplate&lt;&gt;(producerFactory());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>é¦–å…ˆæˆ‘ä»¬é…ç½®äº†ä¸€ä¸ª<code>producerFactory</code>ï¼Œæ–¹æ³•é‡Œé…ç½®äº†Kafka Producerå®ä¾‹çš„ç­–ç•¥ã€‚<code>bootstrapServers</code>ä¸ºKafkaç”Ÿäº§è€…çš„åœ°å€ï¼Œæˆ‘ä»¬åœ¨é…ç½®æ–‡ä»¶application.ymlé‡Œé…ç½®å®ƒï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  kafka:</span></span><br><span class="line"><span class="attr">    bootstrap-servers:</span> <span class="attr">localhost:9092</span></span><br></pre></td></tr></table></figure><p></p><p><code>ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG</code>å’Œ<code>ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG</code>æŒ‡å®šäº†keyï¼Œvalueåºåˆ—åŒ–ç­–ç•¥ï¼Œè¿™é‡ŒæŒ‡å®šä¸ºKafkaæä¾›çš„<code>StringSerializer</code>ï¼Œå› ä¸ºæˆ‘ä»¬æš‚æ—¶åªå‘é€ç®€å•çš„Stringç±»å‹çš„æ¶ˆæ¯ã€‚</p><p>æ¥ç€æˆ‘ä»¬ä½¿ç”¨<code>producerFactory</code>é…ç½®äº†<code>kafkaTemplate</code>ï¼Œå…¶åŒ…å«äº†å‘é€æ¶ˆæ¯çš„ä¾¿æ·æ–¹æ³•ï¼Œåé¢æˆ‘ä»¬å°±ç”¨è¿™ä¸ªå¯¹è±¡æ¥å‘é€æ¶ˆæ¯ã€‚</p><h3 id="å‘å¸ƒæ¶ˆæ¯"><a href="#å‘å¸ƒæ¶ˆæ¯" class="headerlink" title="å‘å¸ƒæ¶ˆæ¯"></a>å‘å¸ƒæ¶ˆæ¯</h3><p>é…ç½®å¥½ç”Ÿäº§è€…ï¼Œæˆ‘ä»¬å°±å¯ä»¥å¼€å§‹å‘å¸ƒæ¶ˆæ¯äº†ã€‚</p><p>æ–°å»ºä¸€ä¸ª<code>SendMessageController</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SendMessageController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> KafkaTemplate&lt;String, String&gt; kafkaTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"send/&#123;message&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">send</span><span class="params">(@PathVariable String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.kafkaTemplate.send(<span class="string">"test"</span>, message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>æˆ‘ä»¬æ³¨å…¥äº†<code>kafkaTemplate</code>å¯¹è±¡ï¼Œkey-valueéƒ½ä¸ºStringç±»å‹ï¼Œå¹¶é€šè¿‡å®ƒçš„<code>send</code>æ–¹æ³•æ¥å‘é€æ¶ˆæ¯ã€‚å…¶ä¸­<code>test</code>ä¸ºTopicçš„åç§°ï¼Œä¸Šé¢æˆ‘ä»¬å·²ç»ä½¿ç”¨å‘½ä»¤åˆ›å»ºè¿‡è¿™ä¸ªTopicäº†ã€‚</p><p><code>send</code>æ–¹æ³•æ˜¯ä¸€ä¸ªå¼‚æ­¥æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å›è°ƒçš„æ–¹å¼æ¥ç¡®å®šæ¶ˆæ¯æ˜¯å¦å‘é€æˆåŠŸï¼Œæˆ‘ä»¬æ”¹é€ <code>SendMessageController</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SendMessageController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Logger logger = LoggerFactory.getLogger(<span class="keyword">this</span>.getClass());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> KafkaTemplate&lt;String, String&gt; kafkaTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"send/&#123;message&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">send</span><span class="params">(@PathVariable String message)</span> </span>&#123;</span><br><span class="line">        ListenableFuture&lt;SendResult&lt;String, String&gt;&gt; future = <span class="keyword">this</span>.kafkaTemplate.send(<span class="string">"test"</span>, message);</span><br><span class="line">        future.addCallback(<span class="keyword">new</span> ListenableFutureCallback&lt;SendResult&lt;String, String&gt;&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSuccess</span><span class="params">(SendResult&lt;String, String&gt; result)</span> </span>&#123;</span><br><span class="line">                logger.info(<span class="string">"æˆåŠŸå‘é€æ¶ˆæ¯ï¼š&#123;&#125;ï¼Œoffset=[&#123;&#125;]"</span>, message, result.getRecordMetadata().offset());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(Throwable ex)</span> </span>&#123;</span><br><span class="line">                logger.error(<span class="string">"æ¶ˆæ¯ï¼š&#123;&#125; å‘é€å¤±è´¥ï¼ŒåŸå› ï¼š&#123;&#125;"</span>, message, ex.getMessage());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>æ¶ˆæ¯å‘é€æˆåŠŸåï¼Œä¼šå›è°ƒ<code>onSuccess</code>æ–¹æ³•ï¼Œå‘é€å¤±è´¥åå›è°ƒ<code>onFailure</code>æ–¹æ³•ã€‚</p><h3 id="æ¶ˆè´¹è€…é…ç½®"><a href="#æ¶ˆè´¹è€…é…ç½®" class="headerlink" title="æ¶ˆè´¹è€…é…ç½®"></a>æ¶ˆè´¹è€…é…ç½®</h3><p>æ¥ç€æˆ‘ä»¬æ¥é…ç½®æ¶ˆè´¹è€…ï¼Œæ–°å»ºä¸€ä¸ªJavaé…ç½®ç±»<code>KafkaConsumerConfig</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableKafka</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">KafkaConsumerConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;spring.kafka.bootstrap-servers&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String bootstrapServers;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;spring.kafka.consumer.group-id&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String consumerGroupId;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;spring.kafka.consumer.auto-offset-reset&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String autoOffsetReset;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ConsumerFactory&lt;String, String&gt; <span class="title">consumerFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Map&lt;String, Object&gt; props = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        props.put(</span><br><span class="line">                ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG,</span><br><span class="line">                bootstrapServers);</span><br><span class="line">        props.put(</span><br><span class="line">                ConsumerConfig.GROUP_ID_CONFIG,</span><br><span class="line">                consumerGroupId);</span><br><span class="line">        props.put(</span><br><span class="line">                ConsumerConfig.AUTO_OFFSET_RESET_CONFIG,</span><br><span class="line">                autoOffsetReset);</span><br><span class="line">        props.put(</span><br><span class="line">                ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG,</span><br><span class="line">                StringDeserializer.class);</span><br><span class="line">        props.put(</span><br><span class="line">                ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG,</span><br><span class="line">                StringDeserializer.class);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DefaultKafkaConsumerFactory&lt;&gt;(props);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ConcurrentKafkaListenerContainerFactory&lt;String, String&gt; <span class="title">kafkaListenerContainerFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ConcurrentKafkaListenerContainerFactory&lt;String, String&gt; factory</span><br><span class="line">                = <span class="keyword">new</span> ConcurrentKafkaListenerContainerFactory&lt;&gt;();</span><br><span class="line">        factory.setConsumerFactory(consumerFactory());</span><br><span class="line">        <span class="keyword">return</span> factory;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p><code>consumerGroupId</code>å’Œ<code>autoOffsetReset</code>éœ€è¦åœ¨application.ymlé‡Œé…ç½®ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  kafka:</span></span><br><span class="line"><span class="attr">    consumer:</span></span><br><span class="line"><span class="attr">      group-id:</span> <span class="string">test-consumer</span></span><br><span class="line"><span class="attr">      auto-offset-reset:</span> <span class="string">latest</span></span><br></pre></td></tr></table></figure><p></p><p>å…¶ä¸­<code>group-id</code>å°†æ¶ˆè´¹è€…è¿›è¡Œåˆ†ç»„ï¼ˆä½ ä¹Ÿå¯ä»¥ä¸è¿›è¡Œåˆ†ç»„ï¼‰ï¼Œç»„åä¸º<code>test-consumer</code>ï¼Œå¹¶æŒ‡å®šäº†æ¶ˆæ¯è¯»å–ç­–ç•¥ï¼ŒåŒ…å«å››ä¸ªå¯é€‰å€¼ï¼š</p><p><img src="img/QQæˆªå›¾20190326154735.png" alt="QQæˆªå›¾20190326154735.png"></p><ul><li><p>earliest:å½“å„åˆ†åŒºä¸‹æœ‰å·²æäº¤çš„offsetæ—¶ï¼Œä»æäº¤çš„offsetå¼€å§‹æ¶ˆè´¹ï¼›æ— æäº¤çš„offsetæ—¶ï¼Œä»å¤´å¼€å§‹æ¶ˆè´¹</p></li><li><p>latest:å½“å„åˆ†åŒºä¸‹æœ‰å·²æäº¤çš„offsetæ—¶ï¼Œä»æäº¤çš„offsetå¼€å§‹æ¶ˆè´¹ï¼›æ— æäº¤çš„offsetæ—¶ï¼Œæ¶ˆè´¹æ–°äº§ç”Ÿçš„è¯¥åˆ†åŒºä¸‹çš„æ•°æ®</p></li><li><p>none:topicå„åˆ†åŒºéƒ½å­˜åœ¨å·²æäº¤çš„offsetæ—¶ï¼Œä»offsetåå¼€å§‹æ¶ˆè´¹ï¼›åªè¦æœ‰ä¸€ä¸ªåˆ†åŒºä¸å­˜åœ¨å·²æäº¤çš„offsetï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸</p></li><li><p>exception:ç›´æ¥æŠ›å‡ºå¼‚å¸¸</p></li></ul><p>åœ¨<code>KafkaConsumerConfig</code>ä¸­æˆ‘ä»¬é…ç½®äº†<code>ConsumerFactory</code>å’Œ<code>KafkaListenerContainerFactory</code>ã€‚å½“è¿™ä¸¤ä¸ªBeanæˆåŠŸæ³¨å†Œåˆ°Spring IOCå®¹å™¨ä¸­åï¼Œæˆ‘ä»¬ä¾¿å¯ä»¥ä½¿ç”¨<code>@KafkaListener</code>æ³¨è§£æ¥ç›‘å¬æ¶ˆæ¯äº†ã€‚</p><p>é…ç½®ç±»ä¸Šéœ€è¦<code>@EnableKafka</code>æ³¨é‡Šæ‰èƒ½åœ¨Springæ‰˜ç®¡Beanä¸Šæ£€æµ‹<code>@KafkaListener</code>æ³¨è§£ã€‚</p><h3 id="æ¶ˆæ¯æ¶ˆè´¹"><a href="#æ¶ˆæ¯æ¶ˆè´¹" class="headerlink" title="æ¶ˆæ¯æ¶ˆè´¹"></a>æ¶ˆæ¯æ¶ˆè´¹</h3><p>é…ç½®å¥½æ¶ˆè´¹è€…ï¼Œæˆ‘ä»¬å°±å¯ä»¥å¼€å§‹æ¶ˆè´¹æ¶ˆæ¯äº†ï¼Œæ–°å»º<code>KafkaMessageListener</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">KafkaMessageListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Logger logger = LoggerFactory.getLogger(<span class="keyword">this</span>.getClass());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@KafkaListener</span>(topics = <span class="string">"test"</span>, groupId = <span class="string">"test-consumer"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">listen</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"æ¥æ”¶æ¶ˆæ¯: &#123;&#125;"</span>, message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>æˆ‘ä»¬é€šè¿‡<code>@KafkaListener</code>æ³¨è§£æ¥ç›‘å¬åç§°ä¸ºtestçš„Topicï¼Œæ¶ˆè´¹è€…åˆ†ç»„çš„ç»„åä¸º<code>test-consumer</code>ã€‚</p><h3 id="æ¼”ç¤º"><a href="#æ¼”ç¤º" class="headerlink" title="æ¼”ç¤º"></a>æ¼”ç¤º</h3><p>å¯åŠ¨Spring Booté¡¹ç›®ï¼Œå¯åŠ¨è¿‡ç¨‹ä¸­ï¼Œæ§åˆ¶å°ä¼šè¾“å‡ºKafkaçš„é…ç½®ï¼Œå¯åŠ¨å¥½åï¼Œè®¿é—®<a href="http://localhost:8080/send/hello,mrbird" target="_blank" rel="noopener">http://localhost:8080/send/hello,mrbird</a>ï¼Œæ§åˆ¶å°è¾“å‡ºå¦‚ä¸‹ï¼š</p><p><img src="img/QQæˆªå›¾20190326155948.png" alt="QQæˆªå›¾20190326155948.png"></p><h3 id="KafkaListenerè¯¦è§£"><a href="#KafkaListenerè¯¦è§£" class="headerlink" title="@KafkaListenerè¯¦è§£"></a>@KafkaListenerè¯¦è§£</h3><p><code>@KafkaListener</code>é™¤äº†å¯ä»¥æŒ‡å®šTopicåç§°å’Œåˆ†ç»„idå¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥åŒæ—¶ç›‘å¬æ¥è‡ªå¤šä¸ªTopicçš„æ¶ˆæ¯:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@KafkaListener</span>(topics = <span class="string">"topic1, topic2"</span>)</span><br></pre></td></tr></table></figure><p></p><p>æˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡<code>@Header</code>æ³¨è§£æ¥è·å–å½“å‰æ¶ˆæ¯æ¥è‡ªå“ªä¸ªåˆ†åŒºï¼ˆpartitionsï¼‰:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@KafkaListener</span>(topics = <span class="string">"test"</span>, groupId = <span class="string">"test-consumer"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">listen</span><span class="params">(@Payload String message,</span></span></span><br><span class="line"><span class="function"><span class="params">                   @Header(KafkaHeaders.RECEIVED_PARTITION_ID)</span> <span class="keyword">int</span> partition) </span>&#123;</span><br><span class="line">    logger.info(<span class="string">"æ¥æ”¶æ¶ˆæ¯: &#123;&#125;ï¼Œpartitionï¼š&#123;&#125;"</span>, message, partition);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>é‡å¯é¡¹ç›®ï¼Œå†æ¬¡è®¿é—®<a href="http://localhost:8080/send/hello,mrbird" target="_blank" rel="noopener">http://localhost:8080/send/hello,mrbird</a>ï¼Œæ§åˆ¶å°è¾“å‡ºå¦‚ä¸‹ï¼š</p><p><img src="img/QQå›¾ç‰‡20190326162014.png" alt="QQå›¾ç‰‡20190326162014.png"></p><p>å› ä¸ºæˆ‘ä»¬æ²¡æœ‰è¿›è¡Œåˆ†åŒºï¼Œæ‰€ä»¥test Topicåªæœ‰ä¸€ä¸ªåŒºï¼Œä¸‹æ ‡ä¸º0ã€‚</p><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡<code>@KafkaListener</code>æ¥æŒ‡å®šåªæ¥æ”¶æ¥è‡ªç‰¹å®šåˆ†åŒºçš„æ¶ˆæ¯ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@KafkaListener</span>(groupId = <span class="string">"test-consumer"</span>,</span><br><span class="line">        topicPartitions = <span class="meta">@TopicPartition</span>(topic = <span class="string">"test"</span>,</span><br><span class="line">                partitionOffsets = &#123;</span><br><span class="line">                        <span class="meta">@PartitionOffset</span>(partition = <span class="string">"0"</span>, initialOffset = <span class="string">"0"</span>)</span><br><span class="line">            &#125;))</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">listen</span><span class="params">(@Payload String message,</span></span></span><br><span class="line"><span class="function"><span class="params">                   @Header(KafkaHeaders.RECEIVED_PARTITION_ID)</span> <span class="keyword">int</span> partition) </span>&#123;</span><br><span class="line">    logger.info(<span class="string">"æ¥æ”¶æ¶ˆæ¯: &#123;&#125;ï¼Œpartitionï¼š&#123;&#125;"</span>, message, partition);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>å¦‚æœä¸éœ€è¦æŒ‡å®š<code>initialOffset</code>ï¼Œä¸Šé¢ä»£ç å¯ä»¥ç®€åŒ–ä¸ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@KafkaListener</span>(groupId = <span class="string">"test-consumer"</span>, </span><br><span class="line">	topicPartitions = <span class="meta">@TopicPartition</span>(topic = <span class="string">"test"</span>, partitions = &#123; <span class="string">"0"</span>, <span class="string">"1"</span> &#125;))</span><br></pre></td></tr></table></figure><h3 id="æ¶ˆæ¯è¿‡æ»¤å™¨"><a href="#æ¶ˆæ¯è¿‡æ»¤å™¨" class="headerlink" title="æ¶ˆæ¯è¿‡æ»¤å™¨"></a>æ¶ˆæ¯è¿‡æ»¤å™¨</h3><p>æˆ‘ä»¬å¯ä»¥ä¸ºæ¶ˆæ¯ç›‘å¬æ·»åŠ è¿‡æ»¤å™¨æ¥è¿‡æ»¤ä¸€äº›ç‰¹å®šçš„ä¿¡æ¯ã€‚æˆ‘ä»¬åœ¨æ¶ˆè´¹è€…é…ç½®ç±»<code>KafkaConsumerConfig</code>çš„<code>kafkaListenerContainerFactory</code>æ–¹æ³•é‡Œé…ç½®è¿‡æ»¤è§„åˆ™ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ConcurrentKafkaListenerContainerFactory&lt;String, String&gt; <span class="title">kafkaListenerContainerFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ConcurrentKafkaListenerContainerFactory&lt;String, String&gt; factory</span><br><span class="line">            = <span class="keyword">new</span> ConcurrentKafkaListenerContainerFactory&lt;&gt;();</span><br><span class="line">    factory.setConsumerFactory(consumerFactory());</span><br><span class="line">    <span class="comment">// ------- è¿‡æ»¤é…ç½® --------</span></span><br><span class="line">    factory.setRecordFilterStrategy(</span><br><span class="line">            r -&gt; r.value().contains(<span class="string">"fuck"</span>)</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">return</span> factory;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p><code>setRecordFilterStrategy</code>æ¥æ”¶<code>RecordFilterStrategy&lt;K, V&gt;</code>ï¼Œä»–æ˜¯ä¸€ä¸ªå‡½æ•°å¼æ¥å£ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RecordFilterStrategy</span>&lt;<span class="title">K</span>, <span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">filter</span><span class="params">(ConsumerRecord&lt;K, V&gt; var1)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>æ‰€ä»¥æˆ‘ä»¬ç”¨lambdaè¡¨è¾¾å¼æŒ‡å®šäº†ä¸Šé¢è¿™æ¡è§„åˆ™ï¼Œå³å¦‚æœæ¶ˆæ¯å†…å®¹åŒ…å«<code>fuck</code>è¿™ä¸ªç²—é„™ä¹‹è¯­çš„æ—¶å€™ï¼Œåˆ™ä¸æ¥å—æ¶ˆæ¯ã€‚</p><p>é…ç½®å¥½åæˆ‘ä»¬é‡å¯é¡¹ç›®ï¼Œåˆ†åˆ«å‘é€ä¸‹é¢è¿™ä¸¤æ¡è¯·æ±‚ï¼š</p><ol><li><p><a href="http://localhost:8080/send/fuck,mrbird" target="_blank" rel="noopener">http://localhost:8080/send/fuck,mrbird</a></p></li><li><p><a href="http://localhost:8080/send/love,mrbird" target="_blank" rel="noopener">http://localhost:8080/send/love,mrbird</a></p></li></ol><p>è§‚å¯Ÿæ§åˆ¶å°ï¼š</p><p><img src="img/QQæˆªå›¾20190326163502.png" alt="QQæˆªå›¾20190326163502.png"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œfuck,mrbirdè¿™æ¡æ¶ˆæ¯æ²¡æœ‰è¢«æ¥æ”¶ã€‚</p><h3 id="å‘é€å¤æ‚çš„æ¶ˆæ¯"><a href="#å‘é€å¤æ‚çš„æ¶ˆæ¯" class="headerlink" title="å‘é€å¤æ‚çš„æ¶ˆæ¯"></a>å‘é€å¤æ‚çš„æ¶ˆæ¯</h3><p>æˆªè‡³ç›®å‰ä½ç½®æˆ‘ä»¬åªå‘é€äº†ç®€å•çš„å­—ç¬¦ä¸²ç±»å‹çš„æ¶ˆæ¯ï¼Œæˆ‘ä»¬å¯ä»¥è‡ªå®šä¹‰æ¶ˆæ¯è½¬æ¢å™¨æ¥å‘é€å¤æ‚çš„æ¶ˆæ¯ã€‚</p><p><strong>å®šä¹‰æ¶ˆæ¯å®ä½“</strong></p><p>åˆ›å»ºä¸€ä¸ªMessageç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Message</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">6678420965611108427L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String from;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String message;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Message</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    	</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Message</span><span class="params">(String from, String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.from = from;</span><br><span class="line">        <span class="keyword">this</span>.message = message;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Message&#123;"</span> +</span><br><span class="line">                <span class="string">"from='"</span> + from + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">", message='"</span> + message + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">'&#125;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// get set ç•¥</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p><strong>æ”¹é€ æ¶ˆæ¯ç”Ÿäº§è€…é…ç½®</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">KafkaProducerConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;spring.kafka.bootstrap-servers&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String bootstrapServers;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ProducerFactory&lt;String, Message&gt; <span class="title">producerFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Map&lt;String, Object&gt; configProps = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        configProps.put(</span><br><span class="line">                ProducerConfig.BOOTSTRAP_SERVERS_CONFIG,</span><br><span class="line">                bootstrapServers);</span><br><span class="line">        configProps.put(</span><br><span class="line">                ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG,</span><br><span class="line">                StringSerializer.class);</span><br><span class="line">        configProps.put(</span><br><span class="line">                ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG,</span><br><span class="line">                JsonSerializer.class);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DefaultKafkaProducerFactory&lt;&gt;(configProps);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> KafkaTemplate&lt;String, Message&gt; <span class="title">kafkaTemplate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> KafkaTemplate&lt;&gt;(producerFactory());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>æˆ‘ä»¬å°†valueåºåˆ—åŒ–ç­–ç•¥æŒ‡å®šä¸ºäº†Kafkaæä¾›çš„<code>JsonSerializer</code>ï¼Œå¹¶ä¸”kafkaTemplateè¿”å›ç±»å‹ä¸º<code>KafkaTemplate&lt;String, Message&gt;</code>ã€‚</p><p><strong>å‘é€æ–°çš„æ¶ˆæ¯</strong></p><p>åœ¨<code>SendMessageController</code>é‡Œå‘é€å¤æ‚çš„æ¶ˆæ¯:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> KafkaTemplate&lt;String, Message&gt; kafkaTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@GetMapping</span>(<span class="string">"send/&#123;message&#125;"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendMessage</span><span class="params">(@PathVariable String message)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.kafkaTemplate.send(<span class="string">"test"</span>, <span class="keyword">new</span> Message(<span class="string">"mrbird"</span>, message));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p><strong>ä¿®æ”¹æ¶ˆè´¹è€…é…ç½®</strong></p><p>ä¿®æ”¹æ¶ˆè´¹è€…é…ç½®<code>KafkaConsumerConfig</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableKafka</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">KafkaConsumerConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;spring.kafka.bootstrap-servers&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String bootstrapServers;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;spring.kafka.consumer.group-id&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String consumerGroupId;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;spring.kafka.consumer.auto-offset-reset&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String autoOffsetReset;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ConsumerFactory&lt;String, Message&gt; <span class="title">consumerFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Map&lt;String, Object&gt; props = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        props.put(</span><br><span class="line">                ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG,</span><br><span class="line">                bootstrapServers);</span><br><span class="line">        props.put(</span><br><span class="line">                ConsumerConfig.GROUP_ID_CONFIG,</span><br><span class="line">                consumerGroupId);</span><br><span class="line">        props.put(</span><br><span class="line">                ConsumerConfig.AUTO_OFFSET_RESET_CONFIG,</span><br><span class="line">                autoOffsetReset);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DefaultKafkaConsumerFactory&lt;&gt;(</span><br><span class="line">                props,</span><br><span class="line">                <span class="keyword">new</span> StringDeserializer(),</span><br><span class="line">                <span class="keyword">new</span> JsonDeserializer&lt;&gt;(Message.class));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ConcurrentKafkaListenerContainerFactory&lt;String, Message&gt; <span class="title">kafkaListenerContainerFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ConcurrentKafkaListenerContainerFactory&lt;String, Message&gt; factory</span><br><span class="line">                = <span class="keyword">new</span> ConcurrentKafkaListenerContainerFactory&lt;&gt;();</span><br><span class="line">        factory.setConsumerFactory(consumerFactory());</span><br><span class="line">        <span class="keyword">return</span> factory;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p><strong>ä¿®æ”¹æ¶ˆæ¯ç›‘å¬</strong></p><p>ä¿®æ”¹<code>KafkaMessageListener</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@KafkaListener</span>(topics = <span class="string">"test"</span>, groupId = <span class="string">"test-consumer"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">listen</span><span class="params">(Message message)</span> </span>&#123;</span><br><span class="line">    logger.info(<span class="string">"æ¥æ”¶æ¶ˆæ¯: &#123;&#125;"</span>, message);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>é‡å¯é¡¹ç›®ï¼Œè®¿é—®<a href="http://localhost:8080/send/hello" target="_blank" rel="noopener">http://localhost:8080/send/hello</a>ï¼Œæ§åˆ¶å°è¾“å‡ºå¦‚ä¸‹ï¼š</p><p><img src="img/QQæˆªå›¾20190326171125.png" alt="QQæˆªå›¾20190326171125.png"></p><h3 id="æ›´å¤šé…ç½®"><a href="#æ›´å¤šé…ç½®" class="headerlink" title="æ›´å¤šé…ç½®"></a>æ›´å¤šé…ç½®</h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">spring.kafka.admin.client-id=</span> <span class="comment"># ID to pass to the server when making requests. Used for server-side logging.</span></span><br><span class="line"><span class="string">spring.kafka.admin.fail-fast=false</span> <span class="comment"># Whether to fail fast if the broker is not available on startup.</span></span><br><span class="line"><span class="string">spring.kafka.admin.properties.*=</span> <span class="comment"># Additional admin-specific properties used to configure the client.</span></span><br><span class="line"><span class="string">spring.kafka.admin.ssl.key-password=</span> <span class="comment"># Password of the private key in the key store file.</span></span><br><span class="line"><span class="string">spring.kafka.admin.ssl.key-store-location=</span> <span class="comment"># Location of the key store file.</span></span><br><span class="line"><span class="string">spring.kafka.admin.ssl.key-store-password=</span> <span class="comment"># Store password for the key store file.</span></span><br><span class="line"><span class="string">spring.kafka.admin.ssl.key-store-type=</span> <span class="comment"># Type of the key store.</span></span><br><span class="line"><span class="string">spring.kafka.admin.ssl.protocol=</span> <span class="comment"># SSL protocol to use.</span></span><br><span class="line"><span class="string">spring.kafka.admin.ssl.trust-store-location=</span> <span class="comment"># Location of the trust store file.</span></span><br><span class="line"><span class="string">spring.kafka.admin.ssl.trust-store-password=</span> <span class="comment"># Store password for the trust store file.</span></span><br><span class="line"><span class="string">spring.kafka.admin.ssl.trust-store-type=</span> <span class="comment"># Type of the trust store.</span></span><br><span class="line"><span class="string">spring.kafka.bootstrap-servers=</span> <span class="comment"># Comma-delimited list of host:port pairs to use for establishing the initial connections to the Kafka cluster. Applies to all components unless overridden.</span></span><br><span class="line"><span class="string">spring.kafka.client-id=</span> <span class="comment"># ID to pass to the server when making requests. Used for server-side logging.</span></span><br><span class="line"><span class="string">spring.kafka.consumer.auto-commit-interval=</span> <span class="comment"># Frequency with which the consumer offsets are auto-committed to Kafka if 'enable.auto.commit' is set to true.</span></span><br><span class="line"><span class="string">spring.kafka.consumer.auto-offset-reset=</span> <span class="comment"># What to do when there is no initial offset in Kafka or if the current offset no longer exists on the server.</span></span><br><span class="line"><span class="string">spring.kafka.consumer.bootstrap-servers=</span> <span class="comment"># Comma-delimited list of host:port pairs to use for establishing the initial connections to the Kafka cluster. Overrides the global property, for consumers.</span></span><br><span class="line"><span class="string">spring.kafka.consumer.client-id=</span> <span class="comment"># ID to pass to the server when making requests. Used for server-side logging.</span></span><br><span class="line"><span class="string">spring.kafka.consumer.enable-auto-commit=</span> <span class="comment"># Whether the consumer's offset is periodically committed in the background.</span></span><br><span class="line"><span class="string">spring.kafka.consumer.fetch-max-wait=</span> <span class="comment"># Maximum amount of time the server blocks before answering the fetch request if there isn't sufficient data to immediately satisfy the requirement given by "fetch-min-size".</span></span><br><span class="line"><span class="string">spring.kafka.consumer.fetch-min-size=</span> <span class="comment"># Minimum amount of data the server should return for a fetch request.</span></span><br><span class="line"><span class="string">spring.kafka.consumer.group-id=</span> <span class="comment"># Unique string that identifies the consumer group to which this consumer belongs.</span></span><br><span class="line"><span class="string">spring.kafka.consumer.heartbeat-interval=</span> <span class="comment"># Expected time between heartbeats to the consumer coordinator.</span></span><br><span class="line"><span class="string">spring.kafka.consumer.key-deserializer=</span> <span class="comment"># Deserializer class for keys.</span></span><br><span class="line"><span class="string">spring.kafka.consumer.max-poll-records=</span> <span class="comment"># Maximum number of records returned in a single call to poll().</span></span><br><span class="line"><span class="string">spring.kafka.consumer.properties.*=</span> <span class="comment"># Additional consumer-specific properties used to configure the client.</span></span><br><span class="line"><span class="string">spring.kafka.consumer.ssl.key-password=</span> <span class="comment"># Password of the private key in the key store file.</span></span><br><span class="line"><span class="string">spring.kafka.consumer.ssl.key-store-location=</span> <span class="comment"># Location of the key store file.</span></span><br><span class="line"><span class="string">spring.kafka.consumer.ssl.key-store-password=</span> <span class="comment"># Store password for the key store file.</span></span><br><span class="line"><span class="string">spring.kafka.consumer.ssl.key-store-type=</span> <span class="comment"># Type of the key store.</span></span><br><span class="line"><span class="string">spring.kafka.consumer.ssl.protocol=</span> <span class="comment"># SSL protocol to use.</span></span><br><span class="line"><span class="string">spring.kafka.consumer.ssl.trust-store-location=</span> <span class="comment"># Location of the trust store file.</span></span><br><span class="line"><span class="string">spring.kafka.consumer.ssl.trust-store-password=</span> <span class="comment"># Store password for the trust store file.</span></span><br><span class="line"><span class="string">spring.kafka.consumer.ssl.trust-store-type=</span> <span class="comment"># Type of the trust store.</span></span><br><span class="line"><span class="string">spring.kafka.consumer.value-deserializer=</span> <span class="comment"># Deserializer class for values.</span></span><br><span class="line"><span class="string">spring.kafka.jaas.control-flag=required</span> <span class="comment"># Control flag for login configuration.</span></span><br><span class="line"><span class="string">spring.kafka.jaas.enabled=false</span> <span class="comment"># Whether to enable JAAS configuration.</span></span><br><span class="line"><span class="string">spring.kafka.jaas.login-module=com.sun.security.auth.module.Krb5LoginModule</span> <span class="comment"># Login module.</span></span><br><span class="line"><span class="string">spring.kafka.jaas.options=</span> <span class="comment"># Additional JAAS options.</span></span><br><span class="line"><span class="string">spring.kafka.listener.ack-count=</span> <span class="comment"># Number of records between offset commits when ackMode is "COUNT" or "COUNT_TIME".</span></span><br><span class="line"><span class="string">spring.kafka.listener.ack-mode=</span> <span class="comment"># Listener AckMode. See the spring-kafka documentation.</span></span><br><span class="line"><span class="string">spring.kafka.listener.ack-time=</span> <span class="comment"># Time between offset commits when ackMode is "TIME" or "COUNT_TIME".</span></span><br><span class="line"><span class="string">spring.kafka.listener.client-id=</span> <span class="comment"># Prefix for the listener's consumer client.id property.</span></span><br><span class="line"><span class="string">spring.kafka.listener.concurrency=</span> <span class="comment"># Number of threads to run in the listener containers.</span></span><br><span class="line"><span class="string">spring.kafka.listener.idle-event-interval=</span> <span class="comment"># Time between publishing idle consumer events (no data received).</span></span><br><span class="line"><span class="string">spring.kafka.listener.log-container-config=</span> <span class="comment"># Whether to log the container configuration during initialization (INFO level).</span></span><br><span class="line"><span class="string">spring.kafka.listener.monitor-interval=</span> <span class="comment"># Time between checks for non-responsive consumers. If a duration suffix is not specified, seconds will be used.</span></span><br><span class="line"><span class="string">spring.kafka.listener.no-poll-threshold=</span> <span class="comment"># Multiplier applied to "pollTimeout" to determine if a consumer is non-responsive.</span></span><br><span class="line"><span class="string">spring.kafka.listener.poll-timeout=</span> <span class="comment"># Timeout to use when polling the consumer.</span></span><br><span class="line"><span class="string">spring.kafka.listener.type=single</span> <span class="comment"># Listener type.</span></span><br><span class="line"><span class="string">spring.kafka.producer.acks=</span> <span class="comment"># Number of acknowledgments the producer requires the leader to have received before considering a request complete.</span></span><br><span class="line"><span class="string">spring.kafka.producer.batch-size=</span> <span class="comment"># Default batch size.</span></span><br><span class="line"><span class="string">spring.kafka.producer.bootstrap-servers=</span> <span class="comment"># Comma-delimited list of host:port pairs to use for establishing the initial connections to the Kafka cluster. Overrides the global property, for producers.</span></span><br><span class="line"><span class="string">spring.kafka.producer.buffer-memory=</span> <span class="comment"># Total memory size the producer can use to buffer records waiting to be sent to the server.</span></span><br><span class="line"><span class="string">spring.kafka.producer.client-id=</span> <span class="comment"># ID to pass to the server when making requests. Used for server-side logging.</span></span><br><span class="line"><span class="string">spring.kafka.producer.compression-type=</span> <span class="comment"># Compression type for all data generated by the producer.</span></span><br><span class="line"><span class="string">spring.kafka.producer.key-serializer=</span> <span class="comment"># Serializer class for keys.</span></span><br><span class="line"><span class="string">spring.kafka.producer.properties.*=</span> <span class="comment"># Additional producer-specific properties used to configure the client.</span></span><br><span class="line"><span class="string">spring.kafka.producer.retries=</span> <span class="comment"># When greater than zero, enables retrying of failed sends.</span></span><br><span class="line"><span class="string">spring.kafka.producer.ssl.key-password=</span> <span class="comment"># Password of the private key in the key store file.</span></span><br><span class="line"><span class="string">spring.kafka.producer.ssl.key-store-location=</span> <span class="comment"># Location of the key store file.</span></span><br><span class="line"><span class="string">spring.kafka.producer.ssl.key-store-password=</span> <span class="comment"># Store password for the key store file.</span></span><br><span class="line"><span class="string">spring.kafka.producer.ssl.key-store-type=</span> <span class="comment"># Type of the key store.</span></span><br><span class="line"><span class="string">spring.kafka.producer.ssl.protocol=</span> <span class="comment"># SSL protocol to use.</span></span><br><span class="line"><span class="string">spring.kafka.producer.ssl.trust-store-location=</span> <span class="comment"># Location of the trust store file.</span></span><br><span class="line"><span class="string">spring.kafka.producer.ssl.trust-store-password=</span> <span class="comment"># Store password for the trust store file.</span></span><br><span class="line"><span class="string">spring.kafka.producer.ssl.trust-store-type=</span> <span class="comment"># Type of the trust store.</span></span><br><span class="line"><span class="string">spring.kafka.producer.transaction-id-prefix=</span> <span class="comment"># When non empty, enables transaction support for producer.</span></span><br><span class="line"><span class="string">spring.kafka.producer.value-serializer=</span> <span class="comment"># Serializer class for values.</span></span><br><span class="line"><span class="string">spring.kafka.properties.*=</span> <span class="comment"># Additional properties, common to producers and consumers, used to configure the client.</span></span><br><span class="line"><span class="string">spring.kafka.ssl.key-password=</span> <span class="comment"># Password of the private key in the key store file.</span></span><br><span class="line"><span class="string">spring.kafka.ssl.key-store-location=</span> <span class="comment"># Location of the key store file.</span></span><br><span class="line"><span class="string">spring.kafka.ssl.key-store-password=</span> <span class="comment"># Store password for the key store file.</span></span><br><span class="line"><span class="string">spring.kafka.ssl.key-store-type=</span> <span class="comment"># Type of the key store.</span></span><br><span class="line"><span class="string">spring.kafka.ssl.protocol=</span> <span class="comment"># SSL protocol to use.</span></span><br><span class="line"><span class="string">spring.kafka.ssl.trust-store-location=</span> <span class="comment"># Location of the trust store file.</span></span><br><span class="line"><span class="string">spring.kafka.ssl.trust-store-password=</span> <span class="comment"># Store password for the trust store file.</span></span><br><span class="line"><span class="string">spring.kafka.ssl.trust-store-type=</span> <span class="comment"># Type of the trust store.</span></span><br><span class="line"><span class="string">spring.kafka.streams.application-id=</span> <span class="comment"># Kafka streams application.id property; default spring.application.name.</span></span><br><span class="line"><span class="string">spring.kafka.streams.auto-startup=true</span> <span class="comment"># Whether or not to auto-start the streams factory bean.</span></span><br><span class="line"><span class="string">spring.kafka.streams.bootstrap-servers=</span> <span class="comment"># Comma-delimited list of host:port pairs to use for establishing the initial connections to the Kafka cluster. Overrides the global property, for streams.</span></span><br><span class="line"><span class="string">spring.kafka.streams.cache-max-size-buffering=</span> <span class="comment"># Maximum memory size to be used for buffering across all threads.</span></span><br><span class="line"><span class="string">spring.kafka.streams.client-id=</span> <span class="comment"># ID to pass to the server when making requests. Used for server-side logging.</span></span><br><span class="line"><span class="string">spring.kafka.streams.properties.*=</span> <span class="comment"># Additional Kafka properties used to configure the streams.</span></span><br><span class="line"><span class="string">spring.kafka.streams.replication-factor=</span> <span class="comment"># The replication factor for change log topics and repartition topics created by the stream processing application.</span></span><br><span class="line"><span class="string">spring.kafka.streams.ssl.key-password=</span> <span class="comment"># Password of the private key in the key store file.</span></span><br><span class="line"><span class="string">spring.kafka.streams.ssl.key-store-location=</span> <span class="comment"># Location of the key store file.</span></span><br><span class="line"><span class="string">spring.kafka.streams.ssl.key-store-password=</span> <span class="comment"># Store password for the key store file.</span></span><br><span class="line"><span class="string">spring.kafka.streams.ssl.key-store-type=</span> <span class="comment"># Type of the key store.</span></span><br><span class="line"><span class="string">spring.kafka.streams.ssl.protocol=</span> <span class="comment"># SSL protocol to use.</span></span><br><span class="line"><span class="string">spring.kafka.streams.ssl.trust-store-location=</span> <span class="comment"># Location of the trust store file.</span></span><br><span class="line"><span class="string">spring.kafka.streams.ssl.trust-store-password=</span> <span class="comment"># Store password for the trust store file.</span></span><br><span class="line"><span class="string">spring.kafka.streams.ssl.trust-store-type=</span> <span class="comment"># Type of the trust store.</span></span><br><span class="line"><span class="string">spring.kafka.streams.state-dir=</span> <span class="comment"># Directory location for the state store.</span></span><br><span class="line"><span class="string">spring.kafka.template.default-topic=</span> <span class="comment"># Default topic to which messages are sent.</span></span><br></pre></td></tr></table></figure><p>æºç é“¾æ¥ï¼š<a href="https://github.com/wuyouzhuguli/SpringAll/tree/master/54.Spring-Boot-Kafka" target="_blank" rel="noopener">https://github.com/wuyouzhuguli/SpringAll/tree/master/54.Spring-Boot-Kafka</a></p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Wed May 15 2019 17:13:45 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;Kafkaæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼çš„ã€å¯åˆ†åŒºçš„ã€å¯å¤åˆ¶çš„æ¶ˆæ¯ç³»ç»Ÿï¼Œä¸‹é¢æ˜¯Kafkaçš„å‡ ä¸ªåŸºæœ¬æœ¯è¯­ï¼š&lt;/p&gt;&lt;ol&gt;&lt;li&gt;&lt;p&gt;Kafkaå°†æ¶ˆæ¯ä»¥&lt;strong&gt;topic&lt;/strong&gt;ä¸ºå•ä½è¿›è¡Œå½’çº³ï¼›&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;å°†å‘Kafka topicå‘å¸ƒæ¶ˆæ¯çš„ç¨‹åºæˆä¸º&lt;strong&gt;producers&lt;/strong&gt;ï¼›&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;å°†é¢„è®¢topicså¹¶æ¶ˆè´¹æ¶ˆæ¯çš„ç¨‹åºæˆä¸º&lt;strong&gt;consumer&lt;/strong&gt;ï¼›&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;Kafkaä»¥é›†ç¾¤çš„æ–¹å¼è¿è¡Œï¼Œå¯ä»¥ç”±ä¸€ä¸ªæˆ–å¤šä¸ªæœåŠ¡ç»„æˆï¼Œæ¯ä¸ªæœåŠ¡å«åšä¸€ä¸ª&lt;strong&gt;broker&lt;/strong&gt;ã€‚&lt;/p&gt;&lt;/li&gt;&lt;/ol&gt;
    
    </summary>
    
    
      <category term="Spring Boot" scheme="http://mrbird.cc/tags/Spring-Boot/"/>
    
      <category term="Kafka" scheme="http://mrbird.cc/tags/Kafka/"/>
    
  </entry>
  
  <entry>
    <title>Spring Boot 2.0 WebFluxç¼–ç¨‹</title>
    <link href="http://mrbird.cc/Spring-Boot-2-0-WebFlux.html"/>
    <id>http://mrbird.cc/Spring-Boot-2-0-WebFlux.html</id>
    <published>2018-11-19T07:25:54.000Z</published>
    <updated>2019-04-04T02:43:35.816Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Wed May 15 2019 17:13:44 GMT+0800 (GMT+08:00) --><p>Spring MVC Webæ¶æ„æ˜¯åŸºäºé˜»å¡å¼Servlet APIæ„å»ºçš„ã€‚Servlet 3.1åæä¾›äº†éé˜»å¡APIï¼ŒSpring 5.0ååŸºäºè¿™äº›APIæ„å»ºäº†ä¸€å¥—å…¨æ–°çš„éé˜»å¡Webæ¡†æ¶ â€”â€” WebFluxã€‚Spring Boot 2.0åŸºäºSpring 5.0æ„å»ºï¼Œæ‰€ä»¥è¦åœ¨Spring Bootä¸­ä½¿ç”¨WebFluxæ¶æ„ï¼Œç‰ˆæœ¬å¿…é¡»å¤§äº2.0ã€‚</p><p>é€šè¿‡ä¸‹é¢è¿™å¼ å›¾äº†è§£ä¸‹Spring MVCå’ŒSpring WebFluxçš„åŒºåˆ«ï¼š<a id="more"></a></p><p><img src="img/diagram-boot-reactor.svg" style="width:35rem"> <a href="img/https://www.cnblogs.com/javabg/p/7976977.html">https://www.cnblogs.com/javabg/p/7976977.html</a></p><p>å¯ä»¥çœ‹åˆ°ï¼ŒSpring WebFluxæ˜¯éé˜»å¡å¼çš„ï¼Œæ”¯æŒ Reactive StreamsèƒŒå‹ï¼Œå¹¶åœ¨Nettyï¼ŒUndertowå’ŒServlet 3.1+å®¹å™¨ç­‰æœåŠ¡å™¨ä¸Šè¿è¡Œã€‚å…¶ç›®å‰åªæ”¯æŒéå…³ç³»å‹æ•°æ®åº“ï¼Œå¦‚Mongoï¼ŒRedisç­‰ã€‚éé˜»å¡å¼çš„ç¼–ç¨‹æ¨¡å‹å¯ä»¥æé«˜ç¨‹åºçš„å¹¶å‘é‡ï¼Œæå‡æ€§èƒ½å’Œååé‡ã€‚</p><h2 id="å¼‚æ­¥Servlet"><a href="#å¼‚æ­¥Servlet" class="headerlink" title="å¼‚æ­¥Servlet"></a>å¼‚æ­¥Servlet</h2><p>æ—¢ç„¶WebFluxæ˜¯åŸºäºå¼‚æ­¥Servelt APIæ„å»ºçš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ä»€ä¹ˆæ˜¯å¼‚æ­¥Servletã€‚</p><p>ä½¿ç”¨IDEAåˆ›å»ºä¸€ä¸ªä¼ ç»Ÿçš„Java Webåº”ç”¨ï¼ˆå¯ä»¥å‚è€ƒ<a href="https://www.cnblogs.com/javabg/p/7976977.html" target="_blank" rel="noopener">https://www.cnblogs.com/javabg/p/7976977.html</a>ï¼‰ï¼Œç„¶ååˆ›å»ºä¸€ä¸ª<code>SyncServlet</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@WebServlet</span>(urlPatterns = <span class="string">"/sync"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SyncServlet</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">7583536145022393360L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Logger log = Logger.getLogger(SyncServlet.class.getName());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">long</span> start = System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">this</span>.execute(request, response);</span><br><span class="line">        log.info(<span class="string">"æ€»è€—æ—¶ï¼š"</span> + (System.currentTimeMillis() - start) + <span class="string">"ms"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">2</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            response.getWriter().append(<span class="string">"hello"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p><code>doGet</code>æ–¹æ³•ä¸­çº¿ç¨‹é˜»å¡2ç§’ï¼Œç„¶åæ‰“å°helloã€‚éƒ¨ç½²é¡¹ç›®åˆ°Tomcatï¼Œcontext-pathä¸º/servletï¼Œå¯åŠ¨åè®¿é—®<a href="http://localhost:8080/servlet/sync" target="_blank" rel="noopener">http://localhost:8080/servlet/sync</a>:</p><p><img src="img/QQæˆªå›¾20190401110755.png" alt="QQæˆªå›¾20190401110755.png"></p><p>ä¼ ç»Ÿçš„Servlet APIæ˜¯é˜»å¡çš„ï¼Œ<code>log.info(&quot;æ€»è€—æ—¶ï¼š&quot; + (System.currentTimeMillis() - start) + &quot;ms&quot;)</code>è¿™è¡Œä»£ç å¿…é¡»ç­‰å¾…<code>this.execute()</code>æ‰§è¡Œå®Œæ¯•åæ‰å¼€å§‹æ‰§è¡Œã€‚</p><p>æ¥ä¸‹æ¥çœ‹çœ‹éé˜»å¡Servlet APIæ˜¯æ€ä¹ˆæçš„ã€‚æ–°å»ºä¸€ä¸ª<code>AsyncServlet</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@WebServlet</span>(urlPatterns = <span class="string">"/async"</span>, asyncSupported = <span class="keyword">true</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AsyncServlet</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">393375716683413545L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Logger log = Logger.getLogger(AsyncServlet.class.getName());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> start = System.currentTimeMillis();</span><br><span class="line">        AsyncContext asyncContext = request.startAsync();</span><br><span class="line"></span><br><span class="line">        CompletableFuture.runAsync(() -&gt; execute(</span><br><span class="line">            asyncContext, </span><br><span class="line">            asyncContext.getRequest(), </span><br><span class="line">            asyncContext.getResponse())</span><br><span class="line">        );</span><br><span class="line">        log.info(<span class="string">"æ€»è€—æ—¶ï¼š"</span> + (System.currentTimeMillis() - start) + <span class="string">"ms"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(AsyncContext asyncContext, ServletRequest request, ServletResponse response)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">2</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            response.getWriter().append(<span class="string">"hello"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        asyncContext.complete();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>åœ¨ç±»ä¸Šä½¿ç”¨<code>@WebServlet(asyncSupported = true)</code>å¼€å¯å¼‚æ­¥æ”¯æŒï¼Œé€šè¿‡<code>AsyncContext asyncContext = request.startAsync();</code>è·å–å¼‚æ­¥ä¸Šä¸‹æ–‡<code>AsyncContext</code>ï¼Œ<code>AsyncContext</code>çš„<code>complete</code>æ–¹æ³•ç”¨äºæ ‡è¯†å¼‚æ­¥è°ƒç”¨ç»“æŸã€‚<code>CompletableFuture</code>ä¸ºJava 8æä¾›çš„<code>Future</code>æ¥å£å®ç°ç±»ï¼Œå¯ä»¥æ–¹ä¾¿çš„å¤„ç†å¼‚æ­¥è°ƒç”¨ã€‚</p><p>å¯åŠ¨é¡¹ç›®ï¼Œè®¿é—®<a href="http://localhost:8080/servlet/async" target="_blank" rel="noopener">http://localhost:8080/servlet/async</a>ï¼Œå“åº”è€—æ—¶ä¹Ÿåœ¨2ç§’å·¦å³ï¼Œä½†æ˜¯è¿™ä¸ªè¿‡ç¨‹æ˜¯å¼‚æ­¥çš„ï¼ŒæŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—å°±å¯ä»¥è¯æ˜è¿™ç‚¹ï¼š</p><p><img src="img/QQæˆªå›¾20190401113446.png" alt="QQæˆªå›¾20190401113446.png"></p><p>æ‰€ä»¥ï¼Œå¼‚æ­¥è°ƒç”¨é€‚ç”¨äºé‚£äº›å¯¹æ–¹æ³•è¿”å›å€¼æ²¡æœ‰å½±å“çš„æ“ä½œï¼Œæ¯”å¦‚å¼‚æ­¥è®°å½•ç”¨æˆ·æ“ä½œæ—¥å¿—ç­‰ã€‚å¦‚æœæ–¹æ³•çš„è¿”å›å€¼ä¾èµ–äºå¼‚æ­¥è°ƒç”¨çš„ç»“æœï¼Œé‚£ä¹ˆæ–¹æ³•è€—æ—¶åœ¨åŒæ­¥å’Œå¼‚æ­¥ä¸Šæ˜¯æ²¡æœ‰åŒºåˆ«çš„ã€‚</p><h2 id="Monoå’ŒFlux"><a href="#Monoå’ŒFlux" class="headerlink" title="Monoå’ŒFlux"></a>Monoå’ŒFlux</h2><p>äº†è§£äº†å¼‚æ­¥Servletåï¼Œæˆ‘ä»¬å›åˆ°WebFluxï¼Œæ–°å»ºä¸€ä¸ªSpringBootç¨‹åºï¼Œç‰ˆæœ¬ä¸º2.1.3.RELEASEï¼Œå¹¶å¼•å…¥<code>spring-boot-starter-webflux</code>ä¾èµ–ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-webflux<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p></p><p><a href="https://github.com/reactor/reactor" target="_blank" rel="noopener">Reactor</a> æ˜¯Spring WebFluxæ‰€ä½¿ç”¨çš„å“åº”å¼åº“ï¼Œå…¶æä¾›äº†ä¸¤ä¸ªç‰¹æ®Šçš„ç±»Monoå’ŒFluxã€‚</p><p>Monoå’ŒFluxåœ¨å‘å¸ƒè®¢é˜…æ¨¡å¼ä¸­éƒ½å±äºå‘å¸ƒè€…ï¼ˆä¸æ¸…æ¥šçš„å¯ä»¥å‚è€ƒ<a href="/Java-9-Flow-API-Learn.html">Java 9 Flow APIå­¦ä¹ </a>ï¼‰ï¼ŒæŸ¥çœ‹æºç ä¼šå‘ç°å®ƒä»¬éƒ½å®ç°äº†Publisheræ¥å£ã€‚</p><p>Monoè¡¨ç¤º0 ~ 1ä¸ªå…ƒç´ çš„æ•°æ®å‘å¸ƒè€…ï¼ŒFluxè¡¨ç¤º 0 ~ Nä¸ªå…ƒç´ çš„æ•°æ®å‘å¸ƒè€…ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸€ä¸ªä¾‹å­æ¥äº†è§£Monoå’ŒFluxï¼Œåˆ›å»º<code>MonoFluxTest</code>ç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MonoFluxTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Subscriber&lt;Integer&gt; subscriber = <span class="keyword">new</span> Subscriber&lt;Integer&gt;() &#123;</span><br><span class="line">            <span class="keyword">private</span> Subscription subscription;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSubscribe</span><span class="params">(Subscription subscription)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">this</span>.subscription = subscription;</span><br><span class="line">                <span class="keyword">this</span>.subscription.request(<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(Integer item)</span> </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">"æ¥å—åˆ°æ•°æ®: "</span> + item);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    TimeUnit.SECONDS.sleep(<span class="number">3</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">this</span>.subscription.request(<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable throwable)</span> </span>&#123;</span><br><span class="line">                throwable.printStackTrace();</span><br><span class="line">                <span class="keyword">this</span>.subscription.cancel();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onComplete</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">"å¤„ç†å®Œäº†!"</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;;</span><br><span class="line">        </span><br><span class="line">        String[] strs = &#123;<span class="string">"1"</span>, <span class="string">"2"</span>, <span class="string">"3"</span>&#125;;</span><br><span class="line">        Flux.fromArray(strs).map(Integer::parseInt).subscribe(subscriber);</span><br><span class="line">        Mono.fromSupplier(() -&gt; <span class="number">1</span>).map(s -&gt; s + <span class="number">1</span>).subscribe(subscriber);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¨‹åºé¦–å…ˆåˆ›å»ºäº†ä¸€ä¸ªè®¢é˜…è€…ï¼ˆå‚è€ƒ<a href="/Java-9-Flow-API-Learn.html">Java 9 Flow APIå­¦ä¹ </a>ï¼‰ï¼Œç„¶ååˆ†åˆ«ä½¿ç”¨<code>Flux.fromArray</code>å’Œ<code>Mono.fromSupplier</code>æ„é€ äº†<code>Flux</code>ç±»å‹å‘å¸ƒè€…å’Œ<code>Mono</code>ç±»å‹å‘å¸ƒè€…ï¼Œå¹¶å’Œè®¢é˜…è€…ä¿æŒè®¢é˜…å…³ç³»ã€‚</p><p>è¿è¡Œmainæ–¹æ³•ï¼Œæ§åˆ¶å°è¾“å‡ºï¼š</p><p><img src="img/QQæˆªå›¾20190401134616.png" alt="QQæˆªå›¾20190401134616.png"></p><p>äº†è§£äº†Monoå’ŒFluxåï¼Œæˆ‘ä»¬æ–°å»ºä¸€ä¸ªTestControllerï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestController</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Logger logger = LoggerFactory.getLogger(<span class="keyword">this</span>.getClass());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"sync"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sync</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"sync method start"</span>);</span><br><span class="line">        String result = <span class="keyword">this</span>.execute();</span><br><span class="line">        logger.info(<span class="string">"sync method end"</span>);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"async/mono"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;String&gt; <span class="title">asyncMono</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"async method start"</span>);</span><br><span class="line">        Mono&lt;String&gt; result = Mono.fromSupplier(<span class="keyword">this</span>::execute);</span><br><span class="line">        logger.info(<span class="string">"async method end"</span>);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">execute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">2</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"hello"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p><code>execute</code>æ–¹æ³•è¿”å›ä¸€ä¸ªå€¼helloï¼Œæ‰€ä»¥å¯ä»¥ä½¿ç”¨Monoæ¥å¤„ç†è¿”å›å€¼ï¼Œä½¿å®ƒæˆä¸ºä¸€ä¸ªå¼‚æ­¥æ–¹æ³•ã€‚<code>asyncMono</code>æ–¹æ³•è¿”å›<code>Mono&lt;String&gt;</code>ç±»å‹ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªStringç±»å‹çš„æ•°æ®å‘å¸ƒè€…ï¼Œæˆ‘ä»¬ä¸ç”¨å»æ‰‹åŠ¨å¤„ç†è®¢é˜…å…³ç³»ï¼ŒSpringä¼šå¸®æˆ‘ä»¬å¤„ç†ï¼Œæˆ‘ä»¬ç›´æ¥è¿”å›å³å¯ã€‚</p><p>å¯åŠ¨é¡¹ç›®ï¼Œå¯ä»¥çœ‹åˆ°WebFluxé»˜è®¤ä½¿ç”¨çš„æ˜¯NettyæœåŠ¡å™¨ï¼š</p><p><img src="img/QQæˆªå›¾20190401135918.png" alt="QQæˆªå›¾20190401135918.png"></p><p>åˆ†åˆ«è®¿é—®<a href="http://localhost:8080/sync" target="_blank" rel="noopener">http://localhost:8080/sync</a>å’Œ<a href="http://localhost:8080/async/mono" target="_blank" rel="noopener">http://localhost:8080/async/mono</a>ï¼Œæ§åˆ¶å°è¾“å‡ºå¦‚ä¸‹ï¼š</p><p><img src="img/QQæˆªå›¾20190401140024.png" alt="QQæˆªå›¾20190401140024.png"></p><p><img src="img/QQæˆªå›¾20190401140239.png" alt="QQæˆªå›¾20190401140239.png"></p><p>å¯ä»¥çœ‹åˆ°<code>asyncMono</code>æ–¹æ³•é‡Œçš„<code>Mono&lt;String&gt; result = Mono.fromSupplier(this::execute)</code>æ˜¯å¼‚æ­¥éé˜»å¡çš„ï¼Œå¹¶ä¸”<a href="http://localhost:8080/async/mono" target="_blank" rel="noopener">http://localhost:8080/async/mono</a>è¿”å›çš„å€¼ä¸ºå­—ç¬¦ä¸²helloã€‚</p><p>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªè¿”å›ç±»å‹ä¸º<code>Flux&lt;String&gt;</code>ç±»å‹çš„ä¾‹å­ã€‚</p><h2 id="Server-Sent-Events"><a href="#Server-Sent-Events" class="headerlink" title="Server Sent Events"></a>Server Sent Events</h2><p>è¿”å›å€¼ç±»å‹ä¸º<code>Flux</code>çš„æ—¶å€™ï¼Œå®ƒæ˜¯ä¸€ä¸ªæ•°æ®æµï¼Œä¸æ˜¯ä¸€æ¬¡æ€§æ•°æ®åŒ…ï¼ŒæœåŠ¡ç«¯ä¼šä¸æ–­åœ°ï¼ˆå‡å¦‚Fluxæ•°æ®é•¿åº¦å¤§äº1ï¼‰å¾€å®¢æˆ·ç«¯å‘é€æ•°æ®ã€‚è¿™æ—¶ï¼Œå®¢æˆ·ç«¯ä¸ä¼šå…³é—­è¿æ¥ï¼Œä¼šä¸€ç›´ç­‰ç€æœåŠ¡å™¨å‘è¿‡æ¥çš„æ–°çš„æ•°æ®æµã€‚è¿™ç§æ¨¡å¼ç§°ä¸ºServer-Sent Eventsã€‚</p><p>åœ¨TestControlleræ–°å¢ä¸€ä¸ª<code>asyncFlux</code>æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping</span>(value = <span class="string">"async/flux"</span>, produces = MediaType.TEXT_EVENT_STREAM_VALUE)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Flux&lt;String&gt; <span class="title">asyncFlux</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    logger.info(<span class="string">"async method start"</span>);</span><br><span class="line">    Flux&lt;String&gt; result = Flux.fromStream(IntStream.range(<span class="number">1</span>, <span class="number">5</span>).mapToObj(i -&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"int valueï¼š"</span> + i;</span><br><span class="line">    &#125;));</span><br><span class="line">    logger.info(<span class="string">"async method end"</span>);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p><code>@GetMapping</code>å¿…é¡»é€šè¿‡<code>produces</code>æŒ‡å®šæ•°æ®ç±»å‹ä¸º<code>text/event-stream</code>ï¼Œé‡å¯é¡¹ç›®ï¼Œè®¿é—®<a href="http://localhost:8080/async/flux" target="_blank" rel="noopener">http://localhost:8080/async/flux</a>ï¼š</p><p><img src="img/flux.gif" alt="flux.gif"></p><p>å‰ç«¯å¯ä»¥é€šè¿‡H5çš„<code>EventSource</code>æ¥æ¥æ”¶ã€‚</p><p>å¼•å…¥thymeleafä¾èµ–ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-thymeleaf<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p></p><p>ç„¶ååœ¨resources/templatesä¸‹æ–°å»ºflux.htmlï¼š</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>test sse<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">    <span class="keyword">var</span> es = <span class="keyword">new</span> EventSource(<span class="string">"async/flux"</span>);</span></span><br><span class="line"><span class="javascript">    es.onmessage = <span class="function"><span class="keyword">function</span> (<span class="params">evt</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="built_in">console</span>.log(evt.data);</span></span><br><span class="line"><span class="javascript">        <span class="keyword">if</span> (evt.data === <span class="string">"int valueï¼š4"</span>) &#123;</span></span><br><span class="line"><span class="undefined">            es.close();</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined">    &#125;;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p></p><p>éœ€è¦è°ƒç”¨<code>es.close()</code>æ¥å…³é—­äº‹ä»¶æµï¼Œä¸ç„¶<code>EventSource</code>ä¼šåœ¨æ•°æ®ä¼ è¾“å®Œæ¯•ä¼šè‡ªåŠ¨é‡è¿ï¼Œè¿™æ ·å°±ä¼šä¸é—´æ–­çš„è°ƒç”¨<code>localhost:8080/async/flux</code>è¯·æ±‚äº†ã€‚</p><p>æ·»åŠ ä¸€ä¸ªViewControllerï¼Œç”¨æ¥è®¿é—®flux.htmlï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ViewController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"flux"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">flux</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"flux"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>é‡å¯é¡¹ç›®ï¼Œè®¿é—®<a href="http://localhost:8080/flux" target="_blank" rel="noopener">http://localhost:8080/flux</a>ï¼Œæµè§ˆå™¨æ§åˆ¶å°è¾“å‡ºå¦‚ä¸‹æ‰€ç¤º:</p><p><img src="img/asfasfdvvasd.gif" alt="asfasfdvvasd.gif"></p><h2 id="Mono-Fluxå¸¸ç”¨æ–¹æ³•"><a href="#Mono-Fluxå¸¸ç”¨æ–¹æ³•" class="headerlink" title="Mono,Fluxå¸¸ç”¨æ–¹æ³•"></a>Mono,Fluxå¸¸ç”¨æ–¹æ³•</h2><p>é€šè¿‡ä¸Šé¢çš„ä¾‹å­ï¼Œæˆ‘ä»¬ç®€å•äº†è§£äº†Monoå’ŒFluxçš„ç”¨æ³•å’ŒåŒºåˆ«ï¼Œä¸‹é¢æˆ‘ä»¬åˆ—ä¸¾ä¸€äº›å®ƒä»¬çš„å¸¸ç”¨æ–¹æ³•ã€‚</p><h3 id="æºå¤´æ“ä½œ"><a href="#æºå¤´æ“ä½œ" class="headerlink" title="æºå¤´æ“ä½œ"></a>æºå¤´æ“ä½œ</h3><p><strong>Flux</strong></p><p>å¯ä»¥é€šè¿‡Fluxç±»çš„é™æ€æ–¹æ³•æ¥ç”Ÿæˆï¼š</p><ol><li><p><code>just()</code>ï¼šå¯ä»¥æŒ‡å®šåºåˆ—ä¸­åŒ…å«çš„å…¨éƒ¨å…ƒç´ ã€‚åˆ›å»ºå‡ºæ¥çš„ Flux åºåˆ—åœ¨å‘å¸ƒè¿™äº›å…ƒç´ ä¹‹åä¼šè‡ªåŠ¨ç»“æŸã€‚</p></li><li><p><code>fromArray()</code>ï¼Œ<code>fromIterable()</code>å’Œ <code>fromStream()</code>ï¼šå¯ä»¥ä»ä¸€ä¸ªæ•°ç»„ã€Iterable å¯¹è±¡æˆ– Stream å¯¹è±¡ä¸­åˆ›å»º Flux å¯¹è±¡ã€‚</p></li><li><p><code>empty()</code>ï¼šåˆ›å»ºä¸€ä¸ªä¸åŒ…å«ä»»ä½•å…ƒç´ ï¼Œåªå‘å¸ƒç»“æŸæ¶ˆæ¯çš„åºåˆ—ã€‚</p></li><li><p><code>error(Throwable error)</code>ï¼šåˆ›å»ºä¸€ä¸ªåªåŒ…å«é”™è¯¯æ¶ˆæ¯çš„åºåˆ—ã€‚</p></li><li><p><code>never()</code>ï¼šåˆ›å»ºä¸€ä¸ªä¸åŒ…å«ä»»ä½•æ¶ˆæ¯é€šçŸ¥çš„åºåˆ—ã€‚</p></li><li><p><code>range(int start, int count)</code>ï¼šåˆ›å»ºåŒ…å«ä» start èµ·å§‹çš„ count ä¸ªæ•°é‡çš„ Integer å¯¹è±¡çš„åºåˆ—ã€‚</p></li><li><p><code>interval(Duration period)</code>å’Œ <code>interval(Duration delay, Duration period)</code>ï¼šåˆ›å»ºä¸€ä¸ªåŒ…å«äº†ä» 0 å¼€å§‹é€’å¢çš„ Long å¯¹è±¡çš„åºåˆ—ã€‚å…¶ä¸­åŒ…å«çš„å…ƒç´ æŒ‰ç…§æŒ‡å®šçš„é—´éš”æ¥å‘å¸ƒã€‚é™¤äº†é—´éš”æ—¶é—´ä¹‹å¤–ï¼Œè¿˜å¯ä»¥æŒ‡å®šèµ·å§‹å…ƒç´ å‘å¸ƒä¹‹å‰çš„å»¶è¿Ÿæ—¶é—´ã€‚</p></li></ol><p>ä¸¾äº›ä¾‹å­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    Flux.just(<span class="string">"Hello"</span>, <span class="string">"World"</span>).subscribe(System.out::println);</span><br><span class="line">    Flux.fromArray(<span class="keyword">new</span> Integer[] &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125;).subscribe(System.out::println);</span><br><span class="line">    Flux.empty().subscribe(System.out::println);</span><br><span class="line">    Flux.range(<span class="number">1</span>, <span class="number">4</span>).subscribe(System.out::println);</span><br><span class="line">    Flux.interval(Duration.of(<span class="number">1</span>, ChronoUnit.SECONDS)).subscribe(System.out::println);</span><br><span class="line">    <span class="comment">// çº¿ç¨‹å»¶è¿Ÿå…³é—­ï¼Œä¸ç„¶æœ€åä¸€ä¸ªä¾‹å­æœ¨æœ‰è¾“å‡º</span></span><br><span class="line">    Thread.currentThread().join(<span class="number">10000</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>è¾“å‡ºå¦‚ä¸‹æ‰€ç¤ºï¼š <img src="img/QQæˆªå›¾20190401170048.png" alt="QQæˆªå›¾20190401170048.png"></p><p>ä¸Šé¢çš„è¿™äº›é™æ€æ–¹æ³•é€‚åˆäºç®€å•çš„Fluxåºåˆ—ç”Ÿæˆï¼Œå½“åºåˆ—çš„ç”Ÿæˆéœ€è¦å¤æ‚çš„é€»è¾‘æ—¶ï¼Œåˆ™åº”è¯¥ä½¿ç”¨<code>generate()</code>æˆ–<code>create()</code>æ–¹æ³•ã€‚</p><p><strong>generate()</strong></p><p>generate()æ–¹æ³•é€šè¿‡åŒæ­¥å’Œé€ä¸€çš„æ–¹å¼æ¥äº§ç”Ÿ Flux åºåˆ—ã€‚åºåˆ—çš„äº§ç”Ÿæ˜¯é€šè¿‡è°ƒç”¨æ‰€æä¾›çš„ SynchronousSink å¯¹è±¡çš„ next()ï¼Œcomplete()å’Œ error(Throwable)æ–¹æ³•æ¥å®Œæˆçš„ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Flux.generate(sink -&gt; &#123;</span><br><span class="line">    sink.next(<span class="string">"Hello"</span>);</span><br><span class="line">    sink.complete();</span><br><span class="line">&#125;).subscribe(System.out::println);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> Random random = <span class="keyword">new</span> Random();</span><br><span class="line">Flux.generate(ArrayList::<span class="keyword">new</span>, (list, sink) -&gt; &#123;</span><br><span class="line">    <span class="keyword">int</span> value = random.nextInt(<span class="number">100</span>);</span><br><span class="line">    list.add(value);</span><br><span class="line">    sink.next(value);</span><br><span class="line">    <span class="keyword">if</span> (list.size() == <span class="number">10</span>) &#123;</span><br><span class="line">        sink.complete();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> list;</span><br><span class="line">&#125;).subscribe(System.out::println);</span><br></pre></td></tr></table></figure><p></p><p>è¾“å‡ºå¦‚ä¸‹æ‰€ç¤º:</p><p><img src="img/QQæˆªå›¾20190401170950.png" alt="QQæˆªå›¾20190401170950.png"></p><p>å¦‚æœä¸è°ƒç”¨ complete()æ–¹æ³•ï¼Œæ‰€äº§ç”Ÿçš„æ˜¯ä¸€ä¸ªæ— é™åºåˆ—ã€‚</p><p><strong>create()</strong></p><p>create()æ–¹æ³•ä¸ generate()æ–¹æ³•çš„ä¸åŒä¹‹å¤„åœ¨äºæ‰€ä½¿ç”¨çš„æ˜¯ FluxSink å¯¹è±¡ã€‚FluxSink æ”¯æŒåŒæ­¥å’Œå¼‚æ­¥çš„æ¶ˆæ¯äº§ç”Ÿï¼Œå¹¶ä¸”å¯ä»¥åœ¨ä¸€æ¬¡è°ƒç”¨ä¸­äº§ç”Ÿå¤šä¸ªå…ƒç´ ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Flux.create(sink -&gt; &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">        sink.next(i);</span><br><span class="line">    &#125;</span><br><span class="line">    sink.complete();</span><br><span class="line">&#125;).subscribe(System.out::println);</span><br></pre></td></tr></table></figure><p><strong>Mono</strong></p><p>Mono çš„åˆ›å»ºæ–¹å¼ä¸ä¹‹å‰ä»‹ç»çš„ Flux æ¯”è¾ƒç›¸ä¼¼ã€‚Mono ç±»ä¸­ä¹ŸåŒ…å«äº†ä¸€äº›ä¸ Flux ç±»ä¸­ç›¸åŒçš„é™æ€æ–¹æ³•ã€‚è¿™äº›æ–¹æ³•åŒ…æ‹¬ just()ï¼Œempty()ï¼Œerror()å’Œ never()ç­‰ã€‚é™¤äº†è¿™äº›æ–¹æ³•ä¹‹å¤–ï¼ŒMono è¿˜æœ‰ä¸€äº›ç‹¬æœ‰çš„é™æ€æ–¹æ³•ï¼š</p><ol><li><p><code>fromCallable()</code>ã€<code>fromCompletionStage()</code>ã€<code>fromFuture()</code>ã€<code>fromRunnable(</code>)å’Œ <code>fromSupplier()</code>ï¼šåˆ†åˆ«ä» Callableã€CompletionStageã€CompletableFutureã€Runnable å’Œ Supplier ä¸­åˆ›å»º Monoã€‚</p></li><li><p><code>delay(Duration duration)</code>ï¼šåˆ›å»ºä¸€ä¸ª Mono åºåˆ—ï¼Œåœ¨æŒ‡å®šçš„å»¶è¿Ÿæ—¶é—´ä¹‹åï¼Œäº§ç”Ÿæ•°å­— 0 ä½œä¸ºå”¯ä¸€å€¼ã€‚</p></li><li><p><code>ignoreElements(Publisher&lt;T&gt; source)</code>ï¼šåˆ›å»ºä¸€ä¸ª Mono åºåˆ—ï¼Œå¿½ç•¥ä½œä¸ºæºçš„ Publisher ä¸­çš„æ‰€æœ‰å…ƒç´ ï¼Œåªäº§ç”Ÿç»“æŸæ¶ˆæ¯ã€‚</p></li><li><p><code>justOrEmpty(Optional&lt;? extends T&gt; data)</code>å’Œ <code>justOrEmpty(T data)</code>ï¼šä»ä¸€ä¸ª Optional å¯¹è±¡æˆ–å¯èƒ½ä¸º null çš„å¯¹è±¡ä¸­åˆ›å»º Monoã€‚åªæœ‰ Optional å¯¹è±¡ä¸­åŒ…å«å€¼æˆ–å¯¹è±¡ä¸ä¸º null æ—¶ï¼ŒMono åºåˆ—æ‰äº§ç”Ÿå¯¹åº”çš„å…ƒç´ ã€‚</p></li></ol><p>ä¸¾äº›ä¾‹å­:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Mono.just(<span class="string">"are"</span>).subscribe(System.out::println);</span><br><span class="line">Mono.empty().subscribe(System.out::println);</span><br><span class="line">Mono.fromSupplier(() -&gt; <span class="string">"you"</span>).subscribe(System.out::println);</span><br><span class="line">Mono.justOrEmpty(Optional.of(<span class="string">"ok"</span>)).subscribe(System.out::println);</span><br></pre></td></tr></table></figure><p></p><p>è¾“å‡º:</p><p><img src="img/QQæˆªå›¾20190401173002.png" alt="QQæˆªå›¾20190401173002.png"></p><p>è¿˜å¯ä»¥é€šè¿‡ create()æ–¹æ³•æ¥ä½¿ç”¨ MonoSink æ¥åˆ›å»º Monoï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Mono.create(sink -&gt; sink.success(<span class="string">"Hello"</span>)).subscribe(System.out::println);</span><br></pre></td></tr></table></figure><p></p><h3 id="ä¸­é—´æ“ä½œ"><a href="#ä¸­é—´æ“ä½œ" class="headerlink" title="ä¸­é—´æ“ä½œ"></a>ä¸­é—´æ“ä½œ</h3><p><strong>filter</strong></p><p>å¯¹æµä¸­åŒ…å«çš„å…ƒç´ è¿›è¡Œè¿‡æ»¤ï¼Œåªç•™ä¸‹æ»¡è¶³ Predicate æŒ‡å®šæ¡ä»¶çš„å…ƒç´ ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Flux.range(<span class="number">1</span>, <span class="number">10</span>).filter(i -&gt; i % <span class="number">2</span> == <span class="number">0</span>).subscribe(System.out::println);</span><br></pre></td></tr></table></figure><p></p><p>è¾“å‡ºå‰10å¶æ•°ã€‚</p><p><strong>take</strong></p><p>take ç³»åˆ—æ“ä½œç¬¦ç”¨æ¥ä»å½“å‰æµä¸­æå–å…ƒç´ ã€‚æå–çš„æ–¹å¼å¯ä»¥æœ‰å¾ˆå¤šç§ã€‚</p><ol><li><p><code>take(long n)</code>ï¼šæŒ‰ç…§æŒ‡å®šçš„æ•°é‡æ¥æå–ã€‚</p></li><li><p><code>takeLast(long n)</code>ï¼šæå–æµä¸­çš„æœ€å N ä¸ªå…ƒç´ ã€‚</p></li><li><p><code>takeUntil(Predicate&lt;? super T&gt; predicate)</code>ï¼šæå–å…ƒç´ ç›´åˆ° Predicate è¿”å› trueã€‚</p></li></ol><p>4 <code>takeWhile(Predicate&lt;? super T&gt; continuePredicate)</code>ï¼š å½“ Predicate è¿”å› true æ—¶æ‰è¿›è¡Œæå–ã€‚</p><p>ä¸¾äº›ä¾‹å­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Flux.range(<span class="number">1</span>, <span class="number">20</span>).take(<span class="number">10</span>).subscribe(System.out::println);</span><br><span class="line">Flux.range(<span class="number">1</span>, <span class="number">20</span>).takeLast(<span class="number">10</span>).subscribe(System.out::println);</span><br><span class="line">Flux.range(<span class="number">1</span>, <span class="number">20</span>).takeWhile(i -&gt; i &lt; <span class="number">10</span>).subscribe(System.out::println);</span><br><span class="line">Flux.range(<span class="number">1</span>, <span class="number">20</span>).takeUntil(i -&gt; i == <span class="number">10</span>).subscribe(System.out::println);</span><br></pre></td></tr></table></figure><p></p><p><strong>reduce å’Œ reduceWith</strong></p><p>reduce å’Œ reduceWith æ“ä½œç¬¦å¯¹æµä¸­åŒ…å«çš„æ‰€æœ‰å…ƒç´ è¿›è¡Œç´¯ç§¯æ“ä½œï¼Œå¾—åˆ°ä¸€ä¸ªåŒ…å«è®¡ç®—ç»“æœçš„ Mono åºåˆ—ã€‚ç´¯ç§¯æ“ä½œæ˜¯é€šè¿‡ä¸€ä¸ª BiFunction æ¥è¡¨ç¤ºçš„ã€‚åœ¨æ“ä½œæ—¶å¯ä»¥æŒ‡å®šä¸€ä¸ªåˆå§‹å€¼ã€‚å¦‚æœæ²¡æœ‰åˆå§‹å€¼ï¼Œåˆ™åºåˆ—çš„ç¬¬ä¸€ä¸ªå…ƒç´ ä½œä¸ºåˆå§‹å€¼ã€‚</p><p>æ¯”å¦‚ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Flux.range(<span class="number">1</span>, <span class="number">10</span>).reduce((x, y) -&gt; x + y).subscribe(System.out::println);</span><br><span class="line">Flux.range(<span class="number">1</span>, <span class="number">10</span>).reduceWith(() -&gt; <span class="number">10</span>, (x, y) -&gt; x + y).subscribe(System.out::println);</span><br></pre></td></tr></table></figure><p></p><p>ç¬¬ä¸€è¡Œè¯­å¥å¯¹æµä¸­çš„å…ƒç´ è¿›è¡Œç›¸åŠ æ“ä½œï¼Œç»“æœä¸º 55ï¼›ç¬¬äºŒè¡Œè¯­å¥åŒæ ·ä¹Ÿæ˜¯è¿›è¡Œç›¸åŠ æ“ä½œï¼Œä¸è¿‡é€šè¿‡ä¸€ä¸ª Supplier ç»™å‡ºäº†åˆå§‹å€¼ä¸º 10ï¼Œæ‰€ä»¥ç»“æœä¸º 65ã€‚</p><p><strong>merge</strong></p><p><code>merge</code>æ“ä½œç¬¦ç”¨æ¥æŠŠå¤šä¸ªæµåˆå¹¶æˆä¸€ä¸ª Flux åºåˆ—ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Flux.merge(</span><br><span class="line">        Flux.interval(Duration.of(<span class="number">500</span>, ChronoUnit.MILLIS)).take(<span class="number">2</span>),</span><br><span class="line">        Flux.interval(Duration.of(<span class="number">500</span>, ChronoUnit.MILLIS)).take(<span class="number">2</span>)</span><br><span class="line">).toStream().forEach(System.out::println);</span><br></pre></td></tr></table></figure><p>è¾“å‡º 0 0 1 1ã€‚</p><p><strong>buffer</strong></p><p>ç›´æ¥çœ‹ä¾‹å­å§ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Flux.range(<span class="number">1</span>, <span class="number">100</span>).buffer(<span class="number">20</span>).subscribe(System.out::println);</span><br><span class="line">Flux.range(<span class="number">1</span>, <span class="number">10</span>).bufferUntil(i -&gt; i % <span class="number">2</span> == <span class="number">0</span>).subscribe(System.out::println);</span><br><span class="line">Flux.range(<span class="number">1</span>, <span class="number">10</span>).bufferWhile(i -&gt; i % <span class="number">2</span> == <span class="number">0</span>).subscribe(System.out::println);</span><br></pre></td></tr></table></figure><p></p><p>è¾“å‡ºå¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><img src="img/QQæˆªå›¾20190402090631.png" alt="QQæˆªå›¾20190402090631.png"></p><p>ç±»ä¼¼äºæ•°æ®æµåˆ†åŒºã€‚</p><p><strong>zipWith</strong></p><p>å°†ä¸¤ä¸ªæµçš„å…ƒç´ å®‰è£…å…ƒç´ ä½ç½®ä¸€ä¸€ç»„åˆï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Flux.just(<span class="string">"a"</span>, <span class="string">"b"</span>, <span class="string">"c"</span>, <span class="string">"d"</span>)</span><br><span class="line">    .zipWith(Flux.just(<span class="string">"e"</span>, <span class="string">"f"</span>, <span class="string">"g"</span>, <span class="string">"h"</span>, <span class="string">"i"</span>))</span><br><span class="line">    .subscribe(System.out::println);</span><br></pre></td></tr></table></figure><p></p><p>è¾“å‡ºï¼š</p><p><img src="img/QQæˆªå›¾20190402092516.png" alt="QQæˆªå›¾20190402092516.png"></p><p>æ²¡æœ‰é…å¯¹ä¸Šçš„è¢«ä¸¢å¼ƒã€‚</p><p>å¦å¤–ä¸€ä¸ªä¾‹å­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Flux.just(<span class="string">"a"</span>, <span class="string">"b"</span>, <span class="string">"c"</span>, <span class="string">"d"</span>)</span><br><span class="line">    .zipWith(Flux.just(<span class="string">"e"</span>, <span class="string">"f"</span>, <span class="string">"g"</span>, <span class="string">"h"</span>, <span class="string">"i"</span>), (s1, s2) -&gt; String.format(<span class="string">"%s-%s"</span>, s1, s2))</span><br><span class="line">    .subscribe(System.out::println);</span><br></pre></td></tr></table></figure><p></p><p>è¾“å‡ºå¦‚ä¸‹:</p><p><img src="img/QQæˆªå›¾20190402092833.png" alt="QQæˆªå›¾20190402092833.png"></p><p><strong>flatMap</strong></p><p>æŠŠæµä¸­çš„æ¯ä¸ªå…ƒç´ è½¬æ¢æˆä¸€ä¸ªæµï¼Œå†æŠŠæ‰€æœ‰æµä¸­çš„å…ƒç´ è¿›è¡Œåˆå¹¶ã€‚</p><p>æ¯”å¦‚ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Flux.just(<span class="number">5</span>, <span class="number">10</span>).flatMap(</span><br><span class="line">            x -&gt; Flux.range(<span class="number">1</span>, x).take(x)</span><br><span class="line">    ).subscribe(System.out::println);</span><br></pre></td></tr></table></figure><p></p><h3 id="ç»ˆç«¯å¤„ç†"><a href="#ç»ˆç«¯å¤„ç†" class="headerlink" title="ç»ˆç«¯å¤„ç†"></a>ç»ˆç«¯å¤„ç†</h3><p>é€šè¿‡<code>subscribe()</code>æ–¹æ³•å¤„ç†æ­£å¸¸å’Œé”™è¯¯æ¶ˆæ¯ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Flux.just(<span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line">    .concatWith(Mono.error(<span class="keyword">new</span> IllegalStateException()))</span><br><span class="line">    .subscribe(System.out::println, System.err::println);</span><br></pre></td></tr></table></figure><p></p><p>è¾“å‡º:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">java.lang.IllegalStateException</span><br></pre></td></tr></table></figure><p></p><p>å‡ºç°é”™è¯¯æ—¶è¿”å›é»˜è®¤å€¼ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Flux.just(<span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line">    .concatWith(Mono.error(<span class="keyword">new</span> IllegalStateException()))</span><br><span class="line">    .onErrorReturn(<span class="number">0</span>)</span><br><span class="line">    .subscribe(System.out::println);</span><br></pre></td></tr></table></figure><p></p><p>è¾“å‡ºï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">0</span><br></pre></td></tr></table></figure><p></p><p>å‡ºç°é”™è¯¯æ—¶ä½¿ç”¨å¦å¤–çš„æµï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Flux.just(<span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line">    .concatWith(Mono.error(<span class="keyword">new</span> IllegalArgumentException()))</span><br><span class="line">    .onErrorResume(e -&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (e <span class="keyword">instanceof</span> IllegalStateException) &#123;</span><br><span class="line">            <span class="keyword">return</span> Mono.just(<span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> IllegalArgumentException) &#123;</span><br><span class="line">            <span class="keyword">return</span> Mono.just(-<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Mono.empty();</span><br><span class="line">    &#125;).subscribe(System.out::println);</span><br></pre></td></tr></table></figure><p></p><p>è¾“å‡ºå¦‚ä¸‹:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">-1</span><br></pre></td></tr></table></figure><p></p><p>æºç é“¾æ¥ï¼š<a href="https://github.com/wuyouzhuguli/SpringAll/tree/master/57.Spring-Boot-WebFlux" target="_blank" rel="noopener">https://github.com/wuyouzhuguli/SpringAll/tree/master/57.Spring-Boot-WebFlux</a></p><p>å‚è€ƒé“¾æ¥:</p><ol><li><p><a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/web-reactive.html#spring-webflux" target="_blank" rel="noopener">https://docs.spring.io/spring/docs/current/spring-framework-reference/web-reactive.html#spring-webflux</a></p></li><li><p><a href="https://developer.mozilla.org/zh-CN/docs/Server-sent_events/Using_server-sent_events" target="_blank" rel="noopener">https://developer.mozilla.org/zh-CN/docs/Server-sent_events/Using_server-sent_events</a></p></li><li><p><a href="http://www.ruanyifeng.com/blog/2017/05/server-sent_events.html" target="_blank" rel="noopener">http://www.ruanyifeng.com/blog/2017/05/server-sent_events.html</a></p></li><li><p><a href="https://projectreactor.io/docs/core/release/reference/#flux" target="_blank" rel="noopener">https://projectreactor.io/docs/core/release/reference/#flux</a></p></li><li><p><a href="https://www.ibm.com/developerworks/cn/java/j-cn-with-reactor-response-encode/index.html" target="_blank" rel="noopener">https://www.ibm.com/developerworks/cn/java/j-cn-with-reactor-response-encode/index.html</a></p></li></ol><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Wed May 15 2019 17:13:44 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;Spring MVC Webæ¶æ„æ˜¯åŸºäºé˜»å¡å¼Servlet APIæ„å»ºçš„ã€‚Servlet 3.1åæä¾›äº†éé˜»å¡APIï¼ŒSpring 5.0ååŸºäºè¿™äº›APIæ„å»ºäº†ä¸€å¥—å…¨æ–°çš„éé˜»å¡Webæ¡†æ¶ â€”â€” WebFluxã€‚Spring Boot 2.0åŸºäºSpring 5.0æ„å»ºï¼Œæ‰€ä»¥è¦åœ¨Spring Bootä¸­ä½¿ç”¨WebFluxæ¶æ„ï¼Œç‰ˆæœ¬å¿…é¡»å¤§äº2.0ã€‚&lt;/p&gt;&lt;p&gt;é€šè¿‡ä¸‹é¢è¿™å¼ å›¾äº†è§£ä¸‹Spring MVCå’ŒSpring WebFluxçš„åŒºåˆ«ï¼š
    
    </summary>
    
    
      <category term="Spring" scheme="http://mrbird.cc/tags/Spring/"/>
    
      <category term="Spring Boot" scheme="http://mrbird.cc/tags/Spring-Boot/"/>
    
      <category term="WebFlux" scheme="http://mrbird.cc/tags/WebFlux/"/>
    
  </entry>
  
  <entry>
    <title>Spring Bootæ•´åˆMongo DB</title>
    <link href="http://mrbird.cc/Spring-Boot-Mongo-DB-CRUD.html"/>
    <id>http://mrbird.cc/Spring-Boot-Mongo-DB-CRUD.html</id>
    <published>2018-11-15T02:41:51.000Z</published>
    <updated>2019-04-04T06:10:50.260Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Wed May 15 2019 17:13:43 GMT+0800 (GMT+08:00) --><p>è¿™èŠ‚æˆ‘ä»¬å°†æ•´åˆSpring Bootä¸Mongo DBå®ç°å¢åˆ æ”¹æŸ¥çš„åŠŸèƒ½ï¼Œå¹¶ä¸”å®ç°åºåˆ—é€’å¢ã€‚Mongo DBä¸‹è½½åœ°å€ï¼š<a href="https://www.mongodb.com/download-center/community" target="_blank" rel="noopener">https://www.mongodb.com/download-center/community</a>ã€‚Mongo DBçš„åŸºæœ¬ä»‹ç»å’Œå¢åˆ æ”¹æŸ¥çš„ç”¨æ³•å¯ä»¥å‚è€ƒæˆ‘ä¹‹å‰çš„æ–‡ç« ï¼š<a href="https://mrbird.cc/MongoDB-shell.html"> MongoDB shell </a>ã€<a href="https://mrbird.cc/MongoDB%E6%96%87%E6%A1%A3CUD.html"> MongoDBæ–‡æ¡£CUD </a>å’Œ<a href="https://mrbird.cc/MongoDB-%E6%96%87%E6%A1%A3%E6%9F%A5%E8%AF%A2.html"> MongoDB æ–‡æ¡£æŸ¥è¯¢ </a>ã€‚</p><a id="more"></a><p>æ–°å»ºä¸€ä¸ªSpring Booté¡¹ç›®ï¼Œç‰ˆæœ¬ä¸º2.1.3.RELEASEï¼Œå¹¶å¼•å…¥å¦‚ä¸‹ä¾èµ–ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-mongodb<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p></p><p>ç„¶åå¯ä»¥é€šè¿‡Mongo Shellæˆ–è€…Mongo Compasså·¥å…·åˆ›å»ºä¸€ä¸ªåç§°ä¸ºtestdbçš„æ•°æ®åº“ï¼Œå¹¶æ–°å¢useræ–‡æ¡£ï¼ˆæ–‡æ¡£ï¼Œç±»ä¼¼ä¸å…³ç³»å‹æ•°æ®åº“é‡Œçš„æ•°æ®è¡¨ï¼‰ï¼š</p><p><img src="img/QQæˆªå›¾20190402141210.png" alt="QQæˆªå›¾20190402141210.png"></p><p>åœ¨é…ç½®æ–‡ä»¶application.ymlé‡Œé…ç½®Mongo DBï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  data:</span></span><br><span class="line"><span class="attr">    mongodb:</span></span><br><span class="line"><span class="attr">      host:</span> <span class="string">localhost</span></span><br><span class="line"><span class="attr">      port:</span> <span class="number">27017</span></span><br><span class="line"><span class="attr">      database:</span> <span class="string">testdb</span></span><br></pre></td></tr></table></figure><p></p><p>Mongo DBçš„é»˜è®¤ç«¯å£ä¸º27017ï¼Œä½¿ç”¨çš„æ•°æ®åº“ä¸ºåˆšåˆšåˆ›å»ºçš„testdbã€‚</p><p>åˆ›å»ºUserå®ä½“ç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Document</span>(collection = <span class="string">"user"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String description;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// get set ç•¥</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>@Document(collection = &quot;user&quot;)</code>è¡¨æ˜è¿™æ˜¯ä¸€ä¸ªæ–‡æ¡£å¯¹è±¡ï¼Œåç§°ä¸º<code>user</code>ï¼Œå¯¹åº”Mongo DBé‡Œçš„userè¡¨ã€‚<code>@Id</code>æ ‡æ³¨ä¸»é”®å­—æ®µï¼ŒStringç±»å‹çš„ä¸»é”®å€¼åœ¨æ’å…¥çš„æ—¶å€™Mongo DBä¼šå¸®æˆ‘ä»¬è‡ªåŠ¨ç”Ÿæˆã€‚å¦‚æœå¯¹è±¡ä¸­çš„æŸä¸ªå±æ€§ä¸ºéè¡¨å­—æ®µï¼Œå¯ä»¥ä½¿ç”¨æ³¨è§£<code>@Transient</code>è¿›è¡Œæ’é™¤ã€‚</p><p>å‡†å¤‡å¥½è¿™äº›åï¼Œæˆ‘ä»¬å¼€å§‹ç¼–å†™ä¸€äº›ç®€å•çš„å¢åˆ æ”¹æŸ¥æ ·ä¾‹ã€‚</p><h2 id="ç®€å•å¢åˆ æ”¹æŸ¥"><a href="#ç®€å•å¢åˆ æ”¹æŸ¥" class="headerlink" title="ç®€å•å¢åˆ æ”¹æŸ¥"></a>ç®€å•å¢åˆ æ”¹æŸ¥</h2><p>åˆ›å»ºä¸€ä¸ªUserDaoæ¥å£ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserDao</span> <span class="keyword">extends</span> <span class="title">MongoRepository</span>&lt;<span class="title">User</span>, <span class="title">String</span>&gt; </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>æ¥å£ç»§æ‰¿è‡ª<code>MongoRepository</code>ï¼Œæ³›å‹åˆ†åˆ«ä¸ºå®ä½“å¯¹è±¡å’Œä¸»é”®ç±»å‹ã€‚é€šè¿‡ç»§æ‰¿<code>MongoRepository</code>ï¼Œ<code>UserDao</code>åŒ…å«äº†ä¸€äº›å¢åˆ æ”¹æŸ¥çš„æ–¹æ³•ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="img/QQæˆªå›¾20190404094010.png" alt="QQæˆªå›¾20190404094010.png"></p><p>æ¥ç€ç¼–å†™UserServiceï¼Œä¸ºäº†æ–¹ä¾¿è¿™é‡Œä¸å†ç¼–å†™æ¥å£ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserDao userDao;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;User&gt; <span class="title">getUsers</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userDao.findAll();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Optional&lt;User&gt; <span class="title">getUser</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.userDao.findById(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ–°å¢å’Œä¿®æ”¹éƒ½æ˜¯ saveæ–¹æ³•ï¼Œ</span></span><br><span class="line"><span class="comment">     * id å­˜åœ¨ä¸ºä¿®æ”¹ï¼Œid ä¸å­˜åœ¨ä¸ºæ–°å¢</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">createUser</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">        user.setId(<span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">return</span> userDao.save(user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteUser</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.userDao.findById(id)</span><br><span class="line">                .ifPresent(user -&gt; <span class="keyword">this</span>.userDao.delete(user));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateUser</span><span class="params">(String id, User user)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.userDao.findById(id)</span><br><span class="line">            .ifPresent(</span><br><span class="line">                u -&gt; &#123;</span><br><span class="line">                    u.setName(user.getName());</span><br><span class="line">                    u.setAge(user.getAge());</span><br><span class="line">                    u.setDescription(user.getDescription());</span><br><span class="line">                    <span class="keyword">this</span>.userDao.save(u);</span><br><span class="line">                &#125;</span><br><span class="line">            );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ä¸Šé¢æˆ‘ä»¬ç¼–å†™äº†åŸºæœ¬çš„å¢åˆ æ”¹æŸ¥æ ·ä¾‹ï¼Œæ–°å¢å’Œä¿®æ”¹éƒ½æ˜¯é€šè¿‡<code>save</code>æ–¹æ³•å®Œæˆçš„ï¼Œå½“ä¸»é”®å­˜åœ¨æ—¶åˆ™ä¸ºä¿®æ”¹ï¼Œä¸»é”®ä¸å­˜åœ¨åˆ™ä¸ºæ–°å¢ã€‚</p><p>æœ€åç¼–å†™ä¸€ä¸ªRESTfulçš„UserControllerï¼ˆä¸ºäº†æ–¹ä¾¿ï¼Œæ²¡æœ‰å¯¹å‚æ•°è¿›è¡Œæ ¡éªŒï¼‰ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"user"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;User&gt; <span class="title">getUsers</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userService.getUsers();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">createUser</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userService.createUser(user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@DeleteMapping</span>(<span class="string">"/&#123;id&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteUser</span><span class="params">(@PathVariable String id)</span> </span>&#123;</span><br><span class="line">        userService.deleteUser(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PutMapping</span>(<span class="string">"/&#123;id&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateUser</span><span class="params">(@PathVariable String id, User user)</span> </span>&#123;</span><br><span class="line">        userService.updateUser(id, user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ ¹æ®ç”¨æˆ· idæŸ¥æ‰¾</span></span><br><span class="line"><span class="comment">     * å­˜åœ¨è¿”å›ï¼Œä¸å­˜åœ¨è¿”å› null</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/&#123;id&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">getUser</span><span class="params">(@PathVariable String id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userService.getUser(id).orElse(<span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>å¯åŠ¨é¡¹ç›®ï¼Œä½¿ç”¨postmanæ¥æµ‹è¯•æ¥å£çš„å¯ç”¨æ€§ã€‚</p><p>æµ‹è¯•æ–°å¢ç”¨æˆ·ï¼š</p><p><img src="img/QQæˆªå›¾20190404094900.png" alt="QQæˆªå›¾20190402142923.png"></p><p>æ–°å¢æˆåŠŸï¼ŒæŸ¥çœ‹æ•°æ®åº“ï¼š</p><p><img src="img/QQæˆªå›¾20190404094944.png" alt="QQæˆªå›¾20190404094944.png"></p><p>æµ‹è¯•æŸ¥è¯¢ç”¨æˆ·ï¼š</p><p><img src="img/QQæˆªå›¾20190404095026.png" alt="QQæˆªå›¾20190402143028.png"></p><p>æŸ¥è¯¢æˆåŠŸã€‚</p><p>æµ‹è¯•é€šè¿‡ç”¨IDæŸ¥æ‰¾ç”¨æˆ·ï¼š</p><p><img src="img/QQæˆªå›¾20190404095104.png" alt="QQæˆªå›¾20190402143107.png"></p><p>æ›´æ–°ç”¨æˆ·ï¼š</p><p><img src="img/QQæˆªå›¾20190404095151.png" alt="QQæˆªå›¾20190402143139.png"></p><p>æŸ¥çœ‹æ•°æ®åº“æ˜¯å¦æ›´æ–°æˆåŠŸï¼š</p><p><img src="img/QQæˆªå›¾20190404095609.png" alt="QQæˆªå›¾20190402143232.png"></p><p>æ›´æ–°æˆåŠŸã€‚</p><p>æœ€åæµ‹è¯•é€šè¿‡ç”¨æˆ·IDåˆ é™¤ç”¨æˆ·ï¼š</p><p><img src="img/QQæˆªå›¾20190404095646.png" alt="QQæˆªå›¾20190402143320.png"></p><p>è¿”å›çŠ¶æ€ç 200ï¼Œåˆ é™¤æˆåŠŸã€‚</p><p>æŸ¥çœ‹æ•°æ®åº“ï¼Œåˆ é™¤æˆåŠŸï¼š</p><p><img src="img/QQæˆªå›¾20190404095710.png" alt="QQæˆªå›¾20190404095710.png"></p><h2 id="å¤šæ¡ä»¶æŸ¥è¯¢"><a href="#å¤šæ¡ä»¶æŸ¥è¯¢" class="headerlink" title="å¤šæ¡ä»¶æŸ¥è¯¢"></a>å¤šæ¡ä»¶æŸ¥è¯¢</h2><p>å…¶å®<code>UserDao</code>é€šè¿‡ç»§æ‰¿<code>MongoRepository</code>å·²ç»å…·æœ‰äº†JPAçš„ç‰¹æ€§ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æ–¹æ³•åæ¥æ„å»ºå¤šæŸ¥è¯¢æ¡ä»¶çš„SQLã€‚æ¯”å¦‚é€šè¿‡ç”¨æˆ·çš„å¹´é¾„æ®µæ¥æŸ¥è¯¢ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserDao</span> <span class="keyword">extends</span> <span class="title">MongoRepository</span>&lt;<span class="title">User</span>, <span class="title">String</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ ¹æ®å¹´é¾„æ®µæ¥æŸ¥æ‰¾</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> from from</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> to   to</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> List&lt;User&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">List&lt;User&gt; <span class="title">findByAgeBetween</span><span class="params">(Integer from, Integer to)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>åœ¨è¾“å…¥<code>findBy</code>åï¼ŒIDEAä¼šæ ¹æ®å®ä½“å¯¹è±¡çš„å±æ€§å’ŒSQLçš„å„ç§å…³é”®å­—è‡ªåŠ¨ç»„åˆæç¤ºï¼š</p><p><img src="img/fasdfasdf.png" alt="QQæˆªå›¾20190404101118.png"></p><p>æ¯”å¦‚å†åœ¨åˆ›å»ºä¸€ä¸ªé€šè¿‡å¹´é¾„æ®µï¼Œç”¨æˆ·åå’Œæè¿°ï¼ˆæ¨¡ç³ŠæŸ¥è¯¢ï¼‰æŸ¥è¯¢ç”¨æˆ·çš„æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * é€šè¿‡å¹´é¾„æ®µï¼Œç”¨æˆ·åï¼Œæè¿°ï¼ˆæ¨¡ç³ŠæŸ¥è¯¢ï¼‰</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> from        from</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> to          to</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> name        name</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> description description</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> List&lt;User&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function">List&lt;User&gt; <span class="title">findByAgeBetweenAndNameEqualsAndDescriptionIsLike</span><span class="params">(Integer from, Integer to, String name, String description)</span></span>;</span><br></pre></td></tr></table></figure><p>æ–¹æ³•å‚æ•°ä¸ªæ•°éœ€è¦å’Œæ–¹æ³•åä¸­æ‰€éœ€è¦çš„å‚æ•°ä¸ªæ•°å¯¹åº”ä¸Šã€‚</p><h2 id="æ’åºä¸åˆ†é¡µ"><a href="#æ’åºä¸åˆ†é¡µ" class="headerlink" title="æ’åºä¸åˆ†é¡µ"></a>æ’åºä¸åˆ†é¡µ</h2><p>æ’åºå’Œåˆ†é¡µéœ€è¦ä½¿ç”¨<code>MongoTemplate</code>å¯¹è±¡æ¥å®Œæˆï¼Œåœ¨<code>UserService</code>é‡Œæ–°å¢ä¸€ä¸ª<code>getUserByCondition</code>æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> MongoTemplate template;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Page&lt;User&gt; <span class="title">getUserByCondition</span><span class="params">(<span class="keyword">int</span> size, <span class="keyword">int</span> page, User user)</span> </span>&#123;</span><br><span class="line">    Query query = <span class="keyword">new</span> Query();</span><br><span class="line">    Criteria criteria = <span class="keyword">new</span> Criteria();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!StringUtils.isEmpty(user.getName())) &#123;</span><br><span class="line">        criteria.and(<span class="string">"name"</span>).is(user.getName());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!StringUtils.isEmpty(user.getDescription())) &#123;</span><br><span class="line">        criteria.and(<span class="string">"description"</span>).regex(user.getDescription());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    query.addCriteria(criteria);</span><br><span class="line"></span><br><span class="line">    Sort sort = <span class="keyword">new</span> Sort(Sort.Direction.DESC, <span class="string">"age"</span>);</span><br><span class="line">    Pageable pageable = PageRequest.of(page, size, sort);</span><br><span class="line"></span><br><span class="line">    List&lt;User&gt; users = template.find(query.with(pageable), User.class);</span><br><span class="line">    <span class="keyword">return</span> PageableExecutionUtils.getPage(users, pageable, () -&gt; template.count(query, User.class));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p><code>size</code>è¡¨ç¤ºæ¯é¡µæ˜¾ç¤ºçš„æ¡æ•°ï¼Œ<code>page</code>è¡¨ç¤ºå½“å‰é¡µç æ•°ï¼Œ0è¡¨ç¤ºç¬¬ä¸€é¡µã€‚ä¸Šé¢çš„æ–¹æ³•é€šè¿‡<code>name</code>å’Œ<code>description</code>ï¼ˆæ¨¡ç³ŠæŸ¥è¯¢ï¼‰æ¥æŸ¥è¯¢ç”¨æˆ·åˆ†é¡µä¿¡æ¯ï¼Œå¹¶ä¸”æŸ¥è¯¢ç»“æœä½¿ç”¨<code>age</code>å­—æ®µé™åºæ’åºã€‚æ–¹æ³•è¿”å›<code>Page</code>å¯¹è±¡ã€‚</p><p>åœ¨<code>UserController</code>é‡Œæ·»åŠ ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping</span>(<span class="string">"/condition"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Page&lt;User&gt; <span class="title">getUserByCondition</span><span class="params">(<span class="keyword">int</span> size, <span class="keyword">int</span> page, User user)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> userService.getUserByCondition(size, page, user);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>é‡å¯é¡¹ç›®ï¼Œæˆ‘ä»¬å¾€æ•°æ®åº“é‡Œå¤šåŠ å‡ æ¡æ•°æ®ï¼š</p><p><img src="img/QQæˆªå›¾20190404102609.png" alt="QQæˆªå›¾20190404102609.png"></p><p>è·å–ç¬¬1é¡µæ•°æ®ï¼Œæ¯é¡µæ˜¾ç¤º10æ¡ï¼š</p><p><img src="img/QQæˆªå›¾20190404102736.png" alt="QQæˆªå›¾20190404102736.png"></p><p>è¿”å›æ•°æ®ï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"content"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"id"</span>: <span class="string">"5ca56ae2f08f0b6048fd470d"</span>,</span><br><span class="line">            <span class="attr">"name"</span>: <span class="string">"jane"</span>,</span><br><span class="line">            <span class="attr">"age"</span>: <span class="number">26</span>,</span><br><span class="line">            <span class="attr">"description"</span>: <span class="string">"web developer"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"id"</span>: <span class="string">"5ca56ad1f08f0b6048fd470c"</span>,</span><br><span class="line">            <span class="attr">"name"</span>: <span class="string">"scott"</span>,</span><br><span class="line">            <span class="attr">"age"</span>: <span class="number">23</span>,</span><br><span class="line">            <span class="attr">"description"</span>: <span class="string">"ui designer"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"id"</span>: <span class="string">"5ca56afaf08f0b6048fd470e"</span>,</span><br><span class="line">            <span class="attr">"name"</span>: <span class="string">"mike"</span>,</span><br><span class="line">            <span class="attr">"age"</span>: <span class="number">21</span>,</span><br><span class="line">            <span class="attr">"description"</span>: <span class="string">"python developer"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"id"</span>: <span class="string">"5ca56b38f08f0b6048fd470f"</span>,</span><br><span class="line">            <span class="attr">"name"</span>: <span class="string">"mrbird"</span>,</span><br><span class="line">            <span class="attr">"age"</span>: <span class="number">18</span>,</span><br><span class="line">            <span class="attr">"description"</span>: <span class="string">"java noob"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"pageable"</span>: &#123;</span><br><span class="line">        <span class="attr">"sort"</span>: &#123;</span><br><span class="line">            <span class="attr">"sorted"</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">"unsorted"</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">"empty"</span>: <span class="literal">false</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"offset"</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">"pageSize"</span>: <span class="number">10</span>,</span><br><span class="line">        <span class="attr">"pageNumber"</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">"unpaged"</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">"paged"</span>: <span class="literal">true</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"last"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">"totalPages"</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">"totalElements"</span>: <span class="number">4</span>,</span><br><span class="line">    <span class="attr">"number"</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">"size"</span>: <span class="number">10</span>,</span><br><span class="line">    <span class="attr">"sort"</span>: &#123;</span><br><span class="line">        <span class="attr">"sorted"</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">"unsorted"</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">"empty"</span>: <span class="literal">false</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"numberOfElements"</span>: <span class="number">4</span>,</span><br><span class="line">    <span class="attr">"first"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">"empty"</span>: <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>å‰©ä¸‹å¯ä»¥è‡ªå·±æµ‹è¯•ã€‚</p><p>postmanæµ‹è¯•æ ·ä¾‹åŠæºç é“¾æ¥ï¼š<a href="https://github.com/wuyouzhuguli/SpringAll/tree/master/56.Spring-Boot-MongoDB-crud" target="_blank" rel="noopener">https://github.com/wuyouzhuguli/SpringAll/tree/master/56.Spring-Boot-MongoDB-crud</a></p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Wed May 15 2019 17:13:43 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;è¿™èŠ‚æˆ‘ä»¬å°†æ•´åˆSpring Bootä¸Mongo DBå®ç°å¢åˆ æ”¹æŸ¥çš„åŠŸèƒ½ï¼Œå¹¶ä¸”å®ç°åºåˆ—é€’å¢ã€‚Mongo DBä¸‹è½½åœ°å€ï¼š&lt;a href=&quot;https://www.mongodb.com/download-center/community&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://www.mongodb.com/download-center/community&lt;/a&gt;ã€‚Mongo DBçš„åŸºæœ¬ä»‹ç»å’Œå¢åˆ æ”¹æŸ¥çš„ç”¨æ³•å¯ä»¥å‚è€ƒæˆ‘ä¹‹å‰çš„æ–‡ç« ï¼š&lt;a href=&quot;https://mrbird.cc/MongoDB-shell.html&quot;&gt; MongoDB shell &lt;/a&gt;ã€&lt;a href=&quot;https://mrbird.cc/MongoDB%E6%96%87%E6%A1%A3CUD.html&quot;&gt; MongoDBæ–‡æ¡£CUD &lt;/a&gt;å’Œ&lt;a href=&quot;https://mrbird.cc/MongoDB-%E6%96%87%E6%A1%A3%E6%9F%A5%E8%AF%A2.html&quot;&gt; MongoDB æ–‡æ¡£æŸ¥è¯¢ &lt;/a&gt;ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Spring Boot" scheme="http://mrbird.cc/tags/Spring-Boot/"/>
    
      <category term="MongoDB" scheme="http://mrbird.cc/tags/MongoDB/"/>
    
  </entry>
  
  <entry>
    <title>Java 9 Flow API å­¦ä¹ </title>
    <link href="http://mrbird.cc/Java-9-Flow-API-Learn.html"/>
    <id>http://mrbird.cc/Java-9-Flow-API-Learn.html</id>
    <published>2018-11-10T02:46:14.000Z</published>
    <updated>2019-02-26T11:28:18.786Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Wed May 15 2019 17:13:43 GMT+0800 (GMT+08:00) --><p>å“åº”å¼ç¼–ç¨‹ï¼ˆReactive Programmingï¼‰å¯ä»¥ç†è§£ä¸ºä¸€ç§å¤„ç†æ•°æ®é¡¹ï¼ˆData Itemï¼‰çš„å¼‚æ­¥æµï¼Œå³åœ¨æ•°æ®é¡¹äº§ç”Ÿçš„æ—¶å€™ï¼Œæ¥æ”¶è€…å°±å¯¹å…¶è¿›è¡Œå“åº”ã€‚åœ¨å“åº”å¼ç¼–ç¨‹ä¸­ï¼Œä¼šæœ‰ä¸€ä¸ªæ•°æ®å‘å¸ƒè€…ï¼ˆPublisherï¼‰å’Œæ•°æ®è®¢é˜…è€…ï¼ˆSubscriberï¼‰ï¼Œåè€…ç”¨äºå¼‚æ­¥æ¥æ”¶å‘å¸ƒè€…å‘å¸ƒçš„æ•°æ®ã€‚åœ¨è¯¥æ¨¡å¼ä¸­ï¼Œè¿˜å¼•å…¥äº†ä¸€ä¸ªæ›´é«˜çº§çš„ç‰¹æ€§ï¼šæ•°æ®å¤„ç†å™¨ï¼ˆProcessorï¼‰ï¼Œå®ƒç”¨äºå°†æ•°æ®å‘å¸ƒè€…å‘å¸ƒçš„æ•°æ®è¿›è¡ŒæŸäº›è½¬æ¢æ“ä½œï¼Œç„¶åå†å‘å¸ƒç»™æ•°æ®è®¢é˜…è€…ã€‚</p><p>æ€»ä¹‹ï¼Œå“åº”å¼ç¼–ç¨‹æ˜¯å¼‚æ­¥éé˜»å¡ç¼–ç¨‹ï¼Œèƒ½å¤Ÿæå‡ç¨‹åºæ€§èƒ½ï¼Œå¯ä»¥è§£å†³ä¼ ç»Ÿç¼–ç¨‹æ¨¡å‹é‡åˆ°çš„å›°å¢ƒã€‚åŸºäºè¿™ä¸ªæ¨¡å‹å®ç°çš„æœ‰Java 9 Flow APIã€RxJavaå’ŒReactorç­‰ï¼Œè¿™é‡Œä¸»è¦ä»‹ç»çš„æ˜¯Java 9 Flow APIçš„ä½¿ç”¨ã€‚</p><a id="more"></a><h2 id="Flowæ¥å£æ¦‚è§ˆ"><a href="#Flowæ¥å£æ¦‚è§ˆ" class="headerlink" title="Flowæ¥å£æ¦‚è§ˆ"></a>Flowæ¥å£æ¦‚è§ˆ</h2><p>Java 9 æ–°å¢äº†ä¸€ä¸ª<code>Flow</code>æ¥å£ï¼Œä½äº<code>java.util.concurrent</code>è·¯å¾„ä¸‹ï¼Œæ„æˆå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="img/QQæˆªå›¾20190226141817.png" alt="QQæˆªå›¾20190226141817.png"></p><p>å…¶ä¸­<code>Publisher</code>ä¸ºæ•°æ®å‘å¸ƒè€…ï¼Œ<code>Subscriber</code>ä¸ºæ•°æ®è®¢é˜…è€…ï¼Œ<code>Subscription</code>ä¸ºå‘å¸ƒè€…å’Œè®¢é˜…è€…ä¹‹é—´çš„è®¢é˜…å…³ç³»ï¼Œ<code>Processor</code>ä¸ºæ•°æ®å¤„ç†å™¨ã€‚</p><h3 id="Publisher"><a href="#Publisher" class="headerlink" title="Publisher"></a>Publisher</h3><p><code>Publisher</code>éƒ¨åˆ†çš„æºç å¦‚ä¸‹æ‰€ç¤º:</p><p><img src="img/QQæˆªå›¾20190226142214.png" alt="QQæˆªå›¾20190226142214.png"></p><p>å®ƒæ˜¯ä¸€ä¸ªå‡½æ•°å¼æ¥å£ï¼ŒåªåŒ…å«ä¸€ä¸ª<code>subscribe</code>æ–¹æ³•ï¼Œé€šè¿‡è¿™ä¸ªæ–¹æ³•å°†æ•°æ®å‘å¸ƒå‡ºå»ã€‚</p><h3 id="Subscriber"><a href="#Subscriber" class="headerlink" title="Subscriber"></a>Subscriber</h3><p><code>Subscriber</code>éƒ¨åˆ†çš„æºç å¦‚ä¸‹æ‰€ç¤º: <img src="img/QQæˆªå›¾20190226142519.png" alt="QQæˆªå›¾20190226142519.png"></p><p>è¯¥æ¥å£åŒ…å«äº†å››ä¸ªæ–¹æ³•ï¼š</p><table><tr><th>æ–¹æ³•</th><th>æè¿°</th></tr><tr><td>onSubscribe</td><td>è®¢é˜…æˆåŠŸçš„å›è°ƒæ–¹æ³•ï¼Œç”¨äºåˆå§‹åŒ–<code>Subscription</code>ï¼Œå¹¶ä¸”è¡¨æ˜å¯ä»¥å¼€å§‹æ¥æ”¶è®¢é˜…æ•°æ®äº†</td></tr><tr><td>onNext</td><td>æ¥æ”¶ä¸‹ä¸€é¡¹è®¢é˜…æ•°æ®çš„å›è°ƒæ–¹æ³•</td></tr><tr><td>onError</td><td>åœ¨Publisheræˆ–Subcriberé‡åˆ°ä¸å¯æ¢å¤çš„é”™è¯¯æ—¶è°ƒç”¨æ­¤æ–¹æ³•ï¼ŒSubscriberä¸å†æ¥æ”¶è®¢é˜…æ¶ˆæ¯</td></tr><tr><td>onComplete</td><td>å½“æ¥æ”¶å®Œæ‰€æœ‰è®¢é˜…æ•°æ®ï¼Œå¹¶ä¸”å‘å¸ƒè€…å·²ç»å…³é—­åä¼šå›è°ƒè¿™ä¸ªæ–¹æ³•</td></tr></table><h3 id="Subscription"><a href="#Subscription" class="headerlink" title="Subscription"></a>Subscription</h3><p><code>Subscription</code>éƒ¨åˆ†çš„æºç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><img src="img/QQæˆªå›¾20190226143424.png" alt="QQæˆªå›¾20190226143424.png"></p><p>è¯¥æ¥å£åŒ…å«äº†ä¸¤ä¸ªæ–¹æ³•ï¼š</p><table><tr><th>æ–¹æ³•</th><th>æè¿°</th></tr><tr><td>request</td><td>ç”¨äºå‘æ•°æ®å‘å¸ƒè€…è¯·æ±‚nä¸ªæ•°æ®é¡¹</td></tr><tr><td>cancel</td><td>å–æ¶ˆæ¶ˆæ¯è®¢é˜…ï¼Œè®¢é˜…è€…å°†ä¸å†æ¥æ”¶æ•°æ®</td></tr></table><h3 id="Processor"><a href="#Processor" class="headerlink" title="Processor"></a>Processor</h3><p><code>Processor</code>éƒ¨åˆ†çš„ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><img src="img/QQæˆªå›¾20190226143709.png" alt="QQæˆªå›¾20190226143709.png"></p><p>å®ƒæ˜¯ä¸€ä¸ªç©ºæ¥å£ï¼Œä½†æ˜¯å®ƒç»§æ‰¿äº†<code>Publisher</code>å’Œ<code>Subscriber</code>ï¼Œæ‰€ä»¥å®ƒæ—¢èƒ½å‘å¸ƒæ•°æ®ä¹Ÿèƒ½è®¢é˜…æ•°æ®ã€‚åŸºäºè¿™ä¸ªç‰¹æ€§ï¼Œå®ƒå¯ä»¥å……å½“æ•°æ®è½¬æ¢çš„è§’è‰²ï¼Œå…ˆä»æ•°æ®å‘å¸ƒè€…é‚£æ¥æ”¶æ•°æ®é¡¹ï¼Œç„¶åç»è¿‡å¤„ç†åå†å‘å¸ƒç»™æœ€ç»ˆçš„æ•°æ®è®¢é˜…è€…ã€‚</p><h2 id="å‘å¸ƒè®¢é˜…ç¤ºä¾‹"><a href="#å‘å¸ƒè®¢é˜…ç¤ºä¾‹" class="headerlink" title="å‘å¸ƒè®¢é˜…ç¤ºä¾‹"></a>å‘å¸ƒè®¢é˜…ç¤ºä¾‹</h2><p>æ¥ä¸‹æ¥æˆ‘ä»¬ä¸¾ä¸ªæ•°æ®å‘å¸ƒå’Œæ•°æ®è®¢é˜…çš„ç®€å•ç¤ºä¾‹ï¼Œä»¥æ­¤äº†è§£Java 9 Flow APIçš„ä½¿ç”¨ã€‚å…ˆå…¥ä¸ºä¸»ï¼Œç›´æ¥è´´å‡ºæ•´ä¸ªç¤ºä¾‹ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FlowApiTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="comment">// 1. å®šä¹‰ String ç±»å‹çš„æ•°æ®å‘å¸ƒè€…ï¼ŒJDK 9è‡ªå¸¦çš„</span></span><br><span class="line">        <span class="comment">// SubmissionPublisher å®ç°äº† Publisher</span></span><br><span class="line">        SubmissionPublisher&lt;String&gt; publisher = <span class="keyword">new</span> SubmissionPublisher&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. åˆ›å»ºä¸€ä¸ªè®¢é˜…è€…ï¼Œç”¨äºæ¥æ”¶å‘å¸ƒè€…çš„æ¶ˆæ¯</span></span><br><span class="line">        Subscriber&lt;String&gt; subscriber = <span class="keyword">new</span> Subscriber&lt;&gt;() &#123;</span><br><span class="line">            <span class="keyword">private</span> Subscription subscription;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSubscribe</span><span class="params">(Subscription subscription)</span> </span>&#123;</span><br><span class="line">                <span class="comment">// é€šè¿‡ Subscription å’Œå‘å¸ƒè€…ä¿æŒè®¢é˜…å…³ç³»ï¼Œå¹¶ç”¨å®ƒæ¥ç»™å‘å¸ƒè€…åé¦ˆ</span></span><br><span class="line">                <span class="keyword">this</span>.subscription = subscription;</span><br><span class="line">                <span class="comment">// è¯·æ±‚ä¸€ä¸ªæ•°æ®</span></span><br><span class="line">                <span class="keyword">this</span>.subscription.request(<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(String item)</span> </span>&#123;</span><br><span class="line">                <span class="comment">// æ¥æ”¶å‘å¸ƒè€…å‘å¸ƒçš„æ¶ˆæ¯</span></span><br><span class="line">                System.out.println(<span class="string">"ã€è®¢é˜…è€…ã€‘æ¥æ”¶æ¶ˆæ¯ &lt;------ "</span> + item);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// æ¥æ”¶åå†æ¬¡è¯·æ±‚ä¸€ä¸ªæ•°æ®</span></span><br><span class="line">                <span class="keyword">this</span>.subscription.request(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// å¦‚æœä¸æƒ³å†æ¥æ”¶æ•°æ®ï¼Œä¹Ÿå¯ä»¥ç›´æ¥è°ƒç”¨ cancelï¼Œè¡¨ç¤ºä¸å†æ¥æ”¶äº†</span></span><br><span class="line">                <span class="comment">// this.subscription.cancel();</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable throwable)</span> </span>&#123;</span><br><span class="line">                <span class="comment">// è¿‡ç¨‹ä¸­å‡ºç°å¼‚å¸¸ä¼šå›è°ƒè¿™ä¸ªæ–¹æ³•</span></span><br><span class="line">                System.out.println(<span class="string">"ã€è®¢é˜…è€…ã€‘æ•°æ®æ¥æ”¶å‡ºç°å¼‚å¸¸ï¼Œ"</span> + throwable);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// å‡ºç°å¼‚å¸¸ï¼Œå–æ¶ˆè®¢é˜…ï¼Œå‘Šè¯‰å‘å¸ƒè€…æˆ‘ä¸å†æ¥æ”¶æ•°æ®äº†</span></span><br><span class="line">                <span class="comment">// å®é™…æµ‹è¯•å‘ç°ï¼Œåªè¦è®¢é˜…è€…æ¥æ”¶æ¶ˆæ¯å‡ºç°å¼‚å¸¸ï¼Œè¿›å…¥äº†è¿™ä¸ªå›è°ƒ</span></span><br><span class="line">                <span class="comment">// è®¢é˜…è€…å°±ä¸ä¼šå†ç»§ç»­æ¥æ”¶æ¶ˆæ¯äº†</span></span><br><span class="line">                <span class="keyword">this</span>.subscription.cancel();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onComplete</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="comment">// å½“å‘å¸ƒè€…å‘å‡ºçš„æ•°æ®éƒ½è¢«æ¥æ”¶äº†ï¼Œ</span></span><br><span class="line">                <span class="comment">// å¹¶ä¸”å‘å¸ƒè€…å…³é—­åï¼Œä¼šå›è°ƒè¿™ä¸ªæ–¹æ³•</span></span><br><span class="line">                System.out.println(<span class="string">"ã€è®¢é˜…è€…ã€‘æ•°æ®æ¥æ”¶å®Œæ¯•"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. å‘å¸ƒè€…å’Œè®¢é˜…è€…éœ€è¦å»ºç«‹å…³ç³»</span></span><br><span class="line">        publisher.subscribe(subscriber);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4. å‘å¸ƒè€…å¼€å§‹å‘å¸ƒæ•°æ®</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            String message = <span class="string">"hello flow api "</span> + i;</span><br><span class="line">            System.out.println(<span class="string">"ã€å‘å¸ƒè€…ã€‘å‘å¸ƒæ¶ˆæ¯ ------&gt; "</span> + message);</span><br><span class="line">            publisher.submit(message);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5. å‘å¸ƒç»“æŸåï¼Œå…³é—­å‘å¸ƒè€…</span></span><br><span class="line">        publisher.close();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// mainçº¿ç¨‹å»¶è¿Ÿå…³é—­ï¼Œä¸ç„¶è®¢é˜…è€…è¿˜æ²¡æ¥æ”¶å®Œæ¶ˆæ¯ï¼Œçº¿ç¨‹å°±è¢«å…³é—­äº†</span></span><br><span class="line">        Thread.currentThread().join(<span class="number">2000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢ä½¿ç”¨JDK è‡ªå¸¦çš„<code>Publisher</code>å®ç°ç±»<code>SubmissionPublisher</code>æ¥å‘å¸ƒ Stringç±»å‹çš„æ•°æ®ï¼Œç„¶åç”¨åŒ¿åå®ç°ç±»çš„æ–¹å¼åˆ›å»ºäº†ä¸€ä¸ª<code>Subscriber</code>å®ç°ç±»ã€‚æ¥ç€ä½¿ç”¨<code>SubmissionPublisher</code>çš„<code>subscribe</code>æ–¹æ³•æ¥ä¸ºå‘å¸ƒè€…å’Œè®¢é˜…è€…å»ºç«‹å…³ç³»ã€‚å»ºç«‹å…³ç³»åï¼Œå‘å¸ƒè€…å°±å¯ä»¥å‘å¸ƒæ•°æ®ï¼Œæ¥æ”¶è€…ä¹Ÿå¼€å§‹æ¥æ”¶æ•°æ®ã€‚è¯¦ç»†çš„è¯´æ˜æ³¨é‡Šé‡Œéƒ½å†™äº†ï¼Œè¿™é‡Œå°±ä¸å†èµ˜è¿°ä»£ç çš„é€»è¾‘äº†ã€‚</p><p>ç¨‹åºçš„è¾“å‡ºå¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><img src="img/QQæˆªå›¾20190226144617.png" alt="QQæˆªå›¾20190226144617.png"></p><h2 id="æ¨¡æ‹ŸèƒŒå‹"><a href="#æ¨¡æ‹ŸèƒŒå‹" class="headerlink" title="æ¨¡æ‹ŸèƒŒå‹"></a>æ¨¡æ‹ŸèƒŒå‹</h2><p>æ‰€è°“çš„<a href="https://en.wikipedia.org/wiki/Back_pressure" target="_blank" rel="noopener">èƒŒå‹</a>ï¼ˆBackpressureï¼‰é€šä¿—çš„è®²å°±æ˜¯æ•°æ®æ¥æ”¶è€…çš„å‹åŠ›ï¼Œä¼ ç»Ÿæ¨¡å¼ä¸‹ï¼Œå‘å¸ƒè€…åªå…³å¿ƒæ•°æ®çš„åˆ›é€ ä¸å‘å¸ƒï¼Œè€Œå½“æ•°æ®å‘å¸ƒé€Ÿç‡è¿œé«˜äºæ•°æ®æ¥æ”¶é€Ÿç‡çš„æ—¶å€™ï¼Œæ•°æ®æ¥æ”¶è€…ç¼“å†²åŒºå°†è¢«å¡«æ»¡ï¼Œæ— æ³•å†æ¥æ”¶æ•°æ®ã€‚å‘å¸ƒè€…å¹¶ä¸å…³å¿ƒè¿™äº›ï¼Œä¾æ—§ä¸æ–­åœ°å‘é€æ•°æ®ï¼Œæ‰€ä»¥å°±é€ æˆäº†IOé˜»å¡ã€‚</p><p>åŸºäºå“åº”å¼æ¨¡å‹å®ç°çš„Flow APIå¯ä»¥å¾ˆå¥½åœ°è§£å†³è¿™ä¸ªé—®é¢˜ã€‚åœ¨Java 9çš„Flow APIå®šä¹‰ä¸­ï¼Œ<code>Subscriber</code>ä¼šå°†<code>Publisher</code>å‘å¸ƒçš„æ•°æ®ç¼“å†²åœ¨<code>Subscription</code>ä¸­ï¼Œå…¶é•¿åº¦é»˜è®¤ä¸º256ï¼š</p><p><img src="img/QQæˆªå›¾20190226150028.png" alt="QQæˆªå›¾20190226150028.png"></p><p>å‡å¦‚å½“è¿™ä¸ªç¼“å†²åŒºéƒ½è¢«å¡«æ»¡åï¼Œ<code>Publisher</code>å°†ä¼šåœæ­¢å‘é€æ•°æ®ï¼Œç›´åˆ°<code>Subscriber</code>æ¥æ”¶äº†æ•°æ®<code>Subscription</code>æœ‰ç©ºé—²ä½ç½®çš„æ—¶å€™ï¼Œ<code>Publisher</code>æ‰ä¼šç»§ç»­å‘å¸ƒæ•°æ®ï¼Œè€Œéä¸€å‘³åœ°å‘ä¸ªä¸åœã€‚</p><p>ä¸‹é¢ç”¨ä»£ç æ¥æ¼”ç¤ºè¿™ä¸ªæƒ…å†µï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FlowApiTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="comment">// 1. å®šä¹‰Stringç±»å‹çš„æ•°æ®å‘å¸ƒè€…ï¼ŒJDK 9è‡ªå¸¦çš„</span></span><br><span class="line">        <span class="comment">// SubmissionPublisherå®ç°äº† Publisher</span></span><br><span class="line">        SubmissionPublisher&lt;String&gt; publisher = <span class="keyword">new</span> SubmissionPublisher&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. åˆ›å»ºä¸€ä¸ªè®¢é˜…è€…ï¼Œç”¨äºæ¥æ”¶å‘å¸ƒè€…çš„æ¶ˆæ¯</span></span><br><span class="line">        Subscriber&lt;String&gt; subscriber = <span class="keyword">new</span> Subscriber&lt;&gt;() &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">private</span> Subscription subscription;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSubscribe</span><span class="params">(Subscription subscription)</span> </span>&#123;</span><br><span class="line">                <span class="comment">// é€šè¿‡ Subscription å’Œå‘å¸ƒè€…ä¿æŒè®¢é˜…å…³ç³»ï¼Œå¹¶ç”¨å®ƒæ¥ç»™å‘å¸ƒè€…åé¦ˆ</span></span><br><span class="line">                <span class="keyword">this</span>.subscription = subscription;</span><br><span class="line">                <span class="comment">// è¯·æ±‚ä¸€ä¸ªæ•°æ®</span></span><br><span class="line">                <span class="keyword">this</span>.subscription.request(<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(String item)</span> </span>&#123;</span><br><span class="line">                <span class="comment">// æ¥æ”¶å‘å¸ƒè€…å‘å¸ƒçš„æ¶ˆæ¯</span></span><br><span class="line">                System.out.println(<span class="string">"ã€è®¢é˜…è€…ã€‘æ¥æ”¶æ¶ˆæ¯ &lt;------ "</span> + item);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// æ¨¡æ‹Ÿæ¥æ”¶æ•°æ®ç¼“æ…¢ï¼Œè®©ç¼“å†²æ± å¡«æ»¡</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    TimeUnit.SECONDS.sleep(<span class="number">2</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// æ¥æ”¶åå†æ¬¡è¯·æ±‚ä¸€ä¸ªæ•°æ®ï¼Œè¡¨ç¤ºæˆ‘å·²ç»å¤„ç†å®Œäº†ï¼Œä½ å¯ä»¥å†å‘æ•°æ®è¿‡æ¥äº†</span></span><br><span class="line">                <span class="keyword">this</span>.subscription.request(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// å¦‚æœä¸æƒ³å†æ¥æ”¶æ•°æ®ï¼Œä¹Ÿå¯ä»¥ç›´æ¥è°ƒç”¨cancelï¼Œè¡¨ç¤ºä¸å†æ¥æ”¶äº†</span></span><br><span class="line">                <span class="comment">// this.subscription.cancel();</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable throwable)</span> </span>&#123;</span><br><span class="line">                <span class="comment">// è¿‡ç¨‹ä¸­å‡ºç°å¼‚å¸¸ä¼šå›è°ƒè¿™ä¸ªæ–¹æ³•</span></span><br><span class="line">                System.out.println(<span class="string">"ã€è®¢é˜…è€…ã€‘æ•°æ®æ¥æ”¶å‡ºç°å¼‚å¸¸ï¼Œ"</span> + throwable);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// å‡ºç°å¼‚å¸¸ï¼Œå–æ¶ˆè®¢é˜…ï¼Œå‘Šè¯‰å‘å¸ƒè€…æˆ‘ä¸å†æ¥æ”¶æ•°æ®äº†</span></span><br><span class="line">                <span class="comment">// å®é™…æµ‹è¯•å‘ç°ï¼Œåªè¦è®¢é˜…è€…æ¥æ”¶æ¶ˆæ¯å‡ºç°å¼‚å¸¸ï¼Œè¿›å…¥äº†è¿™ä¸ªå›è°ƒ</span></span><br><span class="line">                <span class="comment">// è®¢é˜…è€…å°±ä¸ä¼šå†ç»§ç»­æ¥æ”¶æ¶ˆæ¯äº†</span></span><br><span class="line">                <span class="keyword">this</span>.subscription.cancel();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onComplete</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="comment">// å½“å‘å¸ƒè€…å‘å‡ºçš„æ•°æ®éƒ½è¢«æ¥æ”¶äº†ï¼Œ</span></span><br><span class="line">                <span class="comment">// å¹¶ä¸”å‘å¸ƒè€…å…³é—­åï¼Œä¼šå›è°ƒè¿™ä¸ªæ–¹æ³•</span></span><br><span class="line">                System.out.println(<span class="string">"ã€è®¢é˜…è€…ã€‘æ•°æ®æ¥æ”¶å®Œæ¯•"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. å‘å¸ƒè€…å’Œè®¢é˜…è€…éœ€è¦å»ºç«‹å…³ç³»</span></span><br><span class="line">        publisher.subscribe(subscriber);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4. å‘å¸ƒè€…å¼€å§‹å‘å¸ƒæ•°æ®</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">500</span>; i++) &#123;</span><br><span class="line">            String message = <span class="string">"hello flow api "</span> + i;</span><br><span class="line">            System.out.println(<span class="string">"ã€å‘å¸ƒè€…ã€‘å‘å¸ƒæ¶ˆæ¯ ------&gt; "</span> + message);</span><br><span class="line">            publisher.submit(message);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5. å‘å¸ƒç»“æŸåï¼Œå…³é—­å‘å¸ƒè€…</span></span><br><span class="line">        publisher.close();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// mainçº¿ç¨‹å»¶è¿Ÿå…³é—­ï¼Œä¸ç„¶è®¢é˜…è€…è¿˜æ²¡æ¥æ”¶å®Œæ¶ˆæ¯ï¼Œçº¿ç¨‹å°±è¢«å…³é—­äº†</span></span><br><span class="line">        Thread.currentThread().join(<span class="number">20000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢ä»£ç ä¸­ï¼Œæˆ‘ä»¬åœ¨<code>Subscriber</code>çš„<code>onNext</code>æ–¹æ³•ä¸­ç”¨ä¸‹é¢çš„ä»£ç æ¨¡æ‹Ÿå»¶è¿Ÿï¼Œè®©æ•°æ®å¤„ç†è¿‡ç¨‹ç»´æŒåœ¨2ç§’å·¦å³ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    TimeUnit.SECONDS.sleep(<span class="number">2</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ç„¶åæ•°æ®å‘å¸ƒé‡è°ƒæ•´åˆ°äº†500ï¼Œå½“ç¨‹åºå¯åŠ¨çš„æ—¶å€™ï¼Œç”±äºæ•°æ®å‘å¸ƒçš„é€Ÿåº¦éå¸¸å¿«ï¼ˆæ™®é€šforå¾ªç¯ï¼‰ï¼Œæ‰€ä»¥æ•°æ®è®¢é˜…è€…çš„æ•°æ®ç¼“å†²åŒºç¬é—´è¢«å¡«æ»¡ï¼Œäºæ˜¯ä½ ä¼šçœ‹åˆ°ä¸‹é¢è¿™ä¸ªæƒ…å†µï¼Œåªæœ‰å½“æ•°æ®è®¢é˜…è€…å¤„ç†äº†ä¸€ä¸ªæ•°æ®çš„æ—¶å€™ï¼Œæ•°æ®å‘å¸ƒè€…æ‰ä¼šç›¸åº”åœ°å†æ¬¡å‘å¸ƒä¸€ä¸ªæ–°æ•°æ®ï¼š</p><p><img src="img/testasdfasdf.gif" alt="testasdfasdf.gif"></p><h2 id="Processorç¤ºä¾‹"><a href="#Processorç¤ºä¾‹" class="headerlink" title="Processorç¤ºä¾‹"></a>Processorç¤ºä¾‹</h2><p><code>Processor</code>çš„ä½¿ç”¨ä¹Ÿå¾ˆç®€å•ï¼Œå…¶å®å®ƒå°±æ˜¯<code>Publisher</code>å’Œ<code>Subscriber</code>çš„ç»“åˆä½“ï¼Œå……å½“æ•°æ®å¤„ç†çš„è§’è‰²ï¼Œé€šå¸¸çš„åšæ³•æ˜¯ç”¨å®ƒæ¥æ¥æ”¶å‘å¸ƒè€…å‘å¸ƒçš„æ¶ˆæ¯ï¼Œç„¶åè¿›è¡Œç›¸åº”çš„å¤„ç†ï¼Œå†å°†æ•°æ®å‘å¸ƒå‡ºå»ï¼Œä¾›æ¶ˆæ¯è®¢é˜…è€…æ¥æ”¶ã€‚</p><p>ä¸‹é¢æ˜¯ä¸€ä¸ª<code>Processor</code>ç”¨æ³•çš„ç®€å•ç¤ºä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FlowApiTest2</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyProcessor</span> <span class="keyword">extends</span> <span class="title">SubmissionPublisher</span>&lt;<span class="title">String</span>&gt;</span></span><br><span class="line"><span class="class">            <span class="keyword">implements</span> <span class="title">Processor</span>&lt;<span class="title">String</span>, <span class="title">String</span>&gt; </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> Subscription subscription;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSubscribe</span><span class="params">(Subscription subscription)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// é€šè¿‡ Subscription å’Œå‘å¸ƒè€…ä¿æŒè®¢é˜…å…³ç³»ï¼Œå¹¶ç”¨å®ƒæ¥ç»™å‘å¸ƒè€…åé¦ˆ</span></span><br><span class="line">            <span class="keyword">this</span>.subscription = subscription;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// è¯·æ±‚ä¸€ä¸ªæ•°æ®</span></span><br><span class="line">            <span class="keyword">this</span>.subscription.request(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(String item)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// æ¥æ”¶å‘å¸ƒè€…å‘å¸ƒçš„æ¶ˆæ¯</span></span><br><span class="line">            System.out.println(<span class="string">"ã€å¤„ç†å™¨ã€‘æ¥æ”¶æ¶ˆæ¯ &lt;------ "</span> + item);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// å¤„ç†å™¨å°†æ¶ˆæ¯è¿›è¡Œè½¬æ¢</span></span><br><span class="line">            String newItem = <span class="string">"ã€å¤„ç†å™¨åŠ å·¥åçš„æ•°æ®: "</span> + item + <span class="string">"ã€‘"</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">this</span>.submit(newItem);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// æ¥æ”¶åå†æ¬¡è¯·æ±‚ä¸€ä¸ªæ•°æ®ï¼Œè¡¨ç¤ºæˆ‘å·²ç»å¤„ç†å®Œäº†ï¼Œä½ å¯ä»¥å†å‘æ•°æ®è¿‡æ¥äº†</span></span><br><span class="line">            <span class="keyword">this</span>.subscription.request(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// å¦‚æœä¸æƒ³å†æ¥æ”¶æ•°æ®ï¼Œä¹Ÿå¯ä»¥ç›´æ¥è°ƒç”¨cancelï¼Œè¡¨ç¤ºä¸å†æ¥æ”¶äº†</span></span><br><span class="line">            <span class="comment">// this.subscription.cancel();</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable throwable)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// è¿‡ç¨‹ä¸­å‡ºç°å¼‚å¸¸ä¼šå›è°ƒè¿™ä¸ªæ–¹æ³•</span></span><br><span class="line">            System.out.println(<span class="string">"ã€å¤„ç†å™¨ã€‘æ•°æ®æ¥æ”¶å‡ºç°å¼‚å¸¸ï¼Œ"</span> + throwable);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// å‡ºç°å¼‚å¸¸ï¼Œå–æ¶ˆè®¢é˜…ï¼Œå‘Šè¯‰å‘å¸ƒè€…æˆ‘ä¸å†æ¥æ”¶æ•°æ®äº†</span></span><br><span class="line">            <span class="keyword">this</span>.subscription.cancel();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onComplete</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            System.out.println(<span class="string">"ã€å¤„ç†å™¨ã€‘æ•°æ®å¤„ç†å®Œæ¯•"</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// å¤„ç†å™¨å¤„ç†å®Œæ•°æ®åå…³é—­</span></span><br><span class="line">            <span class="keyword">this</span>.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="comment">// 1. å®šä¹‰Stringç±»å‹çš„æ•°æ®å‘å¸ƒè€…ï¼ŒJDK 9è‡ªå¸¦çš„</span></span><br><span class="line">        <span class="comment">// SubmissionPublisherå®ç°äº† Publisher</span></span><br><span class="line">        SubmissionPublisher&lt;String&gt; publisher = <span class="keyword">new</span> SubmissionPublisher&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. åˆ›å»ºå¤„ç†å™¨ï¼Œç”¨äºæ¥æ”¶å‘å¸ƒè€…å‘å¸ƒçš„æ¶ˆæ¯ï¼Œ</span></span><br><span class="line">        <span class="comment">// è½¬æ¢åå†å‘é€ç»™è®¢é˜…è€…</span></span><br><span class="line">        MyProcessor processor = <span class="keyword">new</span> MyProcessor();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. å‘å¸ƒè€…å’Œå¤„ç†å™¨å»ºç«‹è®¢é˜…çš„å…³ç³»</span></span><br><span class="line">        publisher.subscribe(processor);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4.åˆ›å»ºä¸€ä¸ªè®¢é˜…è€…ï¼Œç”¨äºæ¥æ”¶å¤„ç†å™¨çš„æ¶ˆæ¯</span></span><br><span class="line">        Subscriber&lt;String&gt; subscriber = <span class="keyword">new</span> Subscriber&lt;&gt;() &#123;</span><br><span class="line">            <span class="keyword">private</span> Subscription subscription;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSubscribe</span><span class="params">(Subscription subscription)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">this</span>.subscription = subscription;</span><br><span class="line">                <span class="keyword">this</span>.subscription.request(<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(String item)</span> </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">"ã€è®¢é˜…è€…ã€‘æ¥æ”¶æ¶ˆæ¯ &lt;------ "</span> + item + <span class="string">""</span>);</span><br><span class="line">                <span class="keyword">this</span>.subscription.request(<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable throwable)</span> </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">"ã€è®¢é˜…è€…ã€‘æ•°æ®æ¥æ”¶å‡ºç°å¼‚å¸¸ï¼Œ"</span> + throwable);</span><br><span class="line">                <span class="keyword">this</span>.subscription.cancel();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onComplete</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">"ã€è®¢é˜…è€…ã€‘æ•°æ®æ¥æ”¶å®Œæ¯•"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5. å¤„ç†å™¨å’Œè®¢é˜…è€…å»ºç«‹è®¢é˜…å…³ç³»</span></span><br><span class="line">        processor.subscribe(subscriber);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6. å‘å¸ƒè€…å¼€å§‹å‘å¸ƒæ•°æ®</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            String message = <span class="string">"hello flow api "</span> + i;</span><br><span class="line">            System.out.println(<span class="string">"ã€å‘å¸ƒè€…ã€‘å‘å¸ƒæ¶ˆæ¯ ------&gt; "</span> + message);</span><br><span class="line">            publisher.submit(message);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 7. å‘å¸ƒç»“æŸåï¼Œå…³é—­å‘å¸ƒè€…</span></span><br><span class="line">        publisher.close();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// mainçº¿ç¨‹å»¶è¿Ÿå…³é—­ï¼Œä¸ç„¶è®¢é˜…è€…è¿˜æ²¡æ¥æ”¶å®Œæ¶ˆæ¯ï¼Œçº¿ç¨‹å°±è¢«å…³é—­äº†</span></span><br><span class="line">        Thread.currentThread().join(<span class="number">2000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ç¨‹åºè¿è¡Œç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><img src="img/QQæˆªå›¾20190226151701.png" alt="QQæˆªå›¾20190226151701.png"></p><blockquote><p>å‚è€ƒæ–‡æ¡£ï¼š<a href="https://community.oracle.com/docs/DOC-1006738" target="_blank" rel="noopener">https://community.oracle.com/docs/DOC-1006738</a></p></blockquote><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Wed May 15 2019 17:13:43 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;å“åº”å¼ç¼–ç¨‹ï¼ˆReactive Programmingï¼‰å¯ä»¥ç†è§£ä¸ºä¸€ç§å¤„ç†æ•°æ®é¡¹ï¼ˆData Itemï¼‰çš„å¼‚æ­¥æµï¼Œå³åœ¨æ•°æ®é¡¹äº§ç”Ÿçš„æ—¶å€™ï¼Œæ¥æ”¶è€…å°±å¯¹å…¶è¿›è¡Œå“åº”ã€‚åœ¨å“åº”å¼ç¼–ç¨‹ä¸­ï¼Œä¼šæœ‰ä¸€ä¸ªæ•°æ®å‘å¸ƒè€…ï¼ˆPublisherï¼‰å’Œæ•°æ®è®¢é˜…è€…ï¼ˆSubscriberï¼‰ï¼Œåè€…ç”¨äºå¼‚æ­¥æ¥æ”¶å‘å¸ƒè€…å‘å¸ƒçš„æ•°æ®ã€‚åœ¨è¯¥æ¨¡å¼ä¸­ï¼Œè¿˜å¼•å…¥äº†ä¸€ä¸ªæ›´é«˜çº§çš„ç‰¹æ€§ï¼šæ•°æ®å¤„ç†å™¨ï¼ˆProcessorï¼‰ï¼Œå®ƒç”¨äºå°†æ•°æ®å‘å¸ƒè€…å‘å¸ƒçš„æ•°æ®è¿›è¡ŒæŸäº›è½¬æ¢æ“ä½œï¼Œç„¶åå†å‘å¸ƒç»™æ•°æ®è®¢é˜…è€…ã€‚&lt;/p&gt;&lt;p&gt;æ€»ä¹‹ï¼Œå“åº”å¼ç¼–ç¨‹æ˜¯å¼‚æ­¥éé˜»å¡ç¼–ç¨‹ï¼Œèƒ½å¤Ÿæå‡ç¨‹åºæ€§èƒ½ï¼Œå¯ä»¥è§£å†³ä¼ ç»Ÿç¼–ç¨‹æ¨¡å‹é‡åˆ°çš„å›°å¢ƒã€‚åŸºäºè¿™ä¸ªæ¨¡å‹å®ç°çš„æœ‰Java 9 Flow APIã€RxJavaå’ŒReactorç­‰ï¼Œè¿™é‡Œä¸»è¦ä»‹ç»çš„æ˜¯Java 9 Flow APIçš„ä½¿ç”¨ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Java" scheme="http://mrbird.cc/tags/Java/"/>
    
      <category term="Java 9" scheme="http://mrbird.cc/tags/Java-9/"/>
    
  </entry>
  
  <entry>
    <title>Java 10 æ–°ç‰¹æ€§ä¹‹var</title>
    <link href="http://mrbird.cc/Java10-new-feature-var.html"/>
    <id>http://mrbird.cc/Java10-new-feature-var.html</id>
    <published>2018-11-05T07:16:50.000Z</published>
    <updated>2019-02-15T06:24:13.399Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Wed May 15 2019 17:13:42 GMT+0800 (GMT+08:00) --><p>ä»Šå¹´3æœˆï¼ŒJava 10 å¦‚æœŸå‘å¸ƒï¼ŒJava 10 æ˜¯é‡‡ç”¨æ–°å‘å¸ƒå‘¨æœŸçš„ç¬¬ä¸€ä¸ªç‰ˆæœ¬ï¼Œæä¾›äº† 109 é¡¹æ–°ç‰¹æ€§ï¼Œå…¶ä¸­æœ€å¤‡å—å…³æ³¨çš„è«è¿‡äºå±€éƒ¨å˜é‡çš„ç±»å‹æ¨æ–­ã€‚æ‰€ä»¥è¿™é‡Œä¸»è¦è®°å½•ä¸€ä¸‹è¿™ä¸ªç‰¹æ€§çš„ç”¨æ³•ã€‚</p><a id="more"></a><p>çœ‹å‡ ä¸ªJava 10ä¹‹å‰å£°æ˜å˜é‡çš„ä¾‹å­:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">List&lt;String&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">Stream&lt;String&gt; stream = list.stream();</span><br><span class="line"></span><br><span class="line">InputStreamReader reader = <span class="keyword">new</span> InputStreamReader(System.in);</span><br><span class="line">HttpClient httpClient = HttpClient.newHttpClient();</span><br></pre></td></tr></table></figure><p></p><p>åœ¨Java 10 ä¸­ï¼Œåªè¦æ˜¯ç¼–è¯‘å™¨èƒ½å¤Ÿé€šè¿‡å¯¹è±¡ç±»å‹æ¥ç¡®å®šå˜é‡ç±»å‹çš„æƒ…å†µä¸‹ï¼Œå˜é‡ç±»å‹å£°æ˜å¯ä»¥ä½¿ç”¨<code>var</code>ä¿ç•™å­—ä»£æ›¿ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"><span class="keyword">var</span> stream = list.stream();</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> reader = <span class="keyword">new</span> InputStreamReader(System.in);</span><br><span class="line"><span class="keyword">var</span> httpClient = HttpClient.newHttpClient();</span><br></pre></td></tr></table></figure><p></p><p>å¼•å…¥è¿™ä¸ªç‰¹æ€§ä½¿å¾—æˆ‘ä»¬çš„Java ä»£ç å˜å¾—æ›´åŠ çš„ç®€æ´æ˜“è¯»ã€‚é™¤æ­¤ä¹‹å¤–æˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨å¢å¼º<code>for</code>å¾ªç¯ä¸­ä½¿ç”¨<code>var</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">list.add(<span class="string">"hello"</span>);</span><br><span class="line">list.add(<span class="string">"java 10"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> s : list) System.out.println(s);</span><br></pre></td></tr></table></figure><p></p><p>å½“ç„¶ï¼Œ<code>var</code>å¹¶ä¸æ˜¯åœ¨ä½•æ—¶ä½•åœ°éƒ½èƒ½ä½¿ç”¨ï¼Œç”¨äºå˜é‡å£°æ˜æ—¶ï¼Œä»…å±€é™äºå…·æœ‰æ„é€ å™¨çš„å˜é‡æˆ–åŸºæœ¬æ•°æ®ç±»å‹ï¼Œæ¯”å¦‚ä¸‹é¢è¿™äº›ä¾‹å­ç¼–è¯‘æ˜¯ä¸é€šè¿‡çš„ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a;</span><br><span class="line">a = <span class="string">"hello world"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> b = &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125;;</span><br></pre></td></tr></table></figure><p>ç¼–è¯‘å™¨å°†ä¼šå‘Šè­¦ï¼š</p><p><img src="img/QQæˆªå›¾20190214164317.png" alt="QQæˆªå›¾20190214164317.png"></p><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Wed May 15 2019 17:13:42 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;ä»Šå¹´3æœˆï¼ŒJava 10 å¦‚æœŸå‘å¸ƒï¼ŒJava 10 æ˜¯é‡‡ç”¨æ–°å‘å¸ƒå‘¨æœŸçš„ç¬¬ä¸€ä¸ªç‰ˆæœ¬ï¼Œæä¾›äº† 109 é¡¹æ–°ç‰¹æ€§ï¼Œå…¶ä¸­æœ€å¤‡å—å…³æ³¨çš„è«è¿‡äºå±€éƒ¨å˜é‡çš„ç±»å‹æ¨æ–­ã€‚æ‰€ä»¥è¿™é‡Œä¸»è¦è®°å½•ä¸€ä¸‹è¿™ä¸ªç‰¹æ€§çš„ç”¨æ³•ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Java" scheme="http://mrbird.cc/tags/Java/"/>
    
      <category term="Java 10" scheme="http://mrbird.cc/tags/Java-10/"/>
    
  </entry>
  
  <entry>
    <title>Java 9 æ–°ç‰¹æ€§å­¦ä¹ </title>
    <link href="http://mrbird.cc/Java-9-Feature.html"/>
    <id>http://mrbird.cc/Java-9-Feature.html</id>
    <published>2018-11-02T00:50:59.000Z</published>
    <updated>2019-02-14T07:12:22.428Z</updated>
    
    <content type="html"><![CDATA[<!-- build time:Wed May 15 2019 17:13:43 GMT+0800 (GMT+08:00) --><p>åœ¨Java 8 å‘å¸ƒ3å¹´å¤šåï¼ŒJava 9 ç»ˆäºåœ¨2017å¹´9æœˆ21æ—¥æ­£å¼å‘å¸ƒã€‚Java 9 æä¾›äº†è¶…è¿‡150é¡¹æ–°åŠŸèƒ½ç‰¹æ€§ï¼ŒåŒ…æ‹¬å¤‡å—æœŸå¾…çš„æ¨¡å—åŒ–ç³»ç»Ÿã€ å¯äº¤äº’çš„REPLå·¥å…·jShellã€JDKç¼–è¯‘å·¥å…·ã€Javaå…¬å…±APIå’Œç§æœ‰ä»£ç ï¼Œä»¥åŠå®‰å…¨å¢å¼ºã€æ‰©å±•æå‡å’Œæ€§èƒ½ç®¡ç†æ”¹å–„ç­‰ã€‚åœ¨å­¦ä¹ è¿™äº›æ–°ç‰¹æ€§ä¹‹å‰ï¼Œæˆ‘ä»¬å¾—å…ˆå®‰è£…å¥½JDK 9ï¼ŒJDK 9 ä¸‹è½½åœ°å€ï¼š<a href="https://www.oracle.com/technetwork/cn/java/javase/downloads/jdk9-downloads-3848520-zhs.html" target="_blank" rel="noopener">https://www.oracle.com/technetwork/cn/java/javase/downloads/jdk9-downloads-3848520-zhs.html</a>ã€‚<a id="more"></a></p><h2 id="æ¨¡å—åŒ–"><a href="#æ¨¡å—åŒ–" class="headerlink" title="æ¨¡å—åŒ–"></a>æ¨¡å—åŒ–</h2><p>Java 9 ä¸­çš„æ¨¡å—åŒ–ï¼ˆModuleï¼‰ç±»ä¼¼äºES6ä¸­çš„æ¨¡å—åŒ–ï¼Œéƒ½æ˜¯ä¸ºäº†è§£å†³é¡¹ç›®ä¸­å‡å°‘å†…å­˜çš„å¼€é”€ï¼Œæä¾›å¯ç»´æŠ¤æ€§å’Œç³»ç»Ÿæ€§èƒ½è€Œæå‡ºçš„ã€‚é€šä¿—åœ°è¯´ï¼ŒJava 9 çš„æ¨¡å—åŒ–æœ¬è´¨ä¸Šå°±æ˜¯åœ¨åŒ…ï¼ˆpackageï¼‰ä¸Šå†åŒ…è£¹ä¸€å±‚ï¼ˆModuleï¼‰ï¼Œé»˜è®¤æ¨¡å—é‡Œçš„å†…å®¹éƒ½æ˜¯éšè—çš„ï¼Œåªèƒ½é€šè¿‡ï¼ˆexportsï¼‰å…³é”®å­—æ¥æš´éœ²æ¨¡å—é‡Œçš„å†…å®¹ï¼Œè€Œåˆ«çš„æ¨¡å—éœ€è¦ç”¨åˆ°è¿™äº›å†…å®¹åˆ™éœ€è¦ä½¿ç”¨ï¼ˆrequiresï¼‰å…³é”®å­—æ¥å¯¼å…¥ã€‚</p><p>ä¸‹é¢æˆ‘ä»¬ç”¨ä»£ç æ¥æ¼”ç¤ºè¿™ä¸€ä¸ªæ–°ç‰¹æ€§ã€‚</p><p>æ–°å»ºä¸€ä¸ªJava å·¥ç¨‹ï¼Œç„¶ååœ¨å·¥ç¨‹ä¸‹é¢åˆ›å»ºä¸€ä¸ªåä¸º<strong>ModuleOne</strong>çš„æ¨¡å—ï¼š</p><p><img src="img/QQæˆªå›¾20190213094527.png" alt="QQæˆªå›¾20190213094527.png"></p><p>åŒæ ·çš„ï¼Œæˆ‘ä»¬å†åˆ›å»ºä¸€ä¸ª<strong>ModuleTwo</strong>æ¨¡å—ï¼Œåˆ›å»ºå®Œåé¡¹ç›®ç›®å½•å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><img src="img/QQæˆªå›¾20190213094722.png" alt="QQæˆªå›¾20190213094722.png"></p><p>æ¥ç€æˆ‘ä»¬åœ¨ModuleOneçš„srcç›®å½•ä¸‹åˆ›å»º<code>cc.mrbird.domain</code>åŒ…ï¼Œå¹¶åˆ›å»ºä¸€ä¸ªåä¸ºPersonçš„ç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cc.mrbird.domain;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> age;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Person</span><span class="params">(String name, <span class="keyword">int</span> age)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Person&#123;"</span> +</span><br><span class="line">                <span class="string">"name='"</span> + name + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">", age="</span> + age +</span><br><span class="line">                <span class="string">'&#125;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getAge</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAge</span><span class="params">(<span class="keyword">int</span> age)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ç„¶ååœ¨ModuleTwoçš„srcç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ª<code>cc.mrbid.test</code>åŒ…ï¼Œå¹¶ä¸”åˆ›å»ºä¸€ä¸ªTestç±»ï¼Œç”¨äºå¾…ä¼šæµ‹è¯•ã€‚</p><p>è‡³æ­¤ï¼Œå·¥ç¨‹ç›®å½•ç»“æ„å¦‚ä¸‹æ‰€ç¤º:</p><p><img src="img/QQæˆªå›¾20190213095358.png" alt="QQæˆªå›¾20190213095358.png"></p><p>æˆ‘ä»¬åœ¨ModuleTwoçš„Testç±»ä¸‹è¯•å›¾å¼•å…¥ModuleOneçš„Personç±»ï¼Œä¼šå‘ç°æ˜¯è¡Œä¸é€šçš„ï¼š</p><p><img src="img/QQæˆªå›¾20190213095624.png" alt="QQæˆªå›¾20190213095624.png"></p><p>æ­£å¦‚ä¸Šé¢æ‰€è¯´ï¼Œæ¨¡å—é‡Œçš„ä¸œè¥¿é»˜è®¤éƒ½æ˜¯éšè—çš„ï¼Œè¦è®©å…¶å¯ä»¥è¢«åˆ«çš„æ¨¡å—ä½¿ç”¨ï¼Œéœ€è¦é€šè¿‡<strong>exports</strong>å…³é”®å­—æ¥æš´éœ²å®ƒä»¬ã€‚</p><p>åœ¨ModuleOneæ¨¡å—ä¸‹çš„srcä¸Šå³é”®ï¼Œæ–°å»ºä¸€ä¸ªmodule-info.javaï¼š</p><p><img src="img/QQæˆªå›¾20190213095840.png" alt="QQæˆªå›¾20190213095840.png"></p><p>ä»£ç å¦‚ä¸‹æ‰€ç¤º:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span> ModuleOne &#123;</span><br><span class="line">    <span class="comment">// å¯¼å‡ºåŒ…</span></span><br><span class="line">    <span class="keyword">exports</span> cc.mrbird.domain;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>ä¸Šé¢ä»£ç ä¸­å¯¼å‡ºäº†<code>cc.mrbird.domain</code>åŒ…ä¸‹çš„æ‰€æœ‰å†…å®¹ï¼Œå¯¹åˆ«çš„æ¨¡å—æ¥è¯´ï¼Œå®ƒä»¬æ˜¯å¯è§çš„äº†ã€‚</p><p>ç„¶ååŒæ ·åœ°åœ¨ModuleTwoæ¨¡å—ä¸‹çš„srcä¸Šå³é”®ï¼Œä¹Ÿæ–°å»ºä¸€ä¸ªmodule-info.javaï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤º:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span> ModuleTwo &#123;</span><br><span class="line">    <span class="comment">// å¯¼å…¥æ¨¡å—</span></span><br><span class="line">    <span class="keyword">requires</span> ModuleOne;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬ä¸»è¦åšçš„æ˜¯å°†ModuleOneå¯¼å…¥è¿›æ¥ï¼Œæ‰€ä»¥å…¶æš´éœ²çš„<code>cc.mrbird.domain</code>åŒ…ä¸‹çš„å†…å®¹å°±å¯ä»¥åœ¨ModuleTwoä¸‹è¢«ä½¿ç”¨äº†ã€‚</p><p>è¿™æ—¶å€™å›åˆ°ModuleTwoæ¨¡å—ä¸‹çš„Testç±»ï¼ŒIDEAä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬å¯¼å…¥éœ€è¦çš„ç±»ï¼Œä»£ç å°±ä¸ä¼šæŠ¥é”™äº†ï¼š</p><p><img src="img/QQæˆªå›¾20190213100532.png" alt="QQæˆªå›¾20190213100532.png"></p><p>æˆ‘ä»¬ç»§ç»­åœ¨Testç±»ä¸­åŠ å…¥ä¸€äº›å†…å®¹ï¼š</p><p><img src="img/QQæˆªå›¾20190213101203.png" alt="QQæˆªå›¾20190213101203.png"></p><p>ä¸Šé¢æˆ‘ä»¬ä½¿ç”¨äº†<code>java.util.logging.Logger</code>æ¥æ‰“å°æ—¥å¿—ï¼Œä½†æ˜¯ä»£ç ç¼–è¯‘æ˜¯ä¸é€šè¿‡çš„ï¼Œä½¿ç”¨<code>Alt+Enter</code>å¿«æ·é”®åé€‰æ‹©ç¬¬ä¸€é¡¹ï¼ŒIDEAä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬åœ¨module-info.javaæ–‡ä»¶ä¸­å¯¼å…¥éœ€è¦çš„åŒ…ï¼Œéå¸¸æ–¹ä¾¿ã€‚</p><p>å¯¼å…¥åï¼Œmodule-info.javaä¸‹çš„ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span> ModuleTwo &#123;</span><br><span class="line">    <span class="comment">// å¯¼å…¥æ¨¡å—</span></span><br><span class="line">    <span class="keyword">requires</span> ModuleOne;</span><br><span class="line">    <span class="keyword">requires</span> java.logging;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>æ€»çš„æ¥è¯´ï¼Œé€šè¿‡æ¨¡å—åŒ–æ¥æ„å»ºé¡¹ç›®å¯ä»¥å¸¦æ¥ä»¥ä¸‹å¥½å¤„:</p><ol><li><p>å‡å°‘å†…å­˜çš„å¼€é”€ï¼›</p></li><li><p>ç®€åŒ–å„ç§ç±»åº“å’Œå¤§å‹åº”ç”¨çš„å¼€å‘å’Œç»´æŠ¤ï¼›</p></li><li><p>æ”¹è¿›å…¶å®‰å…¨æ€§ï¼Œå¯ç»´æŠ¤æ€§ï¼Œæé«˜æ€§èƒ½ã€‚</p></li></ol><h2 id="jshellå‘½ä»¤"><a href="#jshellå‘½ä»¤" class="headerlink" title="jshellå‘½ä»¤"></a>jshellå‘½ä»¤</h2><p>åœ¨Java 9 ä¹‹å‰ï¼Œæˆ‘ä»¬è¦æƒ³ä½¿ç”¨Javaæ¥è¾“å‡ºä¸€å¥hello worldæˆ–è€…è®¡ç®—ä¸¤ä¸ªæ•°çš„å’Œéƒ½å¿…é¡»åˆ›å»ºä¸€ä¸ªJavaé¡¹ç›®ï¼Œç„¶ååˆ›å»ºç±»åœ¨é‡Œé¢å†™mainæ–¹æ³•æ¥è¿è¡Œã€‚Java 9 åå°±ä¸å¿…è¿™æ ·äº†ï¼Œå…¶æä¾›äº†REPLå·¥å…·ï¼šjshellã€‚åˆ©ç”¨ jshell åœ¨æ²¡æœ‰åˆ›å»ºç±»çš„æƒ…å†µä¸‹ç›´æ¥å£°æ˜å˜é‡ï¼Œè®¡ç®—è¡¨è¾¾å¼ï¼Œæ‰§è¡Œè¯­å¥ã€‚å³å¼€å‘æ—¶å¯ä»¥åœ¨å‘½ä»¤è¡Œé‡Œç›´æ¥è¿è¡Œ Java çš„ä»£ç ï¼Œè€Œæ— éœ€åˆ›å»º Java æ–‡ä»¶ã€‚</p><p>åœ¨JDK 9 çš„binç›®å½•ä¸‹æœ‰ä¸ªjshell.exeæ–‡ä»¶ï¼Œæˆ‘ä»¬è¿è¡Œå®ƒï¼š</p><p><img src="img/QQæˆªå›¾20190213103825.png" alt="QQæˆªå›¾20190213103825.png"></p><p>ä¸‹é¢æ¼”ç¤ºä¸€äº›jshellçš„å¸¸ç”¨æ“ä½œã€‚</p><p><strong>åŸºæœ¬ä½¿ç”¨</strong></p><p><img src="img/QQæˆªå›¾20190213104253.png" alt="QQæˆªå›¾20190213104253.png"></p><div class="note info"><p>åœ¨jshellä¸­ï¼Œä»£ç æœ«å°¾çš„<code>;</code>æ˜¯å¯é€‰çš„ã€‚</p></div><p><strong>å¯¼åŒ…æ“ä½œ</strong></p><p><img src="img/QQæˆªå›¾20190213104534.png" alt="QQæˆªå›¾20190213104534.png"></p><p><strong>æŸ¥çœ‹æ‰€æœ‰å·²ç»å¯¼å…¥çš„åŒ…</strong></p><p><img src="img/QQæˆªå›¾20190213104610.png" alt="QQæˆªå›¾20190213104610.png"></p><p><strong>ä½¿ç”¨Tabé”®è¡¥å…¨ä»£ç </strong></p><p><img src="img/QQæˆªå›¾20190213104732.png" alt="QQæˆªå›¾20190213104732.png"></p><p><strong>æŸ¥çœ‹å½“å‰ç¯å¢ƒä¸‹æ‰€æœ‰æœ‰æ•ˆä»£ç </strong></p><p><img src="img/QQæˆªå›¾20190213104840.png" alt="QQæˆªå›¾20190213104840.png"></p><p><strong>æŸ¥çœ‹å½“å‰ç¯å¢ƒä¸‹æ‰€æœ‰å˜é‡</strong></p><p><img src="img/QQæˆªå›¾20190213104941.png" alt="QQæˆªå›¾20190213104941.png"></p><p><strong>æŸ¥çœ‹å½“å‰ç¯å¢ƒä¸‹æ‰€æœ‰æ–¹æ³•</strong></p><p><img src="img/QQæˆªå›¾20190213105231.png" alt="QQæˆªå›¾20190213105231.png"></p><p><strong>ä½¿ç”¨å¤–éƒ¨ä»£ç ç¼–è¾‘å™¨æ¥ä¿®æ”¹addæ–¹æ³•</strong></p><p><img src="img/QQæˆªå›¾20190213105412.png" alt="QQæˆªå›¾20190213105412.png"></p><p>ç•Œé¢å¼¹å‡ºï¼š</p><p><img src="img/QQæˆªå›¾20190213105500.png" alt="QQæˆªå›¾20190213105500.png"></p><p>ä¿®æ”¹å®Œæ¯•ç‚¹å‡»Acceptå’ŒExitæŒ‰é’®å³å¯ï¼š</p><p><img src="img/QQæˆªå›¾20190213105553.png" alt="QQæˆªå›¾20190213105553.png"></p><p><strong>åŠ è½½å¤–éƒ¨ä»£ç </strong></p><p>åœ¨æ¡Œé¢æ–°å»ºä¸€ä¸ªHello.javaæ–‡ä»¶ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">hello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    System.out.println(<span class="string">"hello world"</span>);</span><br><span class="line">&#125;</span><br><span class="line">hello();</span><br></pre></td></tr></table></figure><p></p><p>ç„¶åä½¿ç”¨<code>/open</code>å‘½ä»¤æ‰§è¡Œè¿™ä¸ªæ–‡ä»¶ï¼š</p><p><img src="img/QQæˆªå›¾20190213110050.png" alt="QQæˆªå›¾20190213110050.png"></p><p>æ›´å¤šå…³äºjshellçš„åŠŸèƒ½ä»‹ç»ï¼Œå¯ä»¥ä½¿ç”¨<code>/help</code>å‘½ä»¤æ¥æŸ¥çœ‹ã€‚</p><h2 id="æ¥å£ä¸­çš„ç§æœ‰æ–¹æ³•"><a href="#æ¥å£ä¸­çš„ç§æœ‰æ–¹æ³•" class="headerlink" title="æ¥å£ä¸­çš„ç§æœ‰æ–¹æ³•"></a>æ¥å£ä¸­çš„ç§æœ‰æ–¹æ³•</h2><p>æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œåœ¨JDK 8ä¹‹å‰ï¼Œæ¥å£åªèƒ½åŒ…å«<code>public static final</code>çš„æˆå‘˜å˜é‡å’Œ<code>public abstract</code>ä¿®é¥°çš„æŠ½è±¡æ–¹æ³•ï¼›è€Œåœ¨JDK 8ä¸­ï¼Œæ¥å£ä¸­å¯ä»¥å®šä¹‰é™æ€æ–¹æ³•å’Œé»˜è®¤æ–¹æ³•äº†ï¼›JDK 9çš„æ¥å£åˆåŠ äº†æ–°çš„ç‰¹æ€§ï¼Œå…¶å…è®¸æ¥å£ä¸­åŒ…å«ç§æœ‰çš„æ–¹æ³•ï¼Œä¸‹é¢è¿™ä¸ªæ¥å£å®šä¹‰åœ¨JDK 9 ä¸­æ˜¯åˆæ³•çš„ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TestInterface</span> </span>&#123;</span><br><span class="line">    <span class="comment">// before jdk 7 :</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">method1</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// jdk 8:</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">method2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"mehtod2"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">default</span> <span class="keyword">void</span> <span class="title">method3</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"mehtod3"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// jdk 9:</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">method4</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"mehtod4"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><h2 id="Diamond-Operatorä½¿ç”¨å‡çº§"><a href="#Diamond-Operatorä½¿ç”¨å‡çº§" class="headerlink" title="Diamond Operatorä½¿ç”¨å‡çº§"></a>Diamond Operatorä½¿ç”¨å‡çº§</h2><p>åœ¨Java 9 ä¹‹å‰çš„ç‰ˆæœ¬ä¸­ï¼Œæˆ‘ä»¬ä¸èƒ½å°†é’»çŸ³æ“ä½œç¬¦ï¼ˆDiamond Operatorï¼‰å’ŒåŒ¿åå®ç°ç±»æ”¾åœ¨ä¸€èµ·ä½¿ç”¨ï¼Œæ¯”å¦‚ä¸‹é¢è¿™ä¸ªä¾‹å­åœ¨Java 9 ä¹‹å‰çš„ç‰ˆæœ¬ä¸­ç¼–è¯‘æ˜¯ä¸é€šè¿‡çš„ï¼š</p><p><img src="img/QQæˆªå›¾20190214091025.png" alt="QQæˆªå›¾20190214091025.png"></p><p>è€Œåœ¨Java 9ä¸­å–æ¶ˆäº†è¿™ä¸ªé™åˆ¶ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™ä¸ªç‰¹æ€§æ¥è¿›è¡Œä¸€äº›åˆå§‹åŒ–æ“ä½œ:</p><p><img src="img/QQæˆªå›¾20190214091154.png" alt="QQæˆªå›¾20190214091154.png"></p><h2 id="tryä½¿ç”¨å‡çº§"><a href="#tryä½¿ç”¨å‡çº§" class="headerlink" title="tryä½¿ç”¨å‡çº§"></a>tryä½¿ç”¨å‡çº§</h2><p>åœ¨Java 9 ä¹‹å‰ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸‹é¢è¿™ç§ä¼˜é›…çš„æ–¹å¼æ¥è¿›è¡Œæµçš„å…³é—­æ“ä½œï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> (InputStreamReader reader = <span class="keyword">new</span> InputStreamReader(System.in)) &#123;</span><br><span class="line">    reader.read();</span><br><span class="line">&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>åœ¨<code>try</code>åé¢çš„æ‹¬å·ä¸­å£°æ˜åˆå§‹åŒ–çš„æµJavaä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬è¿›è¡Œå…³é—­æ“ä½œã€‚Java 9 å¯¹è¿™ä¸ªç‰¹æ€§è¿›è¡Œäº†å‡çº§ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨<code>try</code>åé¢çš„æ‹¬å·ä¸­ä½¿ç”¨å·²ç»åˆå§‹åŒ–è¿‡çš„èµ„æºï¼Œæ­¤æ—¶çš„èµ„æºæ˜¯<code>final</code>çš„ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">InputStreamReader reader = <span class="keyword">new</span> InputStreamReader(System.in);</span><br><span class="line"><span class="keyword">try</span> (reader) &#123;</span><br><span class="line">    reader.read();</span><br><span class="line">&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>å¦‚æœå¯¹<code>reader</code>å†æ¬¡è¿›è¡Œèµ‹å€¼æ“ä½œï¼Œç¼–è¯‘å°†ä¸é€šè¿‡ï¼š</p><p><img src="img/QQæˆªå›¾20190214093344.png" alt="QQæˆªå›¾20190214093344.png"></p><h2 id="ä¸‹åˆ’çº¿æ ‡è¯†ç¬¦çš„é™åˆ¶"><a href="#ä¸‹åˆ’çº¿æ ‡è¯†ç¬¦çš„é™åˆ¶" class="headerlink" title="ä¸‹åˆ’çº¿æ ‡è¯†ç¬¦çš„é™åˆ¶"></a>ä¸‹åˆ’çº¿æ ‡è¯†ç¬¦çš„é™åˆ¶</h2><p>Java 8 ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸‹åˆ’çº¿<code>_</code>ä½œä¸ºæ ‡è¯†ç¬¦ä½¿ç”¨ï¼Œæ¯”å¦‚ä¸‹é¢è¿™æ®µä»£ç æ˜¯åˆæ³•çš„ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">String _ = <span class="string">"mrbird"</span>;</span><br><span class="line">System.out.println(_);</span><br></pre></td></tr></table></figure><p></p><p>è€Œåœ¨Java 9 ä¸­ï¼Œä¸‹åˆ’çº¿<code>_</code>å·²ç»ä¸èƒ½ç”¨äºæ ‡è¯†ç¬¦äº†ï¼š</p><p><img src="img/QQæˆªå›¾20190214094709.png" alt="QQæˆªå›¾20190214094709.png"></p><h2 id="Stringå­˜å‚¨ç»“æ„å˜æ›´"><a href="#Stringå­˜å‚¨ç»“æ„å˜æ›´" class="headerlink" title="Stringå­˜å‚¨ç»“æ„å˜æ›´"></a>Stringå­˜å‚¨ç»“æ„å˜æ›´</h2><p>Java 9 ä¹‹å‰ï¼Œå­—ç¬¦ä¸²çš„åº•å±‚æ˜¯ç”¨<code>char[]</code>è¿›è¡Œå­˜å‚¨çš„ï¼ŒJava 9 ä¸­ï¼Œå­—ç¬¦ä¸²æ”¹ç”¨æˆäº†<code>byte[]</code>è¿›è¡Œå­˜å‚¨:</p><p><img src="img/QQæˆªå›¾20190214101945.png" alt="QQæˆªå›¾20190214101945.png"></p><p>ä¹‹æ‰€ä»¥åšå‡ºè¿™ä¸ªæ”¹å˜æ˜¯å› ä¸ºï¼šå¤§å¤šæ•°<code>String</code>ç±»å‹å¯¹è±¡å­˜å‚¨çš„éƒ½æ˜¯æ‹‰ä¸å­—ç¬¦ï¼Œè¿™äº›å­—ç¬¦åªå ä¸€ä¸ªå­—èŠ‚ï¼Œè€Œ<code>char</code>èƒ½å¤Ÿå­˜å‚¨ä¸¤ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥å¤§éƒ¨åˆ†æƒ…å†µä¸‹éƒ½æµªè´¹äº†ä¸€åŠçš„å­˜å‚¨ç©ºé—´ã€‚Java 9 å°†<code>String</code>ç±»çš„å†…éƒ¨è¡¨ç¤ºä»<code>UTF-16</code>çš„<code>char</code>æ•°ç»„æ›´æ”¹ä¸º<code>byte</code>æ•°ç»„åŠ ä¸Š<code>encoding-flag</code>å­—æ®µã€‚æ–°<code>String</code>ç±»å°†æ ¹æ®å­—ç¬¦ä¸²çš„å†…å®¹å­˜å‚¨ç¼–ç ä¸º<code>ISO-8859-1</code> / Latin-1ï¼ˆæ¯ä¸ªå­—ç¬¦ä¸€ä¸ªå­—èŠ‚ï¼‰æˆ–<code>UTF-16</code>ï¼ˆæ¯ä¸ªå­—ç¬¦ä¸¤ä¸ªå­—èŠ‚ï¼‰çš„å­—ç¬¦ã€‚<code>encoding-flag</code>ç¼–ç æ ‡å¿—å°†æŒ‡ç¤ºä½¿ç”¨å“ªç§ç¼–ç ã€‚</p><p>åŸºäº<code>String</code>çš„ç±»å¦‚<code>StringBuffer</code>å’Œ<code>StringBuilder</code>ç­‰ä¹Ÿæ˜¯åšå‡ºäº†ç›¸åŒçš„æ”¹å˜ã€‚</p><p>å…·ä½“å¯å‚è€ƒï¼š<a href="http://openjdk.java.net/jeps/254" target="_blank" rel="noopener">http://openjdk.java.net/jeps/254</a>ã€‚</p><h2 id="é›†åˆçš„ofæ–¹æ³•"><a href="#é›†åˆçš„ofæ–¹æ³•" class="headerlink" title="é›†åˆçš„ofæ–¹æ³•"></a>é›†åˆçš„<code>of</code>æ–¹æ³•</h2><p>Java 9 ä¹‹å‰æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„æ–¹å¼æ¥åˆ›å»ºä¸å¯å˜é›†åˆï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Integer&gt; list = Collections.unmodifiableList(Arrays.asList(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>));</span><br><span class="line"></span><br><span class="line">Set&lt;Integer&gt; set = Collections.unmodifiableSet(<span class="keyword">new</span> HashSet&lt;&gt;(Arrays.asList(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)));</span><br><span class="line"></span><br><span class="line">Map&lt;String, Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">map.put(<span class="string">"mrbird"</span>, <span class="number">18</span>);</span><br><span class="line">map.put(<span class="string">"kangkang"</span>, <span class="number">20</span>);</span><br><span class="line">Map&lt;String, Object&gt; map1 = Collections.unmodifiableMap(map);</span><br></pre></td></tr></table></figure><p></p><p>Java 9 ä¸­çš„é›†åˆç±»éƒ½æ·»åŠ äº†ä¸€ä¸ª<code>of</code>æ–¹æ³•ï¼Œå¯ä»¥å¿«é€Ÿçš„æ„é€ ä¸å¯å˜é›†åˆï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Integer&gt; list = List.of(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>);</span><br><span class="line">Set&lt;Integer&gt; set = Set.of(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>);</span><br><span class="line">Map&lt;String, Object&gt; map1 = Map.of(<span class="string">"mrbird"</span>, <span class="number">18</span>, <span class="string">"kangkang"</span>, <span class="number">20</span>);</span><br></pre></td></tr></table></figure><p></p><p>å¯¹ä¸å¯å˜é›†åˆè¿›è¡Œèµ‹å€¼æ“ä½œå°†æŠ›å‡ºå¼‚å¸¸ï¼š</p><p><img src="img/QQæˆªå›¾20190214112738.png" alt="QQæˆªå›¾20190214112738.png"></p><h2 id="å¢å¼ºçš„Steam-API"><a href="#å¢å¼ºçš„Steam-API" class="headerlink" title="å¢å¼ºçš„Steam API"></a>å¢å¼ºçš„Steam API</h2><p>åœ¨ Java 9 ä¸­ï¼ŒStream APIå˜å¾—æ›´å¥½ï¼ŒStreamæ¥å£ä¸­æ·»åŠ äº† 4 ä¸ªæ–°çš„æ–¹æ³•ï¼š<code>dropWhile</code>, <code>takeWhile</code>, <code>ofNullable</code>ï¼Œè¿˜æœ‰ä¸ª <code>iterate</code>æ–¹æ³•çš„æ–°é‡è½½æ–¹æ³•ï¼Œå¯ä»¥è®©ä½ æä¾›ä¸€ä¸ª<code>Predicate</code>ï¼ˆåˆ¤æ–­æ¡ä»¶ï¼‰æ¥æŒ‡å®šä»€ä¹ˆæ—¶å€™ç»“æŸè¿­ä»£ã€‚</p><p>ä¸‹é¢ä¸¾ä¾‹æ¥æ¼”ç¤ºè¿™å‡ ä¸ªçš„ç”¨æ³•ï¼š</p><p><strong>takeWhile</strong></p><p>takeWhileç”¨äºä»Streamä¸­è·å–ä¸€éƒ¨åˆ†æ•°æ®ï¼Œæ¥æ”¶ä¸€ä¸ªPredicateæ¥è¿›è¡Œé€‰æ‹©ã€‚åœ¨æœ‰åºçš„Streamä¸­ï¼ŒtakeWhileè¿”å›ä»å¼€å¤´å¼€å§‹çš„å°½é‡å¤šçš„å…ƒç´ ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Integer&gt; list = Arrays.asList(<span class="number">45</span>, <span class="number">43</span>, <span class="number">76</span>, <span class="number">87</span>, <span class="number">42</span>, <span class="number">77</span>, <span class="number">90</span>, <span class="number">73</span>, <span class="number">67</span>, <span class="number">88</span>);</span><br><span class="line">list.stream().takeWhile(x -&gt; x &lt; <span class="number">50</span>).forEach(System.out::println);</span><br></pre></td></tr></table></figure><p></p><p>ç»“æœè¾“å‡º:</p><p><img src="img/QQæˆªå›¾20190214135831.png" alt="QQæˆªå›¾20190214135831.png"></p><p>ç¨‹åºä»å¤´å¼€å§‹åˆ¤æ–­å½“å‰å€¼æ˜¯å¦å°äº50ï¼Œå½“åˆ¤æ–­åˆ°ç¬¬ä¸‰ä¸ªå…ƒç´ 76æ—¶ï¼Œå‘ç°ä¸æ»¡è¶³ï¼Œäºæ˜¯ç¨‹åºå°±ç»“æŸäº†ã€‚æ‰€ä»¥<code>takeWhile</code>ä¸åŒäºè¿‡æ»¤å™¨ã€‚</p><p><strong>dropWhile</strong></p><p>dropWhileçš„è¡Œä¸ºä¸takeWhileç›¸åï¼Œè¿”å›å‰©ä½™çš„å…ƒç´ ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Integer&gt; list = Arrays.asList(<span class="number">45</span>, <span class="number">43</span>, <span class="number">76</span>, <span class="number">87</span>, <span class="number">42</span>, <span class="number">77</span>, <span class="number">90</span>, <span class="number">73</span>, <span class="number">67</span>, <span class="number">88</span>);</span><br><span class="line">list.stream().dropWhile(x -&gt; x &lt; <span class="number">50</span>).forEach(System.out::println);</span><br></pre></td></tr></table></figure><p></p><p>ç¨‹åºè¾“å‡º:</p><p><img src="img/QQæˆªå›¾20190214140313.png" alt="QQæˆªå›¾20190214140313.png"></p><p><strong>ofNullable</strong></p><p>Java 8 ä¸­Streamä¸èƒ½å®Œå…¨ä¸ºnullï¼ˆåªæœ‰ä¸€ä¸ªå…ƒç´ ï¼Œä¸”ä¸ºnullï¼‰ï¼Œå¦åˆ™ä¼šæŠ¥ç©ºæŒ‡é’ˆå¼‚å¸¸ã€‚è€ŒJava 9 ä¸­çš„ofNullable æ–¹æ³•å…è®¸æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªå•å…ƒç´  Streamï¼Œå¯ä»¥åŒ…å«ä¸€ä¸ªéç©ºå…ƒç´ ï¼Œä¹Ÿå¯ä»¥åˆ›å»ºä¸€ä¸ªç©º Streamï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æŠ¥ NullPointerException</span></span><br><span class="line"><span class="comment">// Stream&lt;Object&gt; stream1 = Stream.of(null);</span></span><br><span class="line"><span class="comment">// System.out.println(stream1.count());</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸æŠ¥å¼‚å¸¸ï¼Œå…è®¸é€šè¿‡</span></span><br><span class="line">Stream&lt;String&gt; stringStream = Stream.of(<span class="string">"AA"</span>, <span class="string">"BB"</span>, <span class="keyword">null</span>);</span><br><span class="line">System.out.println(stringStream.count()); <span class="comment">// 3</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸æŠ¥å¼‚å¸¸ï¼Œå…è®¸é€šè¿‡</span></span><br><span class="line">List&lt;String&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">list.add(<span class="string">"AA"</span>);</span><br><span class="line">list.add(<span class="keyword">null</span>);</span><br><span class="line">System.out.println(list.stream().count()); <span class="comment">// 2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ofNullable()ï¼šå…è®¸å€¼å®Œå…¨ä¸º null</span></span><br><span class="line">Stream&lt;Object&gt; stream1 = Stream.ofNullable(<span class="keyword">null</span>);</span><br><span class="line">System.out.println(stream1.count()); <span class="comment">// 0</span></span><br><span class="line"></span><br><span class="line">Stream&lt;String&gt; stream = Stream.ofNullable(<span class="string">"hello world"</span>);</span><br><span class="line">System.out.println(stream.count()); <span class="comment">// 1</span></span><br></pre></td></tr></table></figure><p></p><p><strong>Steam iteratorçš„é‡è½½æ–¹æ³•</strong></p><p><img src="img/QQæˆªå›¾20190214141552.png" alt="QQæˆªå›¾20190214141552.png"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Java 8 ä¸­çš„</span></span><br><span class="line">Stream.iterate(<span class="number">0</span>, x -&gt; x + <span class="number">1</span>).limit(<span class="number">10</span>).forEach(System.out::println);</span><br><span class="line"><span class="comment">// ç­‰ä»·äº Java 9 ä¸­çš„</span></span><br><span class="line">Stream.iterate(<span class="number">0</span>, x -&gt; x &lt; <span class="number">10</span>, x -&gt; x + <span class="number">1</span>).forEach(System.out::println);</span><br></pre></td></tr></table></figure><p>é™¤äº†ä¸Šé¢å‡ ä¸ªæ–°ç‰¹æ€§å¤–ï¼ŒJava 9 è¿˜æ”¯æŒå°†optionalè½¬æ¢ä¸ºæµçš„æ“ä½œï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">List&lt;String&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">list.add(<span class="string">"mrbird"</span>);</span><br><span class="line">list.add(<span class="string">"kangkang"</span>);</span><br><span class="line">list.add(<span class="string">"maria"</span>);</span><br><span class="line"></span><br><span class="line">Optional&lt;List&lt;String&gt;&gt; optional = Optional.of(list);</span><br><span class="line"></span><br><span class="line"><span class="comment">// æµä¸­çš„å…ƒç´ ä¸º list</span></span><br><span class="line">Stream&lt;List&lt;String&gt;&gt; stream = optional.stream();</span><br><span class="line">stream.forEach(System.out::println);</span><br><span class="line"></span><br><span class="line"><span class="comment">// æµä¸­çš„å…ƒç´ ä¸º listä¸­çš„æ¯ä¸ªå…ƒç´ </span></span><br><span class="line">Stream&lt;String&gt; stringStream = optional.stream().flatMap(Collection::stream);</span><br><span class="line">stringStream.forEach(System.out::println);</span><br></pre></td></tr></table></figure><p></p><p>ç¨‹åºè¾“å‡ºï¼š</p><p><img src="img/QQæˆªå›¾20190214143228.png" alt="QQæˆªå›¾20190214143228.png"></p><h2 id="HTTP-Client"><a href="#HTTP-Client" class="headerlink" title="HTTP Client"></a>HTTP Client</h2><p>Java 9 ä¸­æ–°å¢äº†å…¨æ–°çš„<code>HttpClient</code>æ¥æ›¿ä»£<code>HttpURLConnection</code>ï¼Œå…¶å¯ä»¥ä»<code>jdk.incubator.httpclient</code>æ¨¡å—ä¸­è·å–ã€‚å› ä¸ºåœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿™ä¸ªæ¨¡å—æ˜¯ä¸èƒ½æ ¹æ®<code>classpath</code>è·å–çš„ï¼Œéœ€è¦ä½¿ç”¨<code>add modules</code>å‘½ä»¤é€‰é¡¹é…ç½®è¿™ä¸ªæ¨¡å—ï¼Œå°†è¿™ä¸ªæ¨¡å—æ·»åŠ åˆ° classpathä¸­ã€‚</p><p>æˆ‘ä»¬åœ¨srcä¸‹çš„module-info.javaä¸­å¼•å…¥è¿™ä¸ªæ¨¡å—ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">requires</span> jdk.incubator.httpclient;</span><br></pre></td></tr></table></figure><p></p><p>å†™ä¸ªåŸºäº<code>HttpClient</code>çš„ä¾‹å­:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">HttpClient client = HttpClient.newHttpClient();</span><br><span class="line">HttpRequest req = HttpRequest.newBuilder(URI.create(<span class="string">"https://mrbird.cc"</span>))</span><br><span class="line">                .GET()</span><br><span class="line">                .build();</span><br><span class="line">HttpResponse&lt;String&gt; response = client.send(req, HttpResponse.BodyHandler.asString());</span><br><span class="line">System.out.println(response.statusCode());</span><br><span class="line">System.out.println(response.version().name());</span><br><span class="line">System.out.println(response.body());</span><br></pre></td></tr></table></figure><p></p><p>è¾“å‡ºç»“æœï¼š</p><p><img src="img/QQæˆªå›¾20190214145555.png" alt="QQæˆªå›¾20190214145555.png"></p><blockquote><p>å‚è€ƒè‡ªï¼š<a href="https://www.jianshu.com/u/5f70a16b98e7" target="_blank" rel="noopener">https://www.jianshu.com/u/5f70a16b98e7</a></p></blockquote><!-- rebuild by neat -->]]></content>
    
    <summary type="html">
    
      &lt;!-- build time:Wed May 15 2019 17:13:43 GMT+0800 (GMT+08:00) --&gt;&lt;p&gt;åœ¨Java 8 å‘å¸ƒ3å¹´å¤šåï¼ŒJava 9 ç»ˆäºåœ¨2017å¹´9æœˆ21æ—¥æ­£å¼å‘å¸ƒã€‚Java 9 æä¾›äº†è¶…è¿‡150é¡¹æ–°åŠŸèƒ½ç‰¹æ€§ï¼ŒåŒ…æ‹¬å¤‡å—æœŸå¾…çš„æ¨¡å—åŒ–ç³»ç»Ÿã€ å¯äº¤äº’çš„REPLå·¥å…·jShellã€JDKç¼–è¯‘å·¥å…·ã€Javaå…¬å…±APIå’Œç§æœ‰ä»£ç ï¼Œä»¥åŠå®‰å…¨å¢å¼ºã€æ‰©å±•æå‡å’Œæ€§èƒ½ç®¡ç†æ”¹å–„ç­‰ã€‚åœ¨å­¦ä¹ è¿™äº›æ–°ç‰¹æ€§ä¹‹å‰ï¼Œæˆ‘ä»¬å¾—å…ˆå®‰è£…å¥½JDK 9ï¼ŒJDK 9 ä¸‹è½½åœ°å€ï¼š&lt;a href=&quot;https://www.oracle.com/technetwork/cn/java/javase/downloads/jdk9-downloads-3848520-zhs.html&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://www.oracle.com/technetwork/cn/java/javase/downloads/jdk9-downloads-3848520-zhs.html&lt;/a&gt;ã€‚
    
    </summary>
    
    
      <category term="Java" scheme="http://mrbird.cc/tags/Java/"/>
    
      <category term="Java 9" scheme="http://mrbird.cc/tags/Java-9/"/>
    
  </entry>
  
</feed>
